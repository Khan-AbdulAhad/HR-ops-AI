<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turing Outreach V10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        glass: { light: 'rgba(255, 255, 255, 0.9)', dark: 'rgba(17, 24, 39, 0.9)' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 15px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .dark body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
        }
        .glass { 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255,255,255,0.2); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            background: rgba(255,255,255,0.95); 
        }
        .dark .glass { 
            background: rgba(30,41,59,0.95); 
            border-color: rgba(255,255,255,0.1); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .nav-tab { cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent; }
        .nav-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .dark .nav-tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .smart-chip { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.8rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 1px solid #e5e7eb; background: #fff; color: #4b5563; }
        .smart-chip.active { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .dark .smart-chip { background: #1f2937; border-color: #374151; color: #9ca3af; }
        .dark .smart-chip.active { background: rgba(37, 99, 235, 0.2); color: #60a5fa; border-color: #2563eb; }
        .input-field { width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: white; transition: all 0.2s; }
        .dark .input-field { background: #1f2937; border-color: #374151; color: white; }
        .input-field:focus { ring: 2px; outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .hidden-tab { display: none; }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .toast { padding: 14px 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; min-width: 300px; position: relative; }
        .toast-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .toast-info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .toast-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .toast-close { position: absolute; top: 50%; right: 12px; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: background 0.2s; }
        .toast-close:hover { background: rgba(255,255,255,0.3); }
        .toast-content { flex: 1; padding-right: 24px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast.hiding { animation: slideOut 0.3s ease forwards; }

        /* Collapsible Sections */
        .collapsible-header { cursor: pointer; user-select: none; }
        .collapsible-header:hover { opacity: 0.9; }
        .collapsible-content { transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease; overflow: hidden; }
        .collapsible-content.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; }
        .collapse-icon { transition: transform 0.3s ease; }
        .collapse-icon.collapsed { transform: rotate(-90deg); }
        
        /* Status Log Styles */
        .log-container { max-height: 200px; overflow-y: auto; font-size: 0.75rem; }
        .log-entry { padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-bottom: 0.25rem; }
        .log-info { background: #eff6ff; color: #1e40af; }
        .log-success { background: #ecfdf5; color: #047857; }
        .log-warning { background: #fffbeb; color: #b45309; }
        .log-error { background: #fef2f2; color: #b91c1c; }
        .dark .log-info { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .dark .log-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .dark .log-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .dark .log-error { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        
        /* Badge styles */
        .badge-initial { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .badge-ai-1 { background: #dbeafe; color: #1d4ed8; border: 1px solid #93c5fd; }
        .badge-ai-2 { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }
        .badge-human { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-completed { background: #d1fae5; color: #047857; border: 1px solid #6ee7b7; }
        
        .dark .badge-initial { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; border-color: #6366f1; }
        .dark .badge-ai-1 { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border-color: #3b82f6; }
        .dark .badge-ai-2 { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border-color: #f59e0b; }
        .dark .badge-human { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border-color: #ef4444; }
        .dark .badge-completed { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border-color: #10b981; }
        
        /* Email Composer Slide Panel */
        .slide-panel { 
            position: fixed; 
            top: 0; 
            right: -500px; 
            width: 480px; 
            height: 100vh; 
            background: white; 
            box-shadow: -10px 0 40px rgba(0,0,0,0.15); 
            transition: right 0.3s ease; 
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .slide-panel.open { right: 0; }
        .dark .slide-panel { background: #1e293b; }
        .slide-panel-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.3); 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.3s; 
            z-index: 99; 
        }
        .slide-panel-overlay.open { opacity: 1; visibility: visible; }
        
        /* Progress Bar */
        .progress-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 0.3s; }
        
        /* Sending Animation */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .sending-indicator { position: relative; }
        .sending-indicator::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 12px;
            background: #3b82f6;
            animation: pulse-ring 1.5s infinite;
            z-index: -1;
        }
        
        /* Task Row States */
        .task-row { transition: all 0.2s; }
        .task-row.processing { opacity: 0.5; pointer-events: none; }
        .task-row.selected { background: #eff6ff !important; }
        .dark .task-row.selected { background: rgba(59, 130, 246, 0.1) !important; }
        
        /* Tooltip */
        .tooltip { position: relative; }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: #1f2937;
            color: white;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 50;
        }
        .tooltip:hover::after { opacity: 1; visibility: visible; }

        /* ========== SENT ROW STYLING ========== */
        tr.sent-row td { background-color: #fef2f2 !important; }
        .dark tr.sent-row td { background-color: #450a0a !important; }
        tr.manual-sent-row td { background-color: #fef3c7 !important; }
        .dark tr.manual-sent-row td { background-color: #451a03 !important; }

        /* ========== FILTER CHIPS ========== */
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.625rem;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            user-select: none;
        }
        .filter-chip .filter-check {
            width: 0;
            opacity: 0;
            transition: all 0.2s ease;
            overflow: hidden;
            margin-left: -0.25rem;
        }
        .filter-chip.active .filter-check {
            width: 1rem;
            opacity: 1;
            margin-left: 0;
        }
        .filter-chip.all { background: #f3f4f6; color: #374151; border-color: #d1d5db; }
        .filter-chip.all.active { background: #374151; color: white; border-color: #374151; }
        .filter-chip.all:hover:not(.active) { background: #e5e7eb; border-color: #9ca3af; }
        .filter-chip.new { background: #dcfce7; color: #166534; border-color: #86efac; }
        .filter-chip.new.active { background: #16a34a; color: white; border-color: #16a34a; box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2); }
        .filter-chip.new:hover:not(.active) { background: #bbf7d0; border-color: #4ade80; }
        .filter-chip.followup { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .filter-chip.followup.active { background: #dc2626; color: white; border-color: #dc2626; box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2); }
        .filter-chip.followup:hover:not(.active) { background: #fecaca; border-color: #f87171; }
        .filter-chip.manual { background: #fef3c7; color: #92400e; border-color: #fcd34d; }
        .filter-chip.manual.active { background: #d97706; color: white; border-color: #d97706; box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.2); }
        .filter-chip.manual:hover:not(.active) { background: #fde68a; border-color: #fbbf24; }
        .filter-chip.sub { background: #fed7aa; color: #c2410c; border-color: #fb923c; }
        .filter-chip.sub.active { background: #ea580c; color: white; border-color: #ea580c; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.2); }
        .filter-chip.sub:hover:not(.active) { background: #fdba74; border-color: #f97316; }
        .filter-chip.agency { background: #f3e8ff; color: #7c3aed; border-color: #c4b5fd; }
        .filter-chip.agency.active { background: #7c3aed; color: white; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2); }
        .filter-chip.agency:hover:not(.active) { background: #e9d5ff; border-color: #a78bfa; }
        .filter-chip.direct { background: #e0e7ff; color: #4338ca; border-color: #a5b4fc; }
        .filter-chip.direct.active { background: #4f46e5; color: white; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .filter-chip.direct:hover:not(.active) { background: #c7d2fe; border-color: #818cf8; }

        /* Dark mode filter chips */
        .dark .filter-chip.all { background: #374151; color: #e5e7eb; border-color: #4b5563; }
        .dark .filter-chip.all.active { background: #6b7280; border-color: #6b7280; }
        .dark .filter-chip.new { background: rgba(22, 163, 74, 0.2); color: #86efac; border-color: rgba(134, 239, 172, 0.3); }
        .dark .filter-chip.followup { background: rgba(220, 38, 38, 0.2); color: #fca5a5; border-color: rgba(252, 165, 165, 0.3); }
        .dark .filter-chip.manual { background: rgba(217, 119, 6, 0.2); color: #fcd34d; border-color: rgba(252, 211, 77, 0.3); }
        .dark .filter-chip.sub { background: rgba(234, 88, 12, 0.2); color: #fdba74; border-color: rgba(253, 186, 116, 0.3); }
        .dark .filter-chip.agency { background: rgba(124, 58, 237, 0.2); color: #c4b5fd; border-color: rgba(196, 181, 253, 0.3); }
        .dark .filter-chip.direct { background: rgba(79, 70, 229, 0.2); color: #a5b4fc; border-color: rgba(165, 180, 252, 0.3); }

        .filter-group-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #9ca3af; margin-right: 0.5rem; }
        .dark .filter-group-label { color: #6b7280; }

        .active-filters-indicator {
            display: inline-flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; font-weight: 600;
            color: #2563eb; background: #eff6ff; padding: 0.25rem 0.625rem; border-radius: 9999px; border: 1px solid #bfdbfe;
        }
        .dark .active-filters-indicator { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-color: #3b82f6; }

        .clear-filters-btn {
            font-size: 0.75rem; font-weight: 600; color: #6b7280; padding: 0.375rem 0.75rem;
            border-radius: 0.5rem; cursor: pointer; border: 1px solid #e5e7eb; background: white; transition: all 0.2s;
        }
        .clear-filters-btn:hover { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .dark .clear-filters-btn { background: #374151; border-color: #4b5563; color: #9ca3af; }
        .dark .clear-filters-btn:hover { background: rgba(220, 38, 38, 0.2); color: #fca5a5; border-color: #dc2626; }

        /* ========== GHOST TOOLBAR ========== */
        .ghost-toolbar {
            display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem;
            background: rgba(255,255,255,0.5); backdrop-filter: blur(8px);
            border-radius: 0.75rem; border: 1px solid rgba(0,0,0,0.05);
        }
        .dark .ghost-toolbar { background: rgba(30,41,59,0.5); border-color: rgba(255,255,255,0.05); }
        .ghost-btn {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem;
            font-size: 0.8125rem; font-weight: 600; color: #6b7280; border-radius: 0.5rem;
            transition: all 0.2s ease; cursor: pointer; border: 1px solid transparent; background: transparent; white-space: nowrap;
        }
        .ghost-btn:hover { background: white; color: #374151; border-color: #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .dark .ghost-btn { color: #9ca3af; }
        .dark .ghost-btn:hover { background: #374151; color: #f3f4f6; border-color: #4b5563; }
        .ghost-btn.primary { color: #2563eb; }
        .ghost-btn.primary:hover { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        .dark .ghost-btn.primary { color: #60a5fa; }
        .dark .ghost-btn.primary:hover { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border-color: #3b82f6; }
        .ghost-btn.success { color: #16a34a; }
        .ghost-btn.success:hover { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
        .ghost-btn.warning { color: #d97706; }
        .ghost-btn.warning:hover { background: #fffbeb; color: #b45309; border-color: #fcd34d; }
        .dark .ghost-btn.warning { color: #fbbf24; }
        .dark .ghost-btn.warning:hover { background: rgba(251, 191, 36, 0.15); color: #fcd34d; border-color: #f59e0b; }
        .toolbar-divider { width: 1px; height: 1.5rem; background: #e5e7eb; margin: 0 0.25rem; }
        .dark .toolbar-divider { background: #4b5563; }

        /* ========== FLOATING BULK ACTION BAR ========== */
        .bulk-action-bar {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(200%);
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white; padding: 1rem 2rem; border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; gap: 1.5rem;
            transition: transform 0.3s ease; z-index: 40; border: 1px solid #374151;
        }
        .bulk-action-bar.visible { transform: translateX(-50%) translateY(0); }
        .bulk-action-bar .divider { width: 1px; height: 2rem; background: #4b5563; }
        .bulk-action-bar button {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem;
            font-weight: 600; font-size: 0.875rem; border-radius: 0.5rem; transition: all 0.2s;
            background: transparent; color: white; border: none; cursor: pointer;
        }
        .bulk-action-bar button:hover { background: rgba(255,255,255,0.1); }
        .bulk-action-bar button.primary { color: #60a5fa; }
        .bulk-action-bar button.warning { color: #fbbf24; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen text-gray-800 dark:text-gray-100">

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="max-w-7xl mx-auto">
        <!-- Top Bar -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-robot text-blue-600"></i>
                <span>Turing AI Recruiter</span>
                <span class="text-xs font-normal bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">V12</span>
            </h1>
            <div class="flex gap-3 items-center">
                <!-- Logged-in User Display -->
                <div id="userEmailDisplay" class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700">
                    <i class="fa-solid fa-user-circle text-blue-500"></i>
                    <span id="userEmailText">Loading...</span>
                </div>
                <button onclick="openConfigModal()" class="text-sm bg-white dark:bg-gray-800 px-4 py-2 rounded-lg hover:bg-gray-50 border border-gray-200 dark:border-gray-700 shadow-sm"><i class="fa-solid fa-cog"></i> Config</button>
                <button onclick="toggleDarkMode()" class="text-sm bg-white dark:bg-gray-800 px-4 py-2 rounded-lg hover:bg-gray-50 border border-gray-200 dark:border-gray-700 shadow-sm"><i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:inline"></i></button>
            </div>
        </div>

        <div class="glass rounded-2xl shadow-xl overflow-hidden min-h-[80vh]">
            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200 dark:border-gray-700 px-6 bg-gray-50/50 dark:bg-gray-800/50">
                <div class="nav-tab active px-6 py-4 font-semibold text-sm flex items-center gap-2" onclick="switchTab('outreach', this)"><i class="fa-solid fa-users-viewfinder"></i> Outreach Manager</div>
                <div class="nav-tab px-6 py-4 font-semibold text-sm flex items-center gap-2" onclick="switchTab('negotiation', this)"><i class="fa-solid fa-hand-holding-dollar"></i> Negotiation AI</div>
                <div class="nav-tab px-6 py-4 font-semibold text-sm flex items-center gap-2" onclick="switchTab('tasks', this)"><i class="fa-solid fa-clipboard-check"></i> Task List</div>
                <div class="nav-tab px-6 py-4 font-semibold text-sm flex items-center gap-2" onclick="switchTab('followups', this)"><i class="fa-solid fa-clock-rotate-left"></i> Follow-Ups</div>
            </div>

            <div class="p-6 md:p-8">

                <!-- TAB 1: OUTREACH MANAGER -->
                <div id="tab-outreach" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 mb-8">
                        <div class="lg:col-span-3">
                            <label class="block text-xs font-bold uppercase mb-2 text-gray-500">Job ID</label>
                            <input type="number" id="jobId" class="input-field font-mono" placeholder="51000">
                        </div>
                        <div class="lg:col-span-7">
                            <label class="block text-xs font-bold uppercase mb-2 text-gray-500">Pipeline Stages</label>
                            <div class="flex flex-wrap gap-2">
                                <div class="smart-chip" onclick="toggleChip(this)" data-value="Interested">Interested</div>
                                <div class="smart-chip" onclick="toggleChip(this)" data-value="Passed VetSmith">Passed VetSmith</div>
                                <div class="smart-chip" onclick="toggleChip(this)" data-value="Pending Review">Pending Review</div>
                                <div class="smart-chip" onclick="toggleChip(this)" data-value="Completed Testing">Completed Testing</div>
                                <div class="smart-chip" onclick="toggleChip(this)" data-value="Ready for Selection">Ready for Selection</div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 flex items-end gap-2">
                            <button id="fetchBtn" onclick="fetchData()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2"><i class="fa-solid fa-search"></i> <span>Fetch</span></button>
                            <button onclick="openManualInput()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-3 px-4 rounded-xl shadow transition" title="Manual Test Mode"><i class="fa-solid fa-vial"></i></button>
                        </div>
                    </div>
                    <!-- Status Filter Section (Hidden until data loaded) -->
                    <div id="statusFilterContainer" class="hidden mb-6">
                        <div class="flex items-center gap-2 mb-3 text-xs font-bold uppercase text-gray-500">
                            <i class="fa-solid fa-filter text-blue-600"></i>
                            <span>Filter by Pipeline Status</span>
                        </div>
                        <div id="statusButtons" class="flex flex-wrap gap-2.5"></div>
                    </div>

                    <!-- Table Controls (Hidden until data loaded) -->
                    <div id="tableControls" class="hidden mb-5 space-y-4">
                        <!-- Search + Filter Row -->
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                            <div class="flex items-center gap-2 w-full lg:w-auto">
                                <div class="relative flex-grow lg:flex-grow-0 lg:w-80">
                                    <input type="text" id="tableSearch" oninput="searchTable()" placeholder="Search developers..." class="w-full p-3 pl-10 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 outline-none focus:ring-2 focus:ring-blue-500 transition font-medium text-sm">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                </div>
                                <button onclick="togglePasteFilter()" class="flex-shrink-0 bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 p-3 rounded-xl transition" title="Filter by Specific Emails/IDs">
                                    <i class="fa-solid fa-clipboard-list"></i> Paste & Filter
                                </button>
                            </div>

                            <div class="flex flex-wrap gap-2 items-center">
                                <span class="filter-group-label">Status:</span>
                                <div class="filter-chip all active" data-filter="all" data-group="status" onclick="toggleFilterChip(this)">
                                    <i class="fa-solid fa-check filter-check"></i>
                                    <i class="fa-solid fa-layer-group"></i>
                                    <span>All</span>
                                    <span id="allCount" class="text-xs opacity-75">0</span>
                                </div>
                                <div class="filter-chip new" data-filter="new" data-group="status" onclick="toggleFilterChip(this)">
                                    <i class="fa-solid fa-check filter-check"></i>
                                    <i class="fa-solid fa-sparkles"></i>
                                    <span>New</span>
                                    <span id="newCount" class="text-xs opacity-75">0</span>
                                </div>
                                <div class="filter-chip followup" data-filter="followup" data-group="status" onclick="toggleFilterChip(this)">
                                    <i class="fa-solid fa-check filter-check"></i>
                                    <i class="fa-solid fa-reply"></i>
                                    <span>Sent</span>
                                    <span id="followupCount" class="text-xs opacity-75">0</span>
                                </div>
                                <div class="filter-chip manual" data-filter="manual" data-group="status" onclick="toggleFilterChip(this)">
                                    <i class="fa-solid fa-check filter-check"></i>
                                    <i class="fa-solid fa-hand"></i>
                                    <span>M.Sent</span>
                                    <span id="manualCount" class="text-xs opacity-75">0</span>
                                </div>

                                <div class="toolbar-divider"></div>

                                <span class="filter-group-label">Type:</span>
                                <div class="filter-chip sub" data-filter="sub" data-group="type" onclick="toggleFilterChip(this)">
                                    <i class="fa-solid fa-check filter-check"></i>
                                    <i class="fa-solid fa-user-tie"></i>
                                    <span>Sub-Contractor</span>
                                    <span id="subCount" class="text-xs opacity-75">0</span>
                                </div>
                                <div class="filter-chip agency" data-filter="agency" data-group="type" onclick="toggleFilterChip(this)">
                                    <i class="fa-solid fa-check filter-check"></i>
                                    <i class="fa-solid fa-building"></i>
                                    <span>Agency</span>
                                    <span id="agencyCount" class="text-xs opacity-75">0</span>
                                </div>
                                <div class="filter-chip direct" data-filter="direct" data-group="type" onclick="toggleFilterChip(this)">
                                    <i class="fa-solid fa-check filter-check"></i>
                                    <i class="fa-solid fa-user"></i>
                                    <span>Direct</span>
                                    <span id="directCount" class="text-xs opacity-75">0</span>
                                </div>

                                <div class="toolbar-divider"></div>

                                <div id="activeFiltersInfo" class="hidden items-center gap-2">
                                    <span class="active-filters-indicator">
                                        <i class="fa-solid fa-filter"></i>
                                        <span id="activeFilterCount">0</span> filters
                                    </span>
                                    <button class="clear-filters-btn" onclick="clearAllFilters()">
                                        <i class="fa-solid fa-xmark mr-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Paste Filter Area (Hidden by default) -->
                        <div id="pasteFilterArea" class="hidden bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-inner">
                            <div class="flex flex-col gap-3">
                                <label class="text-sm font-bold text-gray-700 dark:text-gray-300">Paste Comma Separated Emails or Developer IDs:</label>
                                <textarea id="pasteFilterInput" class="w-full h-24 p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="john@example.com, jane@example.com&#10;OR&#10;12345, 67890"></textarea>
                                <div class="flex gap-3">
                                    <button onclick="applyPasteFilter()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">
                                        <i class="fa-solid fa-filter mr-1"></i> Filter List
                                    </button>
                                    <button onclick="clearPasteFilter()" class="bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-500 px-4 py-2 rounded-lg text-sm font-medium transition">
                                        Clear List
                                    </button>
                                    <button onclick="togglePasteFilter()" class="ml-auto text-gray-500 hover:text-gray-700 dark:text-gray-400 text-sm">Close</button>
                                </div>
                            </div>
                        </div>

                        <!-- Ghost Toolbar -->
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <div class="ghost-toolbar">
                                <button onclick="selectAllResults()" class="ghost-btn primary">
                                    <i class="fa-solid fa-check-double"></i>
                                    <span>Select All</span>
                                    <span id="selectAllCount" class="text-xs opacity-60">(0)</span>
                                </button>
                                <button onclick="selectCurrentPage()" class="ghost-btn">
                                    <i class="fa-solid fa-check"></i>
                                    <span>Page Only</span>
                                </button>
                                <button onclick="deselectAll()" class="ghost-btn">
                                    <i class="fa-solid fa-xmark"></i>
                                    <span>Clear</span>
                                </button>

                                <div class="toolbar-divider"></div>

                                <button onclick="markSelectedAsManualSent()" class="ghost-btn warning">
                                    <i class="fa-solid fa-hand"></i>
                                    <span>Mark Sent</span>
                                </button>

                                <div class="toolbar-divider"></div>

                                <button onclick="copyToClipboard()" class="ghost-btn">
                                    <i class="fa-regular fa-copy"></i>
                                    <span>Copy</span>
                                </button>
                                <button onclick="downloadCSV()" class="ghost-btn success">
                                    <i class="fa-solid fa-download"></i>
                                    <span>Export CSV</span>
                                </button>
                            </div>

                            <div id="selectionIndicator" class="hidden items-center gap-2 text-sm font-semibold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-lg">
                                <i class="fa-solid fa-circle-check"></i>
                                <span><span id="quickSelectedCount">0</span> selected</span>
                            </div>
                        </div>
                    </div>

                    <div id="tableContainer" class="hidden overflow-hidden rounded-xl border-2 border-gray-200 dark:border-gray-700 shadow-sm">
                        <table id="devTable" class="w-full text-left text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-800 uppercase text-xs font-bold text-gray-500">
                                <tr>
                                    <th class="px-4 py-3 w-12 text-center"><input type="checkbox" id="masterCheckbox" onclick="toggleMasterCheckbox()" class="w-4 h-4 cursor-pointer" title="Select all on current page"></th>
                                    <th class="px-4 py-3">Developer ID</th>
                                    <th class="px-4 py-3">Candidate Name</th>
                                    <th class="px-4 py-3">Email Address</th>
                                    <th class="px-4 py-3">Pipeline Status</th>
                                    <th class="px-4 py-3">Type</th>
                                    <th class="px-4 py-3">Outreach History</th>
                                </tr>
                            </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: NEGOTIATION AI SETTINGS (UPDATED - No Walk-away) -->
                <div id="tab-negotiation" class="tab-content hidden-tab">
                    <div class="max-w-4xl mx-auto">
                        <div class="mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Negotiation Configuration</h2>
                            <p class="text-sm text-gray-500 mt-1">Configure how the AI Agent negotiates rates for specific jobs.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Select Active Job ID</label>
                                    <select id="activeJobsDropdown" onchange="selectJobFromDropdown(this.value)" class="input-field cursor-pointer"><option value="">-- Select or Enter New --</option></select>
                                    <p class="text-xs text-gray-500 mt-1 mb-2">Select an existing configuration to edit</p>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Target Job ID (Manual Entry)</label>
                                    <input type="number" id="negJobId" class="input-field" placeholder="51000" onchange="loadNegotiationConfig()">
                                </div>
                                <!-- UPDATED: Removed Walk-away Rate -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Target Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                                            <input type="number" id="targetRate" class="input-field pl-7" placeholder="22">
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">Ideal rate to negotiate</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Max Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                                            <input type="number" id="maxRate" class="input-field pl-7" placeholder="28">
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">Absolute maximum</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Negotiation Style</label>
                                    <select id="negStyle" class="input-field cursor-pointer">
                                        <option value="Friendly but firm">Friendly but firm</option>
                                        <option value="Professional and direct">Professional and direct</option>
                                        <option value="Empathetic">Empathetic</option>
                                        <option value="Aggressive">High-pressure / Urgent</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Special Rules</label>
                                    <textarea id="specialRules" rows="2" class="input-field" placeholder="e.g. Can offer signing bonus up to $500..."></textarea>
                                </div>
                            </div>
                            <div class="space-y-6">
                                <div class="bg-blue-50 dark:bg-blue-900/10 p-5 rounded-xl border border-blue-100 dark:border-blue-800">
                                    <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-2 text-sm uppercase flex items-center gap-2">
                                        <i class="fa-solid fa-file-lines"></i> Job Description
                                    </h3>
                                    <p class="text-xs text-gray-500 mb-2">Paste the JD so AI knows the role context and can answer candidate questions accurately.</p>
                                    <textarea id="jobDescription" rows="8" class="input-field text-sm" placeholder="Role: LLM Trainer
Requirements:
- 3+ years experience in technical field
- Experience with any programming language
- Strong analytical skills

Responsibilities:
- Train and evaluate AI models
- Provide quality feedback
- Work on cutting-edge AI projects

This is a freelance, fully remote position."></textarea>
                                </div>
                                <button onclick="saveNegotiationSettings()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2"><i class="fa-solid fa-save"></i> <span>Save Configuration</span></button>
                            </div>
                        </div>
                        
                        <!-- Rate Tiers Section -->
                        <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                        <i class="fa-solid fa-layer-group text-green-500"></i> Region-Based Rate Tiers
                                    </h3>
                                    <p class="text-xs text-gray-500 mt-1">Set different rates for candidates based on their region/country</p>
                                </div>
                                <button onclick="refreshRateTiers()" class="text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1.5 rounded-lg">
                                    <i class="fa-solid fa-rotate"></i> Refresh
                                </button>
                            </div>

                            <!-- Add New Tier Form -->
                            <div class="bg-green-50 dark:bg-green-900/10 p-4 rounded-xl border border-green-200 dark:border-green-800 mb-4">
                                <h4 class="font-bold text-green-700 dark:text-green-300 text-sm mb-3">Add/Edit Rate Tier</h4>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Region/Country</label>
                                        <input type="text" id="tierRegion" class="input-field text-sm" placeholder="e.g. India, LATAM">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Target Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-sm">$</span>
                                            <input type="number" id="tierTargetRate" class="input-field text-sm pl-6" placeholder="20">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Max Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-sm">$</span>
                                            <input type="number" id="tierMaxRate" class="input-field text-sm pl-6" placeholder="28">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Notes (optional)</label>
                                        <input type="text" id="tierNotes" class="input-field text-sm" placeholder="e.g. Tier 1">
                                    </div>
                                    <div class="flex items-end">
                                        <button onclick="addRateTier()" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2.5 rounded-lg">
                                            <i class="fa-solid fa-plus mr-1"></i> Add Tier
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-info-circle mr-1"></i> Country names like "India", "Mexico", "US" are automatically mapped to regions</p>
                            </div>

                            <!-- Rate Tiers Table -->
                            <div id="rateTiersContainer" class="overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-50 dark:bg-gray-900 text-xs uppercase font-bold text-gray-500">
                                        <tr>
                                            <th class="px-4 py-3">Region</th>
                                            <th class="px-4 py-3">Target Rate</th>
                                            <th class="px-4 py-3">Max Rate</th>
                                            <th class="px-4 py-3">Notes</th>
                                            <th class="px-4 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rateTiersBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                        <tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">Select a Job ID to view rate tiers</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Info Boxes -->
                        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                                <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-circle-info text-blue-500"></i> AI Context (Auto-included)
                                </h4>
                                <p class="text-xs text-gray-500">The AI automatically includes Turing's company info and freelance perks. It knows this is a freelance position and won't mention full-time benefits.</p>
                            </div>
                            <div class="bg-amber-50 dark:bg-amber-900/10 p-4 rounded-xl border border-amber-200 dark:border-amber-800">
                                <h4 class="font-bold text-amber-700 dark:text-amber-300 text-sm mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-lightbulb text-amber-500"></i> FAQ Support
                                </h4>
                                <p class="text-xs text-gray-500">Add FAQs to the <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">Negotiation_FAQs</code> sheet. AI will use them to answer candidate questions!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: TASKS (IMPROVED UI/UX) -->
                <div id="tab-tasks" class="tab-content hidden-tab">
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="text-2xl font-bold text-gray-900 dark:text-white" id="statTotal">-</div>
                            <div class="text-xs font-medium text-gray-500 uppercase">Total Active</div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                            <div class="text-2xl font-bold text-blue-600" id="statActive">-</div>
                            <div class="text-xs font-medium text-blue-600 uppercase">AI Negotiating</div>
                        </div>
                        <div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-4 border border-amber-200 dark:border-amber-800">
                            <div class="text-2xl font-bold text-amber-600" id="statHuman">-</div>
                            <div class="text-xs font-medium text-amber-600 uppercase">Needs Human</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-200 dark:border-green-800">
                            <div class="text-2xl font-bold text-green-600" id="statAccepted">-</div>
                            <div class="text-xs font-medium text-green-600 uppercase">Offer Accepted</div>
                        </div>
                    </div>
                    
                    <!-- Top Action Bar -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Active Negotiations</h2>
                            <p class="text-sm text-gray-500">Monitor AI negotiations and manage human escalations.</p>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <div class="relative">
                                <i class="fa-solid fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <select id="taskJobFilter" onchange="filterTasks()" class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Jobs</option>
                                </select>
                            </div>
                            <div class="relative">
                                <i class="fa-solid fa-tag absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <select id="taskStatusFilter" onchange="filterTasks()" class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Statuses</option>
                                    <option value="Initial Outreach">Initial Outreach</option>
                                    <option value="Active">AI Active</option>
                                    <option value="Human-Negotiation">Human Required</option>
                                    <option value="Offer Accepted">Accepted</option>
                                </select>
                            </div>
                            <button id="runAiBtn" onclick="manualTriggerAI()" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-sm transition flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> <span>Run AI Now</span>
                            </button>
                            <button onclick="loadTasks()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm font-bold py-2 px-4 rounded-lg transition tooltip" data-tooltip="Refresh">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Bulk Actions (Hidden by default) -->
                    <div id="bulkActionsBar" class="hidden mb-4 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800 flex items-center justify-between">
                        <span class="text-sm font-semibold text-blue-800 dark:text-blue-300">
                            <span id="bulkSelectedCount">0</span> tasks selected
                        </span>
                        <div class="flex gap-2">
                            <button onclick="bulkCompleteSelected()" class="text-sm bg-green-600 text-white px-3 py-1.5 rounded-lg font-medium hover:bg-green-700">
                                <i class="fa-solid fa-check mr-1"></i> Complete Selected
                            </button>
                            <button onclick="clearTaskSelection()" class="text-sm bg-gray-200 dark:bg-gray-700 px-3 py-1.5 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600">
                                Clear
                            </button>
                        </div>
                    </div>

                    <!-- AI Progress Panel (Hidden by default, collapsible) -->
                    <div id="aiProgressPanel" class="hidden mb-6 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-800 overflow-hidden">
                        <div class="collapsible-header p-4 flex items-center justify-between" onclick="toggleCollapse('aiProgressContent', this)">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-robot text-purple-600 animate-pulse" id="aiProgressIcon"></i>
                                <span class="font-bold text-purple-800 dark:text-purple-300">AI Negotiator Running...</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="aiProgressStatus" class="text-sm text-purple-600">Initializing...</span>
                                <i class="fa-solid fa-chevron-down collapse-icon text-purple-500 text-xs"></i>
                                <button onclick="event.stopPropagation(); closeProgressPanel('aiProgressPanel')" class="text-purple-400 hover:text-purple-600 ml-1" title="Close">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="aiProgressContent" class="collapsible-content px-4 pb-4" style="max-height: 250px;">
                            <div class="log-container bg-white dark:bg-gray-900 rounded-lg p-2 border border-purple-100 dark:border-purple-800" id="aiLogContainer">
                                <!-- Logs will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Task Table -->
                    <div class="overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-900 text-xs uppercase font-bold text-gray-500">
                                <tr>
                                    <th class="px-3 py-4 text-center w-10">
                                        <input type="checkbox" onchange="toggleAllTasks(this)" class="task-master-check">
                                    </th>
                                    <th class="px-4 py-4">Job ID</th>
                                    <th class="px-4 py-4">Name</th>
                                    <th class="px-4 py-4">Email</th>
                                    <th class="px-4 py-4">Tag</th>
                                    <th class="px-4 py-4">AI Notes</th>
                                    <th class="px-4 py-4">Last Activity</th>
                                    <th class="px-4 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="taskListBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                <!-- Tasks injected here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyTaskState" class="hidden text-center py-12">
                        <i class="fa-solid fa-inbox text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
                        <p class="text-gray-500">No active tasks found. Send outreach emails to get started.</p>
                    </div>
                </div>

                <!-- TAB 4: FOLLOW-UPS (NEW) -->
                <div id="tab-followups" class="tab-content hidden-tab">

                    <!-- Follow-up Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                            <div class="text-2xl font-bold text-gray-900 dark:text-white" id="statPending">-</div>
                            <div class="text-xs font-medium text-gray-500 uppercase">Awaiting Response</div>
                        </div>
                        <div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-4 border border-amber-200 dark:border-amber-800">
                            <div class="text-2xl font-bold text-amber-600" id="statFollowUp1">-</div>
                            <div class="text-xs font-medium text-amber-600 uppercase">1st Follow-up Sent</div>
                        </div>
                        <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-4 border border-orange-200 dark:border-orange-800">
                            <div class="text-2xl font-bold text-orange-600" id="statFollowUp2">-</div>
                            <div class="text-xs font-medium text-orange-600 uppercase">2nd Follow-up Sent</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-200 dark:border-green-800">
                            <div class="text-2xl font-bold text-green-600" id="statResponded">-</div>
                            <div class="text-xs font-medium text-green-600 uppercase">Responded</div>
                        </div>
                    </div>

                    <!-- Follow-up Action Bar -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Automated Follow-Ups</h2>
                            <p class="text-sm text-gray-500">Automatic follow-up emails are sent at 12 hours and 28 hours after initial outreach if no response.</p>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button id="runFollowUpBtn" onclick="manualTriggerFollowUps()" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-sm transition flex items-center gap-2">
                                <i class="fa-solid fa-clock"></i> <span>Process Follow-Ups Now</span>
                            </button>
                            <button id="resetStatusBtn" onclick="resetFollowUpStatuses()" class="bg-amber-500 hover:bg-amber-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-sm transition flex items-center gap-2 tooltip" data-tooltip="Re-verify and reset incorrectly marked 'Responded' entries">
                                <i class="fa-solid fa-rotate-left"></i> <span>Reset Status</span>
                            </button>
                            <button onclick="loadFollowUpStats()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm font-bold py-2 px-4 rounded-lg transition tooltip" data-tooltip="Refresh">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Follow-up Info Box (Collapsible) -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800 mb-6 overflow-hidden">
                        <div class="collapsible-header p-4 flex items-center justify-between" onclick="toggleCollapse('followUpInfoContent', this)">
                            <h4 class="font-bold text-blue-700 dark:text-blue-300 text-sm flex items-center gap-2">
                                <i class="fa-solid fa-circle-info text-blue-500"></i> How Follow-Ups Work
                            </h4>
                            <i class="fa-solid fa-chevron-down collapse-icon text-blue-500 text-xs"></i>
                        </div>
                        <div id="followUpInfoContent" class="collapsible-content px-4 pb-4" style="max-height: 200px;">
                            <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1 ml-4 list-disc">
                                <li><strong>1st Follow-up:</strong> Sent 12 hours after initial outreach if no response</li>
                                <li><strong>2nd Follow-up:</strong> Sent 28 hours after initial outreach if still no response</li>
                                <li>Follow-ups are automatically skipped if the candidate has responded</li>
                                <li>AI generates contextual, friendly follow-up messages based on the job description</li>
                                <li>Set up a time-based trigger (Triggers > Add Trigger > runFollowUpProcessor) to run hourly for automation</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Follow-Ups Table Section -->
                    <div class="mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <i class="fa-solid fa-users text-blue-500"></i> Developers Under Follow-Up
                            </h3>
                            <div class="flex gap-2 flex-wrap">
                                <div class="relative">
                                    <i class="fa-solid fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <select id="followUpJobFilter" onchange="loadFollowUpData()" class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="all">All Jobs</option>
                                    </select>
                                </div>
                                <div class="relative">
                                    <i class="fa-solid fa-tag absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <select id="followUpStatusFilter" onchange="loadFollowUpData()" class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="all">All Statuses</option>
                                        <option value="Pending">Pending Response</option>
                                        <option value="Follow-Up-1-Sent">1st Follow-up Sent</option>
                                        <option value="Follow-Up-2-Sent">2nd Follow-up Sent</option>
                                    </select>
                                </div>
                                <button onclick="loadFollowUpData()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm font-bold py-2 px-4 rounded-lg transition tooltip" data-tooltip="Refresh Table">
                                    <i class="fa-solid fa-rotate"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Follow-Ups Table -->
                        <div class="overflow-hidden rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 dark:bg-gray-900 text-xs uppercase font-bold text-gray-500">
                                    <tr>
                                        <th class="px-4 py-4">Job ID</th>
                                        <th class="px-4 py-4">Name</th>
                                        <th class="px-4 py-4">Email</th>
                                        <th class="px-4 py-4">Follow-Up Status</th>
                                        <th class="px-4 py-4">Last Reached Out</th>
                                        <th class="px-4 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="followUpTableBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Empty State -->
                        <div id="emptyFollowUpState" class="hidden text-center py-12 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                            <i class="fa-solid fa-inbox text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                            <p class="text-gray-500 dark:text-gray-400">No developers under follow-up</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Send initial outreach emails to start the follow-up process</p>
                        </div>
                    </div>

                    <!-- Follow-up Progress Panel (Hidden by default, collapsible) -->
                    <div id="followUpProgressPanel" class="hidden mb-6 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-800 overflow-hidden">
                        <div class="collapsible-header p-4 flex items-center justify-between" onclick="toggleCollapse('followUpProgressContent', this)">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-clock text-purple-600 animate-pulse" id="followUpProgressIcon"></i>
                                <span class="font-bold text-purple-800 dark:text-purple-300">Processing Follow-Ups...</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="followUpProgressStatus" class="text-sm text-purple-600">Initializing...</span>
                                <i class="fa-solid fa-chevron-down collapse-icon text-purple-500 text-xs"></i>
                                <button onclick="event.stopPropagation(); closeProgressPanel('followUpProgressPanel')" class="text-purple-400 hover:text-purple-600 ml-1" title="Close">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="followUpProgressContent" class="collapsible-content px-4 pb-4" style="max-height: 250px;">
                            <div class="log-container bg-white dark:bg-gray-900 rounded-lg p-2 border border-purple-100 dark:border-purple-800" id="followUpLogContainer">
                                <!-- Logs will appear here -->
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- Floating Bulk Action Bar -->
    <div id="bulkActionBar" class="bulk-action-bar">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-check-circle text-green-400"></i>
            <span class="font-bold text-lg"><span id="bulkSelectedCount">0</span> selected</span>
        </div>
        <div class="divider"></div>
        <button onclick="openEmailPanel()" class="primary">
            <i class="fa-solid fa-paper-plane"></i>
            <span>Draft Email Campaign</span>
        </button>
        <div class="divider"></div>
        <button onclick="markSelectedAsManualSent()" class="warning">
            <i class="fa-solid fa-hand"></i>
            <span>Mark as Sent</span>
        </button>
    </div>

    <!-- Email Slide Panel (IMPROVED) -->
    <div id="emailPanelOverlay" class="slide-panel-overlay" onclick="closeEmailPanel()"></div>
    <div id="emailPanel" class="slide-panel">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h2 class="text-xl font-bold dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-envelope text-blue-500"></i> Compose Email
            </h2>
            <button onclick="closeEmailPanel()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Recipients Preview -->
            <div class="mb-4">
                <label class="block text-xs font-bold uppercase mb-2 text-gray-500">Recipients</label>
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
                    <span id="emailRecipientCount" class="text-sm font-semibold text-blue-600">0</span>
                    <span class="text-sm text-gray-500">candidates selected</span>
                    <div id="emailRecipientPreview" class="mt-2 text-xs text-gray-400 max-h-20 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Template Selection -->
            <div class="mb-4 bg-green-50 dark:bg-green-900/10 p-3 rounded-lg border border-green-200 dark:border-green-800">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-xs font-bold uppercase text-green-700 dark:text-green-300">
                        <i class="fa-solid fa-file-lines mr-1"></i> Templates
                    </label>
                    <button onclick="refreshTemplates()" class="text-xs text-green-600 hover:text-green-700">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
                <div class="flex gap-2">
                    <select id="templateSelect" onchange="loadSelectedTemplate()" class="flex-1 input-field text-sm py-2">
                        <option value="">-- Select a template --</option>
                    </select>
                    <button onclick="saveCurrentAsTemplate()" class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-2 rounded-lg font-medium" title="Save current content as template">
                        <i class="fa-solid fa-save"></i>
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold uppercase mb-2 text-gray-500">Subject</label>
                <input id="emailSubject" class="input-field" placeholder="Subject line...">
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold uppercase mb-2 text-gray-500">
                    Body 
                    <span class="font-normal text-gray-400">(use {{name}} for personalization)</span>
                </label>
                <textarea id="emailBody" class="input-field h-48 font-mono text-sm" placeholder="Hi {{name}},

We have an exciting opportunity..."></textarea>
            </div>
            
            <div class="bg-amber-50 dark:bg-amber-900/10 p-3 rounded-lg border border-amber-200 dark:border-amber-800 text-xs text-amber-700 dark:text-amber-300">
                <i class="fa-solid fa-lightbulb mr-1"></i>
                <strong>Tip:</strong> {{name}} will be replaced with the candidate's first name.
            </div>
        </div>
        
        <!-- Send Area -->
        <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
            <!-- Progress Bar (hidden by default) -->
            <div id="sendProgressContainer" class="hidden mb-4">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span id="sendProgressText">Sending...</span>
                    <span id="sendProgressCount">0/0</span>
                </div>
                <div class="progress-bar">
                    <div id="sendProgressBar" class="progress-bar-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <button id="sendEmailBtn" onclick="sendEmails()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-paper-plane"></i> <span>Send Emails</span>
            </button>
        </div>
    </div>
    
    <!-- Manual Input Modal -->
    <div id="manualInputModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6">
            <h2 class="text-xl font-bold mb-2 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-vial text-purple-500"></i> Manual Test Mode
            </h2>
            <p class="text-sm text-gray-500 mb-4">Paste emails to test the negotiation AI without fetching real data.</p>
            <div class="mb-4">
                <label class="block text-xs font-bold uppercase mb-2 text-gray-500">Candidate Data (CSV: Email, Name, Region/Country)</label>
                <textarea id="manualDataInput" class="input-field h-32 font-mono text-sm" placeholder="myemail@test.com, John Doe, India&#10;other@test.com, Jane Smith, US&#10;dev@test.com, Alex Garcia, Mexico"></textarea>
                <p class="text-xs text-gray-400 mt-1">Region is optional. Supported: India, US, Mexico, Brazil, LATAM, Europe, APAC, etc.</p>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('manualInputModal').classList.add('hidden')" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600">Cancel</button>
                <button onclick="loadManualData()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold">Load to Table</button>
            </div>
        </div>
    </div>
    
    <!-- Config Modal (Expanded with Triggers) -->
    <div id="configModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-2">
                <i class="fa-solid fa-cog text-blue-500"></i> Settings
            </h3>

            <!-- Sheet URL Section -->
            <div class="mb-6">
                <!-- Database Sheet URL -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Database Sheet URL</label>
                    <p class="text-xs text-gray-500 mb-2">For system data: FAQs, Config, Logs, Negotiation State, etc.</p>
                    <input type="text" id="sheetUrl" class="input-field" placeholder="https://docs.google.com/spreadsheets/d/...">
                </div>

                <!-- Jobs Sheet URL -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jobs Sheet URL</label>
                    <p class="text-xs text-gray-500 mb-2">For job-specific data: Job_X_Details sheets created per job</p>
                    <input type="text" id="jobsSheetUrl" class="input-field" placeholder="https://docs.google.com/spreadsheets/d/...">
                </div>

                <div class="flex justify-end">
                    <button id="saveConfigBtn" onclick="saveConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 min-w-[80px] justify-center">
                        <span id="saveConfigText">Save</span>
                        <svg id="saveConfigSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Divider -->
            <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

            <!-- Automated Triggers Section -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Automated Triggers</label>
                        <p class="text-xs text-gray-500">Required for follow-ups and daily reports</p>
                    </div>
                    <button onclick="refreshTriggerStatus()" class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
                        <i class="fa-solid fa-sync-alt" id="triggerRefreshIcon"></i> Refresh
                    </button>
                </div>

                <!-- Trigger Status Container -->
                <div id="triggerStatusContainer" class="space-y-2">
                    <div class="flex items-center justify-center py-4 text-gray-500">
                        <i class="fa-solid fa-spinner fa-spin mr-2"></i> Loading trigger status...
                    </div>
                </div>

                <!-- Create All Triggers Button -->
                <div id="createTriggersSection" class="hidden mt-3">
                    <button id="createAllTriggersBtn" onclick="createAllTriggers()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i>
                        <span id="createTriggersText">Create Missing Triggers</span>
                        <svg id="createTriggersSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <!-- All Good Message -->
                <div id="allTriggersGood" class="hidden mt-3 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                    <div class="flex items-center gap-2 text-green-700 dark:text-green-400">
                        <i class="fa-solid fa-check-circle"></i>
                        <span class="text-sm font-medium">All triggers are set up and running!</span>
                    </div>
                </div>
            </div>

            <!-- Close Button -->
            <div class="flex justify-end mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button onclick="document.getElementById('configModal').classList.add('hidden')" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600">Close</button>
            </div>
        </div>
    </div>
    
    <!-- AI Notes Modal (Improved) -->
    <div id="notesModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20">
                <h3 class="text-lg font-bold dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-robot text-purple-500"></i> AI Negotiation Notes
                </h3>
                <button onclick="document.getElementById('notesModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div id="notesModalContent" class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-700 min-h-[100px] max-h-[300px] overflow-y-auto whitespace-pre-wrap leading-relaxed">
                    -
                </div>
                <p class="text-xs text-gray-400 mt-3 flex items-center gap-1">
                    <i class="fa-solid fa-circle-info"></i>
                    These notes are auto-generated by AI based on the conversation
                </p>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-end">
                <button onclick="document.getElementById('notesModal').classList.add('hidden')" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 font-medium text-sm">Close</button>
            </div>
        </div>
    </div>

    <!-- Complete Human Negotiation Modal -->
    <div id="completeHumanModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4" onclick="if(event.target === this) closeCompleteHumanModal()">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20">
                <h3 class="text-lg font-bold dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-handshake text-green-500"></i> Complete Human Negotiation
                </h3>
                <button onclick="closeCompleteHumanModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Candidate:</p>
                    <p id="completeHumanEmail" class="font-semibold text-gray-900 dark:text-white"></p>
                </div>
                <div class="mb-4">
                    <label for="agreedRateInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Agreed Hourly Rate
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">$</span>
                        <input type="number" id="agreedRateInput" placeholder="e.g., 35"
                               class="w-full pl-8 pr-16 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg font-semibold">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">/hr</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="noRateAgreed" onchange="toggleRateInput()" class="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                        <span class="text-sm text-gray-600 dark:text-gray-400">No rate agreed (rejected/withdrawn/other)</span>
                    </label>
                </div>
                <div id="completionStatusSection" class="mb-2">
                    <label for="completionStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Completion Status (optional)
                    </label>
                    <select id="completionStatus" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500">
                        <option value="">Offer Accepted (Human)</option>
                        <option value="Rejected by Candidate">Rejected by Candidate</option>
                        <option value="Candidate Withdrew">Candidate Withdrew</option>
                        <option value="Rate Too High">Rate Too High - Rejected</option>
                        <option value="No Response">No Response</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-end gap-2">
                <button onclick="closeCompleteHumanModal()" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 font-medium text-sm">Cancel</button>
                <button onclick="submitCompleteHuman()" id="completeHumanBtn" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium text-sm flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> Complete
                </button>
            </div>
        </div>
    </div>

    <script>
        let tableData = [];
        let fullTableData = [];
        let selectedDevs = new Set();
        let allTasks = [];
        let selectedTasks = new Set();
        let cachedJobIds = [];
        let cachedTemplates = [];
        let currentUserEmail = '';

        // Multi-select filter state
        let activeFilters = {
            status: new Set(['all']),
            type: new Set()
        };

        // ===== INIT: Load user email on page load =====
        document.addEventListener('DOMContentLoaded', function() {
            loadUserEmail();
        });

        function loadUserEmail() {
            google.script.run
                .withSuccessHandler(function(email) {
                    currentUserEmail = email || 'Unknown';
                    document.getElementById('userEmailText').textContent = email || 'Not signed in';
                })
                .withFailureHandler(function(err) {
                    document.getElementById('userEmailText').textContent = 'Not available';
                })
                .getUserEmail();
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: 'check-circle',
                error: 'circle-xmark',
                warning: 'triangle-exclamation',
                info: 'circle-info'
            };

            toast.innerHTML = `
                <i class="fa-solid fa-${icons[type] || 'circle-info'}"></i>
                <span class="toast-content">${message}</span>
                <button class="toast-close" onclick="closeToast(this)" title="Close">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            // Store timeout ID so we can cancel it if user closes manually
            const timeoutId = setTimeout(() => {
                dismissToast(toast);
            }, duration);
            toast.dataset.timeoutId = timeoutId;
        }

        function closeToast(btn) {
            const toast = btn.closest('.toast');
            if (toast) {
                // Clear the auto-dismiss timeout
                if (toast.dataset.timeoutId) {
                    clearTimeout(parseInt(toast.dataset.timeoutId));
                }
                dismissToast(toast);
            }
        }

        function dismissToast(toast) {
            if (toast && !toast.classList.contains('hiding')) {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }
        }

        // ===== TAB SWITCHING =====
        function switchTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-tab'));
            document.getElementById('tab-' + tabName).classList.remove('hidden-tab');
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            if(tabName === 'tasks') loadTasks();
            if(tabName === 'negotiation') refreshJobDropdown();
            if(tabName === 'followups') loadFollowUpStats();
        }

        // ===== FILTER CHIP FUNCTIONS =====
        function toggleFilterChip(element) {
            const filter = element.dataset.filter;
            const group = element.dataset.group;

            if (filter === 'all') {
                activeFilters.status.clear();
                activeFilters.status.add('all');
                document.querySelectorAll('.filter-chip[data-group="status"]').forEach(chip => {
                    chip.classList.remove('active');
                });
                element.classList.add('active');
            } else if (group === 'status') {
                activeFilters.status.delete('all');
                document.querySelector('.filter-chip[data-filter="all"]').classList.remove('active');

                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                    activeFilters.status.delete(filter);
                    if (activeFilters.status.size === 0) {
                        activeFilters.status.add('all');
                        document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
                    }
                } else {
                    element.classList.add('active');
                    activeFilters.status.add(filter);
                }
            } else if (group === 'type') {
                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                    activeFilters.type.delete(filter);
                } else {
                    element.classList.add('active');
                    activeFilters.type.add(filter);
                }
            }

            applyFilters();
            updateActiveFiltersIndicator();
        }

        function applyFilters() {
            let filtered = [...fullTableData];

            // Apply status filters (OR logic)
            if (!activeFilters.status.has('all') && activeFilters.status.size > 0) {
                filtered = filtered.filter(d => {
                    if (activeFilters.status.has('new') && !d.is_sent && !d.is_manual_sent) return true;
                    if (activeFilters.status.has('followup') && d.is_sent && !d.is_manual_sent) return true;
                    if (activeFilters.status.has('manual') && d.is_manual_sent) return true;
                    return false;
                });
            }

            // Apply type filters (OR logic, AND with status)
            if (activeFilters.type.size > 0) {
                filtered = filtered.filter(d => {
                    const candidateType = d.candidate_status || 'Independent';
                    if (activeFilters.type.has('sub') && candidateType === 'Agency Sub-Contractor') return true;
                    if (activeFilters.type.has('agency') && candidateType === 'Agency Contractor') return true;
                    if (activeFilters.type.has('direct') && (candidateType === 'Independent' || !d.candidate_status)) return true;
                    return false;
                });
            }

            tableData = filtered;
            populateTable(tableData);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
        }

        function updateActiveFiltersIndicator() {
            const totalActive = (activeFilters.status.has('all') ? 0 : activeFilters.status.size) + activeFilters.type.size;
            const indicator = document.getElementById('activeFiltersInfo');
            const countEl = document.getElementById('activeFilterCount');

            if (totalActive > 0) {
                indicator.classList.remove('hidden');
                indicator.classList.add('flex');
                countEl.textContent = totalActive;
            } else {
                indicator.classList.add('hidden');
                indicator.classList.remove('flex');
            }
        }

        function clearAllFilters() {
            activeFilters.status.clear();
            activeFilters.status.add('all');
            activeFilters.type.clear();

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');

            document.getElementById('tableSearch').value = '';
            applyFilters();
            updateActiveFiltersIndicator();
        }

        // ===== PASTE FILTER FUNCTIONS =====
        function togglePasteFilter() {
            const area = document.getElementById('pasteFilterArea');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                document.getElementById('pasteFilterInput').focus();
            } else {
                area.classList.add('hidden');
            }
        }

        function applyPasteFilter() {
            const rawInput = document.getElementById('pasteFilterInput').value;
            if (!rawInput || rawInput.trim() === '') {
                showToast("Please paste some Emails or IDs first.", "warning");
                return;
            }

            const filterList = rawInput.split(/[\n,]+/).map(item => item.trim().toLowerCase()).filter(item => item !== '');
            if (filterList.length === 0) return;

            const filtered = fullTableData.filter(d => {
                const idMatch = filterList.includes(d.developer_id.toString().toLowerCase());
                const emailMatch = filterList.includes(d.email.toLowerCase());
                return idMatch || emailMatch;
            });

            tableData = filtered;
            populateTable(filtered);
            updateCounts(filtered);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
            showToast(`Found ${filtered.length} matches out of ${fullTableData.length} records.`, "success");
            togglePasteFilter();
        }

        function clearPasteFilter() {
            document.getElementById('pasteFilterInput').value = '';
            tableData = [...fullTableData];
            populateTable(tableData);
            updateCounts(fullTableData);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
            applyFilters();
        }

        // ===== SEARCH FUNCTION =====
        function searchTable() {
            const searchValue = document.getElementById('tableSearch').value.toLowerCase();
            if (!searchValue) {
                applyFilters();
                return;
            }
            const filtered = tableData.filter(d => {
                return d.developer_id.toString().includes(searchValue) ||
                       d.full_name.toLowerCase().includes(searchValue) ||
                       d.email.toLowerCase().includes(searchValue) ||
                       (d.status && d.status.toLowerCase().includes(searchValue));
            });
            populateTable(filtered);
        }

        // ===== SELECTION FUNCTIONS =====
        function selectAllResults() {
            tableData.forEach(d => selectedDevs.add(d.developer_id));
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = true);
            updateSelectionUI();
        }

        function selectCurrentPage() {
            document.querySelectorAll('.row-checkbox:not(:checked)').forEach(cb => {
                cb.checked = true;
                selectedDevs.add(cb.value);
            });
            updateSelectionUI();
        }

        function deselectAll() {
            selectedDevs.clear();
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('masterCheckbox').checked = false;
            updateSelectionUI();
        }

        function toggleMasterCheckbox() {
            const master = document.getElementById('masterCheckbox');
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = master.checked;
                if (master.checked) {
                    selectedDevs.add(cb.value);
                } else {
                    selectedDevs.delete(cb.value);
                }
            });
            updateSelectionUI();
        }

        function toggleRowCheckbox(devId) {
            if (selectedDevs.has(devId)) {
                selectedDevs.delete(devId);
            } else {
                selectedDevs.add(devId);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedDevs.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('quickSelectedCount').textContent = count;
            document.getElementById('bulkSelectedCount').textContent = count;

            // Show/hide selection indicator
            const indicator = document.getElementById('selectionIndicator');
            if (count > 0) {
                indicator.classList.remove('hidden');
                indicator.classList.add('flex');
            } else {
                indicator.classList.add('hidden');
                indicator.classList.remove('flex');
            }

            // Show/hide bulk action bar
            const bulkBar = document.getElementById('bulkActionBar');
            if (count > 0) {
                bulkBar.classList.add('visible');
            } else {
                bulkBar.classList.remove('visible');
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function copyToClipboard() {
            if (selectedDevs.size === 0) {
                showToast("Please select at least one candidate", "warning");
                return;
            }
            const emails = tableData.filter(d => selectedDevs.has(d.developer_id)).map(d => d.email).join(', ');
            navigator.clipboard.writeText(emails).then(() => {
                showToast(`Copied ${selectedDevs.size} emails to clipboard`, "success");
            }).catch(err => {
                showToast("Failed to copy to clipboard", "error");
            });
        }

        function downloadCSV() {
            if (tableData.length === 0) {
                showToast("No data to export", "warning");
                return;
            }

            const dataToExport = selectedDevs.size > 0
                ? tableData.filter(d => selectedDevs.has(d.developer_id))
                : tableData;

            let csv = "Developer ID,Candidate Name,Email,Pipeline Status,Type,Agency Name,Outreach History\n";
            dataToExport.forEach(d => {
                let typeDisplay = 'Direct';
                if (d.candidate_status === 'Agency Sub-Contractor') typeDisplay = 'Sub-Contractor';
                else if (d.candidate_status === 'Agency Contractor') typeDisplay = 'Agency';

                let historyDisplay = 'New';
                if (d.is_sent) historyDisplay = `Sent (${d.sent_count || 1})`;
                else if (d.is_manual_sent) historyDisplay = `M.Sent (${d.manual_sent_count || 1})`;

                csv += `"${d.developer_id}","${d.full_name}","${d.email}","${d.status}","${typeDisplay}","${d.agency_name || ''}","${historyDisplay}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `developers_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${dataToExport.length} records`, "success");
        }

        function updateCounts(data) {
            const allCount = data.length;
            const newCount = data.filter(d => !d.is_sent && !d.is_manual_sent).length;
            const followupCount = data.filter(d => d.is_sent && !d.is_manual_sent).length;
            const manualCount = data.filter(d => d.is_manual_sent).length;
            const subCount = data.filter(d => d.candidate_status === 'Agency Sub-Contractor').length;
            const agencyCount = data.filter(d => d.candidate_status === 'Agency Contractor').length;
            const directCount = data.filter(d => d.candidate_status === 'Independent' || !d.candidate_status).length;

            document.getElementById('allCount').textContent = allCount;
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('followupCount').textContent = followupCount;
            document.getElementById('manualCount').textContent = manualCount;
            document.getElementById('subCount').textContent = subCount;
            document.getElementById('agencyCount').textContent = agencyCount;
            document.getElementById('directCount').textContent = directCount;
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
        }

        function populateTable(data) {
            const tbody = document.querySelector('#devTable tbody');
            tbody.innerHTML = '';

            data.forEach(d => {
                let rowClass = '';
                let sentBadge = '';

                if (d.is_manual_sent) {
                    rowClass = 'manual-sent-row';
                    sentBadge = `<span class="px-2 py-1 bg-amber-100 text-amber-800 text-xs rounded border border-amber-200" title="${d.manual_sent_note || 'Manually marked'}">
                        <i class="fa-solid fa-hand mr-1"></i>M.Sent${d.manual_sent_count > 1 ? ` (${d.manual_sent_count})` : ''}
                    </span>`;
                } else if (d.is_sent) {
                    rowClass = 'sent-row';
                    sentBadge = `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded border border-red-200">Sent (${d.sent_count || 1})</span>`;
                } else {
                    sentBadge = `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded border border-green-200">New</span>`;
                }

                let typeBadge = '';
                const candidateStatus = d.candidate_status || 'Independent';
                if (candidateStatus === 'Agency Sub-Contractor') {
                    typeBadge = `<span class="px-2 py-1 bg-orange-50 text-orange-700 text-xs rounded border border-orange-200" title="${d.agency_name || 'Sub-Contractor'}">
                        <i class="fa-solid fa-user-tie mr-1"></i>Sub-Con
                    </span>`;
                } else if (candidateStatus === 'Agency Contractor') {
                    typeBadge = `<span class="px-2 py-1 bg-purple-50 text-purple-700 text-xs rounded border border-purple-200" title="${d.agency_name || 'Agency'}">
                        <i class="fa-solid fa-building mr-1"></i>Agency
                    </span>`;
                } else {
                    typeBadge = `<span class="px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded border border-blue-200">
                        <i class="fa-solid fa-user mr-1"></i>Direct
                    </span>`;
                }

                const isChecked = selectedDevs.has(d.developer_id) ? 'checked' : '';

                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-50 dark:hover:bg-gray-700/50 ${rowClass}`;
                tr.innerHTML = `
                    <td class="px-4 py-3 text-center">
                        <input type="checkbox" class="row-checkbox w-4 h-4 cursor-pointer" value="${d.developer_id}" ${isChecked} onchange="toggleRowCheckbox('${d.developer_id}')">
                    </td>
                    <td class="px-4 py-3 font-mono text-xs">${d.developer_id}</td>
                    <td class="px-4 py-3 font-bold">${d.full_name}</td>
                    <td class="px-4 py-3 text-gray-500">${d.email}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-bold">${d.status}</span></td>
                    <td class="px-4 py-3">${typeBadge}</td>
                    <td class="px-4 py-3">${sentBadge}</td>
                `;
                tbody.appendChild(tr);
            });

            updateSelectionUI();
        }

        // ===== EMAIL TEMPLATES =====
        function refreshTemplates() {
            const jobId = document.getElementById('jobId').value || '';
            google.script.run
                .withSuccessHandler(function(templates) {
                    cachedTemplates = templates;
                    const select = document.getElementById('templateSelect');
                    select.innerHTML = '<option value="">-- Select a template --</option>';
                    templates.forEach((t, i) => {
                        const jobLabel = t.jobId ? ` (Job ${t.jobId})` : ' (Global)';
                        select.innerHTML += `<option value="${i}">${t.name}${jobLabel}</option>`;
                    });
                })
                .withFailureHandler(function(err) {
                    showToast("Failed to load templates", "error");
                })
                .getJobTemplates(jobId);
        }

        function loadSelectedTemplate() {
            const idx = document.getElementById('templateSelect').value;
            if(idx === '' || !cachedTemplates[idx]) return;

            const template = cachedTemplates[idx];
            document.getElementById('emailSubject').value = template.subject;
            document.getElementById('emailBody').value = template.body;
            showToast(`Loaded template: ${template.name}`, "success");
        }

        function saveCurrentAsTemplate() {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const jobId = document.getElementById('jobId').value || '';

            if(!subject && !body) {
                showToast("Please enter subject and/or body first", "warning");
                return;
            }

            const templateName = prompt("Enter a name for this template:", `Template ${new Date().toLocaleDateString()}`);
            if(!templateName) return;

            google.script.run
                .withSuccessHandler(function(result) {
                    if(result.success) {
                        showToast(result.isUpdate ? "Template updated!" : "Template saved!", "success");
                        refreshTemplates();
                    } else {
                        showToast("Failed to save: " + result.error, "error");
                    }
                })
                .withFailureHandler(function(err) {
                    showToast("Failed to save template: " + err.message, "error");
                })
                .saveEmailTemplate(templateName, subject, body, jobId);
        }

        // ===== MARK AS MANUALLY SENT =====
        function markSelectedAsManualSent() {
            if(selectedDevs.size === 0) {
                showToast("Please select at least one candidate", "warning");
                return;
            }

            const jobId = document.getElementById('jobId').value;
            if(!jobId) {
                showToast("Please enter a Job ID first", "warning");
                return;
            }

            const note = prompt("Add a note (optional):", "Sent manually outside this system");
            if(note === null) return; // Cancelled

            const devIds = Array.from(selectedDevs);

            google.script.run
                .withSuccessHandler(function(result) {
                    if(result.success) {
                        showToast(`Marked ${result.marked} candidates as manually sent`, "success");
                        // Refresh the table to show updated status
                        fetchData();
                    } else {
                        showToast("Error: " + result.error, "error");
                    }
                })
                .withFailureHandler(function(err) {
                    showToast("Error: " + err.message, "error");
                })
                .markAsManualSent(devIds, jobId, note);
        }

        // ===== FOLLOW-UP FUNCTIONS =====
        function loadFollowUpStats() {
            // Use combined function for faster loading (single API call instead of two)
            const filters = {
                jobId: document.getElementById('followUpJobFilter')?.value || 'all',
                status: document.getElementById('followUpStatusFilter')?.value || 'all'
            };

            const tbody = document.getElementById('followUpTableBody');
            const emptyState = document.getElementById('emptyFollowUpState');
            const tableContainer = tbody?.closest('.overflow-hidden');

            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';
            }
            if (emptyState) emptyState.classList.add('hidden');
            if (tableContainer) tableContainer.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(function(result) {
                    // Update stats
                    if (result.stats) {
                        document.getElementById('statPending').textContent = result.stats.pending || 0;
                        document.getElementById('statFollowUp1').textContent = result.stats.followUp1Done || 0;
                        document.getElementById('statFollowUp2').textContent = result.stats.followUp2Done || 0;
                        document.getElementById('statResponded').textContent = result.stats.responded || 0;
                    }
                    // Update table data
                    followUpData = result.data || [];
                    followUpJobIds = result.jobIds || [];
                    updateFollowUpJobFilter(followUpJobIds);
                    renderFollowUpTable(followUpData);
                })
                .withFailureHandler(function(err) {
                    console.error("Failed to load follow-up data:", err);
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500">Error loading data: ' + err.message + '</td></tr>';
                    }
                    showToast("Error loading follow-up data", "error");
                })
                .getFollowUpDataCombined(filters);
        }

        function manualTriggerFollowUps() {
            const btn = document.getElementById('runFollowUpBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>Processing...</span>';
            btn.disabled = true;

            const progressPanel = document.getElementById('followUpProgressPanel');
            const logContainer = document.getElementById('followUpLogContainer');
            const progressStatus = document.getElementById('followUpProgressStatus');

            progressPanel.classList.remove('hidden');
            logContainer.innerHTML = '';
            progressStatus.textContent = 'Starting...';

            google.script.run
                .withSuccessHandler(function(result) {
                    btn.innerHTML = '<i class="fa-solid fa-clock"></i> <span>Process Follow-Ups Now</span>';
                    btn.disabled = false;

                    progressStatus.textContent = `Done! ${result.followUp1Sent} first, ${result.followUp2Sent} second follow-ups sent`;

                    // Display logs
                    if(result.log && result.log.length > 0) {
                        result.log.forEach(function(logEntry) {
                            addFollowUpLog(logEntry.message, logEntry.type);
                        });
                    }

                    showToast(`Follow-ups processed! Sent: ${result.followUp1Sent + result.followUp2Sent}`, "success");
                    loadFollowUpStats();
                })
                .withFailureHandler(function(err) {
                    btn.innerHTML = '<i class="fa-solid fa-clock"></i> <span>Process Follow-Ups Now</span>';
                    btn.disabled = false;
                    progressStatus.textContent = 'Error occurred';
                    addFollowUpLog("Error: " + err.message, "error");
                    showToast("Error processing follow-ups: " + err.message, "error");
                })
                .runFollowUpProcessor();
        }

        function addFollowUpLog(message, type) {
            const container = document.getElementById('followUpLogContainer');
            const icons = { info: 'circle-info', success: 'check', warning: 'triangle-exclamation', error: 'circle-xmark' };
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type || 'info'}`;
            entry.innerHTML = `<i class="fa-solid fa-${icons[type] || 'circle-info'} mr-1"></i> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function resetFollowUpStatuses() {
            const btn = document.getElementById('resetStatusBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>Resetting...</span>';
            btn.disabled = true;

            const progressPanel = document.getElementById('followUpProgressPanel');
            const logContainer = document.getElementById('followUpLogContainer');
            const progressStatus = document.getElementById('followUpProgressStatus');

            progressPanel.classList.remove('hidden');
            logContainer.innerHTML = '';
            progressStatus.textContent = 'Re-verifying statuses...';

            google.script.run
                .withSuccessHandler(function(result) {
                    btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i> <span>Reset Status</span>';
                    btn.disabled = false;

                    progressStatus.textContent = `Done! ${result.reset} entries reset to Pending`;

                    // Display logs
                    if(result.log && result.log.length > 0) {
                        result.log.forEach(function(logEntry) {
                            const type = logEntry.includes('RESET') ? 'warning' : logEntry.includes('Verified') ? 'success' : 'info';
                            addFollowUpLog(logEntry, type);
                        });
                    }

                    if(result.reset > 0) {
                        showToast(`Reset ${result.reset} entries back to Pending`, "success");
                    } else {
                        showToast("All entries verified - no changes needed", "info");
                    }
                    loadFollowUpStats();
                })
                .withFailureHandler(function(err) {
                    btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i> <span>Reset Status</span>';
                    btn.disabled = false;
                    progressStatus.textContent = 'Error occurred';
                    addFollowUpLog("Error: " + err.message, "error");
                    showToast("Error resetting statuses: " + err.message, "error");
                })
                .resetFollowUpStatus();
        }

        // ===== OUTREACH TAB =====
        function toggleChip(el) { el.classList.toggle('active'); }
        
        function fetchData() {
            const jobId = document.getElementById('jobId').value;
            const stages = Array.from(document.querySelectorAll('.smart-chip.active')).map(e => e.dataset.value);
            if(!jobId || stages.length === 0) {
                showToast("Please enter Job ID and select at least one stage", "warning");
                return;
            }
            
            const btn = document.getElementById('fetchBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Fetching...';
            btn.disabled = true;
            
            document.getElementById('tableContainer').classList.remove('hidden');
            google.script.run
                .withSuccessHandler(data => { 
                    tableData = data; 
                    renderTable(data);
                    btn.innerHTML = '<i class="fa-solid fa-search"></i> <span>Fetch</span>';
                    btn.disabled = false;
                    showToast(`Found ${data.length} candidates`, "success");
                })
                .withFailureHandler(err => {
                    btn.innerHTML = '<i class="fa-solid fa-search"></i> <span>Fetch</span>';
                    btn.disabled = false;
                    showToast("Error: " + err.message, "error");
                })
                .getDevelopers(jobId, stages);
        }
        
        function openManualInput() { document.getElementById('manualInputModal').classList.remove('hidden'); }
        
        function loadManualData() {
            const raw = document.getElementById('manualDataInput').value;
            if(!raw.trim()) return;
            const lines = raw.split('\n');
            const manualData = lines.map((line) => {
                const parts = line.split(',');
                const email = parts[0];
                const name = parts[1];
                const region = parts[2];
                if(!email) return null;
                return {
                    developer_id: `TEST-${Math.floor(Math.random()*10000)}`,
                    full_name: name ? name.trim() : 'Test Candidate',
                    email: email.trim(),
                    region: region ? region.trim() : '',
                    status: 'Manual Test',
                    is_sent: false
                };
            }).filter(d => d !== null);
            tableData = manualData;
            document.getElementById('tableContainer').classList.remove('hidden');
            renderTable(tableData);
            document.getElementById('manualInputModal').classList.add('hidden');
            showToast(`Loaded ${manualData.length} test candidates`, "success");
        }
        
        function renderTable(data) {
            // Store data in both tableData and fullTableData
            tableData = data;
            fullTableData = data;

            // Show the table controls and container
            document.getElementById('statusFilterContainer').classList.remove('hidden');
            document.getElementById('tableControls').classList.remove('hidden');
            document.getElementById('tableContainer').classList.remove('hidden');

            // Reset filters
            activeFilters.status.clear();
            activeFilters.status.add('all');
            activeFilters.type.clear();
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
            updateActiveFiltersIndicator();

            // Clear selections
            selectedDevs.clear();
            document.getElementById('masterCheckbox').checked = false;
            document.getElementById('tableSearch').value = '';
            document.getElementById('pasteFilterInput').value = '';

            // Update counts and populate table
            updateCounts(data);
            populateTable(data);
        }

        // Legacy function for backwards compatibility
        function toggleDev(id) {
            toggleRowCheckbox(id);
        }

        // Legacy function for backwards compatibility
        function toggleAllRows(master) {
            document.getElementById('masterCheckbox').checked = master.checked;
            toggleMasterCheckbox();
        }
        
        // ===== EMAIL PANEL (IMPROVED) =====
        function openEmailPanel() {
            if(selectedDevs.size === 0) {
                showToast("Please select at least one candidate", "warning");
                return;
            }

            // Update recipient preview
            document.getElementById('emailRecipientCount').textContent = selectedDevs.size;
            const recipients = tableData.filter(d => selectedDevs.has(d.developer_id));
            const preview = recipients.slice(0, 5).map(r => r.email).join(', ');
            document.getElementById('emailRecipientPreview').textContent =
                recipients.length > 5 ? preview + ` +${recipients.length - 5} more` : preview;

            // Load templates for this job
            refreshTemplates();

            document.getElementById('emailPanelOverlay').classList.add('open');
            document.getElementById('emailPanel').classList.add('open');
        }
        
        function closeEmailPanel() {
            document.getElementById('emailPanelOverlay').classList.remove('open');
            document.getElementById('emailPanel').classList.remove('open');
        }
        
        function sendEmails() {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const recipients = tableData.filter(d => selectedDevs.has(d.developer_id)).map(d => ({
                name: d.full_name,
                email: d.email,
                devId: d.developer_id,
                region: d.region || ''
            }));
            const jobId = document.getElementById('jobId').value;
            
            if(!recipients.length) {
                showToast("No recipients selected", "warning");
                return;
            }
            if(!jobId) {
                showToast("Please enter a Job ID in the main form", "warning");
                return;
            }
            if(!subject || !body) {
                showToast("Please enter subject and body", "warning");
                return;
            }
            
            // Show progress
            const btn = document.getElementById('sendEmailBtn');
            const progressContainer = document.getElementById('sendProgressContainer');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;
            btn.classList.add('sending-indicator');
            
            progressContainer.classList.remove('hidden');
            document.getElementById('sendProgressText').textContent = 'Sending emails...';
            document.getElementById('sendProgressCount').textContent = `0/${recipients.length}`;
            document.getElementById('sendProgressBar').style.width = '0%';
            
            // Animate progress bar (simulated since we don't have real-time updates)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if(progress > 90) progress = 90;
                document.getElementById('sendProgressBar').style.width = progress + '%';
            }, 300);
            
            google.script.run
                .withSuccessHandler(result => {
                    clearInterval(progressInterval);
                    document.getElementById('sendProgressBar').style.width = '100%';
                    
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> <span>Send Emails</span>';
                        btn.disabled = false;
                        btn.classList.remove('sending-indicator');
                        progressContainer.classList.add('hidden');
                        
                        if(result.sent > 0) {
                            showToast(`Successfully sent ${result.sent} emails!`, "success");
                            if(result.skipped > 0) {
                                showToast(`${result.skipped} already in system (skipped)`, "info");
                            }
                            closeEmailPanel();
                            // Refresh table to show sent status
                            fetchData();
                        } else if(result.skipped > 0) {
                            showToast(`All ${result.skipped} candidates already in system`, "warning");
                        } else {
                            showToast("No emails sent", "warning");
                        }
                        
                        if(result.errors && result.errors.length > 0) {
                            showToast(`${result.errors.length} failed`, "error");
                        }
                    }, 500);
                })
                .withFailureHandler(err => {
                    clearInterval(progressInterval);
                    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> <span>Send Emails</span>';
                    btn.disabled = false;
                    btn.classList.remove('sending-indicator');
                    progressContainer.classList.add('hidden');
                    showToast("Error: " + err.message, "error");
                })
                .sendBulkEmails(recipients, "", subject, body, jobId, {});
        }

        // ===== NEGOTIATION TAB (UPDATED - No Walk-away) =====
        function loadNegotiationConfig() {
            const jobId = document.getElementById('negJobId').value;
            if(!jobId) return;
            google.script.run.withSuccessHandler(config => {
                if(config) {
                    document.getElementById('targetRate').value = config.targetRate || '';
                    document.getElementById('maxRate').value = config.maxRate || '';
                    document.getElementById('negStyle').value = config.style || 'Friendly but firm';
                    document.getElementById('specialRules').value = config.specialRules || '';
                    document.getElementById('jobDescription').value = config.jobDescription || '';
                } else {
                    document.getElementById('targetRate').value = '';
                    document.getElementById('maxRate').value = '';
                    document.getElementById('negStyle').value = 'Friendly but firm';
                    document.getElementById('specialRules').value = '';
                    document.getElementById('jobDescription').value = '';
                }
                // Also load rate tiers for this job
                refreshRateTiers();
            }).getNegotiationConfig(jobId);
        }
        
        function refreshJobDropdown() { 
            google.script.run.withSuccessHandler(jobs => { 
                const select = document.getElementById('activeJobsDropdown'); 
                select.innerHTML = '<option value="">-- Select or Enter New --</option>'; 
                jobs.forEach(j => { 
                    const opt = document.createElement('option'); 
                    opt.value = j; 
                    opt.text = "Job " + j; 
                    select.appendChild(opt); 
                }); 
            }).getJobConfigList(); 
        }
        
        function selectJobFromDropdown(val) { 
            if(!val) return; 
            document.getElementById('negJobId').value = val; 
            loadNegotiationConfig(); 
        }
        
        function saveNegotiationSettings() {
            const jobId = document.getElementById('negJobId').value;
            if(!jobId) {
                showToast("Please enter a Job ID", "warning");
                return;
            }
            // UPDATED: Removed walkAwayRate
            const config = {
                targetRate: document.getElementById('targetRate').value,
                maxRate: document.getElementById('maxRate').value,
                style: document.getElementById('negStyle').value,
                specialRules: document.getElementById('specialRules').value,
                jobDescription: document.getElementById('jobDescription').value
            };
            google.script.run
                .withSuccessHandler(() => {
                    showToast("Configuration saved!", "success");
                    refreshJobDropdown();
                })
                .withFailureHandler(err => showToast("Error: " + err.message, "error"))
                .saveNegotiationConfig(jobId, config);
        }

        // ===== RATE TIERS MANAGEMENT =====
        function refreshRateTiers() {
            const jobId = document.getElementById('negJobId').value;
            const tbody = document.getElementById('rateTiersBody');

            if(!jobId) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">Enter a Job ID above to view rate tiers</td></tr>';
                return;
            }

            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';

            google.script.run
                .withSuccessHandler(tiers => {
                    if(!tiers || tiers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">No rate tiers configured for this job. Add one above.</td></tr>';
                        return;
                    }
                    renderRateTiers(tiers);
                })
                .withFailureHandler(err => {
                    tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-red-500">Error: ${err.message}</td></tr>`;
                })
                .getRateTiersForJob(jobId);
        }

        function renderRateTiers(tiers) {
            const tbody = document.getElementById('rateTiersBody');
            tbody.innerHTML = '';

            tiers.forEach(tier => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50';
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-sm font-medium">${tier.region}</span>
                    </td>
                    <td class="px-4 py-3 font-mono text-green-600 dark:text-green-400">$${tier.targetRate}/hr</td>
                    <td class="px-4 py-3 font-mono text-amber-600 dark:text-amber-400">$${tier.maxRate}/hr</td>
                    <td class="px-4 py-3 text-gray-500 text-sm">${tier.notes || '-'}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editRateTier('${tier.region}', ${tier.targetRate}, ${tier.maxRate}, '${tier.notes || ''}')" class="text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 px-2 py-1 rounded mr-1">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button onclick="deleteRateTier('${tier.region}')" class="text-xs bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40 text-red-600 px-2 py-1 rounded">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function addRateTier() {
            const jobId = document.getElementById('negJobId').value;
            const region = document.getElementById('tierRegion').value.trim();
            const targetRate = parseFloat(document.getElementById('tierTargetRate').value);
            const maxRate = parseFloat(document.getElementById('tierMaxRate').value);
            const notes = document.getElementById('tierNotes').value.trim();

            if(!jobId) {
                showToast("Please enter a Job ID first", "warning");
                return;
            }
            if(!region) {
                showToast("Please enter a region/country", "warning");
                return;
            }
            if(isNaN(targetRate) || isNaN(maxRate)) {
                showToast("Please enter valid rates", "warning");
                return;
            }

            google.script.run
                .withSuccessHandler(result => {
                    if(result.success) {
                        showToast(result.isUpdate ? "Rate tier updated!" : "Rate tier added!", "success");
                        // Clear form
                        document.getElementById('tierRegion').value = '';
                        document.getElementById('tierTargetRate').value = '';
                        document.getElementById('tierMaxRate').value = '';
                        document.getElementById('tierNotes').value = '';
                        refreshRateTiers();
                    } else {
                        showToast("Error: " + result.message, "error");
                    }
                })
                .withFailureHandler(err => showToast("Error: " + err.message, "error"))
                .saveRateTier(jobId, region, targetRate, maxRate, notes);
        }

        function editRateTier(region, targetRate, maxRate, notes) {
            document.getElementById('tierRegion').value = region;
            document.getElementById('tierTargetRate').value = targetRate;
            document.getElementById('tierMaxRate').value = maxRate;
            document.getElementById('tierNotes').value = notes;
            document.getElementById('tierRegion').focus();
            showToast("Edit the values and click Add to update", "info");
        }

        function deleteRateTier(region) {
            const jobId = document.getElementById('negJobId').value;
            if(!confirm(`Delete rate tier for "${region}"?`)) return;

            google.script.run
                .withSuccessHandler(result => {
                    if(result.success) {
                        showToast("Rate tier deleted", "success");
                        refreshRateTiers();
                    } else {
                        showToast("Error: " + result.message, "error");
                    }
                })
                .withFailureHandler(err => showToast("Error: " + err.message, "error"))
                .deleteRateTier(jobId, region);
        }
        
        // ===== AI TRIGGER WITH PROGRESS =====
        function manualTriggerAI() {
            if(!confirm("Start AI negotiation sweep? This will process all configured jobs.")) return;
            
            const btn = document.getElementById('runAiBtn');
            const progressPanel = document.getElementById('aiProgressPanel');
            const logContainer = document.getElementById('aiLogContainer');
            const statusEl = document.getElementById('aiProgressStatus');
            
            progressPanel.classList.remove('hidden');
            logContainer.innerHTML = '';
            addLog('info', 'Starting AI Negotiator...');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Running...';
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            
            google.script.run
                .withSuccessHandler(res => {
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <span>Run AI Now</span>';
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    if(res.status === 'Success') {
                        statusEl.textContent = 'Completed!';
                        
                        if(res.log && res.log.length > 0) {
                            res.log.forEach(l => addLog(l.type, l.message));
                        }
                        
                        // Build summary message
                        let summary = ` Complete! Replied: ${res.stats.replied}, Escalated: ${res.stats.escalated}, Accepted: ${res.stats.accepted}, Skipped: ${res.stats.skipped}`;
                        if(res.stats.synced > 0) {
                            summary += `, Gmail Synced: ${res.stats.synced}`;
                        }
                        if(res.stats.cleaned > 0) {
                            summary += `, Labels Cleaned: ${res.stats.cleaned}`;
                        }
                        addLog('success', summary);
                        
                        showToast(`AI completed: ${res.stats.replied} replied, ${res.stats.accepted} accepted`, "success");
                        if(res.stats.synced > 0) {
                            showToast(`Synced ${res.stats.synced} from Gmail`, "info");
                        }
                        loadTasks();
                    } else {
                        statusEl.textContent = 'Error';
                        addLog('error', 'Error: ' + res.message);
                        showToast("AI Error: " + res.message, "error");
                    }
                })
                .withFailureHandler(err => {
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <span>Run AI Now</span>';
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    statusEl.textContent = 'Failed';
                    addLog('error', 'Failed: ' + err.message);
                    showToast("Failed: " + err.message, "error");
                })
                .runAutoNegotiator();
        }
        
        function addLog(type, message) {
            const container = document.getElementById('aiLogContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const icon = type === 'success' ? 'check-circle' : 
                         type === 'warning' ? 'triangle-exclamation' : 
                         type === 'error' ? 'circle-xmark' : 'circle-info';
            
            entry.innerHTML = `<i class="fa-solid fa-${icon} mr-1"></i> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // ===== TASKS TAB (IMPROVED) =====
        function loadTasks(forceRefresh = true) {
            const tbody = document.getElementById('taskListBody');
            const emptyState = document.getElementById('emptyTaskState');

            tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-gray-400"></i><p class="mt-2 text-gray-500">Loading tasks...</p></td></tr>';
            emptyState.classList.add('hidden');
            selectedTasks.clear();
            updateBulkActionsBar();

            // Load tasks with current filters - stats are now included in the response
            // forceRefresh invalidates server-side cache for fresh data
            const filters = {
                jobId: document.getElementById('taskJobFilter').value,
                status: document.getElementById('taskStatusFilter').value,
                forceRefresh: forceRefresh
            };

            google.script.run.withSuccessHandler(result => {
                // Update stats from combined response
                if(result.stats) {
                    document.getElementById('statTotal').textContent = result.stats.total;
                    document.getElementById('statActive').textContent = result.stats.active;
                    document.getElementById('statHuman').textContent = result.stats.human;
                    document.getElementById('statAccepted').textContent = result.stats.accepted;
                }
                allTasks = result.tasks;
                cachedJobIds = result.jobIds;
                updateJobFilter(cachedJobIds);
                renderTasks(result.tasks);
            }).withFailureHandler(err => {
                tbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-500">Error loading tasks: ${err.message}</td></tr>`;
                showToast("Error loading tasks", "error");
            }).getAllTasks(filters);
        }

        function filterTasks() {
            // Server-side filtering
            loadTasks();
        }

        function updateJobFilter(jobIds) {
            const filter = document.getElementById('taskJobFilter');
            const currentVal = filter.value;
            
            filter.innerHTML = '<option value="all">All Jobs</option>';
            jobIds.forEach(j => {
                const opt = document.createElement('option');
                opt.value = j;
                opt.text = "Job " + j;
                if(String(j) === currentVal) opt.selected = true;
                filter.appendChild(opt);
            });
        }

        function renderTasks(tasks) {
            const tbody = document.getElementById('taskListBody');
            const emptyState = document.getElementById('emptyTaskState');
            
            tbody.innerHTML = '';
            
            if(!tasks || tasks.length === 0) {
                tbody.parentElement.parentElement.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            tbody.parentElement.parentElement.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            tasks.forEach(t => {
                let badgeClass = 'badge-initial';
                if(t.tags.includes('Human')) badgeClass = 'badge-human';
                else if(t.status === 'Offer Accepted') badgeClass = 'badge-completed';
                else if(t.tags.includes('AI-Attempt-2')) badgeClass = 'badge-ai-2';
                else if(t.tags.includes('AI-Attempt-1')) badgeClass = 'badge-ai-1';
                else if(t.tags.includes('Initial')) badgeClass = 'badge-initial';

                const row = document.createElement('tr');
                row.className = 'task-row hover:bg-gray-50 dark:hover:bg-gray-700/50 transition';
                row.dataset.email = t.email;
                
                const hasNotes = t.aiNotes && t.aiNotes.length > 0;
                
                row.innerHTML = `
                    <td class="px-3 py-3 text-center">
                        <input type="checkbox" class="task-check" onchange="toggleTaskSelection('${t.email}')" ${selectedTasks.has(t.email) ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-3 font-mono text-sm text-gray-600 dark:text-gray-400">${t.jobId}</td>
                    <td class="px-4 py-3 font-semibold text-gray-900 dark:text-white">${t.name || 'Unknown'}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-300 text-sm">${t.email}</td>
                    <td class="px-4 py-3">
                        <span class="px-2.5 py-1 rounded-md text-xs font-bold ${badgeClass}">
                            ${t.tags}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        ${hasNotes ? `
                            <button onclick="showNotes(\`${encodeURIComponent(t.aiNotes)}\`)" class="text-xs text-left text-gray-600 dark:text-gray-300 hover:text-blue-600 flex items-center gap-1 max-w-[200px] group">
                                <i class="fa-solid fa-comment-dots text-blue-500 flex-shrink-0"></i>
                                <span class="truncate">${t.aiNotes.substring(0, 40)}${t.aiNotes.length > 40 ? '...' : ''}</span>
                                <i class="fa-solid fa-expand text-gray-400 group-hover:text-blue-500 flex-shrink-0 ml-1"></i>
                            </button>
                        ` : '<span class="text-xs text-gray-400">-</span>'}
                    </td>
                    <td class="px-4 py-3 text-xs text-gray-500">${t.lastReply || 'N/A'}</td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex gap-1 justify-end">
                            ${t.threadId ? `
                                <a href="https://mail.google.com/mail/u/0/#inbox/${t.threadId}" target="_blank" class="tooltip text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 px-2.5 py-1.5 rounded-lg" data-tooltip="View in Gmail">
                                    <i class="fa-solid fa-envelope-open"></i>
                                </a>
                            ` : ''}
                            <button onclick="markAsDone('${t.email}', '${t.jobId}', '${t.tags}', this)" class="text-xs bg-white border border-gray-300 hover:bg-green-50 hover:border-green-300 dark:bg-gray-700 dark:border-gray-600 dark:hover:bg-green-900/20 text-gray-700 dark:text-gray-200 px-2.5 py-1.5 rounded-lg font-bold transition">
                                <i class="fa-solid fa-check text-green-500"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showNotes(encodedNotes) {
            try {
                const notes = decodeURIComponent(encodedNotes);
                document.getElementById('notesModalContent').innerText = notes;
                document.getElementById('notesModal').classList.remove('hidden');
            } catch(e) {
                console.error("Error showing notes:", e);
                document.getElementById('notesModalContent').innerText = "Could not load notes";
                document.getElementById('notesModal').classList.remove('hidden');
            }
        }

        function toggleTaskSelection(email) {
            if(selectedTasks.has(email)) {
                selectedTasks.delete(email);
            } else {
                selectedTasks.add(email);
            }
            updateBulkActionsBar();
            
            // Update row highlight
            document.querySelectorAll('.task-row').forEach(row => {
                if(row.dataset.email === email) {
                    row.classList.toggle('selected', selectedTasks.has(email));
                }
            });
        }
        
        function toggleAllTasks(master) {
            const checks = document.querySelectorAll('.task-check');
            checks.forEach(c => {
                c.checked = master.checked;
                const row = c.closest('.task-row');
                if(row) {
                    const email = row.dataset.email;
                    if(master.checked) {
                        selectedTasks.add(email);
                        row.classList.add('selected');
                    } else {
                        selectedTasks.delete(email);
                        row.classList.remove('selected');
                    }
                }
            });
            updateBulkActionsBar();
        }
        
        function clearTaskSelection() {
            selectedTasks.clear();
            document.querySelectorAll('.task-check').forEach(c => c.checked = false);
            document.querySelectorAll('.task-row').forEach(r => r.classList.remove('selected'));
            document.querySelector('.task-master-check').checked = false;
            updateBulkActionsBar();
        }
        
        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = document.getElementById('bulkSelectedCount');
            
            if(selectedTasks.size > 0) {
                bar.classList.remove('hidden');
                count.textContent = selectedTasks.size;
            } else {
                bar.classList.add('hidden');
            }
        }
        
        function bulkCompleteSelected() {
            if(selectedTasks.size === 0) return;
            
            if(!confirm(`Complete ${selectedTasks.size} selected tasks?`)) return;
            
            const emails = Array.from(selectedTasks);
            
            showToast(`Completing ${emails.length} tasks...`, "info");
            
            google.script.run
                .withSuccessHandler(result => {
                    showToast(`Completed ${result.success} tasks`, "success");
                    if(result.failed > 0) {
                        showToast(`${result.failed} failed`, "warning");
                    }
                    loadTasks();
                })
                .withFailureHandler(err => {
                    showToast("Error: " + err.message, "error");
                })
                .bulkComplete(emails, "Bulk Completed");
        }

        // Store pending completion data for the modal
        let pendingCompletion = { email: '', jobId: '', btn: null };

        function markAsDone(email, jobId, status, btn) {
            // Check if this is a human-escalated negotiation
            const isHumanNegotiation = status && (
                status.includes('Human') ||
                status.includes('Escalated') ||
                status.includes('Human-Negotiation')
            );

            if (isHumanNegotiation) {
                // Show the rate input modal for human negotiations
                pendingCompletion = { email, jobId, btn };
                openCompleteHumanModal(email);
                return;
            }

            // For non-human negotiations, complete directly
            completeTaskDirectly(email, jobId, btn, "Manually Completed");
        }

        function completeTaskDirectly(email, jobId, btn, status, agreedRate = null) {
            const row = btn.closest('.task-row');
            row.classList.add('processing');

            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            // Use completeHumanNegotiation if we have a rate, otherwise use moveToCompleted
            if (agreedRate || status !== "Manually Completed") {
                google.script.run
                    .withSuccessHandler(result => {
                        if(result.success) {
                            showToast("Task completed!" + (agreedRate ? ` Rate: $${agreedRate}/hr` : ""), "success");
                            loadTasks();
                        } else {
                            showToast("Error: " + result.message, "error");
                            row.classList.remove('processing');
                            btn.innerHTML = originalHtml;
                            btn.disabled = false;
                        }
                    })
                    .withFailureHandler(err => {
                        showToast("Error: " + err.message, "error");
                        row.classList.remove('processing');
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                    })
                    .completeHumanNegotiation(email, jobId, agreedRate, status);
            } else {
                google.script.run
                    .withSuccessHandler(result => {
                        if(result.success) {
                            showToast("Task completed!", "success");
                            loadTasks();
                        } else {
                            showToast("Error: " + result.message, "error");
                            row.classList.remove('processing');
                            btn.innerHTML = originalHtml;
                            btn.disabled = false;
                        }
                    })
                    .withFailureHandler(err => {
                        showToast("Error: " + err.message, "error");
                        row.classList.remove('processing');
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                    })
                    .moveToCompleted(email, status);
            }
        }

        // Complete Human Negotiation Modal functions
        function openCompleteHumanModal(email) {
            document.getElementById('completeHumanEmail').textContent = email;
            document.getElementById('agreedRateInput').value = '';
            document.getElementById('noRateAgreed').checked = false;
            document.getElementById('completionStatus').value = '';
            document.getElementById('agreedRateInput').disabled = false;
            document.getElementById('completeHumanModal').classList.remove('hidden');
            document.getElementById('agreedRateInput').focus();
        }

        function closeCompleteHumanModal() {
            document.getElementById('completeHumanModal').classList.add('hidden');
            pendingCompletion = { email: '', jobId: '', btn: null };
        }

        function toggleRateInput() {
            const noRate = document.getElementById('noRateAgreed').checked;
            const rateInput = document.getElementById('agreedRateInput');
            rateInput.disabled = noRate;
            if (noRate) {
                rateInput.value = '';
            }
        }

        function submitCompleteHuman() {
            const { email, jobId, btn } = pendingCompletion;
            if (!email || !btn) {
                showToast("Error: Missing completion data", "error");
                closeCompleteHumanModal();
                return;
            }

            const noRateAgreed = document.getElementById('noRateAgreed').checked;
            const agreedRate = noRateAgreed ? null : document.getElementById('agreedRateInput').value;
            const completionStatus = document.getElementById('completionStatus').value;

            // Validate rate if not "no rate agreed"
            if (!noRateAgreed && !agreedRate) {
                showToast("Please enter the agreed rate or check 'No rate agreed'", "warning");
                return;
            }

            // Determine the final status
            let finalStatus = completionStatus || (agreedRate ? 'Offer Accepted (Human)' : 'Completed (Human)');

            closeCompleteHumanModal();
            completeTaskDirectly(email, jobId, btn, finalStatus, agreedRate);
        }

        // ===== CONFIG & UTILS =====
        function openConfigModal() {
            document.getElementById('configModal').classList.remove('hidden');
            // Load trigger status when modal opens
            refreshTriggerStatus();
        }

        // ===== TRIGGER MANAGEMENT =====
        function refreshTriggerStatus() {
            const container = document.getElementById('triggerStatusContainer');
            const createSection = document.getElementById('createTriggersSection');
            const allGoodSection = document.getElementById('allTriggersGood');
            const refreshIcon = document.getElementById('triggerRefreshIcon');

            // Show loading
            container.innerHTML = `
                <div class="flex items-center justify-center py-4 text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin mr-2"></i> Loading trigger status...
                </div>
            `;
            refreshIcon.classList.add('fa-spin');
            createSection.classList.add('hidden');
            allGoodSection.classList.add('hidden');

            google.script.run
                .withSuccessHandler(result => {
                    refreshIcon.classList.remove('fa-spin');
                    if (!result.success) {
                        container.innerHTML = `
                            <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-sm">
                                <i class="fa-solid fa-exclamation-circle mr-1"></i> ${result.error || 'Failed to load trigger status'}
                            </div>
                        `;
                        return;
                    }

                    renderTriggerStatus(result.status);
                })
                .withFailureHandler(err => {
                    refreshIcon.classList.remove('fa-spin');
                    container.innerHTML = `
                        <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-sm">
                            <i class="fa-solid fa-exclamation-circle mr-1"></i> Error: ${err.message}
                        </div>
                    `;
                })
                .getTriggerStatus();
        }

        function renderTriggerStatus(status) {
            const container = document.getElementById('triggerStatusContainer');
            const createSection = document.getElementById('createTriggersSection');
            const allGoodSection = document.getElementById('allTriggersGood');

            let html = '';
            status.triggers.forEach(trigger => {
                const statusClass = trigger.exists
                    ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800'
                    : 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800';
                const iconClass = trigger.exists
                    ? 'fa-check-circle text-green-500'
                    : 'fa-exclamation-triangle text-yellow-500';
                const statusText = trigger.exists ? 'Active' : 'Missing';
                const statusBadgeClass = trigger.exists
                    ? 'bg-green-100 text-green-700 dark:bg-green-800 dark:text-green-300'
                    : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-800 dark:text-yellow-300';
                const typeIcon = trigger.type === 'hourly' ? 'fa-clock' : 'fa-calendar-day';

                html += `
                    <div class="p-3 rounded-lg border ${statusClass}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start gap-2">
                                <i class="fa-solid ${iconClass} mt-0.5"></i>
                                <div>
                                    <div class="text-sm font-medium text-gray-800 dark:text-gray-200">${trigger.functionName}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${trigger.description}</div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-xs text-gray-400"><i class="fa-solid ${typeIcon} mr-1"></i>${trigger.type === 'hourly' ? 'Every hour' : 'Daily at 8 AM'}</span>
                                    </div>
                                </div>
                            </div>
                            <span class="text-xs px-2 py-0.5 rounded-full ${statusBadgeClass}">${statusText}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Show/hide create button based on missing triggers
            if (status.missingCount > 0) {
                createSection.classList.remove('hidden');
                allGoodSection.classList.add('hidden');
                document.getElementById('createTriggersText').textContent =
                    status.missingCount === 1
                        ? 'Create Missing Trigger'
                        : `Create ${status.missingCount} Missing Triggers`;
            } else {
                createSection.classList.add('hidden');
                allGoodSection.classList.remove('hidden');
            }
        }

        function createAllTriggers() {
            const btn = document.getElementById('createAllTriggersBtn');
            const btnText = document.getElementById('createTriggersText');
            const spinner = document.getElementById('createTriggersSpinner');

            btn.disabled = true;
            btnText.textContent = 'Creating...';
            spinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(result => {
                    btn.disabled = false;
                    btnText.textContent = 'Create Missing Triggers';
                    spinner.classList.add('hidden');

                    if (result.success) {
                        const r = result.results;
                        if (r.created.length > 0) {
                            showToast(`Created ${r.created.length} trigger(s)!`, 'success');
                        } else if (r.alreadyExisted.length > 0) {
                            showToast('All triggers already exist', 'info');
                        }
                        if (r.failed.length > 0) {
                            showToast(`Failed to create ${r.failed.length} trigger(s)`, 'error');
                        }
                        // Refresh the status
                        refreshTriggerStatus();
                    } else {
                        showToast(result.error || 'Failed to create triggers', 'error');
                    }
                })
                .withFailureHandler(err => {
                    btn.disabled = false;
                    btnText.textContent = 'Create Missing Triggers';
                    spinner.classList.add('hidden');
                    showToast('Error: ' + err.message, 'error');
                })
                .createAllMissingTriggers();
        }

        function saveConfig() {
            const databaseUrl = document.getElementById('sheetUrl').value;
            const jobsUrl = document.getElementById('jobsSheetUrl').value;

            if(!databaseUrl) {
                showToast("Please enter the Database Sheet URL", "warning");
                return;
            }
            if(!jobsUrl) {
                showToast("Please enter the Jobs Sheet URL", "warning");
                return;
            }

            // Show loading state
            const btn = document.getElementById('saveConfigBtn');
            const btnText = document.getElementById('saveConfigText');
            const spinner = document.getElementById('saveConfigSpinner');

            btn.disabled = true;
            btnText.textContent = 'Saving...';
            spinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(() => {
                    // Reset button state
                    btn.disabled = false;
                    btnText.textContent = 'Save';
                    spinner.classList.add('hidden');

                    showToast("Settings saved!", "success");
                    document.getElementById('configModal').classList.add('hidden');
                })
                .withFailureHandler(err => {
                    // Reset button state on error
                    btn.disabled = false;
                    btnText.textContent = 'Save';
                    spinner.classList.add('hidden');

                    showToast("Error: " + err.message, "error");
                })
                .saveSheetUrls(databaseUrl, jobsUrl);
        }
        
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        // ===== COLLAPSIBLE SECTIONS =====
        function toggleCollapse(contentId, headerEl) {
            const content = document.getElementById(contentId);
            const icon = headerEl.querySelector('.collapse-icon');

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                if (icon) icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                if (icon) icon.classList.add('collapsed');
            }
        }

        function closeProgressPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        // ===== FOLLOW-UP TABLE FUNCTIONS =====
        let followUpData = [];
        let followUpJobIds = [];

        function loadFollowUpData() {
            // Reuse the combined loading function for consistency
            loadFollowUpStats();
        }

        function updateFollowUpJobFilter(jobIds) {
            const filter = document.getElementById('followUpJobFilter');
            const currentVal = filter.value;

            filter.innerHTML = '<option value="all">All Jobs</option>';
            jobIds.forEach(function(j) {
                const opt = document.createElement('option');
                opt.value = j;
                opt.text = "Job " + j;
                if(String(j) === currentVal) opt.selected = true;
                filter.appendChild(opt);
            });
        }

        function renderFollowUpTable(data) {
            const tbody = document.getElementById('followUpTableBody');
            const emptyState = document.getElementById('emptyFollowUpState');
            const tableContainer = tbody.closest('.overflow-hidden');

            tbody.innerHTML = '';

            if(!data || data.length === 0) {
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            tableContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');

            data.forEach(function(item) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50 transition';
                row.dataset.email = item.email;

                // Determine status badge styling
                let statusBadge = '';
                const status = item.followUpStatus || 'Pending';
                if(status === 'Follow-Up-1-Sent') {
                    statusBadge = '<span class="px-2.5 py-1 rounded-md text-xs font-bold bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300">1st Follow-up Sent</span>';
                } else if(status === 'Follow-Up-2-Sent') {
                    statusBadge = '<span class="px-2.5 py-1 rounded-md text-xs font-bold bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300">2nd Follow-up Sent</span>';
                } else {
                    statusBadge = '<span class="px-2.5 py-1 rounded-md text-xs font-bold bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">Pending Response</span>';
                }

                // Format last reached out time
                let lastReachedOut = item.lastReachedOut || 'N/A';
                if(lastReachedOut !== 'N/A') {
                    try {
                        const date = new Date(lastReachedOut);
                        const now = new Date();
                        const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
                        if(diffHours < 24) {
                            lastReachedOut = diffHours + ' hours ago';
                        } else {
                            const diffDays = Math.floor(diffHours / 24);
                            lastReachedOut = diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
                        }
                    } catch(e) {
                        // Keep original value if parsing fails
                    }
                }

                row.innerHTML =
                    '<td class="px-4 py-3 font-mono text-sm text-gray-600 dark:text-gray-400">' + (item.jobId || '-') + '</td>' +
                    '<td class="px-4 py-3 font-semibold text-gray-900 dark:text-white">' + (item.name || 'Unknown') + '</td>' +
                    '<td class="px-4 py-3 text-gray-600 dark:text-gray-300 text-sm">' + (item.email || '-') + '</td>' +
                    '<td class="px-4 py-3">' + statusBadge + '</td>' +
                    '<td class="px-4 py-3 text-xs text-gray-500">' + lastReachedOut + '</td>' +
                    '<td class="px-4 py-3 text-right">' +
                        '<button onclick="markAsUnresponsive(\'' + item.email + '\', this)" class="text-xs bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 px-3 py-1.5 rounded-lg font-medium transition" title="Mark as unresponsive and remove from follow-up">' +
                            '<i class="fa-solid fa-user-slash mr-1"></i> Unresponsive' +
                        '</button>' +
                    '</td>';

                tbody.appendChild(row);
            });
        }

        function markAsUnresponsive(email, btn) {
            if(!confirm('Mark this developer as unresponsive? They will be removed from the follow-up queue.')) {
                return;
            }

            const row = btn.closest('tr');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;
            row.style.opacity = '0.5';

            google.script.run
                .withSuccessHandler(function(result) {
                    if(result.success) {
                        showToast("Marked as unresponsive and removed from follow-up", "success");
                        // Animate row removal
                        row.style.transition = 'all 0.3s';
                        row.style.transform = 'translateX(100%)';
                        row.style.opacity = '0';
                        setTimeout(function() {
                            loadFollowUpData();
                            loadFollowUpStats();
                        }, 300);
                    } else {
                        showToast("Error: " + (result.message || "Failed to update"), "error");
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        row.style.opacity = '1';
                    }
                })
                .withFailureHandler(function(err) {
                    showToast("Error: " + err.message, "error");
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    row.style.opacity = '1';
                })
                .markFollowUpAsUnresponsive(email);
        }

        // ===== INIT =====
        $(document).ready(() => {
            // Load Database Sheet URL
            google.script.run.withSuccessHandler(url => {
                document.getElementById('sheetUrl').value = url || '';
            }).getStoredSheetUrl();

            // Load Jobs Sheet URL
            google.script.run.withSuccessHandler(url => {
                document.getElementById('jobsSheetUrl').value = url || '';
            }).getStoredJobsSheetUrl();
        });
    </script>
</body>
</html>
