<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turing Outreach V12</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Sidebar Navigation Styles */
        .nav-tab { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            padding: 0.75rem 1rem; 
            margin-bottom: 0.5rem;
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #94a3b8; /* slate-400 */
            font-weight: 500;
            font-size: 0.875rem;
        }
        .nav-tab:hover { 
            background-color: #1e293b; /* slate-800 */
            color: white; 
        }
        .nav-tab.active { 
            background-color: #2563eb; /* blue-600 */
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1), 0 2px 4px -1px rgba(37, 99, 235, 0.06);
        }
        
        /* Modern Card Styles */
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border-top-width: 4px;
            transition: transform 0.2s;
        }
        .dark .stat-card { background: #1e293b; border-color: #334155; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }

        /* Input Fields */
        .input-field { 
            width: 100%; 
            padding: 0.625rem 0.875rem; 
            border-radius: 0.5rem; 
            border: 1px solid #e2e8f0; 
            background: white; 
            transition: all 0.2s; 
            font-size: 0.875rem;
        }
        .dark .input-field { background: #1e293b; border-color: #334155; color: white; }
        .input-field:focus { outline: none; border-color: #3b82f6; ring: 2px; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Chips */
        .smart-chip { 
            display: inline-flex; align-items: center; padding: 0.375rem 0.75rem; 
            border-radius: 9999px; font-size: 0.75rem; font-weight: 600; cursor: pointer; 
            transition: all 0.2s; border: 1px solid #e2e8f0; background: white; color: #64748b; 
        }
        .smart-chip.active { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .dark .smart-chip { background: #1f2937; border-color: #374151; color: #9ca3af; }
        .dark .smart-chip.active { background: rgba(37, 99, 235, 0.2); color: #60a5fa; border-color: #2563eb; }

        /* Utilities */
        .hidden-tab { display: none; }
        .hidden { display: none; }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .toast { padding: 14px 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; min-width: 300px; position: relative; color: white;}
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-info { background: #3b82f6; }
        .toast-warning { background: #f59e0b; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.hiding { opacity: 0; transition: opacity 0.3s; }

        /* Collapsible & Slide Panel */
        .collapsible-content { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }
        .collapsible-content.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; }
        .slide-panel { position: fixed; top: 0; right: -500px; width: 480px; height: 100vh; background: white; box-shadow: -10px 0 40px rgba(0,0,0,0.15); transition: right 0.3s ease; z-index: 100; display: flex; flex-direction: column; }
        .slide-panel.open { right: 0; }
        .dark .slide-panel { background: #1e293b; }
        .slide-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 99; backdrop-filter: blur(2px); }
        .slide-panel-overlay.open { opacity: 1; visibility: visible; }

        /* Table & Rows */
        .task-row.selected { background: #eff6ff !important; }
        .dark .task-row.selected { background: rgba(59, 130, 246, 0.1) !important; }
        tr.sent-row td { background-color: #fef2f2 !important; }
        .dark tr.sent-row td { background-color: #450a0a !important; }
        tr.manual-sent-row td { background-color: #fffbeb !important; } /* Lighter yellow */
        .dark tr.manual-sent-row td { background-color: #451a03 !important; }

        /* Filter Chips */
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .filter-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .filter-chip.all { background: #f1f5f9; color: #64748b; border-color: #e2e8f0; }
        .filter-chip.all:hover { background: #e2e8f0; border-color: #cbd5e1; }
        .filter-chip.all.active { background: #334155; color: white; border-color: #1e293b; box-shadow: 0 4px 6px -1px rgba(51,65,85,0.3); }
        .filter-chip.new { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .filter-chip.new:hover { background: #bbf7d0; border-color: #86efac; }
        .filter-chip.new.active { background: #16a34a; color: white; border-color: #15803d; box-shadow: 0 4px 6px -1px rgba(22,163,74,0.3); }
        .filter-chip.followup { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .filter-chip.followup:hover { background: #fecaca; border-color: #fca5a5; }
        .filter-chip.followup.active { background: #dc2626; color: white; border-color: #b91c1c; box-shadow: 0 4px 6px -1px rgba(220,38,38,0.3); }
        .filter-chip.manual { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .filter-chip.manual:hover { background: #fde68a; border-color: #fcd34d; }
        .filter-chip.manual.active { background: #d97706; color: white; border-color: #b45309; box-shadow: 0 4px 6px -1px rgba(217,119,6,0.3); }
        .filter-chip.sub { background: #fed7aa; color: #c2410c; border-color: #fdba74; }
        .filter-chip.sub:hover { background: #fdba74; border-color: #fb923c; }
        .filter-chip.sub.active { background: #ea580c; color: white; border-color: #c2410c; box-shadow: 0 4px 6px -1px rgba(234,88,12,0.3); }
        .filter-chip.agency { background: #f3e8ff; color: #7c3aed; border-color: #e9d5ff; }
        .filter-chip.agency:hover { background: #e9d5ff; border-color: #d8b4fe; }
        .filter-chip.agency.active { background: #7c3aed; color: white; border-color: #6d28d9; box-shadow: 0 4px 6px -1px rgba(124,58,237,0.3); }
        .filter-chip.direct { background: #e0e7ff; color: #4338ca; border-color: #c7d2fe; }
        .filter-chip.direct:hover { background: #c7d2fe; border-color: #a5b4fc; }
        .filter-chip.direct.active { background: #4f46e5; color: white; border-color: #4338ca; box-shadow: 0 4px 6px -1px rgba(79,70,229,0.3); }
        
        /* Log Entries */
        .log-entry { padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .log-info { background: #eff6ff; color: #1d4ed8; }
        .log-success { background: #dcfce7; color: #15803d; }
        .log-warning { background: #fef9c3; color: #a16207; }
        .log-error { background: #fee2e2; color: #b91c1c; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Email Draft Modal Styles */
        .email-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .email-modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .email-modal {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
        }
        .email-modal-overlay.open .email-modal {
            transform: scale(1) translateY(0);
        }
        .dark .email-modal {
            background: #1e293b;
        }

        /* Rich Text Editor Styles */
        .rich-text-editor {
            min-height: 300px;
            max-height: 400px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow-y: auto;
            background: white;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        .dark .rich-text-editor {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }
        .rich-text-editor:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        /* CSS Reset for rich text editor content */
        .rich-text-editor ul,
        .rich-text-editor ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .rich-text-editor ul {
            list-style-type: disc;
        }
        .rich-text-editor ol {
            list-style-type: decimal;
        }
        .rich-text-editor li {
            margin-bottom: 0.25rem;
        }
        .rich-text-editor p {
            margin-bottom: 0.5rem;
        }
        .rich-text-editor h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .rich-text-editor blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #64748b;
        }

        /* Formatting Toolbar Styles */
        .format-toolbar {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            background: #f8fafc;
        }
        .dark .format-toolbar {
            background: #1e293b;
            border-color: #334155;
        }
        .format-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background: white;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .dark .format-btn {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        .format-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .dark .format-btn:hover {
            background: #475569;
        }
        .format-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .format-divider {
            width: 1px;
            background: #e2e8f0;
            margin: 0 0.25rem;
        }
        .dark .format-divider {
            background: #475569;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: #3b82f6;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            left: 22px;
        }
        .dark .toggle-switch {
            background: #475569;
        }
        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            min-width: 100px;
        }
        .toggle-label.active {
            color: #3b82f6;
        }
        .dark .toggle-label {
            color: #94a3b8;
        }
        .dark .toggle-label.active {
            color: #60a5fa;
        }

        /* Job Type Toggles Container */
        .job-toggles-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .dark .job-toggles-container {
            background: #0f172a;
            border-color: #334155;
        }
        .job-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .job-toggle-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        .job-toggle-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #334155;
        }
        .dark .job-toggle-title {
            color: #e2e8f0;
        }
        .job-toggle-desc {
            font-size: 0.75rem;
            color: #64748b;
        }
        .dark .job-toggle-desc {
            color: #94a3b8;
        }

        /* Name Placeholder Badge */
        .name-placeholder {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .dark .name-placeholder {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        /* Toggle Tooltip Styles */
        .job-toggle-row {
            position: relative;
        }
        .toggle-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            right: 0;
            background: #1e293b;
            color: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transform: translateY(4px);
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 280px;
            white-space: normal;
            text-align: center;
            line-height: 1.4;
        }
        .toggle-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 16px;
            border: 6px solid transparent;
            border-top-color: #1e293b;
        }
        .job-toggle-row:hover .toggle-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            transition-delay: 1.5s;
        }
        .dark .toggle-tooltip {
            background: #334155;
            border: 1px solid #475569;
        }
        .dark .toggle-tooltip::after {
            border-top-color: #334155;
        }
        .toggle-tooltip .tooltip-on {
            color: #4ade80;
        }
        .toggle-tooltip .tooltip-off {
            color: #f87171;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 flex h-screen overflow-hidden">

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- SIDEBAR NAVIGATION -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col h-full flex-shrink-0 z-20 shadow-xl">
        <!-- Logo -->
        <div class="p-6 flex items-center gap-3 border-b border-slate-800">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/50">
                <i class="fa-solid fa-robot text-white text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm tracking-wide">TURING AI</h1>
                <p class="text-xs text-slate-400">Recruiter V12</p>
            </div>
        </div>

        <!-- Navigation Links -->
        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">Main Menu</div>
            
            <div class="nav-tab active" onclick="switchTab('outreach', this)">
                <i class="fa-solid fa-users-viewfinder w-5 text-center"></i>
                <span>Outreach Manager</span>
            </div>
            
            <div class="nav-tab" onclick="switchTab('negotiation', this)">
                <i class="fa-solid fa-hand-holding-dollar w-5 text-center"></i>
                <span>Negotiation AI</span>
            </div>
            
            <div class="nav-tab" onclick="switchTab('tasks', this)">
                <i class="fa-solid fa-clipboard-check w-5 text-center"></i>
                <span>Task List</span>
            </div>
            
            <div class="nav-tab" onclick="switchTab('followups', this)">
                <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i>
                <span>Follow-Ups</span>
            </div>
            
            <div class="nav-tab" onclick="switchTab('analytics', this)">
                <i class="fa-solid fa-chart-line w-5 text-center"></i>
                <span>Analytics</span>
            </div>
        </nav>

        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-slate-800 space-y-2">
            <div onclick="openConfigModal()" class="nav-tab hover:bg-slate-800 text-slate-400">
                <i class="fa-solid fa-cog w-5 text-center"></i>
                <span>Configuration</span>
            </div>
            
            <!-- User Profile Tiny -->
            <div class="flex items-center gap-3 px-2 py-3 mt-2 rounded-lg bg-slate-800/50 border border-slate-700">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold text-white">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="overflow-hidden">
                    <p class="text-xs font-medium text-white truncate" id="userEmailTextSidebar">Loading...</p>
                    <!-- Hidden elements required by original JS logic -->
                    <div id="userEmailText" class="hidden"></div>
                    <div id="userEmailDisplay" class="hidden"></div>
                    <p class="text-[10px] text-slate-400">Admin</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-100 dark:bg-slate-900 relative">
        
        <!-- Header -->
        <header class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center px-8 shadow-sm z-10 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="text-lg font-bold text-slate-800 dark:text-white" id="headerTitle">Dashboard</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                    <input type="text" id="globalSearchInput" placeholder="Global search..." oninput="handleGlobalSearch()" onkeydown="if(event.key==='Escape') clearGlobalSearch()" class="pl-9 pr-4 py-2 rounded-full border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="globalSearchResults" class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg max-h-80 overflow-y-auto z-50 hidden"></div>
                </div>

                <button id="notificationBtn" onclick="toggleNotifications()" class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-500 hover:text-blue-600 transition relative">
                    <i class="fa-regular fa-bell"></i>
                    <span id="notificationBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <div id="notificationPanel" class="absolute top-14 right-4 w-80 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg z-50 hidden">
                    <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <span class="font-semibold text-slate-800 dark:text-white text-sm">Notifications</span>
                        <button onclick="markAllNotificationsRead()" class="text-xs text-blue-600 hover:text-blue-700">Mark all read</button>
                    </div>
                    <div id="notificationList" class="max-h-64 overflow-y-auto">
                        <div class="p-4 text-center text-slate-500 text-sm">No new notifications</div>
                    </div>
                </div>
                
                <div class="h-6 w-px bg-slate-200 dark:bg-slate-700"></div>
                
                <button onclick="toggleDarkMode()" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline"></i>
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
            <div class="max-w-7xl mx-auto">

                <!-- TAB 1: OUTREACH MANAGER -->
                <div id="tab-outreach" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">Outreach Campaigns</h3>
                        <p class="text-sm text-slate-500">Fetch candidates by job ID and stage.</p>
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8">
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div class="lg:col-span-3">
                                <label class="block text-xs font-bold uppercase mb-2 text-slate-500">Job ID</label>
                                <div class="relative">
                                    <i class="fa-solid fa-hashtag absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                    <input type="number" id="jobId" class="input-field pl-8 font-mono text-blue-600 font-bold" placeholder="51000">
                                </div>
                            </div>
                            <div class="lg:col-span-7">
                                <label class="block text-xs font-bold uppercase mb-2 text-slate-500">Pipeline Stages</label>
                                <div class="flex flex-wrap gap-2">
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Interested">Interested</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Passed VetSmith">Passed VetSmith</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Pending Review">Pending Review</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Completed Testing">Completed Testing</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Developer Backout">Developer Backout</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="On Hold - Onboarding">On Hold - Onboarding</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Pending Onboarding">Pending Onboarding</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Ready for Selection">Ready for Selection</div>
                                    <div class="smart-chip" onclick="toggleChip(this)" data-value="Selected for Trial">Selected for Trial</div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="selectAllChips()" class="text-xs text-blue-600 hover:underline">Select All</button>
                                    <button onclick="clearAllChips()" class="text-xs text-slate-500 hover:underline">Clear</button>
                                </div>
                            </div>
                            <div class="lg:col-span-2 flex items-end gap-2">
                                <button id="fetchBtn" onclick="fetchData()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg shadow-md hover:shadow-lg transition flex items-center justify-center gap-2 text-sm">
                                    <i class="fa-solid fa-search"></i> <span>Fetch Data</span>
                                </button>
                                <button onclick="openManualInput()" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 py-2.5 px-3 rounded-lg transition" title="Manual Test Mode">
                                    <i class="fa-solid fa-vial"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Filter Section (Hidden until data loaded) -->
                    <div id="statusFilterContainer" class="hidden mb-6 bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs font-bold uppercase text-slate-500">Quick Filters</span>
                            <span id="selectAllCount" class="text-xs text-blue-600 font-medium bg-blue-50 px-2 py-1 rounded hidden">(0) selected</span>
                        </div>
                        <div id="statusButtons" class="flex flex-wrap gap-2.5">
                            <!-- Filter chips will be injected here by JS logic, ensure logic populates this -->
                            <!-- Re-adding static filter chips structure for robustness in case JS logic is looking for specific classes -->
                            <div class="filter-chip all active" data-filter="all" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-layer-group mr-1"></i>All <span id="allCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip new" data-filter="new" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-sparkles mr-1"></i>New <span id="newCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip followup" data-filter="followup" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-reply mr-1"></i>Sent <span id="followupCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip manual" data-filter="manual" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-hand mr-1"></i>M.Sent <span id="manualCount" class="ml-1 opacity-75">0</span></div>
                            <div class="w-px h-8 bg-slate-300 mx-2"></div>
                            <div class="filter-chip sub" data-filter="sub" data-group="type" onclick="toggleFilterChip(this)">Sub-Con <span id="subCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip agency" data-filter="agency" data-group="type" onclick="toggleFilterChip(this)">Agency <span id="agencyCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip direct" data-filter="direct" data-group="type" onclick="toggleFilterChip(this)">Direct <span id="directCount" class="ml-1 opacity-75">0</span></div>
                            
                            <!-- Active Filters Info -->
                            <div id="activeFiltersInfo" class="hidden items-center gap-2 ml-auto">
                                <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full border border-blue-100"><span id="activeFilterCount">0</span> active</span>
                                <button class="text-xs text-slate-500 hover:text-red-500" onclick="clearAllFilters()"><i class="fa-solid fa-times"></i> Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paste Filter Area -->
                    <div id="pasteFilterArea" class="hidden mb-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border-2 border-blue-200 dark:border-blue-800">
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Paste Comma Separated Emails or Developer IDs:</label>
                        <textarea id="pasteFilterInput" class="w-full h-24 p-3 rounded-lg border-2 border-blue-300 dark:border-blue-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none mb-3" placeholder="john@example.com, jane@example.com&#10;OR&#10;12345, 67890"></textarea>
                        <div class="flex gap-2 items-center">
                            <button onclick="applyPasteFilter()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2 transition">
                                <i class="fa-solid fa-filter"></i> Filter List
                            </button>
                            <button onclick="clearPasteFilter()" class="bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-500 px-4 py-2 rounded-lg text-sm font-medium transition">
                                Clear List
                            </button>
                            <button onclick="togglePasteFilter()" class="ml-auto text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition">Close</button>
                        </div>
                    </div>

                    <!-- Table Controls & Table (Hidden until data loaded) -->
                    <div id="tableControls" class="hidden space-y-4">
                        <div class="flex flex-col lg:flex-row gap-4 justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <div class="flex gap-2 items-center w-full lg:w-auto">
                                <div class="relative flex-1 lg:w-80">
                                    <input type="text" id="tableSearch" oninput="searchTable()" placeholder="Search name, email, or ID..." class="input-field pl-10">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                                </div>
                                <button onclick="togglePasteFilter()" class="bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-200 border border-slate-200 dark:border-slate-600 text-sm font-medium flex items-center gap-2 transition" title="Filter by pasting emails or IDs">
                                    <i class="fa-solid fa-clipboard-list"></i> Paste & Filter
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-2 flex-wrap">
                                <button onclick="selectAllResults()" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-2 rounded hover:bg-blue-100 transition">Select All</button>
                                <button onclick="deselectAll()" class="text-xs font-bold text-slate-600 bg-slate-50 px-3 py-2 rounded hover:bg-slate-100 transition">Clear</button>
                                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                                <button onclick="copyToClipboard()" class="text-xs font-bold text-slate-600 hover:text-blue-600 px-2"><i class="fa-regular fa-copy"></i> Copy</button>
                                <button onclick="downloadCSV()" class="text-xs font-bold text-slate-600 hover:text-green-600 px-2"><i class="fa-solid fa-download"></i> CSV</button>
                                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                                <button onclick="openEmailPanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2">
                                    <i class="fa-solid fa-paper-plane"></i> Campaign
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selection Indicator -->
                        <div id="selectionIndicator" class="hidden items-center gap-2 text-sm text-blue-600 bg-blue-50 p-2 rounded border border-blue-100">
                            <i class="fa-solid fa-circle-check"></i> <span id="quickSelectedCount">0</span> selected
                        </div>

                        <div id="tableContainer" class="hidden bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table id="devTable" class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600 text-xs uppercase font-bold text-slate-500 tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4 w-12 text-center"><input type="checkbox" id="masterCheckbox" onclick="toggleMasterCheckbox()" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500"></th>
                                            <th class="px-6 py-4">Developer ID</th>
                                            <th class="px-6 py-4">Name</th>
                                            <th class="px-6 py-4">Email</th>
                                            <th class="px-6 py-4 relative">
                                                <span class="inline-flex items-center gap-1">
                                                    Country
                                                    <button onclick="toggleCountryFilter(event)" class="country-filter-btn ml-1 p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition" title="Filter by country">
                                                        <i class="fa-solid fa-filter text-xs text-slate-400" id="countryFilterIcon"></i>
                                                    </button>
                                                </span>
                                                <!-- Country Filter Dropdown -->
                                                <div id="countryFilterDropdown" class="hidden absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-600 z-50">
                                                    <div class="p-3 border-b border-slate-200 dark:border-slate-600">
                                                        <input type="text" id="countrySearchInput" oninput="filterCountryList()" placeholder="Search countries..." class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white">
                                                    </div>
                                                    <div id="countryListContainer" class="max-h-48 overflow-y-auto p-2">
                                                        <!-- Country checkboxes will be populated here -->
                                                    </div>
                                                    <div class="p-3 border-t border-slate-200 dark:border-slate-600 flex justify-between gap-2">
                                                        <button onclick="clearCountryFilter()" class="px-3 py-1.5 text-xs text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md transition">Clear</button>
                                                        <button onclick="applyCountryFilter()" class="px-3 py-1.5 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Apply</button>
                                                    </div>
                                                </div>
                                            </th>
                                            <th class="px-6 py-4">Phone</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4">History</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                        <!-- Rows injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: NEGOTIATION AI -->
                <div id="tab-negotiation" class="tab-content hidden-tab">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">Negotiation Configuration</h3>
                        <p class="text-sm text-slate-500">Configure AI behavior and rate limits per Job ID.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Left Col: Configuration Form -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Select Job</label>
                                    <select id="activeJobsDropdown" onchange="selectJobFromDropdown(this.value)" class="input-field cursor-pointer bg-slate-50"><option value="">-- Select --</option></select>
                                    
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="text-xs text-slate-400">Or enter manual ID:</span>
                                        <input type="number" id="negJobId" class="input-field py-1 px-2 text-xs w-24" placeholder="ID" onchange="loadNegotiationConfig()">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Target Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
                                            <input type="number" id="targetRate" class="input-field pl-6" placeholder="20">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Max Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
                                            <input type="number" id="maxRate" class="input-field pl-6" placeholder="35">
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">AI Persona</label>
                                    <select id="negStyle" class="input-field">
                                        <option value="Friendly but firm">Friendly but firm</option>
                                        <option value="Professional and direct">Professional and direct</option>
                                        <option value="Empathetic">Empathetic</option>
                                        <option value="Aggressive">High-pressure / Urgent</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">
                                        <i class="fa-solid fa-shield-halved text-amber-500 mr-1"></i>Internal AI Rules
                                        <span class="text-xs font-normal text-slate-400 ml-1">(Confidential - Not shared with developers)</span>
                                    </label>
                                    <textarea id="specialRules" rows="4" class="input-field text-xs" placeholder="Add any internal rules or context for the AI to follow during negotiations. These are confidential and will not be shared with the developer."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: JD & Save -->
                        <div class="flex flex-col gap-6">
                            <div class="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-xl border border-slate-200 dark:border-slate-700 flex-1 flex flex-col">
                                <h3 class="font-bold text-slate-800 dark:text-slate-300 text-sm mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-file-lines text-blue-500"></i> Job Description Context
                                </h3>
                                <textarea id="jobDescription" class="input-field flex-1 text-xs font-mono" placeholder="Paste JD here..."></textarea>
                            </div>
                            <button onclick="saveNegotiationSettings()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-save"></i> <span>Save Configuration</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rate Tiers (New Section) -->
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">Regional Rate Tiers</h3>
                            <button onclick="refreshRateTiers()" class="text-sm text-blue-600 hover:underline">Refresh</button>
                        </div>
                        <!-- Add Tier Form -->
                        <div class="bg-white p-4 rounded-lg border border-slate-200 mb-4 flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="text-xs text-slate-500">Region</label>
                                <input id="tierRegion" class="input-field" placeholder="e.g. LATAM">
                            </div>
                            <div class="w-24">
                                <label class="text-xs text-slate-500">Target $</label>
                                <input id="tierTargetRate" type="number" class="input-field" placeholder="20">
                            </div>
                            <div class="w-24">
                                <label class="text-xs text-slate-500">Max $</label>
                                <input id="tierMaxRate" type="number" class="input-field" placeholder="30">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs text-slate-500">Note</label>
                                <input id="tierNotes" class="input-field" placeholder="Optional">
                            </div>
                            <button onclick="addRateTier()" class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <!-- Tier Table -->
                        <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold">
                                    <tr>
                                        <th class="px-4 py-3">Region</th>
                                        <th class="px-4 py-3">Target</th>
                                        <th class="px-4 py-3">Max</th>
                                        <th class="px-4 py-3">Notes</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rateTiersBody" class="divide-y divide-slate-100">
                                    <tr><td colspan="5" class="p-4 text-center text-slate-400">No tiers loaded. Select a Job ID.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: TASKS LIST -->
                <div id="tab-tasks" class="tab-content hidden-tab">
                    
                    <!-- Stats Cards (New Design) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card border-slate-500">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Active</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statTotal">-</h2>
                        </div>
                        <div class="stat-card border-blue-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-blue-500 uppercase tracking-wider mb-1">AI Negotiating</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statActive">-</h2>
                                </div>
                                <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i class="fa-solid fa-robot"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-amber-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">Needs Human</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statHuman">-</h2>
                                </div>
                                <div class="p-2 bg-amber-50 rounded-lg text-amber-600"><i class="fa-solid fa-user-clock"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-green-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-green-500 uppercase tracking-wider mb-1">Accepted</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statAccepted">-</h2>
                                </div>
                                <div class="p-2 bg-green-50 rounded-lg text-green-600"><i class="fa-solid fa-check"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <h3 class="text-lg font-bold text-slate-800">Active Negotiations</h3>
                        <div class="flex gap-2">
                            <select id="taskJobFilter" onchange="filterTasks()" class="input-field py-2 w-auto"><option value="all">All Jobs</option></select>
                            <select id="taskStatusFilter" onchange="filterTasks()" class="input-field py-2 w-auto">
                                <option value="all">All Statuses</option>
                                <option value="Initial Outreach">Initial Outreach</option>
                                <option value="Active">AI Active</option>
                                <option value="Human-Negotiation">Human Required</option>
                                <option value="Offer Accepted">Accepted</option>
                            </select>
                            <button id="runAiBtn" onclick="manualTriggerAI()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 shadow-sm">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Run AI
                            </button>
                            <button onclick="loadTasks()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 px-3 py-2 rounded-lg transition">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div id="bulkActionsBar" class="hidden mb-4 bg-blue-50 p-3 rounded-lg border border-blue-200 flex justify-between items-center">
                        <span class="text-sm font-bold text-blue-800"><span id="taskSelectedCount">0</span> selected</span>
                        <div class="flex gap-2">
                            <button onclick="bulkCompleteSelected()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Complete Selected</button>
                            <button onclick="clearTaskSelection()" class="bg-white border text-slate-600 px-3 py-1 rounded text-sm">Clear</button>
                        </div>
                    </div>

                    <!-- Task Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4 w-10 text-center"><input type="checkbox" onchange="toggleAllTasks(this)" class="task-master-check rounded"></th>
                                        <th class="px-6 py-4">Job ID</th>
                                        <th class="px-6 py-4">Candidate</th>
                                        <th class="px-6 py-4">Status Tag</th>
                                        <th class="px-6 py-4">AI Notes</th>
                                        <th class="px-6 py-4">Last Activity</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="taskListBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <!-- Empty State -->
                        <div id="emptyTaskState" class="hidden p-12 text-center">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-inbox text-slate-300 text-2xl"></i>
                            </div>
                            <h3 class="text-slate-800 font-medium">No active tasks</h3>
                            <p class="text-slate-500 text-sm">Everything is up to date.</p>
                        </div>
                    </div>
                    
                    <!-- AI Progress Panel (Hidden) -->
                    <div id="aiProgressPanel" class="hidden mt-6 bg-purple-50 rounded-xl border border-purple-100 p-4">
                        <div class="flex items-center justify-between mb-2 clickable" onclick="toggleCollapse('aiProgressContent', this)">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-circle-notch fa-spin text-purple-600" id="aiProgressIcon"></i>
                                <span class="font-bold text-purple-800" id="aiProgressStatus">AI Running...</span>
                            </div>
                            <button onclick="closeProgressPanel('aiProgressPanel')"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div id="aiProgressContent" class="collapsible-content">
                            <div id="aiLogContainer" class="text-xs font-mono bg-white p-3 rounded border border-purple-100 max-h-32 overflow-y-auto text-slate-600"></div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: FOLLOW-UPS -->
                <div id="tab-followups" class="tab-content hidden-tab">
                    
                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card border-slate-400">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Awaiting Response</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statPending">-</h2>
                        </div>
                        <div class="stat-card border-amber-400">
                            <p class="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">1st Follow-up</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statFollowUp1">-</h2>
                        </div>
                        <div class="stat-card border-orange-500">
                            <p class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-1">2nd Follow-up</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statFollowUp2">-</h2>
                        </div>
                        <div class="stat-card border-green-500">
                            <p class="text-xs font-bold text-green-500 uppercase tracking-wider mb-1">Responded</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statResponded">-</h2>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-slate-800">Automated Follow-Up Queue</h3>
                        <div class="flex gap-2">
                            <select id="followUpJobFilter" onchange="loadFollowUpData()" class="input-field w-auto"><option value="all">All Jobs</option></select>
                            <select id="followUpStatusFilter" onchange="loadFollowUpData()" class="input-field w-auto">
                                <option value="all">All Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Follow-Up-1-Sent">1st Sent</option>
                                <option value="Follow-Up-2-Sent">2nd Sent</option>
                            </select>
                            <button id="runFollowUpBtn" onclick="manualTriggerFollowUps()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm">
                                <i class="fa-solid fa-paper-plane mr-1"></i> Process Queue
                            </button>
                            <button id="resetStatusBtn" onclick="resetFollowUpStatuses()" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50">
                                Reset Statuses
                            </button>
                            <button onclick="loadFollowUpStats()" class="bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase">
                                <tr>
                                    <th class="px-6 py-4">Job ID</th>
                                    <th class="px-6 py-4">Name</th>
                                    <th class="px-6 py-4">Email</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4">Last Sent</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="followUpTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                        <div id="emptyFollowUpState" class="hidden p-12 text-center text-slate-500">
                            <i class="fa-solid fa-check-circle text-4xl text-green-100 mb-3 block"></i>
                            Queue is empty.
                        </div>
                    </div>
                    <!-- FollowUp Progress Panel -->
                    <div id="followUpProgressPanel" class="hidden mt-6 bg-blue-50 rounded-xl border border-blue-100 p-4">
                        <div class="flex items-center justify-between mb-2 clickable" onclick="toggleCollapse('followUpProgressContent', this)">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-circle-notch fa-spin text-blue-600" id="followUpProgressIcon"></i>
                                <span class="font-bold text-blue-800" id="followUpProgressStatus">Processing...</span>
                            </div>
                            <button onclick="closeProgressPanel('followUpProgressPanel')"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div id="followUpProgressContent" class="collapsible-content">
                            <div id="followUpLogContainer" class="text-xs font-mono bg-white p-3 rounded border border-blue-100 max-h-32 overflow-y-auto text-slate-600"></div>
                        </div>
                    </div>
                </div>

                <!-- TAB 5: ANALYTICS -->
                <div id="tab-analytics" class="tab-content hidden-tab">
                    <div class="flex flex-col gap-4 mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white">Usage Analytics</h3>
                            <div class="flex gap-2">
                                <button onclick="loadAnalytics()" class="bg-white border border-slate-300 px-3 py-2 rounded-lg text-sm hover:bg-slate-50">
                                    <i class="fa-solid fa-rotate mr-1"></i> Refresh
                                </button>
                                <button id="manageViewersBtn" onclick="openViewersModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                                    <i class="fa-solid fa-users-gear mr-1"></i> Access
                                </button>
                            </div>
                        </div>
                        <!-- Filters Row -->
                        <div class="flex flex-wrap items-center gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                            <!-- User Email Filter -->
                            <div class="flex-1 min-w-[200px] relative">
                                <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="email" id="analyticsUserFilter"
                                    placeholder="Filter by user email"
                                    class="w-full pl-10 pr-10 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    onkeyup="handleAnalyticsFilterKeyup(event)"
                                    oninput="handleAnalyticsEmailInput(event)"
                                    onfocus="handleAnalyticsEmailFocus()"
                                    autocomplete="off">
                                <button id="clearAnalyticsFilter" onclick="clearAnalyticsEmailFilter()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                                <!-- Email Autocomplete dropdown -->
                                <div id="analyticsEmailDropdown" class="absolute left-0 right-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
                                </div>
                            </div>
                            <!-- Job ID Filter -->
                            <div class="flex-1 min-w-[200px] relative">
                                <i class="fa-solid fa-briefcase absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="analyticsJobFilter"
                                    placeholder="Filter by Job ID"
                                    class="w-full pl-10 pr-10 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                    onkeyup="handleAnalyticsJobFilterKeyup(event)"
                                    oninput="handleAnalyticsJobInput(event)"
                                    onfocus="handleAnalyticsJobFocus()"
                                    autocomplete="off">
                                <button id="clearAnalyticsJobFilter" onclick="clearAnalyticsJobFilter()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                                <!-- Job ID Autocomplete dropdown -->
                                <div id="analyticsJobDropdown" class="absolute left-0 right-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
                                </div>
                            </div>
                            <button onclick="applyAnalyticsFilter()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                                <i class="fa-solid fa-filter mr-1"></i> Filter
                            </button>
                            <button onclick="clearAllAnalyticsFilters()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-200">
                                <i class="fa-solid fa-times mr-1"></i> Clear All
                            </button>
                        </div>
                        <!-- Filter Status -->
                        <div id="analyticsFilterStatus" class="hidden flex items-center gap-2 text-xs text-slate-500 bg-slate-50 px-3 py-2 rounded-lg">
                            <span>Filtering:</span>
                            <span id="analyticsFilterEmailBadge" class="hidden bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-medium">
                                <i class="fa-solid fa-user mr-1"></i><span id="analyticsFilterEmailText"></span>
                            </span>
                            <span id="analyticsFilterJobBadge" class="hidden bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-medium">
                                <i class="fa-solid fa-briefcase mr-1"></i>Job <span id="analyticsFilterJobText"></span>
                            </span>
                        </div>
                    </div>

                    <!-- Analytics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card border-indigo-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-1">Active Users</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalUsers">-</h2>
                                </div>
                                <div class="bg-indigo-50 p-2 rounded-lg text-indigo-600"><i class="fa-solid fa-users"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-emerald-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-1">Emails Sent</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalEmails">-</h2>
                                </div>
                                <div class="bg-emerald-50 p-2 rounded-lg text-emerald-600"><i class="fa-solid fa-envelope"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-amber-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">Auto Follow-Ups</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalFollowUps">-</h2>
                                </div>
                                <div class="bg-amber-50 p-2 rounded-lg text-amber-600"><i class="fa-solid fa-reply-all"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-purple-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-purple-500 uppercase tracking-wider mb-1">Negotiations</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalNegotiations">-</h2>
                                </div>
                                <div class="bg-purple-50 p-2 rounded-lg text-purple-600"><i class="fa-solid fa-handshake"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- User Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <div class="flex items-center gap-3">
                                <div class="bg-indigo-100 p-2 rounded-lg">
                                    <i class="fa-solid fa-users text-indigo-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">User Activity</h4>
                                    <p class="text-xs text-slate-500">Users who have accessed the app and their activity</p>
                                </div>
                            </div>
                        </div>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase">
                                <tr>
                                    <th class="px-6 py-3">User Email</th>
                                    <th class="px-6 py-3 text-center">Emails Sent</th>
                                    <th class="px-6 py-3 text-center">Data Fetches</th>
                                    <th class="px-6 py-3 text-center">Negotiations</th>
                                    <th class="px-6 py-3 text-center">Follow-Ups</th>
                                    <th class="px-6 py-3">Last Active</th>
                                </tr>
                            </thead>
                            <tbody id="userStatsTableBody" class="divide-y divide-slate-100">
                                <tr id="userStatsEmptyState">
                                    <td colspan="6" class="px-6 py-8 text-center text-slate-400">
                                        <i class="fa-regular fa-folder-open text-2xl mb-2 block"></i>
                                        No user activity recorded yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Split Charts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-emerald-100 p-2 rounded-lg">
                                    <i class="fa-solid fa-user-check text-emerald-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Emails by User</h4>
                                    <p class="text-xs text-slate-500">Email distribution across team members</p>
                                </div>
                            </div>
                            <div id="emailUsersList" class="space-y-3">
                                <div id="emailUsersEmpty" class="text-center py-6 text-slate-400">
                                    <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                                    <span class="text-sm">No emails sent yet</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-amber-100 p-2 rounded-lg">
                                    <i class="fa-solid fa-briefcase text-amber-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Emails by Job</h4>
                                    <p class="text-xs text-slate-500">Email activity grouped by job ID</p>
                                </div>
                            </div>
                            <div id="emailJobsList" class="space-y-2">
                                <div id="emailJobsEmpty" class="text-center py-6 text-slate-400">
                                    <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                                    <span class="text-sm">No emails sent yet</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Access Denied State (Hidden) -->
                    <div id="analyticsAccessDenied" class="hidden text-center py-20">
                        <i class="fa-solid fa-lock text-4xl text-red-300 mb-3"></i>
                        <h3 class="text-xl font-bold text-slate-700">Access Denied</h3>
                        <p class="text-slate-500">You do not have permission to view analytics.</p>
                    </div>
                    
                    <!-- Hidden container for recent activity to prevent errors if script references it -->
                    <div id="recentActivityList" class="hidden"></div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODALS (Hidden by default) - Preserved exact structure -->
    
    <!-- Config Modal -->
    <div id="configModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Database URL</label>
                    <input id="sheetUrl" class="input-field" placeholder="Google Sheet URL">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Jobs Sheet URL</label>
                    <input id="jobsSheetUrl" class="input-field" placeholder="Google Sheet URL">
                </div>
                
                <!-- Trigger status section -->
                <div id="triggerStatusContainer"></div>
                <div id="createTriggersSection" class="hidden mt-2">
                    <button id="createAllTriggersBtn" onclick="createAllTriggers()" class="w-full bg-green-600 text-white py-2 rounded-lg">Create Triggers</button>
                    <span id="createTriggersText" class="hidden"></span><span id="createTriggersSpinner" class="hidden"></span>
                </div>
                <div id="allTriggersGood" class="hidden text-green-600 text-sm"><i class="fa-solid fa-check"></i> Triggers Active</div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('configModal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 rounded-lg text-slate-600">Close</button>
                <button id="saveConfigBtn" onclick="saveConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button>
                <span id="saveConfigText" class="hidden"></span><span id="saveConfigSpinner" class="hidden"></span>
            </div>
        </div>
    </div>

    <!-- Email Composer Modal (Centered) -->
    <div id="emailModalOverlay" class="email-modal-overlay" onclick="handleModalOverlayClick(event)">
        <div class="email-modal" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-xl">Draft Email Campaign</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Compose and send bulk emails with formatting</p>
                </div>
                <button onclick="closeEmailPanel()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 text-xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 flex-1 overflow-y-auto">
                <!-- Top Row: Name, Subject, Recipients -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <input id="senderName" class="input-field" placeholder="Your Name">
                    <input id="emailSubject" class="input-field" placeholder="Subject line">
                </div>

                <!-- Recipients Info -->
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800 text-sm text-blue-700 dark:text-blue-300 mb-4">
                    Sending to <span id="emailRecipientCount" class="font-bold">0</span> candidates.
                    <div id="emailRecipientPreview" class="text-xs text-blue-500 dark:text-blue-400 mt-1 truncate"></div>
                </div>

                <!-- Template Selection Row -->
                <div class="flex gap-2 mb-4">
                    <select id="templateSelect" onchange="loadSelectedTemplate()" class="input-field flex-1">
                        <option value="">-- Select Template --</option>
                    </select>
                    <button onclick="saveCurrentAsTemplate()" class="bg-slate-100 dark:bg-slate-700 px-4 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600" title="Save as Template">
                        <i class="fa-solid fa-save"></i>
                    </button>
                </div>

                <!-- Job Type Toggles -->
                <div class="job-toggles-container mb-4">
                    <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-3">Campaign Settings</label>

                    <!-- Negotiation Toggle -->
                    <div class="job-toggle-row" id="negotiationRow">
                        <div class="job-toggle-info">
                            <span class="job-toggle-title">Negotiation</span>
                            <span class="job-toggle-desc">AI will negotiate rates with candidates</span>
                        </div>
                        <div class="toggle-switch active" id="toggleNegotiation" onclick="toggleJobSetting('negotiation')"></div>
                        <div class="toggle-tooltip" id="tooltipNegotiation">
                            <span class="tooltip-on">ON:</span> AI actively negotiates rates with candidates<br>
                            <span class="tooltip-off">OFF:</span> No rate negotiation, just collect responses
                        </div>
                    </div>

                    <!-- Follow-up Toggle -->
                    <div class="job-toggle-row" id="followUpRow">
                        <div class="job-toggle-info">
                            <span class="job-toggle-title">Follow-up</span>
                            <span class="job-toggle-desc">Send automated follow-ups if no response</span>
                        </div>
                        <div class="toggle-switch active" id="toggleFollowUp" onclick="toggleJobSetting('followUp')"></div>
                        <div class="toggle-tooltip" id="tooltipFollowUp">
                            <span class="tooltip-on">ON:</span> Auto-sends reminders at 12hr & 28hr if no reply<br>
                            <span class="tooltip-off">OFF:</span> No automatic follow-ups sent
                        </div>
                    </div>

                    <!-- Data Gathering Toggle -->
                    <div class="job-toggle-row" id="dataGatheringRow">
                        <div class="job-toggle-info">
                            <span class="job-toggle-title">Data Gathering</span>
                            <span class="job-toggle-desc">Collect and track candidate responses</span>
                        </div>
                        <div class="toggle-switch active" id="toggleDataGathering" onclick="toggleJobSetting('dataGathering')"></div>
                        <div class="toggle-tooltip" id="tooltipDataGathering">
                            <span class="tooltip-on">ON:</span> AI asks follow-ups for missing info<br>
                            <span class="tooltip-off">OFF:</span> Data still saved, but no follow-up questions
                        </div>
                    </div>

                    <!-- Status Hint -->
                    <p id="jobTypeHint" class="text-xs text-slate-500 dark:text-slate-400 mt-2 pt-2 border-t border-slate-200 dark:border-slate-600">
                        <i class="fa-solid fa-info-circle mr-1 text-blue-500"></i>
                        <span id="jobTypeHintText">Negotiation + Follow-up enabled. AI will negotiate and send reminders.</span>
                    </p>
                </div>

                <!-- Email Body Section -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Email Body</label>
                        <span class="text-xs text-slate-500 dark:text-slate-400">
                            Use <span class="name-placeholder">{{name}}</span> as a placeholder for the candidate's name
                        </span>
                    </div>

                    <!-- Formatting Toolbar -->
                    <div class="format-toolbar">
                        <button class="format-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
                        <button class="format-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
                        <button class="format-btn" onclick="formatText('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                        <div class="format-divider"></div>
                        <button class="format-btn" onclick="formatText('formatBlock', 'H2')" title="Heading">H2</button>
                        <button class="format-btn" onclick="formatText('insertUnorderedList')" title="Bullet List"><i class="fa-solid fa-list-ul"></i></button>
                        <button class="format-btn" onclick="formatText('insertOrderedList')" title="Numbered List"><i class="fa-solid fa-list-ol"></i></button>
                        <div class="format-divider"></div>
                        <button class="format-btn" id="formatPainterBtn" onclick="handleFormatPainter()" title="Format Painter - Copy and apply formatting">
                            <i class="fa-solid fa-paintbrush"></i>
                        </button>
                        <button class="format-btn" onclick="formatText('removeFormat')" title="Clear Formatting"><i class="fa-solid fa-eraser"></i></button>
                    </div>

                    <!-- Rich Text Editor -->
                    <div id="emailBody" class="rich-text-editor" contenteditable="true" oninput="handleEditorInput()" style="border-top-left-radius: 0; border-top-right-radius: 0;"></div>
                    <input type="hidden" id="htmlBody" value="">
                </div>

                <!-- Save as Template Checkbox -->
                <div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                    <input type="checkbox" id="saveAsTemplateCheck" class="rounded border-slate-300 dark:border-slate-600">
                    <label for="saveAsTemplateCheck" class="text-sm text-slate-600 dark:text-slate-400">Save this email as a new template</label>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                <div id="sendProgressContainer" class="hidden flex-1 mr-4">
                    <div class="text-xs text-slate-500 flex justify-between mb-1">
                        <span id="sendProgressText">Sending...</span>
                        <span id="sendProgressCount">0/0</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-1.5">
                        <div id="sendProgressBar" class="bg-blue-600 h-1.5 rounded-full w-0 transition-all"></div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeEmailPanel()" class="px-6 py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-slate-600 dark:text-slate-300 font-medium">
                        Cancel
                    </button>
                    <button id="sendEmailBtn" onclick="sendEmails()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> Send Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Input Modal -->
    <div id="manualInputModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 class="font-bold mb-2">Manual Test Mode</h3>
            <textarea id="manualDataInput" class="input-field h-32 mb-4" placeholder="email, name, region (one per line)"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('manualInputModal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 rounded-lg">Cancel</button>
                <button onclick="loadManualData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Load Data</button>
            </div>
        </div>
    </div>

    <!-- AI Notes Modal -->
    <div id="notesModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 class="font-bold mb-4 text-purple-700">AI Conversation Notes</h3>
            <div id="notesModalContent" class="bg-slate-50 p-4 rounded-lg text-sm text-slate-700 mb-4 max-h-60 overflow-y-auto whitespace-pre-wrap"></div>
            <div class="flex justify-end">
                <button onclick="document.getElementById('notesModal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Complete Human Modal -->
    <div id="completeHumanModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h3 class="font-bold mb-4 text-green-700">Complete Negotiation</h3>
            <p class="text-sm mb-1 text-slate-500">Candidate: <span id="completeHumanEmail" class="font-medium text-slate-800"></span></p>
            
            <div class="my-4">
                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Agreed Rate</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                    <input type="number" id="agreedRateInput" class="input-field pl-6" placeholder="0.00">
                </div>
                <div class="mt-2 flex items-center gap-2">
                    <input type="checkbox" id="noRateAgreed" onchange="toggleRateInput()" class="rounded border-slate-300">
                    <label for="noRateAgreed" class="text-sm text-slate-600">No rate agreed (Closed/Rejected)</label>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Outcome</label>
                <select id="completionStatus" class="input-field">
                    <option value="">Offer Accepted</option>
                    <option value="Rejected by Candidate">Rejected</option>
                    <option value="Candidate Withdrew">Withdrew</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeCompleteHumanModal()" class="px-4 py-2 bg-slate-100 rounded-lg">Cancel</button>
                <button id="completeHumanBtn" onclick="submitCompleteHuman()" class="px-4 py-2 bg-green-600 text-white rounded-lg">Complete</button>
            </div>
        </div>
    </div>

    <!-- Viewers Modal -->
    <div id="viewersModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h3 class="font-bold mb-4">Manage Access</h3>
            <div class="flex gap-2 mb-4">
                <input id="newViewerEmail" class="input-field" placeholder="Email">
                <select id="newViewerLevel" class="input-field w-24"><option value="viewer">Viewer</option><option value="admin">Admin</option></select>
                <button onclick="addViewer()" class="bg-blue-600 text-white px-3 rounded-lg"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="viewersList" class="max-h-48 overflow-y-auto space-y-2"></div>
            <div class="flex justify-end mt-4">
                <button onclick="closeViewersModal()" class="px-4 py-2 bg-slate-100 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden Bulk Action Bar -->
    <div id="bulkActionBar" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-6 hidden z-40 transition-transform">
        <span class="font-bold"><span id="bulkSelectedCount">0</span> selected</span>
        <div class="h-4 w-px bg-slate-700"></div>
        <button onclick="openEmailPanel()" class="hover:text-blue-300 transition flex items-center gap-2"><i class="fa-solid fa-envelope"></i> Email</button>
        <button onclick="markSelectedAsManualSent()" class="hover:text-amber-300 transition flex items-center gap-2"><i class="fa-solid fa-check"></i> Mark Sent</button>
        <button onclick="clearTaskSelection(); deselectAll();" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
    </div>

    <!-- LOGIC SCRIPT (FULLY RESTORED) -->
    <script>
        let tableData = [];
        let fullTableData = [];
        let selectedDevs = new Set();
        let allTasks = [];
        let selectedTasks = new Set();
        let cachedJobIds = [];
        let cachedTemplates = [];
        let currentUserEmail = '';

        // Data caching to prevent reloading on tab switch
        const dataCache = {
            tasks: { data: null, lastLoaded: 0 },
            followups: { data: null, lastLoaded: 0 },
            analytics: { data: null, lastLoaded: 0 },
            triggers: { data: null, lastLoaded: 0 }
        };
        const CACHE_DURATION = 60000; // Cache for 60 seconds

        function isCacheValid(cacheKey) {
            const cache = dataCache[cacheKey];
            return cache.data !== null && (Date.now() - cache.lastLoaded) < CACHE_DURATION;
        }

        // Multi-select filter state
        let activeFilters = {
            status: new Set(['all']),
            type: new Set(),
            country: new Set()
        };

        // ===== INIT: Load user email on page load =====
        document.addEventListener('DOMContentLoaded', function() {
            loadUserEmail();
        });

        function loadUserEmail() {
            google.script.run
                .withSuccessHandler(function(email) {
                    currentUserEmail = email || 'Unknown';
                    // Update main text
                    const uText = document.getElementById('userEmailText');
                    if(uText) uText.textContent = email || 'Not signed in';
                    // Update sidebar text
                    const navUser = document.getElementById('userEmailTextSidebar');
                    if(navUser) navUser.textContent = email || 'Guest';
                })
                .withFailureHandler(function(err) {
                    const uText = document.getElementById('userEmailText');
                    if(uText) uText.textContent = 'Not available';
                })
                .getUserEmail();
        }

        // --- Layout Switching Logic ---
        function switchTab(tabName, btn) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-tab'));
            // Show selected
            document.getElementById('tab-' + tabName).classList.remove('hidden-tab');
            
            // Update Sidebar Active State
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // Update Header Title
            const titles = {
                'outreach': 'Outreach Manager',
                'negotiation': 'Negotiation AI',
                'tasks': 'Task List',
                'followups': 'Follow-Ups',
                'analytics': 'Analytics'
            };
            document.getElementById('headerTitle').textContent = titles[tabName] || 'Dashboard';

            // Trigger data loads only if cache is invalid
            if(tabName === 'tasks' && !isCacheValid('tasks')) loadTasks();
            if(tabName === 'negotiation' && !isCacheValid('triggers')) refreshJobDropdown();
            if(tabName === 'followups' && !isCacheValid('followups')) loadFollowUpStats();
            if(tabName === 'analytics' && !isCacheValid('analytics')) loadAnalytics();
        }

        // --- Date Formatting Helper ---
        function formatDateTime(isoString) {
            if (!isoString || isoString === '-') return '-';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return '-';
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return date.toLocaleDateString('en-US', options);
            } catch(e) {
                return '-';
            }
        }

        // --- Toast ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'check-circle',
                error: 'circle-xmark',
                warning: 'triangle-exclamation',
                info: 'circle-info'
            };

            toast.innerHTML = `
                <i class="fa-solid fa-${icons[type] || 'circle-info'} mr-2"></i>
                <span class="toast-content">${message}</span>
            `; 
            container.appendChild(toast);
            
            const timeoutId = setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
            toast.dataset.timeoutId = timeoutId;
        }

        // --- Toggles ---
        function toggleChip(el) { el.classList.toggle('active'); }
        function selectAllChips() {
            document.querySelectorAll('.smart-chip[data-value]').forEach(chip => chip.classList.add('active'));
        }
        function clearAllChips() {
            document.querySelectorAll('.smart-chip[data-value]').forEach(chip => chip.classList.remove('active'));
        }
        function openManualInput() { document.getElementById('manualInputModal').classList.remove('hidden'); }
        function openConfigModal() { 
            document.getElementById('configModal').classList.remove('hidden'); 
            refreshTriggerStatus(); // Load trigger status when modal opens
        }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        // ===== NOTIFICATION SYSTEM =====
        let notifications = [];
        let notificationsLoaded = false;

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                if (!notificationsLoaded) {
                    loadNotifications();
                }
            } else {
                panel.classList.add('hidden');
            }
        }

        function loadNotifications() {
            const listEl = document.getElementById('notificationList');
            listEl.innerHTML = '<div class="p-4 text-center"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';

            google.script.run
                .withSuccessHandler(data => {
                    notifications = data || [];
                    notificationsLoaded = true;
                    renderNotifications();
                    updateNotificationBadge();
                })
                .withFailureHandler(err => {
                    listEl.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">Failed to load notifications</div>';
                })
                .getNotifications();
        }

        function renderNotifications() {
            const listEl = document.getElementById('notificationList');
            if (notifications.length === 0) {
                listEl.innerHTML = '<div class="p-4 text-center text-slate-500 text-sm">No new notifications</div>';
                return;
            }

            listEl.innerHTML = notifications.map((n, i) => `
                <div class="p-3 border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer ${n.read ? 'opacity-60' : ''}" onclick="handleNotificationClick(${i})">
                    <div class="flex items-start gap-2">
                        <i class="fa-solid ${n.icon || 'fa-bell'} text-${n.type === 'success' ? 'green' : n.type === 'warning' ? 'yellow' : n.type === 'error' ? 'red' : 'blue'}-500 mt-0.5"></i>
                        <div class="flex-1">
                            <p class="text-sm text-slate-800 dark:text-white ${n.read ? '' : 'font-medium'}">${n.title}</p>
                            <p class="text-xs text-slate-500 mt-0.5">${n.message}</p>
                            <span class="text-xs text-slate-400 mt-1 block">${n.time || 'Just now'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function handleNotificationClick(index) {
            if (notifications[index]) {
                notifications[index].read = true;
                renderNotifications();
                updateNotificationBadge();
                // Navigate if there's an action
                if (notifications[index].action) {
                    if (notifications[index].action.tab) {
                        const tabBtn = document.querySelector(`.nav-tab[onclick*="${notifications[index].action.tab}"]`);
                        if (tabBtn) switchTab(notifications[index].action.tab, tabBtn);
                    }
                }
                toggleNotifications();
            }
        }

        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
            updateNotificationBadge();
        }

        // Close notification panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notificationPanel');
            const btn = document.getElementById('notificationBtn');
            if (!panel.contains(e.target) && !btn.contains(e.target) && !panel.classList.contains('hidden')) {
                panel.classList.add('hidden');
            }
        });

        // ===== GLOBAL SEARCH SYSTEM =====
        let globalSearchTimeout = null;

        function handleGlobalSearch() {
            const input = document.getElementById('globalSearchInput');
            const query = input.value.trim().toLowerCase();
            const resultsEl = document.getElementById('globalSearchResults');

            clearTimeout(globalSearchTimeout);

            if (query.length < 2) {
                resultsEl.classList.add('hidden');
                return;
            }

            globalSearchTimeout = setTimeout(() => {
                performGlobalSearch(query);
            }, 300);
        }

        function performGlobalSearch(query) {
            const resultsEl = document.getElementById('globalSearchResults');
            resultsEl.classList.remove('hidden');
            resultsEl.innerHTML = '<div class="p-3 text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> Searching...</div>';

            google.script.run
                .withSuccessHandler(results => {
                    renderGlobalSearchResults(results, query);
                })
                .withFailureHandler(err => {
                    resultsEl.innerHTML = '<div class="p-3 text-center text-red-500 text-sm">Search failed</div>';
                })
                .globalSearch(query);
        }

        function renderGlobalSearchResults(results, query) {
            const resultsEl = document.getElementById('globalSearchResults');

            if (!results || results.length === 0) {
                resultsEl.innerHTML = '<div class="p-3 text-center text-slate-500 text-sm">No results found</div>';
                return;
            }

            const grouped = {
                developers: results.filter(r => r.type === 'developer'),
                negotiations: results.filter(r => r.type === 'negotiation'),
                followups: results.filter(r => r.type === 'followup')
            };

            let html = '';

            if (grouped.developers.length > 0) {
                html += '<div class="p-2 bg-slate-50 dark:bg-slate-700 text-xs font-semibold text-slate-500 uppercase">Developers</div>';
                grouped.developers.slice(0, 5).forEach(r => {
                    html += `<div class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700" onclick="navigateToSearchResult('${r.type}', '${r.id}', '${r.jobId || ''}')">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-user text-blue-500"></i>
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${highlightMatch(r.name, query)}</p>
                                <p class="text-xs text-slate-500">${highlightMatch(r.email, query)} ${r.jobId ? ' Job ' + r.jobId : ''}</p>
                            </div>
                        </div>
                    </div>`;
                });
            }

            if (grouped.negotiations.length > 0) {
                html += '<div class="p-2 bg-slate-50 dark:bg-slate-700 text-xs font-semibold text-slate-500 uppercase">Negotiations</div>';
                grouped.negotiations.slice(0, 5).forEach(r => {
                    html += `<div class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700" onclick="navigateToSearchResult('${r.type}', '${r.id}', '${r.jobId || ''}')">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-handshake text-green-500"></i>
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${highlightMatch(r.name, query)}</p>
                                <p class="text-xs text-slate-500">${r.status}  Job ${r.jobId}</p>
                            </div>
                        </div>
                    </div>`;
                });
            }

            if (grouped.followups.length > 0) {
                html += '<div class="p-2 bg-slate-50 dark:bg-slate-700 text-xs font-semibold text-slate-500 uppercase">Follow-ups</div>';
                grouped.followups.slice(0, 5).forEach(r => {
                    html += `<div class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700" onclick="navigateToSearchResult('${r.type}', '${r.id}', '${r.jobId || ''}')">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-clock text-yellow-500"></i>
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${highlightMatch(r.name, query)}</p>
                                <p class="text-xs text-slate-500">${r.status}  Job ${r.jobId}</p>
                            </div>
                        </div>
                    </div>`;
                });
            }

            resultsEl.innerHTML = html || '<div class="p-3 text-center text-slate-500 text-sm">No results found</div>';
        }

        function highlightMatch(text, query) {
            if (!text) return '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="bg-yellow-200 dark:bg-yellow-800 rounded px-0.5">$1</span>');
        }

        function navigateToSearchResult(type, id, jobId) {
            clearGlobalSearch();
            if (type === 'developer' && jobId) {
                document.getElementById('jobId').value = jobId;
                const tabBtn = document.querySelector('.nav-tab[onclick*="outreach"]');
                if (tabBtn) switchTab('outreach', tabBtn);
                showToast('Job ID loaded. Click Fetch Data to search.', 'info');
            } else if (type === 'negotiation') {
                const tabBtn = document.querySelector('.nav-tab[onclick*="negotiation"]');
                if (tabBtn) switchTab('negotiation', tabBtn);
            } else if (type === 'followup') {
                const tabBtn = document.querySelector('.nav-tab[onclick*="followups"]');
                if (tabBtn) switchTab('followups', tabBtn);
            }
        }

        function clearGlobalSearch() {
            document.getElementById('globalSearchInput').value = '';
            document.getElementById('globalSearchResults').classList.add('hidden');
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchContainer = document.getElementById('globalSearchInput').parentElement;
            if (!searchContainer.contains(e.target)) {
                document.getElementById('globalSearchResults').classList.add('hidden');
            }
        });

        // --- Filter Logic ---
        function toggleFilterChip(element) {
            const filter = element.dataset.filter;
            const group = element.dataset.group;

            if (filter === 'all') {
                activeFilters.status.clear();
                activeFilters.status.add('all');
                document.querySelectorAll('.filter-chip[data-group="status"]').forEach(chip => {
                    chip.classList.remove('active');
                });
                element.classList.add('active');
            } else if (group === 'status') {
                activeFilters.status.delete('all');
                document.querySelector('.filter-chip[data-filter="all"]').classList.remove('active');

                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                    activeFilters.status.delete(filter);
                    if (activeFilters.status.size === 0) {
                        activeFilters.status.add('all');
                        document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
                    }
                } else {
                    element.classList.add('active');
                    activeFilters.status.add(filter);
                }
            } else if (group === 'type') {
                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                    activeFilters.type.delete(filter);
                } else {
                    element.classList.add('active');
                    activeFilters.type.add(filter);
                }
            }

            applyFilters();
            updateActiveFiltersIndicator();
        }

        function applyFilters() {
            let filtered = [...fullTableData];

            // Apply status filters (OR logic)
            if (!activeFilters.status.has('all') && activeFilters.status.size > 0) {
                filtered = filtered.filter(d => {
                    if (activeFilters.status.has('new') && !d.is_sent && !d.is_manual_sent) return true;
                    if (activeFilters.status.has('followup') && d.is_sent && !d.is_manual_sent) return true;
                    if (activeFilters.status.has('manual') && d.is_manual_sent) return true;
                    return false;
                });
            }

            // Apply type filters (OR logic, AND with status)
            if (activeFilters.type.size > 0) {
                filtered = filtered.filter(d => {
                    const candidateType = d.candidate_status || 'Independent';
                    if (activeFilters.type.has('sub') && candidateType === 'Agency Sub-Contractor') return true;
                    if (activeFilters.type.has('agency') && candidateType === 'Agency Contractor') return true;
                    if (activeFilters.type.has('direct') && (candidateType === 'Independent' || !d.candidate_status)) return true;
                    return false;
                });
            }

            // Apply country filters (OR logic, AND with other filters)
            if (activeFilters.country.size > 0) {
                filtered = filtered.filter(d => {
                    const country = d.developer_country || '';
                    return activeFilters.country.has(country);
                });
            }

            tableData = filtered;
            renderTable(tableData);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
        }

        function updateActiveFiltersIndicator() {
            const totalActive = (activeFilters.status.has('all') ? 0 : activeFilters.status.size) + activeFilters.type.size + activeFilters.country.size;
            const indicator = document.getElementById('activeFiltersInfo');
            const countEl = document.getElementById('activeFilterCount');

            if (totalActive > 0) {
                indicator.classList.remove('hidden');
                indicator.classList.add('flex');
                countEl.textContent = totalActive;
            } else {
                indicator.classList.add('hidden');
                indicator.classList.remove('flex');
            }
        }

        function clearAllFilters() {
            activeFilters.status.clear();
            activeFilters.status.add('all');
            activeFilters.type.clear();
            activeFilters.country.clear();

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');

            document.getElementById('tableSearch').value = '';
            updateCountryFilterIcon();
            applyFilters();
            updateActiveFiltersIndicator();
        }

        // ===== COUNTRY FILTER FUNCTIONS =====
        let tempSelectedCountries = new Set();

        function toggleCountryFilter(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('countryFilterDropdown');
            const isHidden = dropdown.classList.contains('hidden');

            if (isHidden) {
                // Populate country list from current data
                populateCountryList();
                // Copy current filters to temp selection
                tempSelectedCountries = new Set(activeFilters.country);
                dropdown.classList.remove('hidden');
                document.getElementById('countrySearchInput').focus();

                // Add click outside listener
                setTimeout(() => {
                    document.addEventListener('click', closeCountryFilterOnClickOutside);
                }, 0);
            } else {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeCountryFilterOnClickOutside);
            }
        }

        function closeCountryFilterOnClickOutside(event) {
            const dropdown = document.getElementById('countryFilterDropdown');
            const filterBtn = event.target.closest('.country-filter-btn');

            if (!dropdown.contains(event.target) && !filterBtn) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeCountryFilterOnClickOutside);
            }
        }

        function populateCountryList() {
            const container = document.getElementById('countryListContainer');
            const searchInput = document.getElementById('countrySearchInput');
            searchInput.value = '';

            // Get unique countries from fullTableData
            const countries = [...new Set(fullTableData.map(d => d.developer_country || '').filter(c => c !== ''))].sort();

            if (countries.length === 0) {
                container.innerHTML = '<div class="text-xs text-slate-400 p-2 text-center">No countries available</div>';
                return;
            }

            container.innerHTML = countries.map(country => {
                const isChecked = tempSelectedCountries.has(country) ? 'checked' : '';
                const escapedCountry = country.replace(/'/g, "\\'");
                return `
                    <label class="country-option flex items-center gap-2 px-2 py-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded cursor-pointer text-sm text-slate-700 dark:text-slate-300" data-country="${country}">
                        <input type="checkbox" class="country-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500" value="${escapedCountry}" ${isChecked} onchange="toggleCountrySelection('${escapedCountry}')">
                        <span class="country-name">${country}</span>
                    </label>
                `;
            }).join('');
        }

        function filterCountryList() {
            const searchValue = document.getElementById('countrySearchInput').value.toLowerCase();
            const options = document.querySelectorAll('.country-option');

            options.forEach(option => {
                const countryName = option.querySelector('.country-name').textContent.toLowerCase();
                if (countryName.includes(searchValue)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function toggleCountrySelection(country) {
            if (tempSelectedCountries.has(country)) {
                tempSelectedCountries.delete(country);
            } else {
                tempSelectedCountries.add(country);
            }
        }

        function applyCountryFilter() {
            activeFilters.country = new Set(tempSelectedCountries);
            document.getElementById('countryFilterDropdown').classList.add('hidden');
            document.removeEventListener('click', closeCountryFilterOnClickOutside);

            updateCountryFilterIcon();
            applyFilters();
            updateActiveFiltersIndicator();
        }

        function clearCountryFilter() {
            tempSelectedCountries.clear();
            document.querySelectorAll('.country-checkbox').forEach(cb => cb.checked = false);
        }

        function updateCountryFilterIcon() {
            const icon = document.getElementById('countryFilterIcon');
            if (activeFilters.country.size > 0) {
                icon.classList.remove('text-slate-400');
                icon.classList.add('text-blue-600');
            } else {
                icon.classList.remove('text-blue-600');
                icon.classList.add('text-slate-400');
            }
        }

        // ===== PASTE FILTER FUNCTIONS =====
        function togglePasteFilter() {
            const area = document.getElementById('pasteFilterArea');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                document.getElementById('pasteFilterInput').focus();
            } else {
                area.classList.add('hidden');
            }
        }

        function applyPasteFilter() {
            const rawInput = document.getElementById('pasteFilterInput').value;
            if (!rawInput || rawInput.trim() === '') {
                showToast("Please paste some Emails or IDs first.", "warning");
                return;
            }

            const filterList = rawInput.split(/[\n,]+/).map(item => item.trim().toLowerCase()).filter(item => item !== '');
            if (filterList.length === 0) return;

            const filtered = fullTableData.filter(d => {
                const idMatch = filterList.includes(d.developer_id.toString().toLowerCase());
                const emailMatch = filterList.includes(d.email.toLowerCase());
                return idMatch || emailMatch;
            });

            tableData = filtered;
            renderTable(filtered);
            updateCounts(filtered);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
            showToast(`Found ${filtered.length} matches out of ${fullTableData.length} records.`, "success");
            togglePasteFilter();
        }

        function clearPasteFilter() {
            document.getElementById('pasteFilterInput').value = '';
            tableData = [...fullTableData];
            renderTable(tableData);
            updateCounts(fullTableData);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
            applyFilters();
        }

        // ===== SEARCH FUNCTION =====
        function searchTable() {
            const searchValue = document.getElementById('tableSearch').value.toLowerCase();
            if (!searchValue) {
                applyFilters();
                return;
            }
            const filtered = tableData.filter(d => {
                return d.developer_id.toString().includes(searchValue) ||
                        d.full_name.toLowerCase().includes(searchValue) ||
                        d.email.toLowerCase().includes(searchValue) ||
                        (d.status && d.status.toLowerCase().includes(searchValue));
            });
            renderTable(filtered);
        }

        // --- Main Data Fetch ---
        function fetchData() {
            const jobId = document.getElementById('jobId').value;
            const stages = Array.from(document.querySelectorAll('.smart-chip.active')).map(e => e.dataset.value);
            
            if(!jobId || stages.length === 0) {
                showToast("Enter Job ID & Select Stages", "warning");
                return;
            }

            const btn = document.getElementById('fetchBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Fetching...';
            
            google.script.run
                .withSuccessHandler(data => {
                    tableData = data;
                    fullTableData = data;
                    document.getElementById('tableControls').classList.remove('hidden');
                    document.getElementById('statusFilterContainer').classList.remove('hidden');
                    document.getElementById('tableContainer').classList.remove('hidden');
                    
                    renderTable(data);
                    updateCounts(data);
                    
                    btn.innerHTML = originalHtml;
                    showToast(`Loaded ${data.length} candidates`, "success");
                })
                .withFailureHandler(err => {
                    btn.innerHTML = originalHtml;
                    showToast("Error: " + err.message, "error");
                })
                .getDevelopers(jobId, stages);
        }

        function updateCounts(data) {
            const allCount = data.length;
            const newCount = data.filter(d => !d.is_sent && !d.is_manual_sent).length;
            const followupCount = data.filter(d => d.is_sent && !d.is_manual_sent).length;
            const manualCount = data.filter(d => d.is_manual_sent).length;
            const subCount = data.filter(d => d.candidate_status === 'Agency Sub-Contractor').length;
            const agencyCount = data.filter(d => d.candidate_status === 'Agency Contractor').length;
            const directCount = data.filter(d => d.candidate_status === 'Independent' || !d.candidate_status).length;

            document.getElementById('allCount').textContent = allCount;
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('followupCount').textContent = followupCount;
            document.getElementById('manualCount').textContent = manualCount;
            document.getElementById('subCount').textContent = subCount;
            document.getElementById('agencyCount').textContent = agencyCount;
            document.getElementById('directCount').textContent = directCount;
        }

        function renderTable(data) {
            const tbody = document.querySelector('#devTable tbody');
            tbody.innerHTML = '';

            data.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700 transition";

                // Status badge with consistent styling
                let statusBadge = `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300">${d.status}</span>`;

                // Type badge with colors based on candidate type
                let typeBadge = '';
                const candidateType = d.candidate_status || 'Independent';
                if (candidateType === 'Agency Sub-Contractor') {
                    typeBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200"><i class="fa-solid fa-people-arrows text-[10px]"></i> SUB-CON</span>`;
                } else if (candidateType === 'Agency Contractor') {
                    typeBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200"><i class="fa-solid fa-building text-[10px]"></i> AGENCY</span>`;
                } else {
                    typeBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-green-100 text-green-700 border border-green-200"><i class="fa-solid fa-user text-[10px]"></i> DIRECT</span>`;
                }

                // History badge with colors
                let historyBadge = '';
                if (d.is_sent && !d.is_manual_sent) {
                    historyBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-red-100 text-red-700 border border-red-200"><i class="fa-solid fa-paper-plane text-[10px]"></i> Sent</span>`;
                } else if (d.is_manual_sent) {
                    historyBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200"><i class="fa-solid fa-hand text-[10px]"></i> M.Sent</span>`;
                } else {
                    historyBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-emerald-100 text-emerald-700 border border-emerald-200"><i class="fa-solid fa-sparkles text-[10px]"></i> New</span>`;
                }

                // Row class for sent status
                if (d.is_manual_sent) {
                    tr.classList.add('manual-sent-row');
                } else if (d.is_sent) {
                    tr.classList.add('sent-row');
                }

                const isChecked = selectedDevs.has(d.developer_id) ? 'checked' : '';

                // Format phone number with country code
                const phoneDisplay = d.phone_number ?
                    (d.phone_country_code ? `+${d.phone_country_code} ${d.phone_number}` : d.phone_number) :
                    '-';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-center"><input type="checkbox" class="row-checkbox rounded" value="${d.developer_id}" ${isChecked} onchange="toggleRowCheckbox('${d.developer_id}')"></td>
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">${d.developer_id}</td>
                    <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200">${d.full_name}</td>
                    <td class="px-6 py-4 text-slate-500 dark:text-slate-400">${d.email}</td>
                    <td class="px-6 py-4 text-xs text-slate-600 dark:text-slate-400">${d.developer_country || '-'}</td>
                    <td class="px-6 py-4 text-xs text-slate-500 dark:text-slate-400 font-mono">${phoneDisplay}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4">${typeBadge}</td>
                    <td class="px-6 py-4">${historyBadge}</td>
                `;
                tbody.appendChild(tr);
            });
            updateBulkUI();
        }

        // --- Checkbox Logic ---
        function toggleMasterCheckbox() {
            const master = document.getElementById('masterCheckbox');
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = master.checked;
                if(master.checked) selectedDevs.add(cb.value);
                else selectedDevs.delete(cb.value);
            });
            updateBulkUI();
        }
        function toggleRowCheckbox(id) {
            if(selectedDevs.has(id)) selectedDevs.delete(id);
            else selectedDevs.add(id);
            updateBulkUI();
        }
        function updateBulkUI() {
            const bar = document.getElementById('bulkActionBar');
            const count = selectedDevs.size;

            // Update both the floating bar count and the selection indicator
            document.getElementById('bulkSelectedCount').textContent = count;
            document.getElementById('quickSelectedCount').textContent = count;

            // Show/hide floating action bar
            if(count > 0) {
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }

            // Show/hide selection indicator
            const indicator = document.getElementById('selectionIndicator');
            if(count > 0) {
                indicator.classList.remove('hidden');
                indicator.classList.add('flex');
            } else {
                indicator.classList.add('hidden');
                indicator.classList.remove('flex');
            }
        }
        function deselectAll() {
            selectedDevs.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            updateBulkUI();
        }
        function selectAllResults() {
            tableData.forEach(d => selectedDevs.add(d.developer_id));
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = true);
            updateBulkUI();
        }

        function copyToClipboard() {
            if (selectedDevs.size === 0) {
                showToast("Please select at least one candidate", "warning");
                return;
            }
            const emails = tableData.filter(d => selectedDevs.has(d.developer_id)).map(d => d.email).join(', ');
            navigator.clipboard.writeText(emails).then(() => {
                showToast(`Copied ${selectedDevs.size} emails to clipboard`, "success");
            }).catch(err => {
                showToast("Failed to copy to clipboard", "error");
            });
        }

        function downloadCSV() {
            if (tableData.length === 0) {
                showToast("No data to export", "warning");
                return;
            }

            const dataToExport = selectedDevs.size > 0
                ? tableData.filter(d => selectedDevs.has(d.developer_id))
                : tableData;

            let csv = "Developer ID,Candidate Name,Email,Pipeline Status,Type,Agency Name,Outreach History\n";
            dataToExport.forEach(d => {
                let typeDisplay = 'Direct';
                if (d.candidate_status === 'Agency Sub-Contractor') typeDisplay = 'Sub-Contractor';
                else if (d.candidate_status === 'Agency Contractor') typeDisplay = 'Agency';

                let historyDisplay = 'New';
                if (d.is_sent) historyDisplay = `Sent (${d.sent_count || 1})`;
                else if (d.is_manual_sent) historyDisplay = `M.Sent (${d.manual_sent_count || 1})`;

                csv += `"${d.developer_id}","${d.full_name}","${d.email}","${d.status}","${typeDisplay}","${d.agency_name || ''}","${historyDisplay}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `developers_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${dataToExport.length} records`, "success");
        }

        // --- Tasks Logic ---
        function loadTasks() {
            const tbody = document.getElementById('taskListBody');
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center"><i class="fa-solid fa-spinner fa-spin"></i></td></tr>';
            
            const filters = {
                jobId: document.getElementById('taskJobFilter').value,
                status: document.getElementById('taskStatusFilter').value,
                forceRefresh: true
            };

            google.script.run.withSuccessHandler(res => {
                // Update Stats
                if(res.stats) {
                    document.getElementById('statTotal').textContent = res.stats.total;
                    document.getElementById('statActive').textContent = res.stats.active;
                    document.getElementById('statHuman').textContent = res.stats.human;
                    document.getElementById('statAccepted').textContent = res.stats.accepted;
                }
                // Render Table
                const tasks = res.tasks || [];
                tbody.innerHTML = '';
                if(tasks.length === 0) {
                    document.getElementById('emptyTaskState').classList.remove('hidden');
                    tbody.parentElement.classList.add('hidden'); 
                } else {
                    document.getElementById('emptyTaskState').classList.add('hidden');
                    tbody.parentElement.classList.remove('hidden');
                    
                    tasks.forEach(t => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 border-b border-slate-50 transition task-row";
                        tr.dataset.email = t.email;
                        
                        // Badge Logic
                        let badgeClass = 'bg-blue-100 text-blue-700';
                        if(t.tags.includes('Human')) badgeClass = 'bg-amber-100 text-amber-700';
                        else if(t.status === 'Offer Accepted') badgeClass = 'bg-green-100 text-green-700';

                        const isChecked = selectedTasks.has(t.email) ? 'checked' : '';
                        if(selectedTasks.has(t.email)) tr.classList.add('selected');

                        tr.innerHTML = `
                            <td class="px-6 py-4 text-center"><input type="checkbox" class="task-check rounded" onchange="toggleTaskSelection('${t.email}')" ${isChecked}></td>
                            <td class="px-6 py-4 font-mono text-xs">${t.jobId}</td>
                            <td class="px-6 py-4 font-bold text-slate-800">${t.name}</td>
                            <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${t.tags}</span></td>
                            <td class="px-6 py-4 text-xs text-slate-500 truncate max-w-xs cursor-pointer hover:text-blue-600" onclick="showNotes(\`${encodeURIComponent(t.aiNotes)}\`)">${t.aiNotes && t.aiNotes.length > 0 ? t.aiNotes.substring(0,40)+'...' : '-'}</td>
                            <td class="px-6 py-4 text-xs text-slate-400">${t.lastReply || 'N/A'}</td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end">
                                    <button onclick="markAsDone('${t.email}', '${t.jobId}', '${t.tags}', this)" class="bg-green-100 hover:bg-green-200 text-green-700 border border-green-300 px-3 py-1.5 rounded-lg text-sm font-medium transition inline-flex items-center gap-1"><i class="fa-solid fa-check"></i> Complete</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                // Update cache
                dataCache.tasks = { data: res, lastLoaded: Date.now() };
            }).getAllTasks(filters);
        }

        function filterTasks() { loadTasks(); }

        function toggleAllTasks(master) {
            const checks = document.querySelectorAll('.task-check');
            checks.forEach(c => {
                c.checked = master.checked;
                const row = c.closest('.task-row');
                if(row) {
                    const email = row.dataset.email;
                    if(master.checked) {
                        selectedTasks.add(email);
                        row.classList.add('selected');
                    } else {
                        selectedTasks.delete(email);
                        row.classList.remove('selected');
                    }
                }
            });
            updateBulkActionsBar();
        }

        function toggleTaskSelection(email) {
            if(selectedTasks.has(email)) {
                selectedTasks.delete(email);
            } else {
                selectedTasks.add(email);
            }
            updateBulkActionsBar();
            document.querySelectorAll('.task-row').forEach(row => {
                if(row.dataset.email === email) {
                    row.classList.toggle('selected', selectedTasks.has(email));
                }
            });
        }

        function clearTaskSelection() {
            selectedTasks.clear();
            document.querySelectorAll('.task-check').forEach(c => c.checked = false);
            document.querySelectorAll('.task-row').forEach(r => r.classList.remove('selected'));
            document.querySelector('.task-master-check').checked = false;
            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = document.getElementById('taskSelectedCount');
            if(selectedTasks.size > 0) {
                bar.classList.remove('hidden');
                bar.classList.add('flex'); // Ensure flex is added
                count.textContent = selectedTasks.size;
            } else {
                bar.classList.add('hidden');
                bar.classList.remove('flex');
            }
        }

        function showNotes(encodedNotes) {
            try {
                const notes = decodeURIComponent(encodedNotes);
                document.getElementById('notesModalContent').innerText = notes;
                document.getElementById('notesModal').classList.remove('hidden');
            } catch(e) {
                console.error("Error showing notes:", e);
            }
        }

        // --- Follow Up Logic ---
        function loadFollowUpStats() {
            const tbody = document.getElementById('followUpTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center"><i class="fa-solid fa-spinner fa-spin"></i></td></tr>';
            
            const filters = {
                jobId: document.getElementById('followUpJobFilter').value,
                status: document.getElementById('followUpStatusFilter').value
            };

            google.script.run.withSuccessHandler(res => {
                // Update Stats Cards
                if(res.stats) {
                    document.getElementById('statPending').textContent = res.stats.pending;
                    document.getElementById('statFollowUp1').textContent = res.stats.followUp1Done;
                    document.getElementById('statFollowUp2').textContent = res.stats.followUp2Done;
                    document.getElementById('statResponded').textContent = res.stats.responded;
                }
                // Render Table
                tbody.innerHTML = '';
                const data = res.data || [];
                if(data.length === 0) {
                    document.getElementById('emptyFollowUpState').classList.remove('hidden');
                } else {
                    document.getElementById('emptyFollowUpState').classList.add('hidden');
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 border-b border-slate-50";

                        // Status badge colors
                        let statusBadge = '';
                        const status = item.followUpStatus || 'Pending';
                        if(status === 'Pending') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-700">Pending</span>';
                        } else if(status.includes('1') || status === 'Follow-Up-1-Sent') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-amber-100 text-amber-700">1st Follow-Up Sent</span>';
                        } else if(status.includes('2') || status === 'Follow-Up-2-Sent') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-orange-100 text-orange-700">2nd Follow-Up Sent</span>';
                        } else if(status === 'Responded') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700">Responded</span>';
                        } else {
                            statusBadge = `<span class="px-2 py-1 rounded text-xs font-bold bg-blue-100 text-blue-700">${status}</span>`;
                        }

                        tr.innerHTML = `
                            <td class="px-6 py-4 font-mono text-xs">${item.jobId}</td>
                            <td class="px-6 py-4 font-bold">${item.name}</td>
                            <td class="px-6 py-4 text-slate-500">${item.email}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">${formatDateTime(item.lastReachedOut)}</td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end">
                                    <button onclick="markAsUnresponsive('${item.email}', this)" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-3 py-1.5 rounded-lg text-xs font-medium transition inline-flex items-center gap-1"><i class="fa-solid fa-user-xmark"></i> Unresponsive</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                // Update cache
                dataCache.followups = { data: res, lastLoaded: Date.now() };
            }).getFollowUpDataCombined(filters);
        }

        function loadFollowUpData() { loadFollowUpStats(); }

        // --- Settings / Config Logic Wrapper ---
        function openConfigLogic() {
            // Trigger refresh
            refreshTriggerStatus(); 
        }
        function refreshTriggerStatus() {
            const cont = document.getElementById('triggerStatusContainer');

            // Use cache if valid
            if(isCacheValid('triggers')) {
                renderTriggerStatus(dataCache.triggers.data);
                return;
            }

            cont.innerHTML = '<div class="text-xs text-slate-400">Loading triggers...</div>';
            google.script.run.withSuccessHandler(res => {
                // Update cache
                dataCache.triggers = { data: res, lastLoaded: Date.now() };
                renderTriggerStatus(res);
            }).getTriggerStatus();
        }

        function renderTriggerStatus(res) {
            const cont = document.getElementById('triggerStatusContainer');
            let html = '';
            res.status.triggers.forEach(t => {
                const color = t.exists ? 'text-green-600' : 'text-red-500';
                const icon = t.exists ? 'fa-check' : 'fa-times';
                html += `<div class="flex justify-between text-sm items-center p-2 bg-slate-50 rounded mb-1">
                    <span>${t.functionName}</span>
                    <span class="${color}"><i class="fa-solid ${icon}"></i></span>
                </div>`;
            });
            cont.innerHTML = html;
            if(res.status.missingCount > 0) document.getElementById('createTriggersSection').classList.remove('hidden');
            else document.getElementById('allTriggersGood').classList.remove('hidden');
        }

        // --- Email Panel Logic ---
        // Job settings state
        let jobSettings = {
            negotiation: true,
            followUp: true,
            dataGathering: true
        };

        // Format Painter state
        let formatPainterActive = false;
        let capturedFormat = null;

        function openEmailPanel() {
            if(selectedDevs.size === 0) { showToast("Select candidates first", "warning"); return; }
            document.getElementById('emailRecipientCount').textContent = selectedDevs.size;

            // Preview logic
            const recipients = tableData.filter(d => selectedDevs.has(d.developer_id));
            const preview = recipients.slice(0, 5).map(r => r.email).join(', ');
            document.getElementById('emailRecipientPreview').textContent = recipients.length > 5 ? preview + ` +${recipients.length - 5} more` : preview;

            // Refresh templates logic
            refreshTemplates();

            // Reset job settings to defaults
            jobSettings = { negotiation: true, followUp: true, dataGathering: true };
            updateJobTogglesUI();
            updateJobTypeHint();

            // Clear format painter state
            formatPainterActive = false;
            capturedFormat = null;
            const fpBtn = document.getElementById('formatPainterBtn');
            if(fpBtn) fpBtn.classList.remove('active');

            document.getElementById('emailModalOverlay').classList.add('open');
        }

        function closeEmailPanel() {
            document.getElementById('emailModalOverlay').classList.remove('open');
        }

        function handleModalOverlayClick(event) {
            if(event.target.id === 'emailModalOverlay') {
                closeEmailPanel();
            }
        }

        // Toggle job settings
        function toggleJobSetting(setting) {
            jobSettings[setting] = !jobSettings[setting];
            updateJobTogglesUI();
            updateJobTypeHint();
        }

        function updateJobTogglesUI() {
            const toggleNeg = document.getElementById('toggleNegotiation');
            const toggleFollow = document.getElementById('toggleFollowUp');
            const toggleData = document.getElementById('toggleDataGathering');

            if(toggleNeg) toggleNeg.classList.toggle('active', jobSettings.negotiation);
            if(toggleFollow) toggleFollow.classList.toggle('active', jobSettings.followUp);
            if(toggleData) toggleData.classList.toggle('active', jobSettings.dataGathering);
        }

        function updateJobTypeHint() {
            const hintText = document.getElementById('jobTypeHintText');
            if(!hintText) return;

            const parts = [];
            if(jobSettings.negotiation) parts.push('Negotiation');
            if(jobSettings.followUp) parts.push('Follow-up');
            if(jobSettings.dataGathering) parts.push('Data Gathering');

            if(parts.length === 0) {
                hintText.textContent = 'No features enabled. This will be a simple announcement email.';
            } else {
                const features = parts.join(' + ');
                let description = '';
                if(jobSettings.negotiation && jobSettings.followUp) {
                    description = 'AI will negotiate and send automated reminders.';
                } else if(jobSettings.negotiation) {
                    description = 'AI will negotiate rates, no automatic follow-ups.';
                } else if(jobSettings.followUp && jobSettings.dataGathering) {
                    description = 'Responses will be collected with follow-up reminders.';
                } else if(jobSettings.dataGathering) {
                    description = 'Responses will be collected and tracked.';
                } else if(jobSettings.followUp) {
                    description = 'Automated follow-ups will be sent if no response.';
                } else {
                    description = 'Selected features are enabled.';
                }
                hintText.textContent = `${features} enabled. ${description}`;
            }
        }

        // Rich text editor formatting functions
        function formatText(cmd, value = null) {
            document.getElementById('emailBody').focus();
            if(cmd === 'formatBlock') {
                document.execCommand(cmd, false, value);
            } else {
                document.execCommand(cmd, false, value);
            }
            handleEditorInput();
        }

        // Format Painter
        function handleFormatPainter() {
            const btn = document.getElementById('formatPainterBtn');

            if(!formatPainterActive) {
                // Copy mode - capture current formatting
                const selection = window.getSelection();
                if(selection.rangeCount > 0) {
                    capturedFormat = {
                        bold: document.queryCommandState('bold'),
                        italic: document.queryCommandState('italic'),
                        underline: document.queryCommandState('underline')
                    };
                    formatPainterActive = true;
                    btn.classList.add('active');
                    showToast('Format copied! Select text to apply.', 'info');
                } else {
                    showToast('Select text first to copy its format.', 'warning');
                }
            } else {
                // Apply mode
                if(capturedFormat) {
                    // First remove all formatting
                    document.execCommand('removeFormat', false, null);

                    // Then apply captured formatting
                    if(capturedFormat.bold) document.execCommand('bold', false, null);
                    if(capturedFormat.italic) document.execCommand('italic', false, null);
                    if(capturedFormat.underline) document.execCommand('underline', false, null);

                    showToast('Format applied!', 'success');
                }

                // Reset format painter
                formatPainterActive = false;
                capturedFormat = null;
                btn.classList.remove('active');
            }
        }

        function handleEditorInput() {
            const editor = document.getElementById('emailBody');
            const hiddenField = document.getElementById('htmlBody');
            if(editor && hiddenField) {
                hiddenField.value = editor.innerHTML;
            }
        }

        // Get job type string for backend compatibility
        function getJobTypeFromSettings() {
            // Map toggle settings to job type for backend
            if(jobSettings.negotiation && jobSettings.followUp) {
                return 'negotiation';
            } else if(jobSettings.dataGathering && jobSettings.followUp) {
                return 'data_gathering';
            } else if(!jobSettings.followUp) {
                return 'informing';
            } else {
                return 'negotiation'; // default
            }
        }

        // --- Negotiation Config ---
        function loadNegotiationConfig() {
            const jId = document.getElementById('negJobId').value;
            if(!jId) return;
            google.script.run.withSuccessHandler(cfg => {
                if(cfg) {
                    document.getElementById('targetRate').value = cfg.targetRate || '';
                    document.getElementById('maxRate').value = cfg.maxRate || '';
                    document.getElementById('negStyle').value = cfg.style || 'Friendly but firm';
                    document.getElementById('specialRules').value = cfg.specialRules || '';
                    document.getElementById('jobDescription').value = cfg.jobDescription || '';
                }
            }).getNegotiationConfig(jId);
            refreshRateTiers();
        }

        // --- Initial Load ---
        $(document).ready(() => {
            // Load DB URL
            google.script.run.withSuccessHandler(url => document.getElementById('sheetUrl').value = url).getStoredSheetUrl();
            google.script.run.withSuccessHandler(url => document.getElementById('jobsSheetUrl').value = url).getStoredJobsSheetUrl();
        });

        // --- RESTORED COMPLEX LOGIC ---
        
        function manualTriggerAI() {
            if(!confirm("Start AI negotiation sweep? This will process all configured jobs.")) return;
            
            const btn = document.getElementById('runAiBtn');
            const progressPanel = document.getElementById('aiProgressPanel');
            const logContainer = document.getElementById('aiLogContainer');
            const statusEl = document.getElementById('aiProgressStatus');
            
            progressPanel.classList.remove('hidden');
            logContainer.innerHTML = '';
            addLog('info', 'Starting AI Negotiator...');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Running...';
            btn.disabled = true;
            
            google.script.run
                .withSuccessHandler(res => {
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <span>Run AI Now</span>';
                    btn.disabled = false;
                    
                    if(res.status === 'Success') {
                        statusEl.textContent = 'Completed!';
                        
                        if(res.log && res.log.length > 0) {
                            res.log.forEach(l => addLog(l.type, l.message));
                        }
                        
                        let summary = ` Complete! Replied: ${res.stats.replied}, Escalated: ${res.stats.escalated}, Accepted: ${res.stats.accepted}`;
                        addLog('success', summary);
                        showToast(summary, "success");
                        loadTasks();
                    } else {
                        statusEl.textContent = 'Error';
                        addLog('error', 'Error: ' + res.message);
                        showToast("AI Error: " + res.message, "error");
                    }
                })
                .withFailureHandler(err => {
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <span>Run AI Now</span>';
                    btn.disabled = false;
                    statusEl.textContent = 'Failed';
                    addLog('error', 'Failed: ' + err.message);
                    showToast("Failed: " + err.message, "error");
                })
                .runAutoNegotiator();
        }

        function addLog(type, message) {
            const container = document.getElementById('aiLogContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'triangle-exclamation' : type === 'error' ? 'circle-xmark' : 'circle-info';
            entry.innerHTML = `<i class="fa-solid fa-${icon} mr-1"></i> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function saveConfig() {
            const databaseUrl = document.getElementById('sheetUrl').value;
            const jobsUrl = document.getElementById('jobsSheetUrl').value;

            if(!databaseUrl || !jobsUrl) {
                showToast("Please enter both URLs", "warning");
                return;
            }

            const btn = document.getElementById('saveConfigBtn');
            const btnText = document.getElementById('saveConfigText');
            const spinner = document.getElementById('saveConfigSpinner');

            btn.disabled = true;
            btnText.textContent = 'Saving...';
            spinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(() => {
                    btn.disabled = false;
                    btnText.textContent = 'Save';
                    spinner.classList.add('hidden');
                    showToast("Settings saved!", "success");
                    document.getElementById('configModal').classList.add('hidden');
                })
                .withFailureHandler(err => {
                    btn.disabled = false;
                    btnText.textContent = 'Save';
                    spinner.classList.add('hidden');
                    showToast("Error: " + err.message, "error");
                })
                .saveSheetUrls(databaseUrl, jobsUrl);
        }

        function createAllTriggers() {
            const btn = document.getElementById('createAllTriggersBtn');
            const btnText = document.getElementById('createTriggersText');
            const spinner = document.getElementById('createTriggersSpinner');

            btn.disabled = true;
            btnText.textContent = 'Creating...';
            spinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(result => {
                    btn.disabled = false;
                    btnText.textContent = 'Create Missing Triggers';
                    spinner.classList.add('hidden');
                    if (result.success) {
                        showToast(`Created ${result.results.created.length} trigger(s)!`, 'success');
                        refreshTriggerStatus();
                    } else {
                        showToast(result.error, 'error');
                    }
                })
                .createAllMissingTriggers();
        }

        // Legacy function kept for compatibility - now uses toggle system
        function handleJobTypeChange() {
            // This function is deprecated - use toggle system instead
            updateJobTypeHint();
        }

        function sendEmails() {
            const subject = document.getElementById('emailSubject').value;
            const senderName = document.getElementById('senderName')?.value || '';

            // Get body from rich text editor (HTML content)
            const emailBodyEl = document.getElementById('emailBody');
            const body = emailBodyEl.innerHTML || emailBodyEl.innerText || '';
            const plainTextBody = emailBodyEl.innerText || '';

            const recipients = tableData.filter(d => selectedDevs.has(d.developer_id)).map(d => ({
                name: d.full_name,
                email: d.email,
                devId: d.developer_id,
                region: d.region || ''
            }));
            const jobId = document.getElementById('jobId').value;

            // Get job type from toggle settings
            const jobType = getJobTypeFromSettings();

            if(!recipients.length) { showToast("No recipients", "warning"); return; }
            if(!jobId) { showToast("Missing Job ID", "warning"); return; }
            if(!subject || !plainTextBody.trim()) { showToast("Missing subject or content", "warning"); return; }

            // Check if user wants to save as template
            const saveAsTemplate = document.getElementById('saveAsTemplateCheck')?.checked;
            if(saveAsTemplate) {
                const templateName = prompt("Enter template name:");
                if(templateName) {
                    google.script.run.saveEmailTemplate(templateName, subject, body, jobId);
                }
            }

            const btn = document.getElementById('sendEmailBtn');
            const progressContainer = document.getElementById('sendProgressContainer');

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;
            progressContainer.classList.remove('hidden');

            // Fake progress animation
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if(progress > 90) progress = 90;
                document.getElementById('sendProgressBar').style.width = progress + '%';
            }, 300);

            // Build options with all job settings
            const opts = {
                jobType: jobType,
                jobSettings: jobSettings, // Pass full settings object
                senderName: senderName
            };

            google.script.run
                .withSuccessHandler(result => {
                    clearInterval(interval);
                    document.getElementById('sendProgressBar').style.width = '100%';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Campaign';
                        btn.disabled = false;
                        progressContainer.classList.add('hidden');
                        document.getElementById('sendProgressBar').style.width = '0%';

                        if(result.sent > 0) {
                            showToast(`Sent ${result.sent} emails!`, "success");
                            closeEmailPanel();
                            fetchData();
                            // Clear form
                            document.getElementById('emailSubject').value = '';
                            document.getElementById('emailBody').innerHTML = '';
                            if(document.getElementById('senderName')) document.getElementById('senderName').value = '';
                            if(document.getElementById('saveAsTemplateCheck')) document.getElementById('saveAsTemplateCheck').checked = false;
                        } else {
                            showToast("No emails sent (duplicates?)", "warning");
                        }
                    }, 500);
                })
                .withFailureHandler(err => {
                    clearInterval(interval);
                    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Campaign';
                    btn.disabled = false;
                    progressContainer.classList.add('hidden');
                    document.getElementById('sendProgressBar').style.width = '0%';
                    showToast("Error: " + err.message, "error");
                })
                .sendBulkEmails(recipients, senderName, subject, body, jobId, opts);
        }

        function saveNegotiationSettings() {
            const jobId = document.getElementById('negJobId').value;
            if(!jobId) { showToast("Enter Job ID", "warning"); return; }
            
            const config = {
                targetRate: document.getElementById('targetRate').value,
                maxRate: document.getElementById('maxRate').value,
                style: document.getElementById('negStyle').value,
                specialRules: document.getElementById('specialRules').value,
                jobDescription: document.getElementById('jobDescription').value
            };
            
            google.script.run.withSuccessHandler(() => {
                showToast("Configuration saved!", "success");
                refreshJobDropdown();
            }).saveNegotiationConfig(jobId, config);
        }

        function loadManualData() {
            const raw = document.getElementById('manualDataInput').value;
            if(!raw.trim()) return;
            const lines = raw.split('\n');
            const manualData = lines.map((line) => {
                const parts = line.split(',');
                const email = parts[0];
                const name = parts[1];
                const region = parts[2];
                if(!email) return null;
                return {
                    developer_id: `TEST-${Math.floor(Math.random()*10000)}`,
                    full_name: name ? name.trim() : 'Test Candidate',
                    email: email.trim(),
                    region: region ? region.trim() : '',
                    status: 'Manual Test',
                    is_sent: false
                };
            }).filter(d => d !== null);
            tableData = manualData;
            fullTableData = manualData;
            document.getElementById('tableContainer').classList.remove('hidden');
            document.getElementById('statusFilterContainer').classList.remove('hidden');
            document.getElementById('tableControls').classList.remove('hidden');
            renderTable(tableData);
            document.getElementById('manualInputModal').classList.add('hidden');
            showToast(`Loaded ${manualData.length} test candidates`, "success");
        }

        // Functions for button calls
        function selectJobFromDropdown(v) { 
            if(!v) return;
            document.getElementById('negJobId').value = v; 
            loadNegotiationConfig(); 
        }
        function refreshJobDropdown() { 
            google.script.run.withSuccessHandler(jobs => {
                const s = document.getElementById('activeJobsDropdown');
                s.innerHTML = '<option value="">-- Select --</option>';
                jobs.forEach(j => s.innerHTML += `<option value="${j}">Job ${j}</option>`);
            }).getJobConfigList();
        }

        // Rate Tier Functions
        function refreshRateTiers() {
            const jobId = document.getElementById('negJobId').value;
            const tbody = document.getElementById('rateTiersBody');
            if(!jobId) return;
            
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
            
            google.script.run.withSuccessHandler(tiers => {
                if(!tiers || tiers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">No tiers loaded.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                tiers.forEach(tier => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 border-b border-slate-50';
                    row.innerHTML = `
                        <td class="px-4 py-2">${tier.region}</td>
                        <td class="px-4 py-2 text-green-600">$${tier.targetRate}</td>
                        <td class="px-4 py-2 text-amber-600">$${tier.maxRate}</td>
                        <td class="px-4 py-2 text-slate-500 text-xs">${tier.notes || '-'}</td>
                        <td class="px-4 py-2 text-right">
                            <button onclick="deleteRateTier('${tier.region}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }).getRateTiersForJob(jobId);
        }

        function addRateTier() {
            const jobId = document.getElementById('negJobId').value;
            const region = document.getElementById('tierRegion').value;
            const target = document.getElementById('tierTargetRate').value;
            const max = document.getElementById('tierMaxRate').value;
            const notes = document.getElementById('tierNotes').value;
            
            if(!jobId || !region || !target || !max) { showToast("Fill all fields", "warning"); return; }
            
            google.script.run.withSuccessHandler(() => {
                showToast("Rate tier added", "success");
                refreshRateTiers();
            }).saveRateTier(jobId, region, target, max, notes);
        }

        function deleteRateTier(region) {
            const jobId = document.getElementById('negJobId').value;
            if(!confirm("Delete tier?")) return;
            google.script.run.withSuccessHandler(() => {
                showToast("Deleted", "success");
                refreshRateTiers();
            }).deleteRateTier(jobId, region);
        }

        function manualTriggerFollowUps() {
            const btn = document.getElementById('runFollowUpBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;
            
            const progressPanel = document.getElementById('followUpProgressPanel');
            const logContainer = document.getElementById('followUpLogContainer');
            progressPanel.classList.remove('hidden');
            logContainer.innerHTML = '';
            
            google.script.run.withSuccessHandler(res => {
                btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-1"></i> Process Queue';
                btn.disabled = false;
                
                let msg = `Done! 1st: ${res.followUp1Sent}, 2nd: ${res.followUp2Sent}`;
                document.getElementById('followUpProgressStatus').textContent = msg;
                showToast(msg, "success");
                
                if(res.log) res.log.forEach(l => {
                    const entry = document.createElement('div');
                    entry.className = "mb-1";
                    entry.textContent = l.message;
                    logContainer.appendChild(entry);
                });
                
                loadFollowUpStats();
            }).runFollowUpProcessor();
        }

        function resetFollowUpStatuses() {
            if(!confirm("Reset statuses? This is usually for debugging.")) return;
            const btn = document.getElementById('resetStatusBtn');
            btn.disabled = true;
            google.script.run.withSuccessHandler(res => {
                btn.disabled = false;
                showToast(`Reset ${res.reset} entries`, "success");
                loadFollowUpStats();
            }).resetFollowUpStatus();
        }

        function refreshTemplates() {
            const jobId = document.getElementById('jobId').value || '';
            google.script.run.withSuccessHandler(templates => {
                cachedTemplates = templates;
                const select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">-- Select Template --</option>';
                templates.forEach((t, i) => {
                    select.innerHTML += `<option value="${i}">${t.name}</option>`;
                });
            }).getJobTemplates(jobId);
        }

        function loadSelectedTemplate() {
            const idx = document.getElementById('templateSelect').value;
            if(idx === '') return;
            const t = cachedTemplates[idx];
            document.getElementById('emailSubject').value = t.subject;
            // Use innerHTML for rich text editor (contenteditable div)
            const emailBody = document.getElementById('emailBody');
            emailBody.innerHTML = t.body;
            handleEditorInput(); // Update hidden field
        }

        function saveCurrentAsTemplate() {
            const name = prompt("Template Name:");
            if(!name) return;
            const subject = document.getElementById('emailSubject').value;
            // Get HTML content from rich text editor
            const emailBody = document.getElementById('emailBody');
            const body = emailBody.innerHTML || emailBody.innerText || '';
            const jobId = document.getElementById('jobId').value || '';

            google.script.run.withSuccessHandler(() => {
                showToast("Template Saved", "success");
                refreshTemplates();
            }).saveEmailTemplate(name, subject, body, jobId);
        }

        function markSelectedAsManualSent() {
            if(selectedDevs.size === 0) return;
            const jobId = document.getElementById('jobId').value;
            if(!jobId) { showToast("Enter Job ID", "warning"); return; }
            
            const ids = Array.from(selectedDevs);
            google.script.run.withSuccessHandler(res => {
                showToast(`Marked ${res.marked} as sent`, "success");
                fetchData();
            }).markAsManualSent(ids, jobId, "Bulk Manual Mark");
        }

        // --- Negotiation Completion Logic ---
        let pendingCompletion = null;

        function markAsDone(email, jobId, status, btn) {
            // Check for human negotiation
            if(status && (status.includes('Human') || status.includes('Escalated'))) {
                pendingCompletion = { email, jobId, btn };
                document.getElementById('completeHumanEmail').textContent = email;
                document.getElementById('completeHumanModal').classList.remove('hidden');
            } else {
                // Direct completion
                if(!confirm("Mark this negotiation as completed?")) return;
                const row = btn.closest('tr');
                row.style.opacity = '0.5';
                google.script.run.withSuccessHandler(() => {
                    loadTasks();
                    showToast("Completed", "success");
                }).moveToCompleted(email, "Manually Completed");
            }
        }

        function closeCompleteHumanModal() {
            document.getElementById('completeHumanModal').classList.add('hidden');
            pendingCompletion = null;
        }

        function toggleRateInput() {
            const chk = document.getElementById('noRateAgreed');
            document.getElementById('agreedRateInput').disabled = chk.checked;
        }

        function submitCompleteHuman() {
            if(!pendingCompletion) return;
            const { email, jobId } = pendingCompletion;
            const noRate = document.getElementById('noRateAgreed').checked;
            const rate = document.getElementById('agreedRateInput').value;
            const status = document.getElementById('completionStatus').value;
            
            let finalStatus = status || (rate ? 'Offer Accepted (Human)' : 'Completed (Human)');
            let finalRate = noRate ? null : rate;

            google.script.run.withSuccessHandler(() => {
                closeCompleteHumanModal();
                loadTasks();
                showToast("Completed", "success");
            }).completeHumanNegotiation(email, jobId, finalRate, finalStatus);
        }

        function markAsUnresponsive(email, btn) {
            if(!confirm("Mark as unresponsive? Stops follow-ups.")) return;
            const row = btn.closest('tr');
            row.style.opacity = '0.5';
            google.script.run.withSuccessHandler(() => {
                loadFollowUpStats();
                showToast("Updated", "success");
            }).markFollowUpAsUnresponsive(email);
        }

        function bulkCompleteSelected() {
            if(selectedTasks.size === 0) return;
            if(!confirm(`Complete ${selectedTasks.size} tasks?`)) return;
            
            google.script.run.withSuccessHandler(res => {
                showToast(`Completed ${res.success} tasks`, "success");
                loadTasks();
            }).bulkComplete(Array.from(selectedTasks), "Bulk Complete");
        }

        // --- Analytics ---
        let currentAnalyticsFilter = ''; // Track current email filter
        let currentAnalyticsJobFilter = ''; // Track current job ID filter

        // --- Email Filter Functions ---
        function handleAnalyticsFilterKeyup(event) {
            const input = document.getElementById('analyticsUserFilter');
            const clearBtn = document.getElementById('clearAnalyticsFilter');
            clearBtn.classList.toggle('hidden', !input.value);
            if(event.key === 'Enter') {
                hideAnalyticsEmailDropdown();
                applyAnalyticsFilter();
            }
            if(event.key === 'Escape') {
                hideAnalyticsEmailDropdown();
            }
        }

        // Debounce timer for email search
        let analyticsEmailSearchTimer = null;

        function handleAnalyticsEmailInput(event) {
            const query = event.target.value.trim();

            // Clear previous timer
            if (analyticsEmailSearchTimer) {
                clearTimeout(analyticsEmailSearchTimer);
            }

            // Hide dropdown if query is empty
            if (!query) {
                hideAnalyticsEmailDropdown();
                return;
            }

            // Debounce: wait 300ms after user stops typing
            analyticsEmailSearchTimer = setTimeout(() => {
                searchAnalyticsEmails(query);
            }, 300);
        }

        function handleAnalyticsEmailFocus() {
            const query = document.getElementById('analyticsUserFilter').value.trim();
            if (query) {
                searchAnalyticsEmails(query);
            }
        }

        function searchAnalyticsEmails(query) {
            google.script.run
                .withSuccessHandler(emails => {
                    renderAnalyticsEmailDropdown(emails, query);
                })
                .withFailureHandler(() => {
                    hideAnalyticsEmailDropdown();
                })
                .searchAnalyticsUsers(query);
        }

        function renderAnalyticsEmailDropdown(emails, query) {
            const dropdown = document.getElementById('analyticsEmailDropdown');

            if (!emails || emails.length === 0) {
                dropdown.innerHTML = `
                    <div class="px-4 py-3 text-sm text-slate-500 text-center">
                        <i class="fa-solid fa-search mr-2"></i>No users found matching "${query}"
                    </div>
                `;
                dropdown.classList.remove('hidden');
                return;
            }

            dropdown.innerHTML = emails.map(email => `
                <div class="px-4 py-2 hover:bg-indigo-50 cursor-pointer flex items-center gap-2 text-sm border-b border-slate-100 last:border-b-0"
                     onclick="selectAnalyticsEmail('${email}')">
                    <i class="fa-solid fa-user text-indigo-400"></i>
                    <span class="text-slate-700">${highlightMatch(email, query)}</span>
                </div>
            `).join('');

            dropdown.classList.remove('hidden');
        }

        function highlightMatch(text, query) {
            const lowerText = text.toLowerCase();
            const lowerQuery = query.toLowerCase();
            const index = lowerText.indexOf(lowerQuery);

            if (index === -1) return text;

            const before = text.substring(0, index);
            const match = text.substring(index, index + query.length);
            const after = text.substring(index + query.length);

            return `${before}<span class="bg-yellow-200 font-semibold">${match}</span>${after}`;
        }

        function selectAnalyticsEmail(email) {
            document.getElementById('analyticsUserFilter').value = email;
            document.getElementById('clearAnalyticsFilter').classList.remove('hidden');
            hideAnalyticsEmailDropdown();
            applyAnalyticsFilter();
        }

        function hideAnalyticsEmailDropdown() {
            document.getElementById('analyticsEmailDropdown').classList.add('hidden');
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const emailInput = document.getElementById('analyticsUserFilter');
            const emailDropdown = document.getElementById('analyticsEmailDropdown');
            const jobInput = document.getElementById('analyticsJobFilter');
            const jobDropdown = document.getElementById('analyticsJobDropdown');

            if (emailInput && emailDropdown && !emailInput.contains(event.target) && !emailDropdown.contains(event.target)) {
                hideAnalyticsEmailDropdown();
            }
            if (jobInput && jobDropdown && !jobInput.contains(event.target) && !jobDropdown.contains(event.target)) {
                hideAnalyticsJobDropdown();
            }
        });

        function clearAnalyticsEmailFilter() {
            document.getElementById('analyticsUserFilter').value = '';
            document.getElementById('clearAnalyticsFilter').classList.add('hidden');
            currentAnalyticsFilter = '';
            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        // --- Job ID Filter Functions ---
        let analyticsJobSearchTimer = null;

        function handleAnalyticsJobFilterKeyup(event) {
            const input = document.getElementById('analyticsJobFilter');
            const clearBtn = document.getElementById('clearAnalyticsJobFilter');
            clearBtn.classList.toggle('hidden', !input.value);
            if(event.key === 'Enter') {
                hideAnalyticsJobDropdown();
                applyAnalyticsFilter();
            }
            if(event.key === 'Escape') {
                hideAnalyticsJobDropdown();
            }
        }

        function handleAnalyticsJobInput(event) {
            const query = event.target.value.trim();

            // Clear previous timer
            if (analyticsJobSearchTimer) {
                clearTimeout(analyticsJobSearchTimer);
            }

            // Hide dropdown if query is empty
            if (!query) {
                hideAnalyticsJobDropdown();
                return;
            }

            // Debounce: wait 300ms after user stops typing
            analyticsJobSearchTimer = setTimeout(() => {
                searchAnalyticsJobs(query);
            }, 300);
        }

        function handleAnalyticsJobFocus() {
            const query = document.getElementById('analyticsJobFilter').value.trim();
            if (query) {
                searchAnalyticsJobs(query);
            }
        }

        function searchAnalyticsJobs(query) {
            google.script.run
                .withSuccessHandler(jobs => {
                    renderAnalyticsJobDropdown(jobs, query);
                })
                .withFailureHandler(() => {
                    hideAnalyticsJobDropdown();
                })
                .searchAnalyticsJobIds(query);
        }

        function renderAnalyticsJobDropdown(jobs, query) {
            const dropdown = document.getElementById('analyticsJobDropdown');

            if (!jobs || jobs.length === 0) {
                dropdown.innerHTML = `
                    <div class="px-4 py-3 text-sm text-slate-500 text-center">
                        <i class="fa-solid fa-search mr-2"></i>No jobs found matching "${query}"
                    </div>
                `;
                dropdown.classList.remove('hidden');
                return;
            }

            dropdown.innerHTML = jobs.map(job => `
                <div class="px-4 py-2 hover:bg-amber-50 cursor-pointer flex items-center gap-2 text-sm border-b border-slate-100 last:border-b-0"
                     onclick="selectAnalyticsJob('${job}')">
                    <i class="fa-solid fa-briefcase text-amber-400"></i>
                    <span class="text-slate-700">Job ${highlightMatch(job, query)}</span>
                </div>
            `).join('');

            dropdown.classList.remove('hidden');
        }

        function selectAnalyticsJob(jobId) {
            document.getElementById('analyticsJobFilter').value = jobId;
            document.getElementById('clearAnalyticsJobFilter').classList.remove('hidden');
            hideAnalyticsJobDropdown();
            applyAnalyticsFilter();
        }

        function hideAnalyticsJobDropdown() {
            document.getElementById('analyticsJobDropdown').classList.add('hidden');
        }

        function clearAnalyticsJobFilter() {
            document.getElementById('analyticsJobFilter').value = '';
            document.getElementById('clearAnalyticsJobFilter').classList.add('hidden');
            currentAnalyticsJobFilter = '';
            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function clearAllAnalyticsFilters() {
            document.getElementById('analyticsUserFilter').value = '';
            document.getElementById('clearAnalyticsFilter').classList.add('hidden');
            document.getElementById('analyticsJobFilter').value = '';
            document.getElementById('clearAnalyticsJobFilter').classList.add('hidden');
            currentAnalyticsFilter = '';
            currentAnalyticsJobFilter = '';
            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function updateAnalyticsFilterStatus() {
            const statusDiv = document.getElementById('analyticsFilterStatus');
            const emailBadge = document.getElementById('analyticsFilterEmailBadge');
            const jobBadge = document.getElementById('analyticsFilterJobBadge');

            const hasEmailFilter = currentAnalyticsFilter !== '';
            const hasJobFilter = currentAnalyticsJobFilter !== '';

            if (hasEmailFilter || hasJobFilter) {
                statusDiv.classList.remove('hidden');

                if (hasEmailFilter) {
                    emailBadge.classList.remove('hidden');
                    document.getElementById('analyticsFilterEmailText').textContent = currentAnalyticsFilter;
                } else {
                    emailBadge.classList.add('hidden');
                }

                if (hasJobFilter) {
                    jobBadge.classList.remove('hidden');
                    document.getElementById('analyticsFilterJobText').textContent = currentAnalyticsJobFilter;
                } else {
                    jobBadge.classList.add('hidden');
                }
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        function applyAnalyticsFilter() {
            const email = document.getElementById('analyticsUserFilter').value.trim().toLowerCase();
            const jobId = document.getElementById('analyticsJobFilter').value.trim();
            currentAnalyticsFilter = email;
            currentAnalyticsJobFilter = jobId;

            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function loadAnalytics() {
            const filterEmail = currentAnalyticsFilter || '';
            const filterJobId = currentAnalyticsJobFilter || '';
            const hasFilters = filterEmail || filterJobId;

            google.script.run.withSuccessHandler(data => {
                if(data.error) { showAnalyticsAccessDenied(); return; }

                // Hide access denied message on successful load
                document.getElementById('analyticsAccessDenied').classList.add('hidden');

                document.getElementById('statTotalUsers').textContent = data.totalUsers || 0;
                document.getElementById('statTotalEmails').textContent = data.totalEmailsSent || 0;

                const tbody = document.getElementById('userStatsTableBody');
                tbody.innerHTML = '';
                if(data.userStats && data.userStats.length > 0) {
                    data.userStats.forEach(u => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 border-b border-slate-50";
                        tr.innerHTML = `
                            <td class="px-6 py-3 font-medium">${u.email}</td>
                            <td class="px-6 py-3 text-center text-emerald-600 font-bold">${u.emailsSent || 0}</td>
                            <td class="px-6 py-3 text-center text-blue-600">${u.dataFetches || 0}</td>
                            <td class="px-6 py-3 text-center text-purple-600">${u.negotiations || 0}</td>
                            <td class="px-6 py-3 text-center text-amber-600">${u.followUps || 0}</td>
                            <td class="px-6 py-3 text-slate-500 text-xs">${u.lastActive ? new Date(u.lastActive).toLocaleDateString() : '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">
                        <i class="fa-regular fa-folder-open text-2xl mb-2 block"></i>
                        ${hasFilters ? 'No activity found for the selected filters' : 'No user activity recorded yet'}
                    </td></tr>`;
                }
                // Update cache
                dataCache.analytics = { data: data, lastLoaded: Date.now() };
            }).getUserAnalytics(filterEmail, filterJobId);

            google.script.run.withSuccessHandler(stats => {
                if(stats.error) return;
                document.getElementById('statTotalFollowUps').textContent = stats.totalFollowUps || 0;
                document.getElementById('statTotalNegotiations').textContent = stats.totalNegotiations || 0;

                // Render charts (simplified lists)
                const uList = document.getElementById('emailUsersList');
                const userEntries = stats.emailsByUser ? Object.entries(stats.emailsByUser).sort((a,b)=>b[1]-a[1]) : [];
                if(userEntries.length > 0) {
                    uList.innerHTML = '';
                    userEntries.forEach(([k,v]) => {
                        uList.innerHTML += `<div class="flex justify-between text-sm mb-2 p-2 bg-slate-50 rounded"><span class="text-slate-700">${k}</span><span class="font-bold text-emerald-600">${v}</span></div>`;
                    });
                } else {
                    uList.innerHTML = `<div class="text-center py-6 text-slate-400">
                        <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                        <span class="text-sm">${hasFilters ? 'No emails found for the selected filters' : 'No emails sent yet'}</span>
                    </div>`;
                }

                const jList = document.getElementById('emailJobsList');
                const jobEntries = stats.emailsByJob ? Object.entries(stats.emailsByJob).sort((a,b)=>b[1]-a[1]) : [];
                if(jobEntries.length > 0) {
                    jList.innerHTML = '';
                    jobEntries.forEach(([k,v]) => {
                        jList.innerHTML += `<div class="flex justify-between text-sm mb-2 p-2 bg-slate-50 rounded"><span class="text-slate-700">Job ${k}</span><span class="font-bold text-amber-600">${v}</span></div>`;
                    });
                } else {
                    jList.innerHTML = `<div class="text-center py-6 text-slate-400">
                        <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                        <span class="text-sm">${hasFilters ? 'No emails found for the selected filters' : 'No emails sent yet'}</span>
                    </div>`;
                }
            }).getDetailedEmailStats(filterEmail, filterJobId);
        }

        function showAnalyticsAccessDenied() {
            document.getElementById('analyticsAccessDenied').classList.remove('hidden');
        }

        function toggleCollapse(contentId, header) {
            const content = document.getElementById(contentId);
            if(content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        }
        function closeProgressPanel(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Viewers Logic
        function loadViewers() {
            const list = document.getElementById('viewersList');
            list.innerHTML = 'Loading...';
            google.script.run.withSuccessHandler(viewers => {
                if(viewers.error) { list.innerHTML = viewers.error; return; }
                list.innerHTML = '';
                viewers.forEach(v => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-slate-50 rounded mb-1">
                            <div><span class="font-bold text-sm">${v.email}</span> <span class="text-xs text-slate-500">(${v.accessLevel})</span></div>
                            <button onclick="removeViewer('${v.email}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                });
            }).getAnalyticsViewers();
        }
        function addViewer() {
            const email = document.getElementById('newViewerEmail').value;
            const level = document.getElementById('newViewerLevel').value;
            if(!email) return;
            google.script.run.withSuccessHandler(res => {
                if(res.success) { showToast("Viewer Added", "success"); loadViewers(); document.getElementById('newViewerEmail').value=''; }
                else showToast(res.error, "error");
            }).addAnalyticsViewer(email, level);
        }
        function removeViewer(email) {
            if(!confirm("Remove?")) return;
            google.script.run.withSuccessHandler(res => {
                if(res.success) { showToast("Removed", "success"); loadViewers(); }
                else showToast(res.error, "error");
            }).removeAnalyticsViewer(email);
        }
        function openViewersModal() {
            document.getElementById('viewersModal').classList.remove('hidden');
            loadViewers();
        }
        function closeViewersModal() {
            document.getElementById('viewersModal').classList.add('hidden');
        }

    </script>
</body>
</html>
