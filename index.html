<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turing Outreach V12</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Sidebar Navigation Styles */
        .nav-tab { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            padding: 0.75rem 1rem; 
            margin-bottom: 0.5rem;
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #94a3b8; /* slate-400 */
            font-weight: 500;
            font-size: 0.875rem;
        }
        .nav-tab:hover { 
            background-color: #1e293b; /* slate-800 */
            color: white; 
        }
        .nav-tab.active { 
            background-color: #2563eb; /* blue-600 */
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1), 0 2px 4px -1px rgba(37, 99, 235, 0.06);
        }
        
        /* Modern Card Styles */
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border-top-width: 4px;
            transition: transform 0.2s;
        }
        .dark .stat-card { background: #1e293b; border-color: #334155; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }

        /* Input Fields */
        .input-field { 
            width: 100%; 
            padding: 0.625rem 0.875rem; 
            border-radius: 0.5rem; 
            border: 1px solid #e2e8f0; 
            background: white; 
            transition: all 0.2s; 
            font-size: 0.875rem;
        }
        .dark .input-field { background: #1e293b; border-color: #334155; color: white; }
        .input-field:focus { outline: none; border-color: #3b82f6; ring: 2px; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* JD Editor - Rich Text */
        .jd-editor {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        .jd-editor:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8;
            pointer-events: none;
        }
        .jd-editor ul, .jd-editor ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .jd-editor ul { list-style-type: disc; }
        .jd-editor ol { list-style-type: decimal; }
        .jd-editor li { margin-bottom: 0.25rem; }
        .jd-editor h1, .jd-editor h2, .jd-editor h3, .jd-editor h4 { font-weight: bold; margin-top: 0.75rem; margin-bottom: 0.5rem; }
        .jd-editor h1 { font-size: 1.25rem; }
        .jd-editor h2 { font-size: 1.1rem; }
        .jd-editor h3 { font-size: 1rem; }
        .jd-editor p { margin-bottom: 0.5rem; }
        .jd-editor b, .jd-editor strong { font-weight: bold; }

        /* Chips */
        .smart-chip {
            display: inline-flex; align-items: center; padding: 0.375rem 0.75rem;
            border-radius: 9999px; font-size: 0.75rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e2e8f0; background: white; color: #64748b;
            position: relative; overflow: hidden;
        }
        .smart-chip:hover { transform: scale(1.02); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .smart-chip.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            animation: chipPulse 2s ease-in-out infinite;
        }
        .smart-chip.active::before {
            content: '\2713';
            margin-right: 0.35rem;
            font-weight: bold;
            animation: checkPop 0.3s ease-out;
        }
        .smart-chip.active::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes chipPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6); }
        }
        @keyframes shimmer {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }
        @keyframes checkPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); opacity: 1; }
        }
        .dark .smart-chip { background: #1f2937; border-color: #374151; color: #9ca3af; }
        .dark .smart-chip.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5);
        }

        /* Utilities */
        .hidden-tab { display: none; }
        .hidden { display: none; }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .toast { padding: 14px 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; min-width: 300px; position: relative; color: white;}
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-info { background: #3b82f6; }
        .toast-warning { background: #f59e0b; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.hiding { opacity: 0; transition: opacity 0.3s; }

        /* Refresh Button Animation */
        .refresh-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .refresh-btn:active {
            transform: scale(0.95);
        }
        .refresh-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        .refresh-btn.loading .fa-rotate {
            animation: spin 0.8s linear infinite;
        }
        .refresh-btn.success {
            background: #10b981 !important;
            border-color: #10b981 !important;
            color: white !important;
        }
        .refresh-btn.success .fa-rotate::before {
            content: "\f00c"; /* FontAwesome check icon */
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .refresh-btn.success {
            animation: successPulse 0.6s ease-out;
        }

        /* Collapsible & Slide Panel */
        .collapsible-content { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }
        .collapsible-content.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; }
        .slide-panel { position: fixed; top: 0; right: -500px; width: 480px; height: 100vh; background: white; box-shadow: -10px 0 40px rgba(0,0,0,0.15); transition: right 0.3s ease; z-index: 100; display: flex; flex-direction: column; }
        .slide-panel.open { right: 0; }
        .dark .slide-panel { background: #1e293b; }
        .slide-panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 99; backdrop-filter: blur(2px); }
        .slide-panel-overlay.open { opacity: 1; visibility: visible; }

        /* Table & Rows */
        .task-row.selected { background: #eff6ff !important; }
        .dark .task-row.selected { background: rgba(59, 130, 246, 0.1) !important; }
        tr.sent-row td { background-color: #fef2f2 !important; }
        .dark tr.sent-row td { background-color: #450a0a !important; }
        tr.manual-sent-row td { background-color: #fffbeb !important; } /* Lighter yellow */
        .dark tr.manual-sent-row td { background-color: #451a03 !important; }

        /* Filter Chips */
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .filter-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .filter-chip.all { background: #f1f5f9; color: #64748b; border-color: #e2e8f0; }
        .filter-chip.all:hover { background: #e2e8f0; border-color: #cbd5e1; }
        .filter-chip.all.active { background: #334155; color: white; border-color: #1e293b; box-shadow: 0 4px 6px -1px rgba(51,65,85,0.3); }
        .filter-chip.new { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .filter-chip.new:hover { background: #bbf7d0; border-color: #86efac; }
        .filter-chip.new.active { background: #16a34a; color: white; border-color: #15803d; box-shadow: 0 4px 6px -1px rgba(22,163,74,0.3); }
        .filter-chip.followup { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .filter-chip.followup:hover { background: #fecaca; border-color: #fca5a5; }
        .filter-chip.followup.active { background: #dc2626; color: white; border-color: #b91c1c; box-shadow: 0 4px 6px -1px rgba(220,38,38,0.3); }
        .filter-chip.manual { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .filter-chip.manual:hover { background: #fde68a; border-color: #fcd34d; }
        .filter-chip.manual.active { background: #d97706; color: white; border-color: #b45309; box-shadow: 0 4px 6px -1px rgba(217,119,6,0.3); }
        .filter-chip.sub { background: #fed7aa; color: #c2410c; border-color: #fdba74; }
        .filter-chip.sub:hover { background: #fdba74; border-color: #fb923c; }
        .filter-chip.sub.active { background: #ea580c; color: white; border-color: #c2410c; box-shadow: 0 4px 6px -1px rgba(234,88,12,0.3); }
        .filter-chip.agency { background: #f3e8ff; color: #7c3aed; border-color: #e9d5ff; }
        .filter-chip.agency:hover { background: #e9d5ff; border-color: #d8b4fe; }
        .filter-chip.agency.active { background: #7c3aed; color: white; border-color: #6d28d9; box-shadow: 0 4px 6px -1px rgba(124,58,237,0.3); }
        .filter-chip.direct { background: #e0e7ff; color: #4338ca; border-color: #c7d2fe; }
        .filter-chip.direct:hover { background: #c7d2fe; border-color: #a5b4fc; }
        .filter-chip.direct.active { background: #4f46e5; color: white; border-color: #4338ca; box-shadow: 0 4px 6px -1px rgba(79,70,229,0.3); }
        
        /* Log Entries */
        .log-entry { padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .log-info { background: #eff6ff; color: #1d4ed8; }
        .log-success { background: #dcfce7; color: #15803d; }
        .log-warning { background: #fef9c3; color: #a16207; }
        .log-error { background: #fee2e2; color: #b91c1c; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Email Draft Modal Styles */
        .email-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .email-modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .email-modal {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
        }
        .email-modal-overlay.open .email-modal {
            transform: scale(1) translateY(0);
        }
        .dark .email-modal {
            background: #1e293b;
        }

        /* Rich Text Editor Styles */
        .rich-text-editor {
            min-height: 300px;
            max-height: 400px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow-y: auto;
            background: white;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        .dark .rich-text-editor {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }
        .rich-text-editor:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        /* CSS Reset for rich text editor content */
        .rich-text-editor ul,
        .rich-text-editor ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .rich-text-editor ul {
            list-style-type: disc;
        }
        .rich-text-editor ol {
            list-style-type: decimal;
        }
        .rich-text-editor li {
            margin-bottom: 0.25rem;
        }
        .rich-text-editor p {
            margin-bottom: 0.5rem;
        }
        .rich-text-editor h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .rich-text-editor blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #64748b;
        }

        /* Formatting Toolbar Styles */
        .format-toolbar {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            background: #f8fafc;
        }
        .dark .format-toolbar {
            background: #1e293b;
            border-color: #334155;
        }
        .format-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background: white;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .dark .format-btn {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        .format-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .dark .format-btn:hover {
            background: #475569;
        }
        .format-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .format-divider {
            width: 1px;
            background: #e2e8f0;
            margin: 0 0.25rem;
        }
        .dark .format-divider {
            background: #475569;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: #3b82f6;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            left: 22px;
        }
        .dark .toggle-switch {
            background: #475569;
        }
        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            min-width: 100px;
        }
        .toggle-label.active {
            color: #3b82f6;
        }
        .dark .toggle-label {
            color: #94a3b8;
        }
        .dark .toggle-label.active {
            color: #60a5fa;
        }

        /* Job Type Toggles Container */
        .job-toggles-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .dark .job-toggles-container {
            background: #0f172a;
            border-color: #334155;
        }
        .job-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .job-toggle-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        .job-toggle-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #334155;
        }
        .dark .job-toggle-title {
            color: #e2e8f0;
        }
        .job-toggle-desc {
            font-size: 0.75rem;
            color: #64748b;
        }
        .dark .job-toggle-desc {
            color: #94a3b8;
        }

        /* Name Placeholder Badge */
        .name-placeholder {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .dark .name-placeholder {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        /* Toggle Tooltip Styles */
        .job-toggle-row {
            position: relative;
        }
        .toggle-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            right: 0;
            background: #1e293b;
            color: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transform: translateY(4px);
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 280px;
            white-space: normal;
            text-align: center;
            line-height: 1.4;
        }
        .toggle-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 16px;
            border: 6px solid transparent;
            border-top-color: #1e293b;
        }
        .job-toggle-row:hover .toggle-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            transition-delay: 1.5s;
        }
        .dark .toggle-tooltip {
            background: #334155;
            border: 1px solid #475569;
        }
        .dark .toggle-tooltip::after {
            border-top-color: #334155;
        }
        .toggle-tooltip .tooltip-on {
            color: #4ade80;
        }
        .toggle-tooltip .tooltip-off {
            color: #f87171;
        }

        /* ========== PROCESS MAP STYLES ========== */

        /* Process Node Base Styles */
        .process-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        /* User Action Node (rounded pill) */
        .process-node-user {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #93c5fd;
            color: #1e40af;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            justify-content: center;
        }
        .dark .process-node-user {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
            border-color: #3b82f6;
            color: #93c5fd;
        }

        /* Action Node (rectangle) */
        .process-node-action {
            background: white;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #3b82f6;
        }
        .dark .process-node-action {
            background: #1e293b;
            border-color: #334155;
            border-left-color: #3b82f6;
        }
        .process-node-action:hover {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transform: translateX(2px);
        }

        /* Trigger Node (rectangle with clock icon) */
        .process-node-trigger {
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border: 2px dashed #a78bfa;
            border-left: 4px solid #7c3aed;
        }
        .dark .process-node-trigger {
            background: linear-gradient(135deg, #2e1065 0%, #4c1d95 100%);
            border-color: #7c3aed;
            border-left-color: #a78bfa;
        }

        /* Decision Node (diamond-like) */
        .process-node-decision {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            color: #92400e;
            justify-content: center;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            padding: 1.25rem 2rem;
            text-align: center;
        }
        .dark .process-node-decision {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border-color: #f59e0b;
            color: #fde68a;
        }

        /* Output Node */
        .process-node-output {
            background: #f1f5f9;
            border: 1px dashed #94a3b8;
        }
        .dark .process-node-output {
            background: #334155;
            border-color: #64748b;
        }

        /* Mini Node (for sheets/outputs) */
        .process-node-mini {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.5rem;
            border-radius: 0.375rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            font-size: 0.65rem;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            position: relative;
            cursor: pointer;
        }
        .dark .process-node-mini {
            background: #1e293b;
            border-color: #334155;
            color: #94a3b8;
        }

        /* Process Node text overflow fix */
        .process-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
            overflow: hidden;
            word-break: break-word;
        }
        .process-node span {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Process Map Tooltip */
        .pm-tooltip {
            position: relative;
            cursor: pointer;
        }
        .pm-tooltip .pm-tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            background: #1e293b;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            font-weight: 400;
            white-space: normal;
            width: max-content;
            max-width: 200px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.15s, visibility 0.15s;
            line-height: 1.4;
            pointer-events: none;
        }
        /* Arrow hidden for fixed positioning */
        .pm-tooltip .pm-tooltip-text::after {
            display: none;
        }
        .pm-tooltip:hover .pm-tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .dark .pm-tooltip .pm-tooltip-text {
            background: #475569;
        }
        .dark .pm-tooltip .pm-tooltip-text::after {
            border-top-color: #475569;
        }

        /* Process Arrow */
        .process-arrow {
            text-align: center;
            padding: 0.25rem 0;
        }

        /* Status Light Indicators */
        .status-light {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-light.status-ok {
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e;
            animation: pulse-green 2s infinite;
        }
        .status-light.status-idle {
            background: #f59e0b;
        }
        .status-light.status-error {
            background: #ef4444;
            box-shadow: 0 0 8px #ef4444;
            animation: pulse-red 1s infinite;
        }
        .status-light.status-disabled {
            background: #94a3b8;
        }
        .status-light.status-checking {
            background: #94a3b8;
            animation: blink 1s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        @keyframes pulse-red {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px #ef4444; }
            50% { opacity: 0.8; box-shadow: 0 0 12px #ef4444; }
        }
        @keyframes blink {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* ========== PROCESS NODE TOOLTIPS ========== */

        /* Tooltip container for process nodes */
        .process-tooltip-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        /* The tooltip itself */
        .process-tooltip {
            position: fixed;
            background: #1e293b;
            color: #f8fafc;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.5;
            white-space: normal;
            min-width: 200px;
            max-width: 280px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s;
            z-index: 9999;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            text-align: left;
            pointer-events: none;
        }

        /* Show tooltip on hover - positioned via JS */
        .process-tooltip-wrapper:hover .process-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Tooltip title styling */
        .process-tooltip .tooltip-title {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        /* Technical term highlighting in tooltips */
        .process-tooltip .tech-term {
            color: #a78bfa;
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            font-size: 0.7rem;
            background: rgba(167, 139, 250, 0.15);
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* Dark mode tooltip adjustments */
        .dark .process-tooltip {
            background: #334155;
            border: 1px solid #475569;
        }

        /* Function name styling */
        .func-name {
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            color: #3b82f6;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }
        .dark .func-name {
            color: #60a5fa;
        }
        .func-name:hover {
            color: #2563eb;
        }
        .dark .func-name:hover {
            color: #93c5fd;
        }

        /* Text overflow handling for process nodes */
        .process-node-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .process-node-mini .node-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100px;
        }

        /* Status Dashboard Row */
        .status-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .dark .status-row {
            border-color: #334155;
        }
        .status-row:last-child {
            border-bottom: none;
        }
        .status-label {
            flex: 1;
            font-size: 0.875rem;
            color: #64748b;
        }
        .dark .status-label {
            color: #94a3b8;
        }
        .status-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: #334155;
        }
        .dark .status-value {
            color: #e2e8f0;
        }

        /* Stat Box */
        .stat-box {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .dark .stat-box {
            background: #1e293b;
            border-color: #334155;
        }
        .stat-box .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        .dark .stat-box .stat-value {
            color: white;
        }
        .stat-box .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Activity Log Item */
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: #f8fafc;
            border-left: 3px solid #e2e8f0;
        }
        .dark .activity-item {
            background: #1e293b;
            border-left-color: #334155;
        }
        .activity-item.activity-success {
            border-left-color: #22c55e;
        }
        .activity-item.activity-error {
            border-left-color: #ef4444;
        }
        .activity-item.activity-info {
            border-left-color: #3b82f6;
        }
        .activity-item.activity-warning {
            border-left-color: #f59e0b;
        }
        .activity-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .activity-content {
            flex: 1;
            min-width: 0;
        }
        .activity-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1e293b;
        }
        .dark .activity-title {
            color: #f1f5f9;
        }
        .activity-time {
            font-size: 0.75rem;
            color: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 flex h-screen overflow-hidden">

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- SIDEBAR NAVIGATION -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col h-full flex-shrink-0 z-20 shadow-xl">
        <!-- Logo -->
        <div class="p-6 flex items-center gap-3 border-b border-slate-800">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/50">
                <i class="fa-solid fa-robot text-white text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm tracking-wide">TURING AI</h1>
                <p class="text-xs text-slate-400">Recruiter V12</p>
            </div>
        </div>

        <!-- Navigation Links -->
        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">Main Menu</div>

            <!-- Operational tabs - hidden for TM/TA/Manager roles -->
            <div id="navTabOutreach" class="nav-tab active operational-tab" onclick="switchTab('outreach', this)">
                <i class="fa-solid fa-users-viewfinder w-5 text-center"></i>
                <span>Outreach Manager</span>
            </div>

            <div id="navTabNegotiation" class="nav-tab operational-tab" onclick="switchTab('negotiation', this)">
                <i class="fa-solid fa-briefcase w-5 text-center"></i>
                <span>Setup Job Details</span>
            </div>

            <div id="navTabTasks" class="nav-tab operational-tab" onclick="switchTab('tasks', this)">
                <i class="fa-solid fa-clipboard-check w-5 text-center"></i>
                <span>Task List</span>
            </div>

            <div id="navTabFollowups" class="nav-tab operational-tab" onclick="switchTab('followups', this)">
                <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i>
                <span>Follow-Ups</span>
            </div>

            <div id="navTabAnalytics" class="nav-tab" onclick="switchTab('analytics', this)">
                <i class="fa-solid fa-chart-line w-5 text-center"></i>
                <span>Analytics</span>
            </div>

            <div id="navTabLearning" class="nav-tab" onclick="switchTab('learning', this)">
                <i class="fa-solid fa-brain w-5 text-center"></i>
                <span>AI Learning</span>
            </div>

            <!-- AI TESTING FEATURE - DELETE FOR PRODUCTION (START NAV) -->
            <div id="aiTestingNavTab" class="nav-tab hidden" onclick="switchTab('aitesting', this)">
                <i class="fa-solid fa-flask w-5 text-center"></i>
                <span>AI Testing</span>
            </div>
            <!-- AI TESTING FEATURE - DELETE FOR PRODUCTION (END NAV) -->

            <!-- PROCESS MAP - ADMIN ONLY -->
            <div id="processMapNavTab" class="nav-tab hidden" onclick="switchTab('processmap', this)">
                <i class="fa-solid fa-diagram-project w-5 text-center"></i>
                <span>Process Map</span>
            </div>
        </nav>

        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-slate-800 space-y-2">
            <div id="navTabConfig" class="nav-tab hover:bg-slate-800 text-slate-400 operational-tab" onclick="openConfigModal()">
                <i class="fa-solid fa-cog w-5 text-center"></i>
                <span>Configuration</span>
            </div>

            <!-- User Profile Tiny -->
            <div class="flex items-center gap-3 px-2 py-3 mt-2 rounded-lg bg-slate-800/50 border border-slate-700">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold text-white">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="overflow-hidden">
                    <p class="text-xs font-medium text-white truncate" id="userEmailTextSidebar">Loading...</p>
                    <!-- Hidden elements required by original JS logic -->
                    <div id="userEmailText" class="hidden"></div>
                    <div id="userEmailDisplay" class="hidden"></div>
                    <p class="text-[10px] text-slate-400" id="userRoleBadge">Loading...</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-100 dark:bg-slate-900 relative">
        
        <!-- Header -->
        <header class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center px-8 shadow-sm z-10 flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="text-lg font-bold text-slate-800 dark:text-white" id="headerTitle">Dashboard</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                    <input type="text" id="globalSearchInput" placeholder="Global search..." oninput="handleGlobalSearch()" onkeydown="if(event.key==='Escape') clearGlobalSearch()" class="pl-9 pr-4 py-2 rounded-full border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="globalSearchResults" class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg max-h-80 overflow-y-auto z-50 hidden"></div>
                </div>

                <!-- New Users Notification (Admin Only) -->
                <button id="newUsersBtn" onclick="toggleNewUsersPanel()" class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-500 hover:text-green-600 transition relative hidden" title="New Users">
                    <i class="fa-solid fa-user-plus"></i>
                    <span id="newUsersBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <div id="newUsersPanel" class="absolute top-14 right-20 w-96 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg z-50 hidden">
                    <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <span class="font-semibold text-slate-800 dark:text-white text-sm"><i class="fa-solid fa-user-plus mr-2 text-green-500"></i>New Users</span>
                        <button onclick="closeNewUsersPanel()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div id="newUsersList" class="max-h-80 overflow-y-auto">
                        <div class="p-4 text-center text-slate-500 text-sm">No new users</div>
                    </div>
                </div>

                <button id="notificationBtn" onclick="toggleNotifications()" class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-500 hover:text-blue-600 transition relative">
                    <i class="fa-regular fa-bell"></i>
                    <span id="notificationBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <div id="notificationPanel" class="absolute top-14 right-4 w-80 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg z-50 hidden">
                    <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <span class="font-semibold text-slate-800 dark:text-white text-sm">Notifications</span>
                        <button onclick="markAllNotificationsRead()" class="text-xs text-blue-600 hover:text-blue-700">Mark all read</button>
                    </div>
                    <div id="notificationList" class="max-h-64 overflow-y-auto">
                        <div class="p-4 text-center text-slate-500 text-sm">No new notifications</div>
                    </div>
                </div>
                
                <div class="h-6 w-px bg-slate-200 dark:bg-slate-700"></div>
                
                <button onclick="toggleDarkMode()" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline"></i>
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
            <div class="max-w-[1800px] mx-auto">

                <!-- TAB 1: OUTREACH MANAGER -->
                <div id="tab-outreach" class="tab-content">
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 sm:p-6 mb-8">
                        <div class="flex flex-col gap-4 sm:gap-6">
                            <!-- Row 1: Job ID and Pipeline Stages -->
                            <div class="flex flex-col xl:flex-row gap-4 sm:gap-6">
                                <!-- Job ID -->
                                <div class="w-full xl:w-auto xl:min-w-[180px] xl:flex-shrink-0">
                                    <label class="block text-xs font-bold uppercase mb-2 text-slate-500">Job ID</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-hashtag absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                        <input type="number" id="jobId" class="input-field pl-8 font-mono text-blue-600 font-bold w-full" placeholder="51000">
                                    </div>
                                </div>
                                <!-- Pipeline Stages -->
                                <div class="flex-1 min-w-0">
                                    <label class="block text-xs font-bold uppercase mb-2 text-slate-500">Pipeline Stages</label>
                                    <div class="flex flex-wrap gap-2">
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Interested">Interested</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Passed VetSmith">Passed VetSmith</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Passed Internal Interviews">Passed Internal Interviews</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Selected for Internal Interviews">Selected for Internal Interviews</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Pending Review">Pending Review</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Completed Testing">Completed Testing</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Developer Backout">Developer Backout</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="On Hold - Onboarding">On Hold - Onboarding</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Pending Onboarding">Pending Onboarding</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Ready for Selection">Ready for Selection</div>
                                        <div class="smart-chip" onclick="toggleChip(this)" data-value="Selected for Trial">Selected for Trial</div>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="selectAllChips()" class="text-xs text-blue-600 hover:underline">Select All</button>
                                        <button onclick="clearAllChips()" class="text-xs text-slate-500 hover:underline">Clear</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Row 2: Action Buttons -->
                            <div class="flex flex-wrap items-center gap-3 pt-2 border-t border-slate-100 dark:border-slate-700">
                                <button id="fetchBtn" onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-5 rounded-lg shadow-md hover:shadow-lg transition flex items-center justify-center gap-2 text-sm whitespace-nowrap">
                                    <i class="fa-solid fa-search"></i> <span>Fetch Data</span>
                                </button>
                                <button onclick="openManualInput()" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 py-2.5 px-3 rounded-lg transition whitespace-nowrap" title="Manual Entry">
                                    <i class="fa-solid fa-pen-to-square"></i> <span class="sm:inline hidden">Manual Entry</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Filter Section (Hidden until data loaded) -->
                    <div id="statusFilterContainer" class="hidden mb-6 bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-bold uppercase text-slate-500">Quick Filters</span>
                            </div>
                            <span id="selectAllCount" class="text-xs text-blue-600 font-medium bg-blue-50 px-2 py-1 rounded hidden">(0) selected</span>
                        </div>
                        <div id="statusButtons" class="flex flex-wrap gap-2.5">
                            <!-- Filter chips will be injected here by JS logic, ensure logic populates this -->
                            <!-- Re-adding static filter chips structure for robustness in case JS logic is looking for specific classes -->
                            <div class="filter-chip all active" data-filter="all" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-layer-group mr-1"></i>All <span id="allCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip new" data-filter="new" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-sparkles mr-1"></i>New <span id="newCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip followup" data-filter="followup" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-reply mr-1"></i>Sent <span id="followupCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip manual" data-filter="manual" data-group="status" onclick="toggleFilterChip(this)"><i class="fa-solid fa-hand mr-1"></i>M.Sent <span id="manualCount" class="ml-1 opacity-75">0</span></div>
                            <div class="w-px h-8 bg-slate-300 mx-2"></div>
                            <div class="filter-chip sub" data-filter="sub" data-group="type" onclick="toggleFilterChip(this)">Sub-Con <span id="subCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip agency" data-filter="agency" data-group="type" onclick="toggleFilterChip(this)">Agency <span id="agencyCount" class="ml-1 opacity-75">0</span></div>
                            <div class="filter-chip direct" data-filter="direct" data-group="type" onclick="toggleFilterChip(this)">Direct <span id="directCount" class="ml-1 opacity-75">0</span></div>
                            
                            <!-- Active Filters Info -->
                            <div id="activeFiltersInfo" class="hidden items-center gap-2 ml-auto">
                                <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full border border-blue-100"><span id="activeFilterCount">0</span> active</span>
                                <button class="text-xs text-slate-500 hover:text-red-500" onclick="clearAllFilters()"><i class="fa-solid fa-times"></i> Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paste Filter Area -->
                    <div id="pasteFilterArea" class="hidden mb-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border-2 border-blue-200 dark:border-blue-800">
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Paste Comma Separated Emails or Developer IDs:</label>
                        <textarea id="pasteFilterInput" class="w-full h-24 p-3 rounded-lg border-2 border-blue-300 dark:border-blue-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none mb-3" placeholder="john@example.com, jane@example.com&#10;OR&#10;12345, 67890"></textarea>
                        <div class="flex gap-2 items-center">
                            <button onclick="applyPasteFilter()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2 transition">
                                <i class="fa-solid fa-filter"></i> Filter List
                            </button>
                            <button onclick="clearPasteFilter()" class="bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-500 px-4 py-2 rounded-lg text-sm font-medium transition">
                                Clear List
                            </button>
                            <button onclick="togglePasteFilter()" class="ml-auto text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition">Close</button>
                        </div>
                    </div>

                    <!-- Table Controls & Table (Hidden until data loaded) -->
                    <div id="tableControls" class="hidden space-y-4">
                        <div class="flex flex-col lg:flex-row gap-4 justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <div class="flex gap-2 items-center w-full lg:w-auto">
                                <div class="relative flex-1 lg:w-80">
                                    <input type="text" id="tableSearch" oninput="searchTable()" placeholder="Search name, email, or ID..." class="input-field pl-10">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                                </div>
                                <button onclick="togglePasteFilter()" class="bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-200 border border-slate-200 dark:border-slate-600 text-sm font-medium flex items-center gap-2 transition" title="Filter by pasting emails or IDs">
                                    <i class="fa-solid fa-clipboard-list"></i> Paste & Filter
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-2 flex-wrap">
                                <button onclick="selectAllResults()" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-2 rounded hover:bg-blue-100 transition">Select All</button>
                                <button onclick="deselectAll()" class="text-xs font-bold text-slate-600 bg-slate-50 px-3 py-2 rounded hover:bg-slate-100 transition">Clear</button>
                                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                                <button onclick="copyToClipboard()" class="text-xs font-bold text-slate-600 hover:text-blue-600 px-2"><i class="fa-regular fa-copy"></i> Copy</button>
                                <button onclick="downloadCSV()" class="text-xs font-bold text-slate-600 hover:text-green-600 px-2"><i class="fa-solid fa-download"></i> CSV</button>
                                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                                <button onclick="openEmailPanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2">
                                    <i class="fa-solid fa-paper-plane"></i> Campaign
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selection Indicator -->
                        <div id="selectionIndicator" class="hidden items-center gap-2 text-sm text-blue-600 bg-blue-50 p-2 rounded border border-blue-100">
                            <i class="fa-solid fa-circle-check"></i> <span id="quickSelectedCount">0</span> selected
                        </div>

                        <div id="tableContainer" class="hidden bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table id="devTable" class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600 text-xs uppercase font-bold text-slate-500 tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4 w-12 text-center"><input type="checkbox" id="masterCheckbox" onclick="toggleMasterCheckbox()" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500"></th>
                                            <th class="px-6 py-4">Developer ID</th>
                                            <th class="px-6 py-4">Name</th>
                                            <th class="px-6 py-4">Email</th>
                                            <th class="px-6 py-4 relative">
                                                <span class="inline-flex items-center gap-1">
                                                    Country
                                                    <button onclick="toggleCountryFilter(event)" class="country-filter-btn ml-1 p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition" title="Filter by country">
                                                        <i class="fa-solid fa-filter text-xs text-slate-400" id="countryFilterIcon"></i>
                                                    </button>
                                                </span>
                                                <!-- Country Filter Dropdown -->
                                                <div id="countryFilterDropdown" class="hidden absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-600 z-50">
                                                    <div class="p-3 border-b border-slate-200 dark:border-slate-600">
                                                        <input type="text" id="countrySearchInput" oninput="filterCountryList()" placeholder="Search countries..." class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:text-white">
                                                    </div>
                                                    <div id="countryListContainer" class="max-h-48 overflow-y-auto p-2">
                                                        <!-- Country checkboxes will be populated here -->
                                                    </div>
                                                    <div class="p-3 border-t border-slate-200 dark:border-slate-600 flex justify-between gap-2">
                                                        <button onclick="clearCountryFilter()" class="px-3 py-1.5 text-xs text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md transition">Clear</button>
                                                        <button onclick="applyCountryFilter()" class="px-3 py-1.5 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Apply</button>
                                                    </div>
                                                </div>
                                            </th>
                                            <th class="px-6 py-4">Phone</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4">History</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                        <!-- Rows injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: SETUP JOB DETAILS -->
                <div id="tab-negotiation" class="tab-content hidden-tab">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">Setup Job Details</h3>
                        <p class="text-sm text-slate-500">Configure job details, start dates, and AI negotiation settings per Job ID.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Left Col: Configuration Form -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Select Job</label>
                                    <select id="activeJobsDropdown" onchange="selectJobFromDropdown(this.value)" class="input-field cursor-pointer bg-slate-50"><option value="">-- Select --</option></select>

                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="text-xs text-slate-400">Or enter manual ID:</span>
                                        <input type="number" id="negJobId" class="input-field py-1 px-2 text-xs w-24" placeholder="ID" onchange="loadNegotiationConfig()">
                                    </div>
                                </div>

                                <!-- Job Description Link -->
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">
                                        <i class="fa-solid fa-link text-blue-500 mr-1"></i>Job Description Link
                                    </label>
                                    <input type="url" id="jdLink" class="input-field" placeholder="https://your-site.com/jobs/12345">
                                    <p class="text-xs text-slate-400 mt-1">Use <span class="bg-blue-100 text-blue-700 px-1 rounded">{{job_link}}</span> in emails to auto-insert this link</p>
                                </div>

                                <!-- Start Dates -->
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">
                                        <i class="fa-solid fa-calendar-days text-green-500 mr-1"></i>Start Dates
                                    </label>
                                    <div id="startDatesContainer" class="space-y-2 mb-2">
                                        <!-- Start dates will be dynamically added here -->
                                    </div>
                                    <button type="button" onclick="addStartDate()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                        <i class="fa-solid fa-plus"></i> Add Start Date
                                    </button>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Target Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
                                            <input type="number" id="targetRate" class="input-field pl-6" placeholder="20">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Max Rate</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
                                            <input type="number" id="maxRate" class="input-field pl-6" placeholder="35">
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">AI Persona</label>
                                    <select id="negStyle" class="input-field">
                                        <option value="Friendly but firm">Friendly but firm</option>
                                        <option value="Professional and direct">Professional and direct</option>
                                        <option value="Empathetic">Empathetic</option>
                                        <option value="Aggressive">High-pressure / Urgent</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">
                                        <i class="fa-solid fa-shield-halved text-amber-500 mr-1"></i>Internal AI Rules
                                        <span class="text-xs font-normal text-slate-400 ml-1">(Confidential - Not shared with developers)</span>
                                    </label>
                                    <textarea id="specialRules" rows="4" class="input-field text-xs" placeholder="Add any internal rules or context for the AI to follow during negotiations. These are confidential and will not be shared with the developer."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: JD & Save -->
                        <div class="flex flex-col gap-6">
                            <div class="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-xl border border-slate-200 dark:border-slate-700 flex-1 flex flex-col">
                                <h3 class="font-bold text-slate-800 dark:text-slate-300 text-sm mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-file-lines text-blue-500"></i> Job Description Context
                                </h3>
                                <div id="jobDescription" class="input-field flex-1 text-xs jd-editor" contenteditable="true" data-placeholder="Paste JD here..."></div>
                            </div>
                            <button id="saveConfigBtn" onclick="saveNegotiationSettings()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-save"></i> <span>Save Configuration</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rate Tiers (New Section) -->
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">Regional Rate Tiers</h3>
                            <button id="rateTiersRefreshBtn" onclick="refreshRateTiersWithAnimation()" class="refresh-btn text-sm text-blue-600 hover:underline"><i class="fa-solid fa-rotate mr-1 text-xs"></i>Refresh</button>
                        </div>
                        <!-- Add Tier Form -->
                        <div class="bg-white p-4 rounded-lg border border-slate-200 mb-4">
                            <div class="flex gap-2 items-end flex-wrap">
                                <div class="w-36">
                                    <label class="text-xs text-slate-500">Country <span class="text-slate-400">(optional)</span></label>
                                    <input id="tierCountry" class="input-field" placeholder="e.g. Brazil" oninput="autoFillRegionFromCountry()">
                                </div>
                                <div class="w-36">
                                    <label class="text-xs text-slate-500">Region</label>
                                    <select id="tierRegion" class="input-field">
                                        <option value="">Select region...</option>
                                        <option value="US/Canada">US/Canada</option>
                                        <option value="Europe">Europe</option>
                                        <option value="Eastern Europe">Eastern Europe</option>
                                        <option value="LATAM">LATAM</option>
                                        <option value="APAC">APAC</option>
                                        <option value="India">India</option>
                                        <option value="Middle East">Middle East</option>
                                        <option value="Africa">Africa</option>
                                        <option value="Default">Default</option>
                                    </select>
                                </div>
                                <div class="w-24">
                                    <label class="text-xs text-slate-500">Target $</label>
                                    <input id="tierTargetRate" type="number" class="input-field" placeholder="20">
                                </div>
                                <div class="w-24">
                                    <label class="text-xs text-slate-500">Max $</label>
                                    <input id="tierMaxRate" type="number" class="input-field" placeholder="30">
                                </div>
                                <div class="flex-1 min-w-32">
                                    <label class="text-xs text-slate-500">Note</label>
                                    <input id="tierNotes" class="input-field" placeholder="Optional">
                                </div>
                                <button id="addRateTierBtn" onclick="addRateTier()" class="bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 disabled:opacity-50"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <p class="text-xs text-slate-400 mt-2"><i class="fa-solid fa-info-circle mr-1"></i>Add country for specific rates (e.g., Brazil $22/hr) or leave empty for region-wide rates (e.g., all LATAM $20/hr)</p>
                        </div>
                        <!-- Tier Table -->
                        <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold">
                                    <tr>
                                        <th class="px-4 py-3">Country</th>
                                        <th class="px-4 py-3">Region</th>
                                        <th class="px-4 py-3">Target</th>
                                        <th class="px-4 py-3">Max</th>
                                        <th class="px-4 py-3">Notes</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rateTiersBody" class="divide-y divide-slate-100">
                                    <tr><td colspan="6" class="p-4 text-center text-slate-400">No tiers loaded. Select a Job ID.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: TASKS LIST -->
                <div id="tab-tasks" class="tab-content hidden-tab">
                    
                    <!-- Stats Cards (New Design) -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                        <div class="stat-card border-slate-500">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Active</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statTotal">-</h2>
                        </div>
                        <div class="stat-card border-blue-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-blue-500 uppercase tracking-wider mb-1">AI Negotiating</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statActive">-</h2>
                                </div>
                                <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i class="fa-solid fa-robot"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-amber-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">Needs Human</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statHuman">-</h2>
                                </div>
                                <div class="p-2 bg-amber-50 rounded-lg text-amber-600"><i class="fa-solid fa-user-clock"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-green-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-green-500 uppercase tracking-wider mb-1">Accepted</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statAccepted">-</h2>
                                </div>
                                <div class="p-2 bg-green-50 rounded-lg text-green-600"><i class="fa-solid fa-check"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-teal-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-teal-500 uppercase tracking-wider mb-1">Completed</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statCompleted">-</h2>
                                </div>
                                <div class="p-2 bg-teal-50 rounded-lg text-teal-600"><i class="fa-solid fa-flag-checkered"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Bar for Task List -->
                    <div class="flex flex-wrap items-center gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm mb-4">
                        <div class="flex-1 min-w-[300px] relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="taskSearchInput"
                                placeholder="Search by email or Dev ID (comma-separated for bulk)"
                                class="w-full pl-10 pr-10 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                onkeyup="handleTaskSearchKeyup(event)"
                                oninput="handleTaskSearchInput()"
                                autocomplete="off">
                            <button id="clearTaskSearch" onclick="clearTaskSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <button onclick="applyTaskSearch()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700">
                            <i class="fa-solid fa-filter mr-1"></i> Search
                        </button>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold text-slate-800">Active Negotiations</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-500">
                                <span class="inline-flex items-center gap-1"><span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-[9px] font-bold bg-purple-100 text-purple-700 border border-purple-200">N</span> Negotiation</span>
                                <span class="inline-flex items-center gap-1"><span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-[9px] font-bold bg-amber-100 text-amber-700 border border-amber-200">F</span> Follow-up</span>
                                <span class="inline-flex items-center gap-1"><span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-[9px] font-bold bg-blue-100 text-blue-700 border border-blue-200">D</span> Data Gathering</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <select id="taskJobFilter" onchange="filterTasks()" class="input-field py-2 w-auto"><option value="all">All Jobs</option></select>
                            <select id="taskStatusFilter" onchange="filterTasks()" class="input-field py-2 w-auto">
                                <option value="all">All Statuses</option>
                                <option value="Initial Outreach">Initial Outreach</option>
                                <option value="Active">AI Active</option>
                                <option value="Human-Negotiation">Human Required</option>
                                <option value="Offer Accepted">Accepted</option>
                                <option value="Completed">Completed</option>
                            </select>
                            <button id="runAiBtn" onclick="manualTriggerAI()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 shadow-sm" title="Run AI negotiation: Process candidates, generate responses, and escalate complex cases to humans">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Run AI
                            </button>
                            <button id="processHumanBtn" onclick="processCompletedHumanEscalations()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 shadow-sm" title="Import human-completed negotiations: Scans Gmail for threads with 'Completed' + 'Human-Negotiation' labels">
                                <i class="fa-solid fa-user-check"></i> Sync Human
                            </button>
                            <button id="taskRefreshBtn" onclick="refreshTasksWithAnimation()" class="refresh-btn bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 px-3 py-2 rounded-lg transition" title="Refresh task list">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Job AI Settings Panel (Quick access to turn features on/off) -->
                    <div class="mb-6 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-700 overflow-hidden">
                        <div class="p-4 flex items-center justify-between cursor-pointer" onclick="toggleJobSettingsPanel()">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-sliders text-amber-600"></i>
                                <span class="font-bold text-amber-800 dark:text-amber-300">Job AI Settings</span>
                                <span class="text-xs text-amber-600 dark:text-amber-400">(Turn features ON/OFF for any job)</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-amber-600 transition-transform" id="jobSettingsPanelIcon"></i>
                        </div>
                        <div id="jobSettingsPanelContent" class="hidden border-t border-amber-200 dark:border-amber-700 p-4 bg-white dark:bg-slate-800">
                            <div class="flex flex-wrap items-end gap-4">
                                <!-- Job Selection -->
                                <div class="flex-1 min-w-[200px]">
                                    <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 uppercase mb-1">Select Job</label>
                                    <select id="taskJobSettingsDropdown" onchange="loadTaskJobSettings(this.value)" class="input-field w-full">
                                        <option value="">-- Select a Job --</option>
                                    </select>
                                </div>

                                <!-- Negotiation Toggle -->
                                <div class="flex items-center gap-3 px-4 py-2 bg-slate-50 dark:bg-slate-700 rounded-lg" title="Enable AI to handle candidate rate negotiations for this job">
                                    <div>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Negotiation</span>
                                    </div>
                                    <div class="toggle-switch" id="taskToggleNegotiation" onclick="toggleTaskJobSetting('negotiation')"></div>
                                </div>

                                <!-- Follow-up Toggle -->
                                <div class="flex items-center gap-3 px-4 py-2 bg-slate-50 dark:bg-slate-700 rounded-lg" title="Enable automatic follow-up emails for candidates who don't respond">
                                    <div>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Follow-up</span>
                                    </div>
                                    <div class="toggle-switch" id="taskToggleFollowUp" onclick="toggleTaskJobSetting('followUp')"></div>
                                </div>

                                <!-- Data Gathering Toggle -->
                                <div class="flex items-center gap-3 px-4 py-2 bg-slate-50 dark:bg-slate-700 rounded-lg" title="Enable automatic data gathering follow-ups to collect missing candidate information">
                                    <div>
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Data Gathering</span>
                                    </div>
                                    <div class="toggle-switch" id="taskToggleDataGathering" onclick="toggleTaskJobSetting('dataGathering')"></div>
                                </div>

                                <!-- Request Additional Data Button -->
                                <button onclick="openSupplementaryDataModal()" class="flex items-center gap-2 px-4 py-2 bg-teal-100 hover:bg-teal-200 dark:bg-teal-900/30 dark:hover:bg-teal-800/50 text-teal-700 dark:text-teal-400 rounded-lg transition" title="Request additional information from candidates for data gathering">
                                    <i class="fa-solid fa-plus-circle"></i>
                                    <span class="text-sm font-medium">Request Additional Data</span>
                                </button>
                            </div>

                            <!-- Status Hint -->
                            <p id="taskJobSettingsHint" class="text-xs text-amber-600 dark:text-amber-400 mt-3">
                                <i class="fa-solid fa-info-circle mr-1"></i>
                                <span id="taskJobSettingsHintText">Select a job to view/modify its AI settings</span>
                            </p>
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    <div id="bulkActionsBar" class="hidden mb-4 bg-blue-50 p-3 rounded-lg border border-blue-200 flex justify-between items-center">
                        <span class="text-sm font-bold text-blue-800"><span id="taskSelectedCount">0</span> selected</span>
                        <div class="flex gap-2">
                            <button onclick="bulkCompleteSelected()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Complete Selected</button>
                            <button onclick="clearTaskSelection()" class="bg-white border text-slate-600 px-3 py-1 rounded text-sm">Clear</button>
                        </div>
                    </div>

                    <!-- Task Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4 w-10 text-center"><input type="checkbox" onchange="toggleAllTasks(this)" class="task-master-check rounded"></th>
                                        <th class="px-6 py-4">Job ID</th>
                                        <th class="px-6 py-4">Dev ID</th>
                                        <th class="px-6 py-4">Candidate</th>
                                        <th class="px-6 py-4">Status Tag</th>
                                        <th class="px-6 py-4">AI Summary</th>
                                        <th class="px-6 py-4">Last Activity</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="taskListBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <!-- Empty State -->
                        <div id="emptyTaskState" class="hidden p-12 text-center">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-inbox text-slate-300 text-2xl"></i>
                            </div>
                            <h3 class="text-slate-800 font-medium">No active tasks</h3>
                            <p class="text-slate-500 text-sm">Everything is up to date.</p>
                        </div>
                    </div>
                    
                    <!-- AI Progress Panel (Hidden) -->
                    <div id="aiProgressPanel" class="hidden mt-6 bg-purple-50 rounded-xl border border-purple-100 p-4">
                        <div class="flex items-center justify-between mb-2 clickable" onclick="toggleCollapse('aiProgressContent', this)">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-circle-notch fa-spin text-purple-600" id="aiProgressIcon"></i>
                                <span class="font-bold text-purple-800" id="aiProgressStatus">AI Running...</span>
                            </div>
                            <button onclick="closeProgressPanel('aiProgressPanel')"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div id="aiProgressContent" class="collapsible-content">
                            <div id="aiLogContainer" class="text-xs font-mono bg-white p-3 rounded border border-purple-100 max-h-32 overflow-y-auto text-slate-600"></div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: FOLLOW-UPS -->
                <div id="tab-followups" class="tab-content hidden-tab">
                    
                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card border-slate-400">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Awaiting Response</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statPending">-</h2>
                        </div>
                        <div class="stat-card border-amber-400">
                            <p class="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">1st Follow-up</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statFollowUp1">-</h2>
                        </div>
                        <div class="stat-card border-orange-500">
                            <p class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-1">2nd Follow-up</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statFollowUp2">-</h2>
                        </div>
                        <div class="stat-card border-green-500">
                            <p class="text-xs font-bold text-green-500 uppercase tracking-wider mb-1">Responded</p>
                            <h2 class="text-3xl font-extrabold text-slate-800" id="statResponded">-</h2>
                        </div>
                    </div>

                    <!-- Search Bar for Follow-Ups -->
                    <div class="flex flex-wrap items-center gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm mb-4">
                        <div class="flex-1 min-w-[300px] relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="followUpSearchInput"
                                placeholder="Search by email or Dev ID (comma-separated for bulk)"
                                class="w-full pl-10 pr-10 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onkeyup="handleFollowUpSearchKeyup(event)"
                                oninput="handleFollowUpSearchInput()"
                                autocomplete="off">
                            <button id="clearFollowUpSearch" onclick="clearFollowUpSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <button onclick="applyFollowUpSearch()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                            <i class="fa-solid fa-filter mr-1"></i> Search
                        </button>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold text-slate-800">Automated Follow-Up Queue</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-500">
                                <span class="inline-flex items-center gap-1"><span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-[9px] font-bold bg-amber-100 text-amber-700 border border-amber-200">F</span> Follow-up</span>
                                <span class="inline-flex items-center gap-1"><span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-[9px] font-bold bg-blue-100 text-blue-700 border border-blue-200">D</span> Data Gathering</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <select id="followUpJobFilter" onchange="loadFollowUpData()" class="input-field w-auto"><option value="all">All Jobs</option></select>
                            <select id="followUpStatusFilter" onchange="loadFollowUpData()" class="input-field w-auto">
                                <option value="all">All Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Follow-Up-1-Sent">1st Sent</option>
                                <option value="Follow-Up-2-Sent">2nd Sent</option>
                            </select>
                            <button id="runFollowUpBtn" onclick="manualTriggerFollowUps()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm" title="Send scheduled follow-ups: 1st email after ~12hrs, 2nd after ~28hrs, then mark as unresponsive">
                                <i class="fa-solid fa-paper-plane mr-1"></i> Process Queue
                            </button>
                            <button id="resetStatusBtn" onclick="resetFollowUpStatuses()" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50" title="Reset all follow-up statuses and re-check Gmail for responses. Use for debugging only.">
                                Reset Statuses
                            </button>
                            <button id="followUpRefreshBtn" onclick="refreshFollowUpsWithAnimation()" class="refresh-btn bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-50" title="Refresh follow-up queue data"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase">
                                <tr>
                                    <th class="px-6 py-4">Job ID</th>
                                    <th class="px-6 py-4">Dev ID</th>
                                    <th class="px-6 py-4">Name</th>
                                    <th class="px-6 py-4">Email</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4">Last Sent</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="followUpTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                        <div id="emptyFollowUpState" class="hidden p-12 text-center text-slate-500">
                            <i class="fa-solid fa-check-circle text-4xl text-green-100 mb-3 block"></i>
                            Queue is empty.
                        </div>
                    </div>
                    <!-- FollowUp Progress Panel -->
                    <div id="followUpProgressPanel" class="hidden mt-6 bg-blue-50 rounded-xl border border-blue-100 p-4">
                        <div class="flex items-center justify-between mb-2 clickable" onclick="toggleCollapse('followUpProgressContent', this)">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-circle-notch fa-spin text-blue-600" id="followUpProgressIcon"></i>
                                <span class="font-bold text-blue-800" id="followUpProgressStatus">Processing...</span>
                            </div>
                            <button onclick="closeProgressPanel('followUpProgressPanel')"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div id="followUpProgressContent" class="collapsible-content">
                            <div id="followUpLogContainer" class="text-xs font-mono bg-white p-3 rounded border border-blue-100 max-h-32 overflow-y-auto text-slate-600"></div>
                        </div>
                    </div>
                </div>

                <!-- TAB 5: ANALYTICS -->
                <div id="tab-analytics" class="tab-content hidden-tab">
                    <div class="flex flex-col gap-4 mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white">Usage Analytics</h3>
                            <div class="flex gap-2">
                                <button id="analyticsRefreshBtn" onclick="refreshAnalyticsWithAnimation()" class="refresh-btn bg-white border border-slate-300 px-3 py-2 rounded-lg text-sm hover:bg-slate-50">
                                    <i class="fa-solid fa-rotate mr-1"></i> Refresh
                                </button>
                                <button id="manageViewersBtn" onclick="openViewersModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                                    <i class="fa-solid fa-users-gear mr-1"></i> Access
                                </button>
                            </div>
                        </div>
                        <!-- Filters Row -->
                        <div class="flex flex-wrap items-center gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                            <!-- Non-admin badge (hidden by default, shown for non-admin users) -->
                            <div id="analyticsViewOnlyBadge" class="hidden flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg text-sm">
                                <i class="fa-solid fa-user-circle"></i>
                                <span>Viewing your personal analytics</span>
                            </div>
                            <!-- User Email Filter (admin only) -->
                            <div id="analyticsUserFilterContainer" class="flex-1 min-w-[200px] relative">
                                <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="email" id="analyticsUserFilter"
                                    placeholder="Filter by user email"
                                    class="w-full pl-10 pr-10 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    onkeyup="handleAnalyticsFilterKeyup(event)"
                                    oninput="handleAnalyticsEmailInput(event)"
                                    onfocus="handleAnalyticsEmailFocus()"
                                    autocomplete="off">
                                <button id="clearAnalyticsFilter" onclick="clearAnalyticsEmailFilter()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                                <!-- Email Autocomplete dropdown -->
                                <div id="analyticsEmailDropdown" class="absolute left-0 right-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
                                </div>
                            </div>
                            <!-- Job ID Filter -->
                            <div class="flex-1 min-w-[200px] relative">
                                <i class="fa-solid fa-briefcase absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="analyticsJobFilter"
                                    placeholder="Filter by Job ID"
                                    class="w-full pl-10 pr-10 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                    onkeyup="handleAnalyticsJobFilterKeyup(event)"
                                    oninput="handleAnalyticsJobInput(event)"
                                    onfocus="handleAnalyticsJobFocus()"
                                    autocomplete="off">
                                <button id="clearAnalyticsJobFilter" onclick="clearAnalyticsJobFilter()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                                <!-- Job ID Autocomplete dropdown -->
                                <div id="analyticsJobDropdown" class="absolute left-0 right-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
                                </div>
                            </div>
                            <button onclick="applyAnalyticsFilter()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                                <i class="fa-solid fa-filter mr-1"></i> Filter
                            </button>
                            <button onclick="clearAllAnalyticsFilters()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-200">
                                <i class="fa-solid fa-times mr-1"></i> Clear All
                            </button>
                        </div>
                        <!-- Date Range Filter Row -->
                        <div class="flex flex-wrap items-center gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                            <div class="flex items-center gap-2 text-sm text-slate-600">
                                <i class="fa-solid fa-calendar-days text-slate-400"></i>
                                <span class="font-medium">Date Range:</span>
                            </div>
                            <!-- Quick Presets -->
                            <div class="flex gap-1">
                                <button onclick="setAnalyticsDatePreset('today')" class="analytics-date-preset px-3 py-1.5 rounded-lg text-xs font-medium border border-slate-200 hover:bg-slate-100 transition-colors" data-preset="today">
                                    Today
                                </button>
                                <button onclick="setAnalyticsDatePreset('7days')" class="analytics-date-preset px-3 py-1.5 rounded-lg text-xs font-medium border border-slate-200 hover:bg-slate-100 transition-colors" data-preset="7days">
                                    Last 7 Days
                                </button>
                                <button onclick="setAnalyticsDatePreset('30days')" class="analytics-date-preset px-3 py-1.5 rounded-lg text-xs font-medium border border-slate-200 hover:bg-slate-100 transition-colors" data-preset="30days">
                                    Last 30 Days
                                </button>
                                <button onclick="setAnalyticsDatePreset('all')" class="analytics-date-preset px-3 py-1.5 rounded-lg text-xs font-medium border border-slate-200 hover:bg-slate-100 transition-colors bg-teal-50 border-teal-300 text-teal-700" data-preset="all">
                                    All Time
                                </button>
                            </div>
                            <div class="h-6 w-px bg-slate-200"></div>
                            <!-- Custom Date Range -->
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <input type="date" id="analyticsStartDate"
                                        class="px-3 py-1.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                                        onchange="handleAnalyticsDateChange()">
                                </div>
                                <span class="text-slate-400 text-sm">to</span>
                                <div class="relative">
                                    <input type="date" id="analyticsEndDate"
                                        class="px-3 py-1.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                                        onchange="handleAnalyticsDateChange()">
                                </div>
                                <button onclick="applyAnalyticsDateRange()" class="bg-teal-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-teal-700 transition-colors">
                                    Apply
                                </button>
                                <button onclick="clearAnalyticsDateRange()" class="text-slate-400 hover:text-slate-600 px-2 py-1.5 text-xs">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Filter Status -->
                        <div id="analyticsFilterStatus" class="hidden flex flex-wrap items-center gap-2 text-xs text-slate-500 bg-slate-50 px-3 py-2 rounded-lg">
                            <span>Filtering:</span>
                            <span id="analyticsFilterEmailBadge" class="hidden bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-medium">
                                <i class="fa-solid fa-user mr-1"></i><span id="analyticsFilterEmailText"></span>
                            </span>
                            <span id="analyticsFilterJobBadge" class="hidden bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-medium">
                                <i class="fa-solid fa-briefcase mr-1"></i>Job <span id="analyticsFilterJobText"></span>
                            </span>
                            <span id="analyticsFilterDateBadge" class="hidden bg-teal-100 text-teal-700 px-2 py-1 rounded-full font-medium">
                                <i class="fa-solid fa-calendar-days mr-1"></i><span id="analyticsFilterDateText"></span>
                            </span>
                        </div>
                    </div>

                    <!-- Analytics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-6 mb-8">
                        <div class="stat-card border-indigo-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-1">Active Users</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalUsers">-</h2>
                                </div>
                                <div class="bg-indigo-50 p-2 rounded-lg text-indigo-600"><i class="fa-solid fa-users"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-emerald-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-1">Emails Sent</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalEmails">-</h2>
                                </div>
                                <div class="bg-emerald-50 p-2 rounded-lg text-emerald-600"><i class="fa-solid fa-envelope"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-cyan-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-cyan-500 uppercase tracking-wider mb-1">Data Gathering</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalDataFetches">-</h2>
                                </div>
                                <div class="bg-cyan-50 p-2 rounded-lg text-cyan-600"><i class="fa-solid fa-database"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-amber-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-amber-500 uppercase tracking-wider mb-1">Auto Follow-Ups</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalFollowUps">-</h2>
                                </div>
                                <div class="bg-amber-50 p-2 rounded-lg text-amber-600"><i class="fa-solid fa-reply-all"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-purple-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-purple-500 uppercase tracking-wider mb-1">Negotiations</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalNegotiations">-</h2>
                                </div>
                                <div class="bg-purple-50 p-2 rounded-lg text-purple-600"><i class="fa-solid fa-handshake"></i></div>
                            </div>
                        </div>
                        <div class="stat-card border-green-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-xs font-bold text-green-500 uppercase tracking-wider mb-1">Completed</p>
                                    <h2 class="text-3xl font-extrabold text-slate-800" id="statTotalCompleted">-</h2>
                                </div>
                                <div class="bg-green-50 p-2 rounded-lg text-green-600"><i class="fa-solid fa-check-circle"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- User Activity Table with Job ID Pivot -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="bg-indigo-100 p-2 rounded-lg">
                                        <i class="fa-solid fa-users text-indigo-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800">User Activity</h4>
                                        <p class="text-xs text-slate-500">Click on a user row to expand job-level breakdown</p>
                                    </div>
                                </div>
                                <button onclick="toggleAllUserRows()" id="toggleAllRowsBtn" class="text-xs px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors">
                                    <i class="fa-solid fa-expand-alt mr-1"></i> Expand All
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase">
                                    <tr>
                                        <th class="px-6 py-3 w-8"></th>
                                        <th class="px-6 py-3">User Email / Job ID</th>
                                        <th class="px-6 py-3 text-center">Emails Sent</th>
                                        <th class="px-6 py-3 text-center">Data Gathering</th>
                                        <th class="px-6 py-3 text-center">Negotiations</th>
                                        <th class="px-6 py-3 text-center">Follow-Ups</th>
                                        <th class="px-6 py-3">Last Active</th>
                                    </tr>
                                </thead>
                                <tbody id="userStatsTableBody" class="divide-y divide-slate-100">
                                    <tr id="userStatsEmptyState">
                                        <td colspan="7" class="px-6 py-8 text-center text-slate-400">
                                            <i class="fa-regular fa-folder-open text-2xl mb-2 block"></i>
                                            No user activity recorded yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Performance Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Conversion Funnel Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2 rounded-lg">
                                        <i class="fa-solid fa-filter text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800">Conversion Funnel</h4>
                                        <p class="text-xs text-slate-500">Candidate journey from outreach to acceptance</p>
                                    </div>
                                </div>
                                <button onclick="refreshChartData()" class="text-slate-400 hover:text-slate-600 p-2 rounded-lg hover:bg-slate-100 transition-colors">
                                    <i class="fa-solid fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="relative h-64">
                                <canvas id="funnelChart"></canvas>
                            </div>
                            <div id="funnelStats" class="grid grid-cols-4 gap-2 mt-4 pt-4 border-t border-slate-100">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-600" id="funnelOutreach">-</div>
                                    <div class="text-xs text-slate-500">Outreach</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-cyan-600" id="funnelResponded">-</div>
                                    <div class="text-xs text-slate-500">Responded</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-amber-600" id="funnelNegotiating">-</div>
                                    <div class="text-xs text-slate-500">Negotiating</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-emerald-600" id="funnelAccepted">-</div>
                                    <div class="text-xs text-slate-500">Accepted</div>
                                </div>
                            </div>
                        </div>

                        <!-- Response Time Distribution Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-2 rounded-lg">
                                        <i class="fa-solid fa-clock text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800">Response Time Distribution</h4>
                                        <p class="text-xs text-slate-500">How quickly candidates respond to outreach</p>
                                    </div>
                                </div>
                            </div>
                            <div class="relative h-64">
                                <canvas id="responseTimeChart"></canvas>
                            </div>
                            <div id="responseTimeStats" class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-slate-100">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-emerald-600" id="avgResponseTime">-</div>
                                    <div class="text-xs text-slate-500">Avg Response</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-teal-600" id="medianResponseTime">-</div>
                                    <div class="text-xs text-slate-500">Median Response</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-cyan-600" id="responseRatePercent">-</div>
                                    <div class="text-xs text-slate-500">Response Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Outcome Breakdown Pie Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-2 rounded-lg">
                                    <i class="fa-solid fa-chart-pie text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Negotiation Outcomes</h4>
                                    <p class="text-xs text-slate-500">Distribution of negotiation results</p>
                                </div>
                            </div>
                            <div class="relative h-56">
                                <canvas id="outcomeChart"></canvas>
                            </div>
                            <div id="outcomeStats" class="flex flex-wrap justify-center gap-3 mt-4 pt-4 border-t border-slate-100">
                                <div class="flex items-center gap-1.5 text-xs">
                                    <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                                    <span class="text-slate-600">Accepted: <strong id="outcomeAccepted">0</strong></span>
                                </div>
                                <div class="flex items-center gap-1.5 text-xs">
                                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                    <span class="text-slate-600">Rejected: <strong id="outcomeRejected">0</strong></span>
                                </div>
                                <div class="flex items-center gap-1.5 text-xs">
                                    <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                                    <span class="text-slate-600">Escalated: <strong id="outcomeEscalated">0</strong></span>
                                </div>
                                <div class="flex items-center gap-1.5 text-xs">
                                    <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                                    <span class="text-slate-600">Unresponsive: <strong id="outcomeUnresponsive">0</strong></span>
                                </div>
                            </div>
                        </div>

                        <!-- Response by Day of Week Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-gradient-to-br from-amber-500 to-orange-600 p-2 rounded-lg">
                                    <i class="fa-solid fa-calendar-week text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Response by Day</h4>
                                    <p class="text-xs text-slate-500">Best days for candidate responses</p>
                                </div>
                            </div>
                            <div class="relative h-56">
                                <canvas id="dayOfWeekChart"></canvas>
                            </div>
                            <div id="dayStats" class="text-center mt-4 pt-4 border-t border-slate-100">
                                <span class="text-xs text-slate-500">Best day: </span>
                                <span class="text-sm font-bold text-amber-600" id="bestResponseDay">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Split Charts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-emerald-100 p-2 rounded-lg">
                                    <i class="fa-solid fa-user-check text-emerald-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Emails by User</h4>
                                    <p class="text-xs text-slate-500">Email distribution across team members</p>
                                </div>
                            </div>
                            <div id="emailUsersList" class="space-y-3">
                                <div id="emailUsersEmpty" class="text-center py-6 text-slate-400">
                                    <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                                    <span class="text-sm">No emails sent yet</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-amber-100 p-2 rounded-lg">
                                    <i class="fa-solid fa-briefcase text-amber-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Emails by Job</h4>
                                    <p class="text-xs text-slate-500">Email activity grouped by job ID</p>
                                </div>
                            </div>
                            <div id="emailJobsList" class="space-y-2">
                                <div id="emailJobsEmpty" class="text-center py-6 text-slate-400">
                                    <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                                    <span class="text-sm">No emails sent yet</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Completed Breakdown Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-blue-100 p-2 rounded-lg">
                                    <i class="fa-solid fa-user-check text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Completed by User</h4>
                                    <p class="text-xs text-slate-500">Completion distribution across team members</p>
                                </div>
                            </div>
                            <div id="completedUsersList" class="space-y-3">
                                <div id="completedUsersEmpty" class="text-center py-6 text-slate-400">
                                    <i class="fa-regular fa-check-circle text-2xl mb-2 block"></i>
                                    <span class="text-sm">No completions yet</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-purple-100 p-2 rounded-lg">
                                    <i class="fa-solid fa-clipboard-check text-purple-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Completed by Job</h4>
                                    <p class="text-xs text-slate-500">Completions grouped by job ID</p>
                                </div>
                            </div>
                            <div id="completedJobsList" class="space-y-2">
                                <div id="completedJobsEmpty" class="text-center py-6 text-slate-400">
                                    <i class="fa-regular fa-check-circle text-2xl mb-2 block"></i>
                                    <span class="text-sm">No completions yet</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden container for recent activity to prevent errors if script references it -->
                    <div id="recentActivityList" class="hidden"></div>
                </div>

                <!-- TAB: AI LEARNING - Train AI from Human Escalations -->
                <div id="tab-learning" class="tab-content hidden-tab">
                    <div class="flex flex-col gap-4 mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800 dark:text-white">AI Learning Center</h3>
                                <p class="text-sm text-slate-500">Review and approve learnings from successful human escalations to improve AI negotiations.</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="learningRefreshBtn" onclick="refreshLearningCasesWithAnimation()" class="refresh-btn bg-white border border-slate-300 px-3 py-2 rounded-lg text-sm hover:bg-slate-50">
                                    <i class="fa-solid fa-rotate mr-1"></i> Refresh
                                </button>
                                <button onclick="consolidateLearnings()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700">
                                    <i class="fa-solid fa-compress-arrows-alt mr-1"></i> Consolidate to FAQs
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Learning Stats Cards - Row 1 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-4">
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Pending Review</p>
                                    <p id="learningPendingCount" class="text-3xl font-bold text-amber-600">0</p>
                                </div>
                                <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center">
                                    <i class="fa-solid fa-clock text-amber-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Approved</p>
                                    <p id="learningApprovedCount" class="text-3xl font-bold text-green-600">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center">
                                    <i class="fa-solid fa-check text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Consolidated</p>
                                    <p id="learningConsolidatedCount" class="text-3xl font-bold text-indigo-600">0</p>
                                </div>
                                <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl flex items-center justify-center">
                                    <i class="fa-solid fa-book text-indigo-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Effectiveness</p>
                                    <p id="learningEffectivenessRate" class="text-3xl font-bold text-cyan-600">0%</p>
                                </div>
                                <div class="w-12 h-12 bg-cyan-100 dark:bg-cyan-900/30 rounded-xl flex items-center justify-center">
                                    <i class="fa-solid fa-chart-line text-cyan-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Learning Stats Cards - Row 2 (Learning Types) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700 border-l-4 border-l-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Positive Learnings</p>
                                    <p id="learningPositiveCount" class="text-2xl font-bold text-green-600">0</p>
                                    <p class="text-xs text-slate-400 mt-1">From successful escalations</p>
                                </div>
                                <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-thumbs-up text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700 border-l-4 border-l-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Negative Learnings</p>
                                    <p id="learningNegativeCount" class="text-2xl font-bold text-red-600">0</p>
                                    <p class="text-xs text-slate-400 mt-1">From failed negotiations</p>
                                </div>
                                <div class="w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-thumbs-down text-red-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700 border-l-4 border-l-purple-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Style Adaptations</p>
                                    <p id="learningStyleCount" class="text-2xl font-bold text-purple-600">0</p>
                                    <p class="text-xs text-slate-400 mt-1">Candidate tone patterns</p>
                                </div>
                                <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-masks-theater text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Total Learnings</p>
                                    <p id="learningTotalCount" class="text-2xl font-bold text-slate-800 dark:text-white">0</p>
                                    <p class="text-xs text-slate-400 mt-1">All learning types</p>
                                </div>
                                <div class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-brain text-slate-600 dark:text-slate-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Learning Validation Performance Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-gradient-to-br from-emerald-500 to-green-600 p-2 rounded-lg">
                                    <i class="fa-solid fa-trophy text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 dark:text-white">Top Performing Learnings</h4>
                                    <p class="text-xs text-slate-500">Learnings with highest success rates (used 3+ times)</p>
                                </div>
                            </div>
                            <div id="topPerformersList" class="space-y-2">
                                <div class="text-center py-4 text-slate-400 text-sm">
                                    <i class="fa-solid fa-chart-simple text-2xl mb-2 block"></i>
                                    No data yet - learnings need 3+ uses to appear here
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-gradient-to-br from-amber-500 to-orange-600 p-2 rounded-lg">
                                    <i class="fa-solid fa-triangle-exclamation text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 dark:text-white">Underperforming Learnings</h4>
                                    <p class="text-xs text-slate-500">Learnings with &lt;40% effectiveness - consider reviewing</p>
                                </div>
                            </div>
                            <div id="lowPerformersList" class="space-y-2">
                                <div class="text-center py-4 text-slate-400 text-sm">
                                    <i class="fa-solid fa-check-circle text-2xl mb-2 block text-green-400"></i>
                                    No underperforming learnings detected
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Consolidation Trigger -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-calendar-week text-blue-600 text-xl"></i>
                                <div>
                                    <p class="font-medium text-blue-800 dark:text-blue-200">Weekly Auto-Consolidation</p>
                                    <p class="text-sm text-blue-600 dark:text-blue-300">Approved learnings are automatically added to Negotiation FAQs every Sunday at 2 AM</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="setupWeeklyConsolidation()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    <i class="fa-solid fa-play mr-1"></i> Enable
                                </button>
                                <button onclick="removeWeeklyConsolidation()" class="bg-white border border-blue-300 text-blue-700 px-3 py-2 rounded-lg text-sm hover:bg-blue-50">
                                    <i class="fa-solid fa-stop mr-1"></i> Disable
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Learning Cases -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700">
                            <h4 class="font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="fa-solid fa-lightbulb text-amber-500"></i>
                                Pending Learning Cases
                            </h4>
                            <p class="text-sm text-slate-500 mt-1">Review and approve cases to add them to the AI's knowledge base</p>
                        </div>
                        <div id="learningCasesList" class="divide-y divide-slate-200 dark:divide-slate-700">
                            <div class="p-8 text-center text-slate-500">
                                <i class="fa-solid fa-inbox text-4xl mb-3 text-slate-300"></i>
                                <p>No pending learning cases</p>
                                <p class="text-sm">Learning cases will appear here when human escalations are completed</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI TESTING FEATURE - DELETE FOR PRODUCTION (START TAB CONTENT) -->
                <!-- TAB 6: AI TESTING (ADMIN ONLY) -->
                <div id="tab-aitesting" class="tab-content hidden-tab">
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">AI Email Response Testing</h3>
                                <p class="text-sm text-slate-500">Test AI responses for negotiation, follow-up, and data gathering without sending real emails.</p>
                            </div>
                            <button onclick="startNewAiTestSession()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> New Session
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Panel: Scenario Input -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                            <h4 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-edit text-blue-500"></i> Test Scenario
                            </h4>

                            <!-- Test Type Selection (Multi-Select) -->
                            <div class="mb-4">
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Test Functions <span class="text-slate-400 font-normal">(select one or more)</span></label>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="toggleAiTestType('negotiation')" id="testTypeNegotiation" class="smart-chip active" data-test-type="negotiation">
                                        <i class="fa-solid fa-hand-holding-dollar mr-1"></i> Negotiation
                                    </button>
                                    <button onclick="toggleAiTestType('followup')" id="testTypeFollowup" class="smart-chip" data-test-type="followup">
                                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> Follow-Up
                                    </button>
                                    <button onclick="toggleAiTestType('datagathering')" id="testTypeDatagathering" class="smart-chip" data-test-type="datagathering">
                                        <i class="fa-solid fa-clipboard-question mr-1"></i> Data Gathering
                                    </button>
                                </div>
                                <p id="aiTestFunctionsHint" class="text-xs text-slate-400 mt-2 italic">Negotiation enabled. AI will negotiate rates with candidates.</p>
                            </div>

                            <!-- Developer Details -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Developer Name</label>
                                    <input type="text" id="aiTestDevName" class="input-field" placeholder="John Doe">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Developer Email</label>
                                    <input type="email" id="aiTestDevEmail" class="input-field" placeholder="john@example.com">
                                </div>
                            </div>

                            <!-- Country / Region Details -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Developer Country</label>
                                    <input type="text" id="aiTestDevCountry" class="input-field" placeholder="India, US, Brazil, etc.">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">
                                        Job ID <span class="text-slate-400 font-normal">(for rate tiers)</span>
                                    </label>
                                    <div class="flex gap-2">
                                        <input type="text" id="aiTestJobId" class="input-field flex-1" placeholder="51000">
                                        <button onclick="loadAiTestRateTiers()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm" title="Load rate tiers for this job">
                                            <i class="fa-solid fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Description -->
                            <div class="mb-4">
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Job Description / Context</label>
                                <textarea id="aiTestJobDesc" class="input-field min-h-[80px]" placeholder="Senior React Developer needed for e-commerce platform. Remote work, 6-month contract..."></textarea>
                            </div>

                            <!-- Negotiation-specific fields -->
                            <div id="negotiationFields" class="mb-4 p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700">
                                <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Negotiation Settings</h5>

                                <!-- Rate Tiers Selection -->
                                <div class="mb-4">
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">
                                        Regional Rate Tier
                                        <span class="text-slate-400 font-normal">(load from Job ID above)</span>
                                    </label>
                                    <select id="aiTestRateTier" class="input-field" onchange="applySelectedRateTier()">
                                        <option value="">-- Manual Entry (no tier selected) --</option>
                                    </select>
                                    <div id="aiTestRateTierInfo" class="hidden mt-2 p-2 bg-blue-50 dark:bg-blue-900/30 rounded text-xs text-blue-700 dark:text-blue-300">
                                        <i class="fa-solid fa-info-circle mr-1"></i>
                                        <span id="aiTestRateTierInfoText"></span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Target Rate ($/hr)</label>
                                        <input type="number" id="aiTestTargetRate" class="input-field" placeholder="45">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Max Rate ($/hr)</label>
                                        <input type="number" id="aiTestMaxRate" class="input-field" placeholder="55">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Attempt #</label>
                                    <select id="aiTestAttempt" class="input-field">
                                        <option value="1">1st Attempt (80% of target rate)</option>
                                        <option value="2">2nd Attempt (100% of target rate)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Follow-up specific fields -->
                            <div id="followupFields" class="mb-4 p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 hidden">
                                <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Follow-Up Settings</h5>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Follow-Up Number</label>
                                    <select id="aiTestFollowUpNum" class="input-field">
                                        <option value="1">1st Follow-Up (12 hours)</option>
                                        <option value="2">2nd Follow-Up (28 hours)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Data Gathering specific fields -->
                            <div id="dataGatheringFields" class="mb-4 p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 hidden">
                                <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Data Extraction Settings</h5>
                                <div class="mb-3">
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Questions to Extract (comma separated)</label>
                                    <textarea id="aiTestPendingQuestions" class="input-field min-h-[60px]" placeholder="What is your expected hourly rate?, When can you start?, How many hours per week are you available?"></textarea>
                                </div>
                                <button onclick="runDataExtraction()" id="extractDataBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-table-cells"></i> <span>Extract Data & Preview Sheet</span>
                                </button>
                            </div>

                            <!-- Simulated Reply (Candidate Response) -->
                            <div class="mb-4">
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">
                                    Simulated Candidate Reply
                                    <span class="text-slate-400 font-normal">(as if they replied to our email)</span>
                                </label>
                                <textarea id="aiTestCandidateReply" class="input-field min-h-[100px]" placeholder="Hi, thanks for reaching out! I'm interested in the role but my rate is $60/hr. Is there flexibility?"></textarea>
                            </div>

                            <!-- Test Button -->
                            <button onclick="runAiTest()" id="runAiTestBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-2">
                                <i class="fa-solid fa-paper-plane"></i> <span id="runAiTestBtnText">Send & Generate Response</span>
                            </button>
                        </div>

                        <!-- Right Panel: Conversation Thread & Data Extraction -->
                        <div class="space-y-6">
                            <!-- Conversation Thread (WhatsApp-style Chat) -->
                            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                                <!-- Chat Header -->
                                <div class="bg-gradient-to-r from-green-600 to-green-700 px-4 py-3 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                            <i class="fa-solid fa-comments text-white"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-white text-sm">Conversation Thread</h4>
                                            <p class="text-xs text-green-100" id="chatThreadStatus">Test the full email conversation flow</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span id="chatActiveFunctions" class="text-xs bg-white/20 text-white px-2 py-1 rounded-full">Negotiation</span>
                                        <button onclick="clearConversationThread()" class="text-white/70 hover:text-white p-2" title="Clear conversation">
                                            <i class="fa-solid fa-trash-can text-sm"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Chat Messages Container -->
                                <div id="conversationThread" class="h-[400px] overflow-y-auto p-4 bg-slate-100 dark:bg-slate-900 space-y-4">

                                    <!-- Empty State -->
                                    <div id="chatEmptyState" class="text-center py-16">
                                        <div class="w-16 h-16 rounded-full bg-slate-200 dark:bg-slate-700 mx-auto flex items-center justify-center mb-4">
                                            <i class="fa-solid fa-message text-2xl text-slate-400"></i>
                                        </div>
                                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">No conversation yet</p>
                                        <p class="text-xs text-slate-400">Enter a candidate reply and click "Send & Generate Response" to start testing</p>
                                    </div>

                                    <!-- Chat messages will be inserted here by JS -->
                                </div>

                                <!-- Quick Reply Input (for continued conversation) -->
                                <div id="quickReplySection" class="hidden border-t border-slate-200 dark:border-slate-700 p-3 bg-white dark:bg-slate-800">
                                    <div class="flex gap-2">
                                        <input type="text" id="quickReplyInput" class="input-field flex-1" placeholder="Type candidate's next reply..." onkeypress="if(event.key==='Enter') sendQuickReply()">
                                        <button onclick="sendQuickReply()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                                            <i class="fa-solid fa-paper-plane"></i> Send
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Legacy AI Response Output (hidden, for compatibility) -->
                            <div id="legacyAiResponseSection" class="hidden">
                                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                                    <h4 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                        <i class="fa-solid fa-robot text-green-500"></i> AI Response
                                    </h4>
                                    <div id="aiTestResponseContainer" class="min-h-[200px] bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 p-4">
                                        <div id="aiTestResponseEmpty" class="text-center py-10 text-slate-400">
                                            <i class="fa-solid fa-comment-dots text-4xl mb-3 block"></i>
                                            <p class="text-sm">Configure a scenario and click "Generate AI Response" to see how the AI would reply.</p>
                                        </div>
                                        <div id="aiTestResponseContent" class="hidden">
                                            <div class="flex items-center gap-2 mb-3">
                                                <span id="aiTestResponseType" class="text-xs font-bold uppercase px-2 py-1 rounded bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300">NEGOTIATION</span>
                                                <span id="aiTestResponseTime" class="text-xs text-slate-500"></span>
                                            </div>
                                            <div id="aiTestResponseText" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed"></div>
                                        </div>
                                        <div id="aiTestResponseLoading" class="hidden text-center py-10">
                                            <i class="fa-solid fa-spinner fa-spin text-3xl text-blue-500 mb-3 block"></i>
                                            <p class="text-sm text-slate-500">Generating AI response...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Extraction Results (for Data Gathering mode) -->
                            <div id="dataExtractionResults" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 hidden">
                                <h4 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-table-cells text-purple-500"></i> Data Extraction Results
                                </h4>

                                <!-- Summary -->
                                <div id="extractionSummary" class="mb-4 p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-slate-600 dark:text-slate-400">Data Completeness</span>
                                        <span id="extractionStatus" class="text-xs font-bold px-2 py-1 rounded">--</span>
                                    </div>
                                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 mb-2">
                                        <div id="extractionProgressBar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                    <p id="extractionProgressText" class="text-xs text-slate-500">0 of 0 fields extracted</p>
                                </div>

                                <!-- Extracted Fields Table -->
                                <div class="mb-4">
                                    <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Extracted Fields</h5>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-slate-200 dark:border-slate-700">
                                                    <th class="text-left py-2 px-2 text-xs font-bold text-slate-500">Field</th>
                                                    <th class="text-left py-2 px-2 text-xs font-bold text-slate-500">Extracted Value</th>
                                                    <th class="text-left py-2 px-2 text-xs font-bold text-slate-500">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="extractedFieldsTable">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Sheet Preview -->
                                <div class="mb-4">
                                    <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                                        <i class="fa-solid fa-file-excel text-green-500 mr-1"></i> Sheet Preview
                                        <span class="text-slate-400 font-normal text-xs">(how it would appear in Job_X_Details)</span>
                                    </h5>
                                    <div class="overflow-x-auto bg-white dark:bg-slate-900 rounded border border-slate-300 dark:border-slate-600">
                                        <table class="w-full text-xs">
                                            <thead id="sheetPreviewHeaders" class="bg-green-50 dark:bg-green-900/20">
                                                <!-- Populated by JS -->
                                            </thead>
                                            <tbody id="sheetPreviewValues">
                                                <!-- Populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Negotiation Notes -->
                                <div id="extractionNegotiationNotes" class="hidden p-3 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800">
                                    <p class="text-sm text-amber-800 dark:text-amber-200">
                                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                                        <span id="negotiationNotesText"></span>
                                    </p>
                                </div>
                            </div>

                            <!-- AI Summary Panel (generated with each test) -->
                            <div id="aiTestSummaryPanel" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 hidden">
                                <h4 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-robot text-purple-500"></i> AI Summary
                                    <span class="text-xs font-normal text-slate-400">(Email + Data + Negotiation)</span>
                                </h4>
                                <div id="aiTestSummaryContent" class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed max-h-96 overflow-y-auto"></div>
                            </div>

                            <!-- Session History -->
                            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                        <i class="fa-solid fa-history text-purple-500"></i> Session History
                                    </h4>
                                    <button onclick="clearAiTestHistory()" class="text-xs text-slate-500 hover:text-red-500">
                                        <i class="fa-solid fa-trash mr-1"></i> Clear
                                    </button>
                                </div>
                                <div id="aiTestHistoryContainer" class="max-h-[300px] overflow-y-auto space-y-2">
                                    <div id="aiTestHistoryEmpty" class="text-center py-6 text-slate-400">
                                        <i class="fa-regular fa-clock text-2xl mb-2 block"></i>
                                        <span class="text-sm">No tests run yet in this session</span>
                                    </div>
                                    <div id="aiTestHistoryList" class="hidden space-y-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- AI TESTING FEATURE - DELETE FOR PRODUCTION (END TAB CONTENT) -->

                <!-- TAB 7: PROCESS MAP (ADMIN ONLY) -->
                <div id="tab-processmap" class="tab-content hidden-tab">
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">System Process Map</h3>
                                <p class="text-sm text-slate-500">Visual flowchart of the HR-Ops-AI system workflow with real-time status indicators.</p>
                            </div>
                            <button onclick="refreshProcessMap()" id="refreshProcessMapBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                                <i class="fa-solid fa-sync"></i> Refresh Status
                            </button>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mb-6 flex flex-wrap gap-4 items-center">
                        <div class="text-xs font-bold uppercase text-slate-500">Status Legend:</div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-xs text-slate-600 dark:text-slate-400">Working</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                            <span class="text-xs text-slate-600 dark:text-slate-400">Idle / Waiting</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></span>
                            <span class="text-xs text-slate-600 dark:text-slate-400">Error / Needs Attention</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                            <span class="text-xs text-slate-600 dark:text-slate-400">Disabled / Not Configured</span>
                        </div>
                    </div>

                    <!-- Main Flowchart Grid -->
                    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">

                        <!-- PHASE 1: Data Fetching & Email Sending -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                                    <span class="text-blue-600 dark:text-blue-400 font-bold text-sm">1</span>
                                </div>
                                <h4 class="font-bold text-slate-800 dark:text-white">Data Fetching & Outreach</h4>
                            </div>

                            <!-- Flow Steps -->
                            <div class="space-y-3">
                                <!-- User Action -->
                                <div class="process-node process-node-user">
                                    <i class="fa-solid fa-user text-blue-500"></i>
                                    <span>User enters Job ID</span>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- BigQuery Fetch -->
                                <div id="node-bigquery" class="process-node process-node-action pm-tooltip">
                                    <span class="pm-tooltip-text">Fetches candidate data from Turing's database based on Job ID and pipeline stages</span>
                                    <div class="flex items-center gap-2">
                                        <span id="status-bigquery" class="status-light status-idle"></span>
                                        <i class="fa-solid fa-database text-purple-500"></i>
                                        <span class="process-tooltip-wrapper">
                                            BigQuery Fetch
                                            <span class="process-tooltip">
                                                <div class="tooltip-title">BigQuery Data Warehouse</div>
                                                Google's serverless data warehouse that stores candidate profiles. Queries candidate data based on Job ID filters.
                                            </span>
                                        </span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1" id="bigquery-detail">
                                        <span class="process-tooltip-wrapper func-name">
                                            getDevelopers()
                                            <span class="process-tooltip">
                                                <div class="tooltip-title">getDevelopers()</div>
                                                Queries BigQuery to fetch developer candidates matching the job requirements. Returns name, email, skills, and rate expectations.
                                            </span>
                                        </span>
                                    </div>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Decision: Data Found? -->
                                <div class="process-node process-node-decision">
                                    <i class="fa-solid fa-code-branch text-amber-500"></i>
                                    <span>Candidates Found?</span>
                                </div>
                                <div class="flex gap-4 text-xs">
                                    <div class="flex-1 text-center">
                                        <div class="text-green-600 font-medium">Yes</div>
                                        <i class="fa-solid fa-arrow-down text-green-400"></i>
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div class="text-red-500 font-medium">No</div>
                                        <i class="fa-solid fa-arrow-right text-red-400"></i>
                                        <span class="text-slate-400">Stop</span>
                                    </div>
                                </div>

                                <!-- Email Sending -->
                                <div id="node-email-send" class="process-node process-node-action pm-tooltip">
                                    <span class="pm-tooltip-text">Sends personalized emails to selected candidates in batches of 15</span>
                                    <div class="flex items-center gap-2">
                                        <span id="status-email-send" class="status-light status-idle"></span>
                                        <i class="fa-solid fa-envelope text-green-500"></i>
                                        <span>Send Emails</span>
                                    </div>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Outputs -->
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">Records all sent emails with timestamps</span>
                                        <i class="fa-solid fa-list-check text-blue-400 text-xs"></i>
                                        <span class="text-xs node-label">Email_Logs</span>
                                        <span class="process-tooltip">
                                            <div class="tooltip-title">Email_Logs Sheet</div>
                                            Records all sent emails with timestamps, recipient info, and thread IDs for tracking.
                                        </span>
                                    </div>
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">Tracks negotiation progress for each candidate</span>
                                        <i class="fa-solid fa-brain text-purple-400 text-xs"></i>
                                        <span class="text-xs">Nego_State</span>
                                    </div>
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">Queue for automated follow-up reminders</span>
                                        <i class="fa-solid fa-clock text-amber-400 text-xs"></i>
                                        <span class="text-xs">FollowUp_Q</span>
                                    </div>
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">Stores candidate responses and details per job</span>
                                        <i class="fa-solid fa-table text-green-400 text-xs"></i>
                                        <span class="text-xs node-label">Job_Details</span>
                                        <span class="process-tooltip">
                                            <div class="tooltip-title">Job_Details Sheet</div>
                                            Stores job requirements including target rates, required skills, and negotiation parameters.
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PHASE 2: Auto Negotiation -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                                    <span class="text-purple-600 dark:text-purple-400 font-bold text-sm">2</span>
                                </div>
                                <h4 class="font-bold text-slate-800 dark:text-white">Auto Negotiation</h4>
                                <span class="ml-auto text-xs bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-400 px-2 py-1 rounded-full">Hourly</span>
                            </div>

                            <!-- Flow Steps -->
                            <div class="space-y-3">
                                <!-- Trigger -->
                                <div id="node-auto-negotiator" class="process-node process-node-trigger pm-tooltip">
                                    <span class="pm-tooltip-text">Runs every hour to automatically handle candidate replies and send AI-powered negotiation responses</span>
                                    <div class="flex items-center gap-2">
                                        <span id="status-auto-negotiator" class="status-light status-idle"></span>
                                        <i class="fa-solid fa-clock text-purple-500"></i>
                                        <span class="process-tooltip-wrapper func-name">
                                            runAutoNegotiator()
                                            <span class="process-tooltip">
                                                <div class="tooltip-title">runAutoNegotiator()</div>
                                                Main orchestrator for AI negotiations. Runs hourly via time-based trigger. Syncs emails, processes replies, and sends AI responses.
                                            </span>
                                        </span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1" id="auto-negotiator-detail">Trigger: Every hour</div>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Sync Gmail -->
                                <div class="process-node process-node-action pm-tooltip">
                                    <span class="pm-tooltip-text">Checks Gmail for completed negotiations and syncs their status</span>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-sync text-blue-500"></i>
                                        <span>syncCompletedFromGmail()</span>
                                    </div>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Decision: Reply? -->
                                <div class="process-node process-node-decision">
                                    <i class="fa-solid fa-code-branch text-amber-500"></i>
                                    <span>Candidate Replied?</span>
                                </div>
                                <div class="flex gap-4 text-xs mb-2">
                                    <div class="flex-1 text-center">
                                        <div class="text-green-600 font-medium">Yes</div>
                                        <i class="fa-solid fa-arrow-down text-green-400"></i>
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div class="text-red-500 font-medium">No</div>
                                        <span class="text-slate-400 text-xs">Skip</span>
                                    </div>
                                </div>

                                <!-- Decision: Attempts? -->
                                <div class="process-node process-node-decision">
                                    <i class="fa-solid fa-code-branch text-amber-500"></i>
                                    <span>Attempts &lt; 2?</span>
                                </div>
                                <div class="flex gap-2 text-xs">
                                    <div class="flex-1 text-center">
                                        <div class="text-green-600 font-medium">Yes</div>
                                        <i class="fa-solid fa-arrow-down text-green-400"></i>
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div class="text-red-500 font-medium">No</div>
                                        <i class="fa-solid fa-arrow-right text-red-400"></i>
                                    </div>
                                </div>

                                <!-- Two outcomes -->
                                <div class="grid grid-cols-2 gap-2">
                                    <!-- AI Reply -->
                                    <div id="node-openai" class="process-node process-node-action p-2 pm-tooltip">
                                        <span class="pm-tooltip-text">AI generates a personalized negotiation reply using OpenAI</span>
                                        <div class="flex items-center gap-1">
                                            <span id="status-openai" class="status-light status-idle"></span>
                                            <i class="fa-solid fa-robot text-green-500 text-xs"></i>
                                            <span class="text-xs">AI Reply</span>
                                        </div>
                                        <div class="text-[10px] text-slate-500">OpenAI</div>
                                    </div>
                                    <!-- Escalate -->
                                    <div class="process-node process-node-output p-2 pm-tooltip">
                                        <span class="pm-tooltip-text">After 2 AI attempts, task moves to human for manual review</span>
                                        <div class="flex items-center gap-1">
                                            <i class="fa-solid fa-user-tie text-amber-500 text-xs"></i>
                                            <span class="text-xs">Escalate</span>
                                        </div>
                                        <div class="text-[10px] text-slate-500">Human</div>
                                    </div>
                                </div>

                                <!-- Rate Logic -->
                                <div class="mt-3 p-2 bg-slate-50 dark:bg-slate-900 rounded-lg text-xs">
                                    <div class="font-medium text-slate-600 dark:text-slate-400 mb-1">Rate Offers:</div>
                                    <div class="text-slate-500">1st: 70% of target</div>
                                    <div class="text-slate-500">2nd: 100% of target</div>
                                </div>
                            </div>
                        </div>

                        <!-- PHASE 3: Follow-Up Processing -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 rounded-full bg-amber-100 dark:bg-amber-900 flex items-center justify-center">
                                    <span class="text-amber-600 dark:text-amber-400 font-bold text-sm">3</span>
                                </div>
                                <h4 class="font-bold text-slate-800 dark:text-white">Follow-Up Processor</h4>
                                <span class="ml-auto text-xs bg-amber-100 dark:bg-amber-900 text-amber-600 dark:text-amber-400 px-2 py-1 rounded-full">Hourly</span>
                            </div>

                            <!-- Flow Steps -->
                            <div class="space-y-3">
                                <!-- Trigger -->
                                <div id="node-followup-processor" class="process-node process-node-trigger pm-tooltip">
                                    <span class="pm-tooltip-text">Runs every hour to send follow-up emails to candidates who haven't responded</span>
                                    <div class="flex items-center gap-2">
                                        <span id="status-followup-processor" class="status-light status-idle"></span>
                                        <i class="fa-solid fa-clock text-amber-500"></i>
                                        <span class="process-tooltip-wrapper func-name">
                                            runFollowUpProcessor()
                                            <span class="process-tooltip">
                                                <div class="tooltip-title">runFollowUpProcessor()</div>
                                                Processes the follow-up queue hourly. Checks time since initial contact and sends appropriate follow-up emails.
                                            </span>
                                        </span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1" id="followup-processor-detail">Trigger: Every hour</div>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Load Queue -->
                                <div class="process-node process-node-action pm-tooltip">
                                    <span class="pm-tooltip-text">Loads list of candidates waiting for follow-up</span>
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-table text-blue-500"></i>
                                        <span class="process-tooltip-wrapper">
                                            Load Follow_Up_Queue
                                            <span class="process-tooltip">
                                                <div class="tooltip-title">Follow-Up Queue Sheet</div>
                                                Loads pending candidates from the Follow_Up_Queue sheet. Filters by time thresholds for follow-up eligibility.
                                            </span>
                                        </span>
                                    </div>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Decision: Response? -->
                                <div class="process-node process-node-decision">
                                    <i class="fa-solid fa-code-branch text-amber-500"></i>
                                    <span>Candidate Responded?</span>
                                </div>
                                <div class="flex gap-4 text-xs">
                                    <div class="flex-1 text-center">
                                        <div class="text-green-600 font-medium">Yes</div>
                                        <i class="fa-solid fa-arrow-down text-green-400"></i>
                                        <div class="process-node-mini mt-1">
                                            <i class="fa-solid fa-check text-green-400 text-xs"></i>
                                            <span class="text-xs">Responded</span>
                                        </div>
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div class="text-red-500 font-medium">No</div>
                                        <i class="fa-solid fa-arrow-down text-red-400"></i>
                                    </div>
                                </div>

                                <!-- Time-based decisions -->
                                <div class="mt-2 p-3 bg-slate-50 dark:bg-slate-900 rounded-lg">
                                    <div class="text-xs font-medium text-slate-600 dark:text-slate-400 mb-2">Time Since Initial:</div>
                                    <div class="space-y-2 text-xs">
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 font-mono text-slate-500">12h+</span>
                                            <i class="fa-solid fa-arrow-right text-slate-400 text-xs"></i>
                                            <span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 rounded">1st Follow-Up</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 font-mono text-slate-500">28h+</span>
                                            <i class="fa-solid fa-arrow-right text-slate-400 text-xs"></i>
                                            <span class="px-2 py-0.5 bg-amber-100 dark:bg-amber-900 text-amber-600 dark:text-amber-400 rounded">2nd Follow-Up</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="w-16 font-mono text-slate-500">76h+</span>
                                            <i class="fa-solid fa-arrow-right text-slate-400 text-xs"></i>
                                            <span class="px-2 py-0.5 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 rounded">Unresponsive</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Follow-up emails -->
                                <div id="node-followup-email" class="process-node process-node-action pm-tooltip">
                                    <span class="pm-tooltip-text">Sends AI-generated follow-up reminder to the candidate</span>
                                    <div class="flex items-center gap-2">
                                        <span id="status-followup-email" class="status-light status-idle"></span>
                                        <i class="fa-solid fa-paper-plane text-blue-500"></i>
                                        <span class="process-tooltip-wrapper">
                                            Send Follow-Up
                                            <span class="process-tooltip">
                                                <div class="tooltip-title">Follow-Up Email</div>
                                                Sends reminder emails to non-responsive candidates. Timing based on hours since initial contact (12h, 28h, 76h).
                                            </span>
                                        </span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">
                                        <span class="process-tooltip-wrapper func-name">
                                            sendFollowUpEmail()
                                            <span class="process-tooltip">
                                                <div class="tooltip-title">sendFollowUpEmail()</div>
                                                Composes and sends follow-up emails. Uses templates based on follow-up number (1st, 2nd, or final).
                                            </span>
                                        </span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">Auto-generated email</div>
                                </div>
                            </div>
                        </div>

                        <!-- PHASE 4: Human Review & Completion -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center">
                                    <span class="text-green-600 dark:text-green-400 font-bold text-sm">4</span>
                                </div>
                                <h4 class="font-bold text-slate-800 dark:text-white">Human Review</h4>
                                <span class="ml-auto text-xs bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 px-2 py-1 rounded-full">Manual</span>
                            </div>

                            <!-- Flow Steps -->
                            <div class="space-y-3">
                                <!-- Task List -->
                                <div class="process-node process-node-user">
                                    <i class="fa-solid fa-clipboard-check text-green-500"></i>
                                    <span>Task List (UI)</span>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Sources -->
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">Tasks moved here after 2 AI attempts failed</span>
                                        <i class="fa-solid fa-user-tag text-purple-400 text-xs"></i>
                                        <span class="text-xs node-label">Escalated</span>
                                        <span class="process-tooltip">
                                            <div class="tooltip-title">Escalated Tasks</div>
                                            Candidates escalated after 2 AI negotiation attempts. Requires human intervention.
                                        </span>
                                    </div>
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">Gmail label marking threads that need human attention</span>
                                        <i class="fa-solid fa-bell text-amber-400 text-xs"></i>
                                        <span class="text-xs">Human-Nego</span>
                                    </div>
                                </div>

                                <!-- User reviews -->
                                <div class="process-node process-node-user">
                                    <i class="fa-solid fa-user-check text-blue-500"></i>
                                    <span>Admin Reviews Task</span>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Decision: Outcome -->
                                <div class="process-node process-node-decision">
                                    <i class="fa-solid fa-code-branch text-amber-500"></i>
                                    <span>Final Decision?</span>
                                </div>

                                <!-- Outcomes -->
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="process-node-mini bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800">
                                        <i class="fa-solid fa-check text-green-500 text-xs"></i>
                                        <span class="text-xs text-green-700 dark:text-green-400">Accepted</span>
                                    </div>
                                    <div class="process-node-mini bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800">
                                        <i class="fa-solid fa-times text-red-500 text-xs"></i>
                                        <span class="text-xs text-red-700 dark:text-red-400">Rejected</span>
                                    </div>
                                    <div class="process-node-mini bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-800">
                                        <i class="fa-solid fa-user-minus text-amber-500 text-xs"></i>
                                        <span class="text-xs text-amber-700 dark:text-amber-400">Withdrew</span>
                                    </div>
                                    <div class="process-node-mini bg-slate-50 dark:bg-slate-900/30 border-slate-200 dark:border-slate-700">
                                        <i class="fa-solid fa-ellipsis text-slate-500 text-xs"></i>
                                        <span class="text-xs text-slate-700 dark:text-slate-400">Other</span>
                                    </div>
                                </div>
                                <div class="process-arrow"><i class="fa-solid fa-arrow-down text-slate-400"></i></div>

                                <!-- Complete -->
                                <div id="node-complete" class="process-node process-node-action pm-tooltip">
                                    <span class="pm-tooltip-text">Marks the negotiation as finished and archives the record</span>
                                    <div class="flex items-center gap-2">
                                        <span id="status-complete" class="status-light status-idle"></span>
                                        <i class="fa-solid fa-flag-checkered text-green-500"></i>
                                        <span>Complete</span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">Finish & Archive</div>
                                </div>

                                <!-- Final outputs -->
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">Archive sheet storing all finished negotiations</span>
                                        <i class="fa-solid fa-archive text-slate-400 text-xs"></i>
                                        <span class="text-xs">Completed</span>
                                    </div>
                                    <div class="process-node-mini pm-tooltip">
                                        <span class="pm-tooltip-text">"Completed" label applied to Gmail thread for easy filtering</span>
                                        <i class="fa-solid fa-tag text-blue-400 text-xs"></i>
                                        <span class="text-xs">Gmail Tag</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Dashboard -->
                    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- System Status -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                            <h4 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-heartbeat text-red-500"></i> System Status
                            </h4>
                            <div id="systemStatusContainer" class="space-y-3">
                                <div class="status-row">
                                    <span id="status-light-trigger-negotiator" class="status-light status-checking"></span>
                                    <span class="status-label">Auto Negotiator Trigger</span>
                                    <span id="status-text-trigger-negotiator" class="status-value">Checking...</span>
                                </div>
                                <div class="status-row">
                                    <span id="status-light-trigger-followup" class="status-light status-checking"></span>
                                    <span class="status-label">Follow-Up Processor Trigger</span>
                                    <span id="status-text-trigger-followup" class="status-value">Checking...</span>
                                </div>
                                <div class="status-row">
                                    <span id="status-light-sheets" class="status-light status-checking"></span>
                                    <span class="status-label">Database Sheets</span>
                                    <span id="status-text-sheets" class="status-value">Checking...</span>
                                </div>
                                <div class="status-row">
                                    <span id="status-light-gmail" class="status-light status-checking"></span>
                                    <span class="status-label">Gmail API</span>
                                    <span id="status-text-gmail" class="status-value">Checking...</span>
                                </div>
                                <div class="status-row">
                                    <span id="status-light-openai" class="status-light status-checking"></span>
                                    <span class="status-label">OpenAI API</span>
                                    <span id="status-text-openai" class="status-value">Checking...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Today's Statistics -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                            <h4 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-chart-pie text-blue-500"></i> Today's Activity
                            </h4>
                            <div id="todayStatsContainer" class="grid grid-cols-2 gap-3">
                                <div class="stat-box">
                                    <div class="stat-value" id="stat-emails-sent">-</div>
                                    <div class="stat-label">Emails Sent</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="stat-ai-replies">-</div>
                                    <div class="stat-label">AI Replies</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="stat-escalated">-</div>
                                    <div class="stat-label">Escalated</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="stat-followups-sent">-</div>
                                    <div class="stat-label">Follow-Ups Sent</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="stat-completed">-</div>
                                    <div class="stat-label">Completed</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="stat-unresponsive">-</div>
                                    <div class="stat-label">Unresponsive</div>
                                </div>
                            </div>
                        </div>

                        <!-- Queue Status -->
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                            <h4 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-layer-group text-purple-500"></i> Queue Status
                            </h4>
                            <div id="queueStatusContainer" class="space-y-3">
                                <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700">
                                    <span class="text-sm text-slate-600 dark:text-slate-400">Active Negotiations</span>
                                    <span id="queue-negotiations" class="font-bold text-slate-800 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700">
                                    <span class="text-sm text-slate-600 dark:text-slate-400">Pending Follow-Ups</span>
                                    <span id="queue-followups" class="font-bold text-slate-800 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700">
                                    <span class="text-sm text-slate-600 dark:text-slate-400">Awaiting Human Review</span>
                                    <span id="queue-human" class="font-bold text-slate-800 dark:text-white">-</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-sm text-slate-600 dark:text-slate-400">Configured Jobs</span>
                                    <span id="queue-jobs" class="font-bold text-slate-800 dark:text-white">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity Log -->
                    <div class="mt-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="fa-solid fa-history text-amber-500"></i> Recent Activity
                            </h4>
                            <span class="text-xs text-slate-500">Last 24 hours</span>
                        </div>
                        <div id="activityLogContainer" class="max-h-48 overflow-y-auto space-y-2">
                            <div class="text-center py-6 text-slate-400">
                                <i class="fa-solid fa-spinner fa-spin text-xl mb-2 block"></i>
                                <span class="text-sm">Loading activity...</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODALS (Hidden by default) - Preserved exact structure -->
    
    <!-- Config Modal -->
    <div id="configModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Database URL</label>
                    <input id="sheetUrl" class="input-field" placeholder="Google Sheet URL">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Jobs Sheet URL</label>
                    <input id="jobsSheetUrl" class="input-field" placeholder="Google Sheet URL">
                </div>
                
                <!-- Trigger status section -->
                <div id="triggerStatusContainer"></div>
                <div id="createTriggersSection" class="hidden mt-2">
                    <button id="createAllTriggersBtn" onclick="createAllTriggers()" class="w-full bg-green-600 text-white py-2 rounded-lg">Create Triggers</button>
                    <span id="createTriggersText" class="hidden"></span><span id="createTriggersSpinner" class="hidden"></span>
                </div>
                <div id="allTriggersGood" class="hidden text-green-600 text-sm"><i class="fa-solid fa-check"></i> Triggers Active</div>

                <!-- Email Sender Settings -->
                <div class="border-t border-slate-200 dark:border-slate-600 pt-4 mt-4">
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-3">
                        <i class="fa-solid fa-envelope mr-1"></i> Email Sender Settings
                    </label>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                        Customize sender name and signature for all outreach emails.
                    </p>

                    <!-- Toggle for custom sender -->
                    <div class="flex items-center gap-3 mb-3">
                        <div class="toggle-switch" id="toggleEmailSender" onclick="toggleEmailSenderSetting()"></div>
                        <span class="text-sm text-slate-600 dark:text-slate-400">Use custom sender settings</span>
                    </div>

                    <div id="emailSenderFields" class="space-y-3 hidden">
                        <div>
                            <label class="block text-xs text-slate-600 dark:text-slate-400 mb-1">Sender Name</label>
                            <input id="customSenderName" type="text" class="input-field" placeholder="e.g., Turing Recruitment Team">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 dark:text-slate-400 mb-1">Email Signature</label>
                            <textarea id="customSignature" rows="2" class="input-field text-sm" placeholder="e.g., Turing | Talent Operations"></textarea>
                        </div>
                    </div>
                    <div id="emailSenderConfigStatus" class="hidden mt-2 text-xs"></div>
                </div>

                <!-- Follow-up Timing Configuration -->
                <div class="border-t border-slate-200 dark:border-slate-600 pt-4 mt-4">
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-3">
                        <i class="fa-solid fa-clock mr-1"></i> Follow-up Timing (Hours)
                    </label>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                        Configure the timing for automated follow-up emails and marking candidates as unresponsive.
                    </p>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <label class="block text-xs text-slate-600 dark:text-slate-400 mb-1">1st Follow-up</label>
                                <div class="flex items-center gap-2">
                                    <input id="followUp1Hours" type="number" min="1" max="168" class="input-field w-20 text-center" placeholder="12">
                                    <span class="text-xs text-slate-500">hrs after initial email</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <label class="block text-xs text-slate-600 dark:text-slate-400 mb-1">2nd Follow-up</label>
                                <div class="flex items-center gap-2">
                                    <input id="followUp2Hours" type="number" min="2" max="336" class="input-field w-20 text-center" placeholder="28">
                                    <span class="text-xs text-slate-500">hrs after initial email</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <label class="block text-xs text-slate-600 dark:text-slate-400 mb-1">Mark Unresponsive</label>
                                <div class="flex items-center gap-2">
                                    <input id="unresponsiveHours" type="number" min="3" max="720" class="input-field w-20 text-center" placeholder="76">
                                    <span class="text-xs text-slate-500">hrs after initial email</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="timingConfigStatus" class="hidden mt-2 text-xs"></div>
                </div>

                <!-- Page Access Control (Admin Only) -->
                <div id="pageAccessControlSection" class="border-t border-slate-200 dark:border-slate-600 pt-4 mt-4 hidden">
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-3">
                        <i class="fa-solid fa-shield-halved mr-1"></i> Page Access Control (Admin)
                    </label>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                        Control which pages each role can access. Manage role-based page visibility.
                    </p>
                    <button onclick="openPageAccessModal()" class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-table-cells"></i>
                        <span>Manage Page Access</span>
                    </button>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('configModal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-slate-600 dark:text-slate-300">Close</button>
                <button id="saveConfigBtn" onclick="saveConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button>
                <span id="saveConfigText" class="hidden"></span><span id="saveConfigSpinner" class="hidden"></span>
            </div>
        </div>
    </div>

    <!-- Email Composer Modal (Centered) -->
    <div id="emailModalOverlay" class="email-modal-overlay" onclick="handleModalOverlayClick(event)">
        <div class="email-modal" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-xl">Draft Email Campaign</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Compose and send bulk emails with formatting</p>
                </div>
                <button onclick="closeEmailPanel()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 text-xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 flex-1 overflow-y-auto">
                <!-- Top Row: Name, Subject, Recipients -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <input id="senderName" class="input-field" placeholder="Your Name">
                    <input id="emailSubject" class="input-field" placeholder="Subject line">
                </div>

                <!-- Recipients Info -->
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800 text-sm text-blue-700 dark:text-blue-300 mb-4">
                    Sending to <span id="emailRecipientCount" class="font-bold">0</span> candidates.
                    <div id="emailRecipientPreview" class="text-xs text-blue-500 dark:text-blue-400 mt-1 truncate"></div>
                </div>

                <!-- Load Saved Template Section -->
                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-bold text-blue-700 dark:text-blue-300 uppercase tracking-wider flex items-center gap-1">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Load Saved Template
                        </label>
                        <button onclick="refreshTemplates()" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 p-1" title="Refresh Templates">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                    </div>
                    <select id="templateSelect" onchange="loadSelectedTemplate()" class="input-field w-full">
                        <option value="">-- Select a saved template --</option>
                    </select>
                </div>

                <!-- Job Type Toggles -->
                <div class="job-toggles-container mb-4">
                    <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-2">Campaign Settings</label>

                    <!-- Warning: All toggles ON by default -->
                    <div class="bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg p-2 mb-3">
                        <p class="text-xs text-amber-700 dark:text-amber-400 flex items-center gap-1">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <strong>All features are ON by default.</strong> Click any toggle to turn OFF features you don't need.
                        </p>
                    </div>

                    <!-- Negotiation Toggle -->
                    <div class="job-toggle-row" id="negotiationRow">
                        <div class="job-toggle-info">
                            <span class="job-toggle-title">Negotiation</span>
                            <span class="job-toggle-desc">AI will negotiate rates with candidates</span>
                        </div>
                        <div class="toggle-switch active" id="toggleNegotiation" onclick="toggleJobSetting('negotiation')"></div>
                        <div class="toggle-tooltip" id="tooltipNegotiation">
                            <span class="tooltip-on">ON:</span> AI actively negotiates rates with candidates<br>
                            <span class="tooltip-off">OFF:</span> No rate negotiation, just collect responses
                        </div>
                    </div>

                    <!-- Follow-up Toggle -->
                    <div class="job-toggle-row" id="followUpRow">
                        <div class="job-toggle-info">
                            <span class="job-toggle-title">Follow-up</span>
                            <span class="job-toggle-desc">Send automated follow-ups if no response</span>
                        </div>
                        <div class="toggle-switch active" id="toggleFollowUp" onclick="toggleJobSetting('followUp')"></div>
                        <div class="toggle-tooltip" id="tooltipFollowUp">
                            <span class="tooltip-on">ON:</span> Auto-sends reminders based on timing in Settings<br>
                            <span class="tooltip-off">OFF:</span> No automatic follow-ups sent
                        </div>
                    </div>

                    <!-- Data Gathering Toggle -->
                    <div class="job-toggle-row" id="dataGatheringRow">
                        <div class="job-toggle-info">
                            <span class="job-toggle-title">Data Gathering</span>
                            <span class="job-toggle-desc">Collect and track candidate responses</span>
                        </div>
                        <div class="toggle-switch active" id="toggleDataGathering" onclick="toggleJobSetting('dataGathering')"></div>
                        <div class="toggle-tooltip" id="tooltipDataGathering">
                            <span class="tooltip-on">ON:</span> AI asks follow-ups for missing info<br>
                            <span class="tooltip-off">OFF:</span> Data still saved, but no follow-up questions
                        </div>
                    </div>

                    <!-- Status Hint -->
                    <p id="jobTypeHint" class="text-xs text-slate-500 dark:text-slate-400 mt-2 pt-2 border-t border-slate-200 dark:border-slate-600">
                        <i class="fa-solid fa-info-circle mr-1 text-blue-500"></i>
                        <span id="jobTypeHintText">Negotiation + Follow-up enabled. AI will negotiate and send reminders.</span>
                    </p>
                </div>

                <!-- Email Body Section -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Email Body</label>
                        <div class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-2">
                            <span>Placeholders:</span>
                            <span class="name-placeholder cursor-pointer" onclick="insertPlaceholder('{{name}}')" onmousedown="event.preventDefault()" title="Click to insert">{{name}}</span>
                            <span class="name-placeholder cursor-pointer bg-blue-100 text-blue-700" onclick="insertPlaceholder('{{job_link}}')" onmousedown="event.preventDefault()" title="Click to insert - JD link from job config">{{job_link}}</span>
                        </div>
                    </div>

                    <!-- Formatting Toolbar -->
                    <div class="format-toolbar">
                        <button class="format-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
                        <button class="format-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
                        <button class="format-btn" onclick="formatText('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                        <div class="format-divider"></div>
                        <button class="format-btn" onclick="formatText('formatBlock', 'H2')" title="Heading">H2</button>
                        <button class="format-btn" onclick="formatText('insertUnorderedList')" title="Bullet List"><i class="fa-solid fa-list-ul"></i></button>
                        <button class="format-btn" onclick="formatText('insertOrderedList')" title="Numbered List"><i class="fa-solid fa-list-ol"></i></button>
                        <div class="format-divider"></div>
                        <button class="format-btn" id="formatPainterBtn" onclick="handleFormatPainter()" title="Format Painter - Copy and apply formatting">
                            <i class="fa-solid fa-paintbrush"></i>
                        </button>
                        <button class="format-btn" onclick="formatText('removeFormat')" title="Clear Formatting"><i class="fa-solid fa-eraser"></i></button>
                        <div class="format-divider"></div>
                        <button class="format-btn" onclick="pasteAsPlainText()" title="Paste as Plain Text (Ctrl+Shift+V)">
                            <i class="fa-solid fa-clipboard"></i>
                        </button>
                    </div>

                    <!-- Rich Text Editor -->
                    <div id="emailBody" class="rich-text-editor" contenteditable="true" oninput="handleEditorInput()" style="border-top-left-radius: 0; border-top-right-radius: 0;"></div>
                    <input type="hidden" id="htmlBody" value="">
                </div>

                <!-- Save as Template Checkbox -->
                <div class="p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="saveAsTemplateCheck" class="rounded border-slate-300 dark:border-slate-600 w-5 h-5 text-blue-600 focus:ring-blue-500" onchange="toggleTemplateNameInput()">
                        <label for="saveAsTemplateCheck" class="text-sm text-slate-600 dark:text-slate-400">Save this email as a new template</label>
                    </div>
                    <input type="text" id="newTemplateName" class="hidden mt-3 w-full p-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Enter template name (e.g., 'Initial Outreach V1')">
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                <div id="sendProgressContainer" class="hidden flex-1 mr-4">
                    <div class="text-xs text-slate-500 flex justify-between mb-1">
                        <span id="sendProgressText">Sending...</span>
                        <span id="sendProgressCount">0/0</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-slate-200 dark:bg-slate-600 rounded-full h-1.5">
                            <div id="sendProgressBar" class="bg-blue-600 h-1.5 rounded-full w-0 transition-all"></div>
                        </div>
                        <button id="stopSendingBtn" onclick="stopEmailSending()" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded-lg flex items-center gap-1" title="Stop sending remaining emails">
                            <i class="fa-solid fa-stop"></i> STOP
                        </button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeEmailPanel()" class="px-6 py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg text-slate-600 dark:text-slate-300 font-medium">
                        Cancel
                    </button>
                    <button id="sendEmailBtn" onclick="sendEmails()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> Send Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Input Modal -->
    <div id="manualInputModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 class="font-bold mb-2">Manual Entry</h3>
            <p class="text-xs text-slate-500 mb-2">Format: email, name, region/country (one per line)</p>
            <textarea id="manualDataInput" class="input-field h-32 mb-2" placeholder="john@example.com, John Doe, India&#10;jane@test.com, Jane Smith, Brazil"></textarea>
            <div id="manualEntryValidation" class="hidden mb-3 p-3 rounded-lg text-sm max-h-32 overflow-y-auto"></div>
            <div class="flex justify-end gap-2">
                <button onclick="closeManualEntryModal()" class="px-4 py-2 bg-slate-100 rounded-lg">Cancel</button>
                <button onclick="validateManualData()" class="px-4 py-2 bg-amber-500 text-white rounded-lg"><i class="fa-solid fa-check-double mr-1"></i>Validate</button>
                <button onclick="loadManualData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Load Data</button>
            </div>
        </div>
    </div>

    <!-- AI Notes Modal - Comprehensive Summary -->
    <div id="notesModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-2xl">
            <h3 class="font-bold mb-4 text-purple-700 flex items-center gap-2">
                <i class="fa-solid fa-robot"></i> AI Summary
                <span class="text-xs font-normal text-slate-400">(Email + Data + Negotiation)</span>
            </h3>
            <div id="notesModalContent" class="bg-slate-50 p-4 rounded-lg text-sm text-slate-700 mb-4 max-h-96 overflow-y-auto whitespace-pre-wrap leading-relaxed"></div>
            <div class="flex justify-end">
                <button onclick="document.getElementById('notesModal').classList.add('hidden')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Complete Human Modal -->
    <div id="completeHumanModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h3 class="font-bold mb-4 text-green-700">Complete Negotiation</h3>
            <p class="text-sm mb-1 text-slate-500">Candidate: <span id="completeHumanEmail" class="font-medium text-slate-800"></span></p>
            
            <div class="my-4">
                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Agreed Rate</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                    <input type="number" id="agreedRateInput" class="input-field pl-6" placeholder="0.00">
                </div>
                <div class="mt-2 flex items-center gap-2">
                    <input type="checkbox" id="noRateAgreed" onchange="toggleRateInput()" class="rounded border-slate-300">
                    <label for="noRateAgreed" class="text-sm text-slate-600">No rate agreed (Closed/Rejected)</label>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Outcome</label>
                <select id="completionStatus" class="input-field">
                    <option value="">Offer Accepted</option>
                    <option value="Rejected by Candidate">Rejected</option>
                    <option value="Candidate Withdrew">Withdrew</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeCompleteHumanModal()" class="px-4 py-2 bg-slate-100 rounded-lg">Cancel</button>
                <button id="completeHumanBtn" onclick="submitCompleteHuman()" class="px-4 py-2 bg-green-600 text-white rounded-lg">Complete</button>
            </div>
        </div>
    </div>

    <!-- Viewers Modal -->
    <div id="viewersModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 class="font-bold mb-4 text-slate-800 dark:text-white">Manage User Access</h3>

            <!-- Role Legend -->
            <div class="mb-4 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg text-xs">
                <div class="font-semibold mb-2 text-slate-600 dark:text-slate-300">Role Permissions:</div>
                <div class="grid grid-cols-2 gap-1 text-slate-500 dark:text-slate-400">
                    <div><span class="font-medium text-blue-600">Admin</span> - Full access + Manage users</div>
                    <div><span class="font-medium text-indigo-600">TL</span> - Full access (no user mgmt)</div>
                    <div><span class="font-medium text-purple-600">TM/TA/Manager</span> - Analytics only</div>
                    <div><span class="font-medium text-slate-600">Other</span> - Operations + Own analytics</div>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <input id="newViewerEmail" class="input-field flex-1" placeholder="user@example.com">
                <select id="newViewerLevel" class="input-field w-28">
                    <option value="other">Other</option>
                    <option value="tl">TL</option>
                    <option value="tm">TM</option>
                    <option value="ta">TA</option>
                    <option value="manager">Manager</option>
                    <option value="admin">Admin</option>
                </select>
                <button onclick="addViewer()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 rounded-lg transition"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="viewersList" class="max-h-64 overflow-y-auto space-y-2"></div>
            <div class="flex justify-end mt-4">
                <button onclick="closeViewersModal()" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-white rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Page Access Control Modal -->
    <div id="pageAccessModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-800 dark:text-white">
                    <i class="fa-solid fa-shield-halved mr-2 text-indigo-500"></i>Page Access Control
                </h3>
                <button onclick="closePageAccessModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <!-- Info Banner -->
            <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg text-sm text-blue-700 dark:text-blue-300">
                <i class="fa-solid fa-info-circle mr-2"></i>
                Control which pages each role can access. Changes take effect immediately when users refresh.
            </div>

            <!-- Loading State -->
            <div id="pageAccessLoading" class="py-12 text-center">
                <i class="fa-solid fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i>
                <p class="text-slate-500">Loading access settings...</p>
            </div>

            <!-- Access Table Container -->
            <div id="pageAccessTableContainer" class="hidden flex-1 overflow-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left font-semibold text-slate-600 dark:text-slate-300 w-24">Role</th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-users-viewfinder text-blue-500 mb-1"></i>
                                    <span class="text-xs">Outreach</span>
                                </div>
                            </th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-briefcase text-green-500 mb-1"></i>
                                    <span class="text-xs">Job Setup</span>
                                </div>
                            </th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-clipboard-check text-amber-500 mb-1"></i>
                                    <span class="text-xs">Tasks</span>
                                </div>
                            </th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-clock-rotate-left text-purple-500 mb-1"></i>
                                    <span class="text-xs">Follow-Ups</span>
                                </div>
                            </th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-chart-line text-cyan-500 mb-1"></i>
                                    <span class="text-xs">Analytics</span>
                                </div>
                            </th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-brain text-pink-500 mb-1"></i>
                                    <span class="text-xs">AI Learning</span>
                                </div>
                            </th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-flask text-orange-500 mb-1"></i>
                                    <span class="text-xs">AI Testing</span>
                                </div>
                            </th>
                            <th class="px-2 py-3 text-center font-semibold text-slate-600 dark:text-slate-300">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-diagram-project text-red-500 mb-1"></i>
                                    <span class="text-xs">Process Map</span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="pageAccessTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                <div class="text-xs text-slate-500">
                    <i class="fa-solid fa-lightbulb mr-1 text-amber-500"></i>
                    Tip: Admin role always has full access for security
                </div>
                <button onclick="closePageAccessModal()" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-white rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Supplementary Data Request Modal -->
    <div id="supplementaryDataModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold mb-4 text-teal-700 dark:text-teal-400 flex items-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> Request Additional Data
                <span class="text-xs font-normal text-slate-400">(Add questions to data gathering)</span>
            </h3>

            <!-- Job Selection -->
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 uppercase mb-1">Select Job</label>
                <select id="suppDataJobDropdown" onchange="loadSupplementaryCandidates()" class="input-field w-full">
                    <option value="">-- Select a Job --</option>
                </select>
            </div>

            <!-- Current Questions Display -->
            <div id="currentQuestionsSection" class="hidden mb-4 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                <div class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Current Data Fields</div>
                <div id="currentQuestionsList" class="flex flex-wrap gap-2 text-xs"></div>
            </div>

            <!-- Additional Questions Input -->
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-600 dark:text-slate-400 uppercase mb-1">
                    What additional information do you need?
                </label>
                <textarea id="suppDataInput" class="input-field h-24" placeholder="Example: Ask for their visa status, preferred shift timing, and whether they have prior experience with React Native"></textarea>
                <p class="text-xs text-slate-400 mt-1">
                    <i class="fa-solid fa-magic mr-1"></i> AI will convert this to professional questions and create columns automatically
                </p>
            </div>

            <!-- Preview Parsed Questions -->
            <div id="parsedQuestionsPreview" class="hidden mb-4 p-3 bg-teal-50 dark:bg-teal-900/20 rounded-lg border border-teal-200 dark:border-teal-700">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xs font-bold text-teal-600 dark:text-teal-400 uppercase">Preview: Questions to Add</div>
                    <button onclick="clearParsedQuestions()" class="text-xs text-slate-400 hover:text-red-500">
                        <i class="fa-solid fa-times"></i> Clear
                    </button>
                </div>
                <div id="parsedQuestionsList" class="space-y-2 text-sm"></div>
            </div>

            <!-- Parse Questions Button -->
            <div class="mb-4">
                <button onclick="parseSupplementaryInput()" class="bg-teal-100 hover:bg-teal-200 text-teal-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Preview Questions
                </button>
            </div>

            <!-- Target Selection -->
            <div class="mb-4 p-4 bg-slate-50 dark:bg-slate-700 rounded-lg">
                <div class="text-xs font-bold text-slate-600 dark:text-slate-400 uppercase mb-3">Who should receive this request?</div>

                <!-- Selection Mode -->
                <div class="flex gap-4 mb-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="suppDataTarget" value="all" checked onchange="toggleCandidateSelection()" class="text-teal-600">
                        <span class="text-sm text-slate-700 dark:text-slate-300">All candidates for this job</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="suppDataTarget" value="selected" onchange="toggleCandidateSelection()" class="text-teal-600">
                        <span class="text-sm text-slate-700 dark:text-slate-300">Select specific candidates</span>
                    </label>
                </div>

                <!-- Include Completed Checkbox -->
                <div class="flex items-center gap-2 mb-3">
                    <input type="checkbox" id="suppDataIncludeCompleted" onchange="loadSupplementaryCandidates()" class="rounded border-slate-300 text-teal-600">
                    <label for="suppDataIncludeCompleted" class="text-sm text-slate-600 dark:text-slate-400">
                        Include completed candidates (already finished data gathering)
                    </label>
                </div>

                <!-- Apply to Future Checkbox -->
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="suppDataApplyToFuture" checked class="rounded border-slate-300 text-teal-600">
                    <label for="suppDataApplyToFuture" class="text-sm text-slate-600 dark:text-slate-400">
                        Also ask future candidates these questions
                    </label>
                </div>
            </div>

            <!-- Candidate Selection (hidden by default) -->
            <div id="candidateSelectionSection" class="hidden mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Select Candidates</div>
                    <div class="flex gap-2">
                        <button onclick="selectAllSupplementaryCandidates(true)" class="text-xs text-blue-600 hover:underline">Select All</button>
                        <button onclick="selectAllSupplementaryCandidates(false)" class="text-xs text-slate-400 hover:underline">Clear</button>
                    </div>
                </div>
                <div id="candidateCheckboxList" class="max-h-48 overflow-y-auto border border-slate-200 dark:border-slate-600 rounded-lg p-2 space-y-1"></div>
                <div class="mt-2 text-xs text-slate-500">
                    <span id="selectedCandidateCount">0</span> candidates selected
                </div>
            </div>

            <!-- Summary -->
            <div id="suppDataSummary" class="hidden mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                <div class="text-sm text-blue-700 dark:text-blue-300">
                    <i class="fa-solid fa-info-circle mr-1"></i>
                    <span id="suppDataSummaryText">Ready to send</span>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="flex justify-end gap-2 pt-4 border-t border-slate-200 dark:border-slate-700">
                <button onclick="closeSupplementaryDataModal()" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-white rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                    Cancel
                </button>
                <button id="sendSuppDataBtn" onclick="sendSupplementaryDataRequest()" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition flex items-center gap-2" disabled>
                    <i class="fa-solid fa-paper-plane"></i> Send Request
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Bulk Action Bar -->
    <div id="bulkActionBar" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-6 hidden z-40 transition-transform">
        <span class="font-bold"><span id="bulkSelectedCount">0</span> selected</span>
        <div class="h-4 w-px bg-slate-700"></div>
        <button onclick="openEmailPanel()" class="hover:text-blue-300 transition flex items-center gap-2"><i class="fa-solid fa-envelope"></i> Email</button>
        <button onclick="markSelectedAsManualSent()" class="hover:text-amber-300 transition flex items-center gap-2"><i class="fa-solid fa-check"></i> Mark Sent</button>
        <button onclick="clearTaskSelection(); deselectAll();" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
    </div>

    <!-- LOGIC SCRIPT (FULLY RESTORED) -->
    <script>
        let tableData = [];
        let fullTableData = [];
        let selectedDevs = new Set();
        let allTasks = [];
        let selectedTasks = new Set();
        let cachedJobIds = [];
        let cachedTemplates = [];
        let currentUserEmail = '';
        let emailSendingAborted = false; // Flag to stop email sending mid-process

        // Data caching to prevent reloading on tab switch
        const dataCache = {
            tasks: { data: null, lastLoaded: 0 },
            followups: { data: null, lastLoaded: 0 },
            analytics: { data: null, lastLoaded: 0 },
            triggers: { data: null, lastLoaded: 0 }
        };
        const CACHE_DURATION = 60000; // Cache for 60 seconds

        function isCacheValid(cacheKey) {
            const cache = dataCache[cacheKey];
            return cache.data !== null && (Date.now() - cache.lastLoaded) < CACHE_DURATION;
        }

        // Multi-select filter state
        let activeFilters = {
            status: new Set(['all']),
            type: new Set(),
            country: new Set()
        };

        // ===== INIT: Load user email and permissions on page load =====
        document.addEventListener('DOMContentLoaded', function() {
            loadUserEmail();
            // Load cached permissions INSTANTLY, then refresh in background
            loadCachedPermissions();
            loadFreshPermissions();
        });

        // Load permissions from localStorage for instant UI (< 50ms)
        function loadCachedPermissions() {
            try {
                const cached = localStorage.getItem('hr_ops_permissions');
                if (cached) {
                    const data = JSON.parse(cached);
                    // Check if cache is less than 1 hour old
                    if (data.timestamp && (Date.now() - data.timestamp) < 3600000) {
                        userPermissions.isAdmin = data.isAdmin || false;
                        userPermissions.canViewAllAnalytics = data.canViewAllAnalytics || false;
                        userPermissions.hasOperationalAccess = data.hasOperationalAccess !== false;
                        userPermissions.accessLevel = data.accessLevel || 'other';
                        userPermissions.userEmail = data.userEmail || '';
                        userPermissions.pageAccess = data.pageAccess || userPermissions.pageAccess;
                        isAnalyticsAdmin = userPermissions.isAdmin;

                        // Update UI immediately with cached data
                        updateAnalyticsAdminUI();
                        updateRoleBasedUI();

                        // Update role badge
                        const roleLabels = { 'admin': 'Admin', 'tl': 'Team Lead', 'tm': 'Talent Manager', 'ta': 'Talent Acquisition', 'manager': 'Manager', 'other': 'User' };
                        const userRoleBadge = document.getElementById('userRoleBadge');
                        if (userRoleBadge) userRoleBadge.textContent = roleLabels[userPermissions.accessLevel] || 'User';

                        console.log('Loaded cached permissions in < 50ms');
                    }
                }
            } catch (e) {
                console.log('No cached permissions found');
            }
        }

        // Fetch fresh permissions from server (background refresh)
        function loadFreshPermissions() {
            google.script.run
                .withSuccessHandler(function(data) {
                    if (data && data.hasAccess) {
                        userPermissions.isAdmin = data.isAdmin || data.canManageUsers || false;
                        userPermissions.canViewAllAnalytics = data.canViewAllAnalytics || false;
                        userPermissions.hasOperationalAccess = data.hasOperationalAccess !== false;
                        userPermissions.accessLevel = data.accessLevel || 'other';
                        userPermissions.userEmail = data.userEmail || '';
                        userPermissions.pageAccess = data.pageAccess || userPermissions.pageAccess;
                        isAnalyticsAdmin = userPermissions.isAdmin;

                        // Cache in localStorage for next page load
                        try {
                            localStorage.setItem('hr_ops_permissions', JSON.stringify({
                                isAdmin: userPermissions.isAdmin,
                                canViewAllAnalytics: userPermissions.canViewAllAnalytics,
                                hasOperationalAccess: userPermissions.hasOperationalAccess,
                                accessLevel: userPermissions.accessLevel,
                                userEmail: userPermissions.userEmail,
                                pageAccess: userPermissions.pageAccess,
                                timestamp: Date.now()
                            }));
                        } catch (e) {}

                        // Update UI with fresh data
                        updateAnalyticsAdminUI();
                        updateRoleBasedUI();

                        // Update role badge
                        const roleLabels = { 'admin': 'Admin', 'tl': 'Team Lead', 'tm': 'Talent Manager', 'ta': 'Talent Acquisition', 'manager': 'Manager', 'other': 'User' };
                        const userRoleBadge = document.getElementById('userRoleBadge');
                        if (userRoleBadge) userRoleBadge.textContent = roleLabels[userPermissions.accessLevel] || 'User';

                        // Load new users for admin
                        if (userPermissions.isAdmin) {
                            loadNewUsers();
                        }

                        console.log('Fresh permissions loaded from server');
                    }
                })
                .withFailureHandler(function(err) {
                    console.log('Failed to load fresh permissions:', err);
                })
                .checkAnalyticsAccess();
        }

        function loadUserEmail() {
            google.script.run
                .withSuccessHandler(function(email) {
                    currentUserEmail = email || 'Unknown';
                    // Update main text
                    const uText = document.getElementById('userEmailText');
                    if(uText) uText.textContent = email || 'Not signed in';
                    // Update sidebar text
                    const navUser = document.getElementById('userEmailTextSidebar');
                    if(navUser) navUser.textContent = email || 'Guest';
                })
                .withFailureHandler(function(err) {
                    const uText = document.getElementById('userEmailText');
                    if(uText) uText.textContent = 'Not available';
                })
                .getUserEmail();
        }

        // --- Layout Switching Logic ---
        function switchTab(tabName, btn) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-tab'));
            // Show selected
            document.getElementById('tab-' + tabName).classList.remove('hidden-tab');

            // Update Sidebar Active State
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // Hide bulk action bar on non-outreach tabs, show it on outreach if there's a selection
            const bulkBar = document.getElementById('bulkActionBar');
            if (tabName !== 'outreach') {
                bulkBar.classList.add('hidden');
            } else if (selectedDevs.size > 0) {
                bulkBar.classList.remove('hidden');
            }

            // Update Header Title
            const titles = {
                'outreach': 'Outreach Manager',
                'negotiation': 'Setup Job Details',
                'tasks': 'Task List',
                'followups': 'Follow-Ups',
                'analytics': 'Analytics',
                'learning': 'AI Learning Center',
                'aitesting': 'AI Testing', // AI TESTING FEATURE - DELETE FOR PRODUCTION
                'processmap': 'System Process Map'
            };
            document.getElementById('headerTitle').textContent = titles[tabName] || 'Dashboard';

            // Load process map data when switching to that tab
            if (tabName === 'processmap') {
                loadProcessMapData();
            }

            // Load learning cases when switching to learning tab
            if (tabName === 'learning') {
                loadLearningCases();
            }

            // Trigger data loads only if cache is invalid
            if(tabName === 'tasks' && !isCacheValid('tasks')) loadTasks();
            if(tabName === 'negotiation' && !isCacheValid('triggers')) refreshJobDropdown();
            if(tabName === 'followups' && !isCacheValid('followups')) loadFollowUpStats();
            if(tabName === 'analytics') {
                // Pre-load search cache for instant filtering
                loadAnalyticsSearchCache();
                if(!isCacheValid('analytics')) loadAnalytics();
            }
        }

        // --- Date Formatting Helper ---
        function formatDateTime(isoString) {
            if (!isoString || isoString === '-') return '-';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return '-';
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return date.toLocaleDateString('en-US', options);
            } catch(e) {
                return '-';
            }
        }

        // --- Status Badge Helper (N=Negotiation, F=Follow-up, D=Data Gathering) ---
        // jobSettings: { negotiation: bool, followUp: bool, dataGathering: bool } - controls which badges to show
        function getStatusBadges(tags, status, type, isFollowUp = false, jobSettings = null) {
            let badges = [];

            if (isFollowUp) {
                // Follow-up items always get F badge (they only appear if follow-up is enabled)
                badges.push('<span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-bold bg-amber-100 text-amber-700 border border-amber-200" title="Follow-up">F</span>');
                // If still pending, also gathering data
                if (status === 'Pending') {
                    badges.push('<span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-bold bg-blue-100 text-blue-700 border border-blue-200" title="Data Gathering">D</span>');
                }
            } else {
                // Task items
                const tagsLower = (tags || '').toLowerCase();
                const statusLower = (status || '').toLowerCase();
                const typeLower = (type || '').toLowerCase();

                // Use job settings to determine which badges to show
                const showDataGathering = !jobSettings || jobSettings.dataGathering !== false;
                const showNegotiation = !jobSettings || jobSettings.negotiation === true;
                const showFollowUp = !jobSettings || jobSettings.followUp !== false;

                // Data Gathering: Initial outreach or gathering info (only if enabled)
                if (showDataGathering && (tagsLower.includes('initial') || tagsLower.includes('outreach'))) {
                    badges.push('<span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-bold bg-blue-100 text-blue-700 border border-blue-200" title="Data Gathering">D</span>');
                }

                // Negotiation: AI attempts or human negotiation or actively negotiating (only if enabled)
                if (showNegotiation && (tagsLower.includes('attempt') || tagsLower.includes('negotiat') ||
                    statusLower.includes('negotiat') || typeLower === 'negotiating')) {
                    badges.push('<span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-bold bg-purple-100 text-purple-700 border border-purple-200" title="Negotiation">N</span>');
                }

                // Follow-up: Show if follow-up is enabled AND candidate is in a status that would receive follow-ups
                // (Initial Outreach, Pending, or any follow-up related status)
                if (showFollowUp && (
                    tagsLower.includes('follow') ||
                    statusLower.includes('follow') ||
                    tagsLower.includes('initial') ||
                    tagsLower.includes('outreach') ||
                    statusLower.includes('pending')
                )) {
                    badges.push('<span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-bold bg-amber-100 text-amber-700 border border-amber-200" title="Follow-up">F</span>');
                }

                // If accepted, show a checkmark badge (always show - this is a completion status)
                if (statusLower.includes('accepted') || tagsLower.includes('completed')) {
                    badges.push('<span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-bold bg-green-100 text-green-700 border border-green-200" title="Completed"><i class="fa-solid fa-check text-[8px]"></i></span>');
                }
            }

            return badges.length > 0 ? '<div class="flex gap-1">' + badges.join('') + '</div>' : '';
        }

        // --- HTML Escape Helper ---
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // --- Toast ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'check-circle',
                error: 'circle-xmark',
                warning: 'triangle-exclamation',
                info: 'circle-info'
            };

            toast.innerHTML = `
                <i class="fa-solid fa-${icons[type] || 'circle-info'} mr-2"></i>
                <span class="toast-content">${message}</span>
            `; 
            container.appendChild(toast);
            
            const timeoutId = setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
            toast.dataset.timeoutId = timeoutId;
        }

        // --- Toggles ---
        function toggleChip(el) { el.classList.toggle('active'); }
        function selectAllChips() {
            document.querySelectorAll('.smart-chip[data-value]').forEach(chip => chip.classList.add('active'));
        }
        function clearAllChips() {
            document.querySelectorAll('.smart-chip[data-value]').forEach(chip => chip.classList.remove('active'));
        }
        function openManualInput() { document.getElementById('manualInputModal').classList.remove('hidden'); }
        function openConfigModal() {
            document.getElementById('configModal').classList.remove('hidden');
            refreshTriggerStatus(); // Load trigger status when modal opens
            loadFollowUpTimingConfig(); // Load follow-up timing settings
            loadEmailSenderConfig(); // Load email sender settings

            // Show Page Access Control section for admins only
            const pageAccessSection = document.getElementById('pageAccessControlSection');
            if (pageAccessSection) {
                if (userPermissions.isAdmin) {
                    pageAccessSection.classList.remove('hidden');
                } else {
                    pageAccessSection.classList.add('hidden');
                }
            }
        }

        // Email Sender Settings Functions
        function loadEmailSenderConfig() {
            google.script.run
                .withSuccessHandler(config => {
                    const toggle = document.getElementById('toggleEmailSender');
                    const fields = document.getElementById('emailSenderFields');
                    if (config.enabled) {
                        toggle.classList.add('active');
                        fields.classList.remove('hidden');
                    } else {
                        toggle.classList.remove('active');
                        fields.classList.add('hidden');
                    }
                    document.getElementById('customSenderName').value = config.senderName || '';
                    document.getElementById('customSignature').value = config.signature || '';
                })
                .withFailureHandler(err => {
                    console.error('Error loading email sender config:', err);
                })
                .getEmailSenderConfig();
        }

        function toggleEmailSenderSetting() {
            const toggle = document.getElementById('toggleEmailSender');
            const fields = document.getElementById('emailSenderFields');
            toggle.classList.toggle('active');
            if (toggle.classList.contains('active')) {
                fields.classList.remove('hidden');
            } else {
                fields.classList.add('hidden');
            }
        }

        function saveEmailSenderConfig() {
            const enabled = document.getElementById('toggleEmailSender').classList.contains('active');
            const config = {
                enabled: enabled,
                senderName: document.getElementById('customSenderName').value.trim(),
                signature: document.getElementById('customSignature').value.trim()
            };
            google.script.run
                .withSuccessHandler(() => {
                    const statusEl = document.getElementById('emailSenderConfigStatus');
                    statusEl.textContent = ' Email sender settings saved';
                    statusEl.className = 'mt-2 text-xs text-green-600';
                    statusEl.classList.remove('hidden');
                    setTimeout(() => statusEl.classList.add('hidden'), 3000);
                })
                .withFailureHandler(err => {
                    const statusEl = document.getElementById('emailSenderConfigStatus');
                    statusEl.textContent = 'Error: ' + err.message;
                    statusEl.className = 'mt-2 text-xs text-red-600';
                    statusEl.classList.remove('hidden');
                })
                .saveEmailSenderConfig(config);
        }

        function loadFollowUpTimingConfig() {
            google.script.run
                .withSuccessHandler(config => {
                    document.getElementById('followUp1Hours').value = config.FOLLOW_UP_1_HOURS || 12;
                    document.getElementById('followUp2Hours').value = config.FOLLOW_UP_2_HOURS || 28;
                    document.getElementById('unresponsiveHours').value = config.UNRESPONSIVE_HOURS || 76;
                })
                .withFailureHandler(err => {
                    console.error('Error loading timing config:', err);
                    // Set defaults if loading fails
                    document.getElementById('followUp1Hours').value = 12;
                    document.getElementById('followUp2Hours').value = 28;
                    document.getElementById('unresponsiveHours').value = 76;
                })
                .getFollowUpTimingConfig();
        }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        // ===== NOTIFICATION SYSTEM =====
        let notifications = [];
        let notificationsLoaded = false;

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                if (!notificationsLoaded) {
                    loadNotifications();
                }
            } else {
                panel.classList.add('hidden');
            }
        }

        function loadNotifications() {
            const listEl = document.getElementById('notificationList');
            listEl.innerHTML = '<div class="p-4 text-center"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';

            google.script.run
                .withSuccessHandler(data => {
                    notifications = data || [];
                    notificationsLoaded = true;
                    renderNotifications();
                    updateNotificationBadge();
                })
                .withFailureHandler(err => {
                    listEl.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">Failed to load notifications</div>';
                })
                .getNotifications();
        }

        function renderNotifications() {
            const listEl = document.getElementById('notificationList');
            if (notifications.length === 0) {
                listEl.innerHTML = '<div class="p-4 text-center text-slate-500 text-sm">No new notifications</div>';
                return;
            }

            listEl.innerHTML = notifications.map((n, i) => `
                <div class="p-3 border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer ${n.read ? 'opacity-60' : ''}" onclick="handleNotificationClick(${i})">
                    <div class="flex items-start gap-2">
                        <i class="fa-solid ${n.icon || 'fa-bell'} text-${n.type === 'success' ? 'green' : n.type === 'warning' ? 'yellow' : n.type === 'error' ? 'red' : 'blue'}-500 mt-0.5"></i>
                        <div class="flex-1">
                            <p class="text-sm text-slate-800 dark:text-white ${n.read ? '' : 'font-medium'}">${n.title}</p>
                            <p class="text-xs text-slate-500 mt-0.5">${n.message}</p>
                            <span class="text-xs text-slate-400 mt-1 block">${n.time || 'Just now'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function handleNotificationClick(index) {
            if (notifications[index]) {
                notifications[index].read = true;
                renderNotifications();
                updateNotificationBadge();
                // Navigate if there's an action
                if (notifications[index].action) {
                    if (notifications[index].action.tab) {
                        const tabBtn = document.querySelector(`.nav-tab[onclick*="${notifications[index].action.tab}"]`);
                        if (tabBtn) switchTab(notifications[index].action.tab, tabBtn);
                    }
                }
                toggleNotifications();
            }
        }

        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
            updateNotificationBadge();
        }

        // Close notification panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notificationPanel');
            const btn = document.getElementById('notificationBtn');
            if (!panel.contains(e.target) && !btn.contains(e.target) && !panel.classList.contains('hidden')) {
                panel.classList.add('hidden');
            }
        });

        // ===== GLOBAL SEARCH SYSTEM =====
        let globalSearchTimeout = null;

        function handleGlobalSearch() {
            const input = document.getElementById('globalSearchInput');
            const query = input.value.trim().toLowerCase();
            const resultsEl = document.getElementById('globalSearchResults');

            clearTimeout(globalSearchTimeout);

            if (query.length < 2) {
                resultsEl.classList.add('hidden');
                return;
            }

            globalSearchTimeout = setTimeout(() => {
                performGlobalSearch(query);
            }, 300);
        }

        function performGlobalSearch(query) {
            const resultsEl = document.getElementById('globalSearchResults');
            resultsEl.classList.remove('hidden');
            resultsEl.innerHTML = '<div class="p-3 text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> Searching...</div>';

            google.script.run
                .withSuccessHandler(results => {
                    renderGlobalSearchResults(results, query);
                })
                .withFailureHandler(err => {
                    resultsEl.innerHTML = '<div class="p-3 text-center text-red-500 text-sm">Search failed</div>';
                })
                .globalSearch(query);
        }

        function renderGlobalSearchResults(results, query) {
            const resultsEl = document.getElementById('globalSearchResults');

            if (!results || results.length === 0) {
                resultsEl.innerHTML = '<div class="p-3 text-center text-slate-500 text-sm">No results found</div>';
                return;
            }

            const grouped = {
                developers: results.filter(r => r.type === 'developer'),
                negotiations: results.filter(r => r.type === 'negotiation'),
                followups: results.filter(r => r.type === 'followup')
            };

            let html = '';

            if (grouped.developers.length > 0) {
                html += '<div class="p-2 bg-slate-50 dark:bg-slate-700 text-xs font-semibold text-slate-500 uppercase">Developers</div>';
                grouped.developers.slice(0, 5).forEach(r => {
                    html += `<div class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700" onclick="navigateToSearchResult('${r.type}', '${r.id}', '${r.jobId || ''}')">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-user text-blue-500"></i>
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${highlightMatch(r.name, query)}</p>
                                <p class="text-xs text-slate-500">${highlightMatch(r.email, query)} ${r.jobId ? ' Job ' + r.jobId : ''}</p>
                            </div>
                        </div>
                    </div>`;
                });
            }

            if (grouped.negotiations.length > 0) {
                html += '<div class="p-2 bg-slate-50 dark:bg-slate-700 text-xs font-semibold text-slate-500 uppercase">Negotiations</div>';
                grouped.negotiations.slice(0, 5).forEach(r => {
                    html += `<div class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700" onclick="navigateToSearchResult('${r.type}', '${r.id}', '${r.jobId || ''}')">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-handshake text-green-500"></i>
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${highlightMatch(r.name, query)}</p>
                                <p class="text-xs text-slate-500">${r.status}  Job ${r.jobId}</p>
                            </div>
                        </div>
                    </div>`;
                });
            }

            if (grouped.followups.length > 0) {
                html += '<div class="p-2 bg-slate-50 dark:bg-slate-700 text-xs font-semibold text-slate-500 uppercase">Follow-ups</div>';
                grouped.followups.slice(0, 5).forEach(r => {
                    html += `<div class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700" onclick="navigateToSearchResult('${r.type}', '${r.id}', '${r.jobId || ''}')">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-clock text-yellow-500"></i>
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${highlightMatch(r.name, query)}</p>
                                <p class="text-xs text-slate-500">${r.status}  Job ${r.jobId}</p>
                            </div>
                        </div>
                    </div>`;
                });
            }

            resultsEl.innerHTML = html || '<div class="p-3 text-center text-slate-500 text-sm">No results found</div>';
        }

        function highlightMatch(text, query) {
            if (!text) return '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="bg-yellow-200 dark:bg-yellow-800 rounded px-0.5">$1</span>');
        }

        function navigateToSearchResult(type, id, jobId) {
            clearGlobalSearch();
            if (type === 'developer' && jobId) {
                document.getElementById('jobId').value = jobId;
                const tabBtn = document.querySelector('.nav-tab[onclick*="outreach"]');
                if (tabBtn) switchTab('outreach', tabBtn);
                showToast('Job ID loaded. Click Fetch Data to search.', 'info');
            } else if (type === 'negotiation') {
                const tabBtn = document.querySelector('.nav-tab[onclick*="negotiation"]');
                if (tabBtn) switchTab('negotiation', tabBtn);
            } else if (type === 'followup') {
                const tabBtn = document.querySelector('.nav-tab[onclick*="followups"]');
                if (tabBtn) switchTab('followups', tabBtn);
            }
        }

        function clearGlobalSearch() {
            document.getElementById('globalSearchInput').value = '';
            document.getElementById('globalSearchResults').classList.add('hidden');
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchContainer = document.getElementById('globalSearchInput').parentElement;
            if (!searchContainer.contains(e.target)) {
                document.getElementById('globalSearchResults').classList.add('hidden');
            }
        });

        // --- Filter Logic ---
        function toggleFilterChip(element) {
            const filter = element.dataset.filter;
            const group = element.dataset.group;

            if (filter === 'all') {
                activeFilters.status.clear();
                activeFilters.status.add('all');
                document.querySelectorAll('.filter-chip[data-group="status"]').forEach(chip => {
                    chip.classList.remove('active');
                });
                element.classList.add('active');
            } else if (group === 'status') {
                activeFilters.status.delete('all');
                document.querySelector('.filter-chip[data-filter="all"]').classList.remove('active');

                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                    activeFilters.status.delete(filter);
                    if (activeFilters.status.size === 0) {
                        activeFilters.status.add('all');
                        document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
                    }
                } else {
                    element.classList.add('active');
                    activeFilters.status.add(filter);
                }
            } else if (group === 'type') {
                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                    activeFilters.type.delete(filter);
                } else {
                    element.classList.add('active');
                    activeFilters.type.add(filter);
                }
            }

            applyFilters();
            updateActiveFiltersIndicator();
        }

        function applyFilters() {
            let filtered = [...fullTableData];

            // Apply status filters (OR logic)
            if (!activeFilters.status.has('all') && activeFilters.status.size > 0) {
                filtered = filtered.filter(d => {
                    if (activeFilters.status.has('new') && !d.is_sent && !d.is_manual_sent) return true;
                    if (activeFilters.status.has('followup') && d.is_sent && !d.is_manual_sent) return true;
                    if (activeFilters.status.has('manual') && d.is_manual_sent) return true;
                    return false;
                });
            }

            // Apply type filters (OR logic, AND with status)
            if (activeFilters.type.size > 0) {
                filtered = filtered.filter(d => {
                    const candidateType = d.candidate_status || 'Independent';
                    if (activeFilters.type.has('sub') && candidateType === 'Agency Sub-Contractor') return true;
                    if (activeFilters.type.has('agency') && candidateType === 'Agency Contractor') return true;
                    if (activeFilters.type.has('direct') && (candidateType === 'Independent' || !d.candidate_status)) return true;
                    return false;
                });
            }

            // Apply country filters (OR logic, AND with other filters)
            if (activeFilters.country.size > 0) {
                filtered = filtered.filter(d => {
                    const country = d.developer_country || '';
                    return activeFilters.country.has(country);
                });
            }

            tableData = filtered;
            renderTable(tableData);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
        }

        function updateActiveFiltersIndicator() {
            const totalActive = (activeFilters.status.has('all') ? 0 : activeFilters.status.size) + activeFilters.type.size + activeFilters.country.size;
            const indicator = document.getElementById('activeFiltersInfo');
            const countEl = document.getElementById('activeFilterCount');

            if (totalActive > 0) {
                indicator.classList.remove('hidden');
                indicator.classList.add('flex');
                countEl.textContent = totalActive;
            } else {
                indicator.classList.add('hidden');
                indicator.classList.remove('flex');
            }
        }

        function clearAllFilters() {
            activeFilters.status.clear();
            activeFilters.status.add('all');
            activeFilters.type.clear();
            activeFilters.country.clear();

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');

            document.getElementById('tableSearch').value = '';
            updateCountryFilterIcon();
            applyFilters();
            updateActiveFiltersIndicator();
        }

        // ===== COUNTRY FILTER FUNCTIONS =====
        let tempSelectedCountries = new Set();

        function toggleCountryFilter(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('countryFilterDropdown');
            const isHidden = dropdown.classList.contains('hidden');

            if (isHidden) {
                // Populate country list from current data
                populateCountryList();
                // Copy current filters to temp selection
                tempSelectedCountries = new Set(activeFilters.country);
                dropdown.classList.remove('hidden');
                document.getElementById('countrySearchInput').focus();

                // Add click outside listener
                setTimeout(() => {
                    document.addEventListener('click', closeCountryFilterOnClickOutside);
                }, 0);
            } else {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeCountryFilterOnClickOutside);
            }
        }

        function closeCountryFilterOnClickOutside(event) {
            const dropdown = document.getElementById('countryFilterDropdown');
            const filterBtn = event.target.closest('.country-filter-btn');

            if (!dropdown.contains(event.target) && !filterBtn) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeCountryFilterOnClickOutside);
            }
        }

        function populateCountryList() {
            const container = document.getElementById('countryListContainer');
            const searchInput = document.getElementById('countrySearchInput');
            searchInput.value = '';

            // Get unique countries from fullTableData
            const countries = [...new Set(fullTableData.map(d => d.developer_country || '').filter(c => c !== ''))].sort();

            if (countries.length === 0) {
                container.innerHTML = '<div class="text-xs text-slate-400 p-2 text-center">No countries available</div>';
                return;
            }

            container.innerHTML = countries.map(country => {
                const isChecked = tempSelectedCountries.has(country) ? 'checked' : '';
                const escapedCountry = country.replace(/'/g, "\\'");
                return `
                    <label class="country-option flex items-center gap-2 px-2 py-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded cursor-pointer text-sm text-slate-700 dark:text-slate-300" data-country="${country}">
                        <input type="checkbox" class="country-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500" value="${escapedCountry}" ${isChecked} onchange="toggleCountrySelection('${escapedCountry}')">
                        <span class="country-name">${country}</span>
                    </label>
                `;
            }).join('');
        }

        function filterCountryList() {
            const searchValue = document.getElementById('countrySearchInput').value.toLowerCase();
            const options = document.querySelectorAll('.country-option');

            options.forEach(option => {
                const countryName = option.querySelector('.country-name').textContent.toLowerCase();
                if (countryName.includes(searchValue)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function toggleCountrySelection(country) {
            if (tempSelectedCountries.has(country)) {
                tempSelectedCountries.delete(country);
            } else {
                tempSelectedCountries.add(country);
            }
        }

        function applyCountryFilter() {
            activeFilters.country = new Set(tempSelectedCountries);
            document.getElementById('countryFilterDropdown').classList.add('hidden');
            document.removeEventListener('click', closeCountryFilterOnClickOutside);

            updateCountryFilterIcon();
            applyFilters();
            updateActiveFiltersIndicator();
        }

        function clearCountryFilter() {
            tempSelectedCountries.clear();
            document.querySelectorAll('.country-checkbox').forEach(cb => cb.checked = false);
        }

        function updateCountryFilterIcon() {
            const icon = document.getElementById('countryFilterIcon');
            if (activeFilters.country.size > 0) {
                icon.classList.remove('text-slate-400');
                icon.classList.add('text-blue-600');
            } else {
                icon.classList.remove('text-blue-600');
                icon.classList.add('text-slate-400');
            }
        }

        // ===== PASTE FILTER FUNCTIONS =====
        function togglePasteFilter() {
            const area = document.getElementById('pasteFilterArea');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                document.getElementById('pasteFilterInput').focus();
            } else {
                area.classList.add('hidden');
            }
        }

        function applyPasteFilter() {
            const rawInput = document.getElementById('pasteFilterInput').value;
            if (!rawInput || rawInput.trim() === '') {
                showToast("Please paste some Emails or IDs first.", "warning");
                return;
            }

            const filterList = rawInput.split(/[\n,]+/).map(item => item.trim().toLowerCase()).filter(item => item !== '');
            if (filterList.length === 0) return;

            const filtered = fullTableData.filter(d => {
                const idMatch = filterList.includes(d.developer_id.toString().toLowerCase());
                const emailMatch = filterList.includes(d.email.toLowerCase());
                return idMatch || emailMatch;
            });

            tableData = filtered;
            renderTable(filtered);
            updateCounts(filtered);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
            showToast(`Found ${filtered.length} matches out of ${fullTableData.length} records.`, "success");
            togglePasteFilter();
        }

        function clearPasteFilter() {
            document.getElementById('pasteFilterInput').value = '';
            tableData = [...fullTableData];
            renderTable(tableData);
            updateCounts(fullTableData);
            document.getElementById('selectAllCount').textContent = `(${tableData.length})`;
            applyFilters();
        }

        // ===== SEARCH FUNCTION =====
        function searchTable() {
            const searchValue = document.getElementById('tableSearch').value.toLowerCase();
            if (!searchValue) {
                applyFilters();
                return;
            }
            const filtered = tableData.filter(d => {
                return d.developer_id.toString().includes(searchValue) ||
                        d.full_name.toLowerCase().includes(searchValue) ||
                        d.email.toLowerCase().includes(searchValue) ||
                        (d.status && d.status.toLowerCase().includes(searchValue));
            });
            renderTable(filtered);
        }

        // --- Main Data Fetch ---
        function fetchData() {
            const jobId = document.getElementById('jobId').value;
            const stages = Array.from(document.querySelectorAll('.smart-chip.active')).map(e => e.dataset.value);

            if(!jobId || stages.length === 0) {
                showToast("Enter Job ID & Select Stages", "warning");
                return;
            }

            // Reset all selection state when fetching new data
            selectedDevs.clear();
            updateBulkUI();

            // Clear paste filter input and hide area
            document.getElementById('pasteFilterInput').value = '';
            document.getElementById('pasteFilterArea').classList.add('hidden');

            // Reset all filters to default state
            activeFilters.status.clear();
            activeFilters.status.add('all');
            activeFilters.type.clear();
            activeFilters.country.clear();
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            const allFilterChip = document.querySelector('.filter-chip[data-filter="all"]');
            if (allFilterChip) allFilterChip.classList.add('active');
            document.getElementById('tableSearch').value = '';
            updateCountryFilterIcon();
            updateActiveFiltersIndicator();

            const btn = document.getElementById('fetchBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Fetching...';

            google.script.run
                .withSuccessHandler(data => {
                    // Handle BigQuery timeout error
                    if (data && data.error === 'TIMEOUT') {
                        btn.innerHTML = originalHtml;
                        showBigQueryTimeoutError(data.message, jobId, stages);
                        return;
                    }

                    // Handle other error objects
                    if (data && data.error && typeof data.error === 'string') {
                        btn.innerHTML = originalHtml;
                        showToast("Error: " + data.error, "error");
                        return;
                    }

                    tableData = data;
                    fullTableData = data;
                    document.getElementById('tableControls').classList.remove('hidden');
                    document.getElementById('statusFilterContainer').classList.remove('hidden');
                    document.getElementById('tableContainer').classList.remove('hidden');

                    // Hide any previous timeout error
                    hideBigQueryTimeoutError();

                    renderTable(data);
                    updateCounts(data);

                    btn.innerHTML = originalHtml;
                    showToast(`Loaded ${data.length} candidates`, "success");
                })
                .withFailureHandler(err => {
                    btn.innerHTML = originalHtml;
                    showToast("Error: " + err.message, "error");
                })
                .getDevelopers(jobId, stages);
        }

        function updateCounts(data) {
            const allCount = data.length;
            const newCount = data.filter(d => !d.is_sent && !d.is_manual_sent).length;
            const followupCount = data.filter(d => d.is_sent && !d.is_manual_sent).length;
            const manualCount = data.filter(d => d.is_manual_sent).length;
            const subCount = data.filter(d => d.candidate_status === 'Agency Sub-Contractor').length;
            const agencyCount = data.filter(d => d.candidate_status === 'Agency Contractor').length;
            const directCount = data.filter(d => d.candidate_status === 'Independent' || !d.candidate_status).length;

            document.getElementById('allCount').textContent = allCount;
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('followupCount').textContent = followupCount;
            document.getElementById('manualCount').textContent = manualCount;
            document.getElementById('subCount').textContent = subCount;
            document.getElementById('agencyCount').textContent = agencyCount;
            document.getElementById('directCount').textContent = directCount;
        }

        // BigQuery Timeout Error Handling
        let lastBigQueryParams = { jobId: '', stages: [] };

        function showBigQueryTimeoutError(message, jobId, stages) {
            lastBigQueryParams = { jobId, stages };

            // Create or show the error container
            let errorContainer = document.getElementById('bigQueryTimeoutError');
            if (!errorContainer) {
                errorContainer = document.createElement('div');
                errorContainer.id = 'bigQueryTimeoutError';
                errorContainer.className = 'bg-amber-50 border border-amber-200 rounded-xl p-6 mb-6';

                // Insert after the fetch button area
                const tableControls = document.getElementById('tableControls');
                if (tableControls) {
                    tableControls.parentNode.insertBefore(errorContainer, tableControls);
                }
            }

            errorContainer.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-clock text-amber-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-amber-800 mb-1">BigQuery Query Timeout</h4>
                        <p class="text-sm text-amber-700 mb-3">${message || 'The database query took too long to complete. This can happen with large datasets or high server load.'}</p>
                        <div class="flex items-center gap-3">
                            <button onclick="retryBigQueryFetch()" class="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-amber-700 flex items-center gap-2 transition-colors">
                                <i class="fa-solid fa-rotate"></i> Retry Fetch
                            </button>
                            <button onclick="hideBigQueryTimeoutError()" class="text-amber-600 hover:text-amber-800 text-sm font-medium">
                                Dismiss
                            </button>
                        </div>
                        <p class="text-xs text-amber-500 mt-2">
                            <i class="fa-solid fa-info-circle mr-1"></i>
                            Tip: If this keeps happening, try selecting fewer pipeline stages or contact support.
                        </p>
                    </div>
                </div>
            `;

            errorContainer.classList.remove('hidden');
            showToast('Query timed out. Click "Retry Fetch" to try again.', 'warning');
        }

        function hideBigQueryTimeoutError() {
            const errorContainer = document.getElementById('bigQueryTimeoutError');
            if (errorContainer) {
                errorContainer.classList.add('hidden');
            }
        }

        function retryBigQueryFetch() {
            if (!lastBigQueryParams.jobId) {
                showToast('No previous query to retry. Please fetch again.', 'warning');
                return;
            }

            hideBigQueryTimeoutError();

            // Trigger the fetch again with the same parameters
            const jobId = lastBigQueryParams.jobId;
            const stages = lastBigQueryParams.stages;

            // Set the UI values
            document.getElementById('jobIdInput').value = jobId;

            // Call fetchDevelopers again
            fetchDevelopers();
        }

        function renderTable(data) {
            const tbody = document.querySelector('#devTable tbody');
            tbody.innerHTML = '';

            data.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700 transition";

                // Status badge with consistent styling
                let statusBadge = `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300">${d.status}</span>`;

                // Type badge with colors based on candidate type
                let typeBadge = '';
                const candidateType = d.candidate_status || 'Independent';
                if (candidateType === 'Agency Sub-Contractor') {
                    typeBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200"><i class="fa-solid fa-people-arrows text-[10px]"></i> SUB-CON</span>`;
                } else if (candidateType === 'Agency Contractor') {
                    typeBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200"><i class="fa-solid fa-building text-[10px]"></i> AGENCY</span>`;
                } else {
                    typeBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-green-100 text-green-700 border border-green-200"><i class="fa-solid fa-user text-[10px]"></i> DIRECT</span>`;
                }

                // History badge with colors
                let historyBadge = '';
                if (d.is_sent && !d.is_manual_sent) {
                    historyBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-red-100 text-red-700 border border-red-200"><i class="fa-solid fa-paper-plane text-[10px]"></i> Sent</span>`;
                } else if (d.is_manual_sent) {
                    historyBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200"><i class="fa-solid fa-hand text-[10px]"></i> M.Sent</span>`;
                } else {
                    historyBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-emerald-100 text-emerald-700 border border-emerald-200"><i class="fa-solid fa-sparkles text-[10px]"></i> New</span>`;
                }

                // Row class for sent status
                if (d.is_manual_sent) {
                    tr.classList.add('manual-sent-row');
                } else if (d.is_sent) {
                    tr.classList.add('sent-row');
                }

                const isChecked = selectedDevs.has(d.developer_id) ? 'checked' : '';

                // Format phone number with country code
                const phoneDisplay = d.phone_number ?
                    (d.phone_country_code ? `+${d.phone_country_code} ${d.phone_number}` : d.phone_number) :
                    '-';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-center"><input type="checkbox" class="row-checkbox rounded" value="${d.developer_id}" ${isChecked} onchange="toggleRowCheckbox('${d.developer_id}')"></td>
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">${d.developer_id}</td>
                    <td class="px-6 py-4">
                        <span class="font-bold text-slate-800 dark:text-slate-200">${d.full_name}</span>
                    </td>
                    <td class="px-6 py-4 text-slate-500 dark:text-slate-400">${d.email}</td>
                    <td class="px-6 py-4 text-xs text-slate-600 dark:text-slate-400">${d.developer_country || '-'}</td>
                    <td class="px-6 py-4 text-xs text-slate-500 dark:text-slate-400 font-mono">${phoneDisplay}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4">${typeBadge}</td>
                    <td class="px-6 py-4">${historyBadge}</td>
                `;
                tbody.appendChild(tr);
            });
            updateBulkUI();
        }

        // --- Checkbox Logic ---
        function toggleMasterCheckbox() {
            const master = document.getElementById('masterCheckbox');
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = master.checked;
                if(master.checked) selectedDevs.add(cb.value);
                else selectedDevs.delete(cb.value);
            });
            updateBulkUI();
        }
        function toggleRowCheckbox(id) {
            if(selectedDevs.has(id)) selectedDevs.delete(id);
            else selectedDevs.add(id);
            updateBulkUI();
        }
        function updateBulkUI() {
            const bar = document.getElementById('bulkActionBar');
            const count = selectedDevs.size;

            // Update both the floating bar count and the selection indicator
            document.getElementById('bulkSelectedCount').textContent = count;
            document.getElementById('quickSelectedCount').textContent = count;

            // Show/hide floating action bar
            if(count > 0) {
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }

            // Show/hide selection indicator
            const indicator = document.getElementById('selectionIndicator');
            if(count > 0) {
                indicator.classList.remove('hidden');
                indicator.classList.add('flex');
            } else {
                indicator.classList.add('hidden');
                indicator.classList.remove('flex');
            }
        }
        function deselectAll() {
            selectedDevs.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            updateBulkUI();
        }
        function selectAllResults() {
            tableData.forEach(d => selectedDevs.add(d.developer_id));
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = true);
            updateBulkUI();
        }

        function copyToClipboard() {
            if (selectedDevs.size === 0) {
                showToast("Please select at least one candidate", "warning");
                return;
            }

            const dataToExport = tableData.filter(d => selectedDevs.has(d.developer_id));

            // Create tab-separated values (TSV) for proper Excel/Google Sheets paste
            // Header row
            let tsv = "Developer ID\tName\tEmail\tCountry\tPhone\tStatus\tType\tAgency Name\tHistory\n";

            dataToExport.forEach(d => {
                // Format phone for Google Sheets - just the number, prefix with apostrophe to prevent formula interpretation
                const phoneDisplay = d.phone_number ? `'${d.phone_number.toString().replace(/^\+/, '')}` : '';

                // Type display
                let typeDisplay = 'Direct';
                if (d.candidate_status === 'Agency Sub-Contractor') typeDisplay = 'Sub-Contractor';
                else if (d.candidate_status === 'Agency Contractor') typeDisplay = 'Agency';

                // History display
                let historyDisplay = 'New';
                if (d.is_sent && !d.is_manual_sent) historyDisplay = `Sent (${d.sent_count || 1})`;
                else if (d.is_manual_sent) historyDisplay = `M.Sent (${d.manual_sent_count || 1})`;

                // Clean values to prevent tab/newline issues
                const cleanValue = (val) => (val || '').toString().replace(/[\t\n\r]/g, ' ');

                tsv += `${cleanValue(d.developer_id)}\t${cleanValue(d.full_name)}\t${cleanValue(d.email)}\t${cleanValue(d.developer_country)}\t${cleanValue(phoneDisplay)}\t${cleanValue(d.status)}\t${cleanValue(typeDisplay)}\t${cleanValue(d.agency_name)}\t${cleanValue(historyDisplay)}\n`;
            });

            navigator.clipboard.writeText(tsv).then(() => {
                showToast(`Copied ${selectedDevs.size} candidates to clipboard - paste into Excel/Sheets`, "success");
            }).catch(err => {
                showToast("Failed to copy to clipboard", "error");
            });
        }

        function downloadCSV() {
            if (tableData.length === 0) {
                showToast("No data to export", "warning");
                return;
            }

            const dataToExport = selectedDevs.size > 0
                ? tableData.filter(d => selectedDevs.has(d.developer_id))
                : tableData;

            // Helper function to escape CSV values (handle quotes and commas)
            const escapeCSV = (val) => {
                const str = (val || '').toString();
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return '"' + str + '"';
            };

            let csv = "Developer ID,Candidate Name,Email,Country,Phone,Pipeline Status,Type,Agency Name,Outreach History\n";
            dataToExport.forEach(d => {
                // Format phone for CSV - just the number without country code
                const phoneDisplay = d.phone_number ? d.phone_number.toString().replace(/^\+/, '') : '';

                let typeDisplay = 'Direct';
                if (d.candidate_status === 'Agency Sub-Contractor') typeDisplay = 'Sub-Contractor';
                else if (d.candidate_status === 'Agency Contractor') typeDisplay = 'Agency';

                let historyDisplay = 'New';
                if (d.is_sent && !d.is_manual_sent) historyDisplay = `Sent (${d.sent_count || 1})`;
                else if (d.is_manual_sent) historyDisplay = `M.Sent (${d.manual_sent_count || 1})`;

                csv += `${escapeCSV(d.developer_id)},${escapeCSV(d.full_name)},${escapeCSV(d.email)},${escapeCSV(d.developer_country)},${escapeCSV(phoneDisplay)},${escapeCSV(d.status)},${escapeCSV(typeDisplay)},${escapeCSV(d.agency_name)},${escapeCSV(historyDisplay)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `developers_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${dataToExport.length} records`, "success");
        }

        // --- Tasks Logic ---
        function loadTasks(showSpinner = false, onComplete = null) {
            const tbody = document.getElementById('taskListBody');

            // Only show spinner if explicitly requested or if table is empty
            if (showSpinner || tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center"><i class="fa-solid fa-spinner fa-spin"></i></td></tr>';
            } else {
                // Add a subtle loading indicator without clearing the table
                const refreshBtn = document.querySelector('#tasksTab .fa-rotate');
                if (refreshBtn) refreshBtn.classList.add('fa-spin');
            }

            const filters = {
                jobId: document.getElementById('taskJobFilter').value,
                status: document.getElementById('taskStatusFilter').value,
                forceRefresh: true
            };

            google.script.run.withSuccessHandler(res => {
                // Remove loading indicator
                const refreshBtn = document.querySelector('#tasksTab .fa-rotate');
                if (refreshBtn) refreshBtn.classList.remove('fa-spin');
                // Update Stats
                if(res.stats) {
                    document.getElementById('statTotal').textContent = res.stats.total;
                    document.getElementById('statActive').textContent = res.stats.active;
                    document.getElementById('statHuman').textContent = res.stats.human;
                    document.getElementById('statAccepted').textContent = res.stats.accepted;
                    document.getElementById('statCompleted').textContent = res.stats.completed || 0;
                }
                // Store job settings for badge rendering
                const jobSettingsMap = res.jobSettings || {};
                // Populate Job Filter dropdown with job IDs from sent emails
                if(res.jobIds && res.jobIds.length > 0) {
                    const jobFilter = document.getElementById('taskJobFilter');
                    const currentValue = jobFilter.value;
                    jobFilter.innerHTML = '<option value="all">All Jobs</option>';
                    res.jobIds.forEach(jobId => {
                        const option = document.createElement('option');
                        option.value = jobId;
                        option.textContent = jobId;
                        jobFilter.appendChild(option);
                    });
                    // Restore previous selection if still valid
                    if(currentValue !== 'all' && res.jobIds.includes(currentValue)) {
                        jobFilter.value = currentValue;
                    }
                }
                // Render Table
                const tasks = res.tasks || [];
                tbody.innerHTML = '';
                if(tasks.length === 0) {
                    document.getElementById('emptyTaskState').classList.remove('hidden');
                    tbody.parentElement.classList.add('hidden'); 
                } else {
                    document.getElementById('emptyTaskState').classList.add('hidden');
                    tbody.parentElement.classList.remove('hidden');
                    
                    tasks.forEach(t => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 border-b border-slate-50 transition task-row";
                        tr.dataset.email = t.email;
                        
                        // Badge Logic
                        let badgeClass = 'bg-blue-100 text-blue-700';
                        if(t.tags.includes('Human')) badgeClass = 'bg-amber-100 text-amber-700';
                        else if(t.status === 'Offer Accepted') badgeClass = 'bg-green-100 text-green-700';
                        else if(t.status === 'Completed' || t.type === 'Completed') badgeClass = 'bg-teal-100 text-teal-700';

                        // Status initials badges (N/F/D) - use job settings to show only enabled features
                        const taskJobSettings = jobSettingsMap[t.jobId] || null;
                        const statusBadges = getStatusBadges(t.tags, t.status, t.type, false, taskJobSettings);

                        const isChecked = selectedTasks.has(t.email) ? 'checked' : '';
                        if(selectedTasks.has(t.email)) tr.classList.add('selected');

                        tr.innerHTML = `
                            <td class="px-6 py-4 text-center"><input type="checkbox" class="task-check rounded" onchange="toggleTaskSelection('${t.email}')" ${isChecked}></td>
                            <td class="px-6 py-4 font-mono text-xs">${t.jobId}</td>
                            <td class="px-6 py-4 font-mono text-xs text-slate-600">${t.devId || 'N/A'}</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-800">${t.name}</span>
                                    ${statusBadges}
                                </div>
                            </td>
                            <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${t.tags}</span></td>
                            <td class="px-6 py-4 text-xs text-slate-500 max-w-sm cursor-pointer hover:text-blue-600" onclick="showNotes(\`${encodeURIComponent(t.aiNotes || '')}\`)">
                                ${t.aiNotes && t.aiNotes.length > 0 ?
                                    '<div class="truncate" title="Click to view full summary">' + t.aiNotes.split('\\n')[0].substring(0,60) + (t.aiNotes.length > 60 ? '...' : '') + '</div>' +
                                    (t.aiNotes.includes('') || t.aiNotes.includes('') ? '<span class="text-purple-500 text-xs"> View full summary</span>' : '')
                                    : '<span class="text-slate-300">-</span>'}
                            </td>
                            <td class="px-6 py-4 text-xs text-slate-400">${t.lastReply || 'N/A'}</td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end">
                                    <button onclick="markAsDone('${t.email}', '${t.jobId}', '${t.tags}', this)" class="bg-green-100 hover:bg-green-200 text-green-700 border border-green-300 px-3 py-1.5 rounded-lg text-sm font-medium transition inline-flex items-center gap-1"><i class="fa-solid fa-check"></i> Complete</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                // Update cache
                dataCache.tasks = { data: res, lastLoaded: Date.now() };
                // Call completion callback if provided
                if (onComplete) onComplete(res);
            }).getAllTasks(filters);
        }

        function filterTasks() { loadTasks(); }

        // Refresh Tasks with animation and success message
        function refreshTasksWithAnimation() {
            const btn = document.getElementById('taskRefreshBtn');
            if (!btn || btn.classList.contains('loading')) return;

            btn.classList.add('loading');

            loadTasks(false, (res) => {
                btn.classList.remove('loading');
                btn.classList.add('success');
                const taskCount = res.tasks ? res.tasks.length : 0;
                showToast(`Task list refreshed (${taskCount} tasks)`, 'success');

                // Reset button state after animation
                setTimeout(() => {
                    btn.classList.remove('success');
                }, 1500);
            });
        }

        // Task List Search Functions
        let taskSearchTerms = [];

        function handleTaskSearchKeyup(event) {
            if (event.key === 'Enter') {
                applyTaskSearch();
            }
        }

        function handleTaskSearchInput() {
            const input = document.getElementById('taskSearchInput');
            const clearBtn = document.getElementById('clearTaskSearch');
            if (input.value.trim()) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
                taskSearchTerms = [];
                filterTaskTable();
            }
        }

        function clearTaskSearch() {
            document.getElementById('taskSearchInput').value = '';
            document.getElementById('clearTaskSearch').classList.add('hidden');
            taskSearchTerms = [];
            filterTaskTable();
        }

        function applyTaskSearch() {
            const input = document.getElementById('taskSearchInput').value.trim();
            if (!input) {
                taskSearchTerms = [];
            } else {
                // Split by comma for bulk search
                taskSearchTerms = input.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
            }
            filterTaskTable();
        }

        function filterTaskTable() {
            const rows = document.querySelectorAll('#taskListBody .task-row');
            let visibleCount = 0;

            rows.forEach(row => {
                if (taskSearchTerms.length === 0) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    const email = (row.dataset.email || '').toLowerCase();
                    const devId = (row.querySelector('td:nth-child(3)')?.textContent || '').toLowerCase();

                    const matches = taskSearchTerms.some(term =>
                        email.includes(term) || devId.includes(term)
                    );

                    row.style.display = matches ? '' : 'none';
                    if (matches) visibleCount++;
                }
            });

            // Show/hide empty state
            const emptyState = document.getElementById('emptyTaskState');
            const table = document.querySelector('#taskListBody').parentElement;
            if (visibleCount === 0 && rows.length > 0) {
                emptyState.classList.remove('hidden');
                emptyState.querySelector('h3').textContent = 'No matching tasks';
                emptyState.querySelector('p').textContent = 'Try adjusting your search criteria.';
            } else if (visibleCount > 0) {
                emptyState.classList.add('hidden');
            }
        }

        function toggleAllTasks(master) {
            const checks = document.querySelectorAll('.task-check');
            checks.forEach(c => {
                c.checked = master.checked;
                const row = c.closest('.task-row');
                if(row) {
                    const email = row.dataset.email;
                    if(master.checked) {
                        selectedTasks.add(email);
                        row.classList.add('selected');
                    } else {
                        selectedTasks.delete(email);
                        row.classList.remove('selected');
                    }
                }
            });
            updateBulkActionsBar();
        }

        function toggleTaskSelection(email) {
            if(selectedTasks.has(email)) {
                selectedTasks.delete(email);
            } else {
                selectedTasks.add(email);
            }
            updateBulkActionsBar();
            document.querySelectorAll('.task-row').forEach(row => {
                if(row.dataset.email === email) {
                    row.classList.toggle('selected', selectedTasks.has(email));
                }
            });
        }

        function clearTaskSelection() {
            selectedTasks.clear();
            document.querySelectorAll('.task-check').forEach(c => c.checked = false);
            document.querySelectorAll('.task-row').forEach(r => r.classList.remove('selected'));
            document.querySelector('.task-master-check').checked = false;
            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = document.getElementById('taskSelectedCount');
            if(selectedTasks.size > 0) {
                bar.classList.remove('hidden');
                bar.classList.add('flex'); // Ensure flex is added
                count.textContent = selectedTasks.size;
            } else {
                bar.classList.add('hidden');
                bar.classList.remove('flex');
            }
        }

        function showNotes(encodedNotes) {
            try {
                const notes = decodeURIComponent(encodedNotes);
                document.getElementById('notesModalContent').innerText = notes;
                document.getElementById('notesModal').classList.remove('hidden');
            } catch(e) {
                console.error("Error showing notes:", e);
            }
        }

        // --- Follow Up Logic ---
        function loadFollowUpStats(showSpinner = false, onComplete = null) {
            const tbody = document.getElementById('followUpTableBody');

            // Only show spinner if explicitly requested or if table is empty
            if (showSpinner || tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center"><i class="fa-solid fa-spinner fa-spin"></i></td></tr>';
            } else {
                // Add a subtle loading indicator without clearing the table
                const refreshBtn = document.querySelector('#followupsTab .fa-rotate');
                if (refreshBtn) refreshBtn.classList.add('fa-spin');
            }

            const filters = {
                jobId: document.getElementById('followUpJobFilter').value,
                status: document.getElementById('followUpStatusFilter').value
            };

            google.script.run.withSuccessHandler(res => {
                // Remove loading indicator
                const refreshBtn = document.querySelector('#followupsTab .fa-rotate');
                if (refreshBtn) refreshBtn.classList.remove('fa-spin');
                // Update Stats Cards
                if(res.stats) {
                    document.getElementById('statPending').textContent = res.stats.pending;
                    document.getElementById('statFollowUp1').textContent = res.stats.followUp1Done;
                    document.getElementById('statFollowUp2').textContent = res.stats.followUp2Done;
                    document.getElementById('statResponded').textContent = res.stats.responded;
                }
                // Render Table
                tbody.innerHTML = '';
                const data = res.data || [];
                if(data.length === 0) {
                    document.getElementById('emptyFollowUpState').classList.remove('hidden');
                } else {
                    document.getElementById('emptyFollowUpState').classList.add('hidden');
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 border-b border-slate-50";

                        // Status badge colors
                        let statusBadge = '';
                        const status = item.followUpStatus || 'Pending';
                        if(status === 'Pending') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-700">Pending</span>';
                        } else if(status.includes('1') || status === 'Follow-Up-1-Sent') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-amber-100 text-amber-700">1st Follow-Up Sent</span>';
                        } else if(status.includes('2') || status === 'Follow-Up-2-Sent') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-orange-100 text-orange-700">2nd Follow-Up Sent</span>';
                        } else if(status === 'Responded') {
                            statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700">Responded</span>';
                        } else {
                            statusBadge = `<span class="px-2 py-1 rounded text-xs font-bold bg-blue-100 text-blue-700">${status}</span>`;
                        }

                        // Status initials badges (N/F/D) for follow-ups
                        const initialBadges = getStatusBadges('', status, '', true);

                        tr.innerHTML = `
                            <td class="px-6 py-4 font-mono text-xs">${item.jobId}</td>
                            <td class="px-6 py-4 font-mono text-xs text-slate-600">${item.devId || 'N/A'}</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold">${item.name}</span>
                                    ${initialBadges}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-slate-500">${item.email}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">${formatDateTime(item.lastReachedOut)}</td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end">
                                    <button onclick="markAsUnresponsive('${item.email}', this)" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-3 py-1.5 rounded-lg text-xs font-medium transition inline-flex items-center gap-1"><i class="fa-solid fa-user-xmark"></i> Unresponsive</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                // Update cache
                dataCache.followups = { data: res, lastLoaded: Date.now() };
                // Call completion callback if provided
                if (onComplete) onComplete(res);
            }).getFollowUpDataCombined(filters);
        }

        function loadFollowUpData() { loadFollowUpStats(); }

        // Refresh Follow-Ups with animation and success message
        function refreshFollowUpsWithAnimation() {
            const btn = document.getElementById('followUpRefreshBtn');
            if (!btn || btn.classList.contains('loading')) return;

            btn.classList.add('loading');

            loadFollowUpStats(false, (res) => {
                btn.classList.remove('loading');
                btn.classList.add('success');
                const itemCount = res.data ? res.data.length : 0;
                showToast(`Follow-up queue refreshed (${itemCount} items)`, 'success');

                // Reset button state after animation
                setTimeout(() => {
                    btn.classList.remove('success');
                }, 1500);
            });
        }

        // Follow-Up Search Functions
        let followUpSearchTerms = [];

        function handleFollowUpSearchKeyup(event) {
            if (event.key === 'Enter') {
                applyFollowUpSearch();
            }
        }

        function handleFollowUpSearchInput() {
            const input = document.getElementById('followUpSearchInput');
            const clearBtn = document.getElementById('clearFollowUpSearch');
            if (input.value.trim()) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
                followUpSearchTerms = [];
                filterFollowUpTable();
            }
        }

        function clearFollowUpSearch() {
            document.getElementById('followUpSearchInput').value = '';
            document.getElementById('clearFollowUpSearch').classList.add('hidden');
            followUpSearchTerms = [];
            filterFollowUpTable();
        }

        function applyFollowUpSearch() {
            const input = document.getElementById('followUpSearchInput').value.trim();
            if (!input) {
                followUpSearchTerms = [];
            } else {
                // Split by comma for bulk search
                followUpSearchTerms = input.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
            }
            filterFollowUpTable();
        }

        function filterFollowUpTable() {
            const rows = document.querySelectorAll('#followUpTableBody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                if (followUpSearchTerms.length === 0) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    const email = (row.querySelector('td:nth-child(4)')?.textContent || '').toLowerCase();
                    const devId = (row.querySelector('td:nth-child(2)')?.textContent || '').toLowerCase();

                    const matches = followUpSearchTerms.some(term =>
                        email.includes(term) || devId.includes(term)
                    );

                    row.style.display = matches ? '' : 'none';
                    if (matches) visibleCount++;
                }
            });

            // Show/hide empty state
            const emptyState = document.getElementById('emptyFollowUpState');
            if (visibleCount === 0 && rows.length > 0) {
                emptyState.classList.remove('hidden');
                emptyState.innerHTML = '<i class="fa-solid fa-search text-4xl text-slate-200 mb-3 block"></i>No matching follow-ups found.';
            } else if (visibleCount > 0) {
                emptyState.classList.add('hidden');
            }
        }

        // --- Settings / Config Logic Wrapper ---
        function openConfigLogic() {
            // Trigger refresh
            refreshTriggerStatus(); 
        }
        function refreshTriggerStatus() {
            const cont = document.getElementById('triggerStatusContainer');

            // Use cache if valid
            if(isCacheValid('triggers')) {
                renderTriggerStatus(dataCache.triggers.data);
                return;
            }

            cont.innerHTML = '<div class="text-xs text-slate-400">Loading triggers...</div>';
            google.script.run.withSuccessHandler(res => {
                // Update cache
                dataCache.triggers = { data: res, lastLoaded: Date.now() };
                renderTriggerStatus(res);
            }).getTriggerStatus();
        }

        function renderTriggerStatus(res) {
            const cont = document.getElementById('triggerStatusContainer');
            let html = '';
            res.status.triggers.forEach(t => {
                const color = t.exists ? 'text-green-600' : 'text-red-500';
                const icon = t.exists ? 'fa-check' : 'fa-times';
                html += `<div class="flex justify-between text-sm items-center p-2 bg-slate-50 rounded mb-1">
                    <span>${t.functionName}</span>
                    <span class="${color}"><i class="fa-solid ${icon}"></i></span>
                </div>`;
            });
            cont.innerHTML = html;
            if(res.status.missingCount > 0) document.getElementById('createTriggersSection').classList.remove('hidden');
            else document.getElementById('allTriggersGood').classList.remove('hidden');
        }

        // --- Email Panel Logic ---
        // Job settings state
        let jobSettings = {
            negotiation: true,
            followUp: true,
            dataGathering: true
        };

        // Format Painter state
        let formatPainterActive = false;
        let capturedFormat = null;

        // Saved editor selection for placeholder insertion
        let savedEditorRange = null;

        // Save selection when user interacts with the editor
        function saveEditorSelection() {
            const editor = document.getElementById('emailBody');
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                // Only save if selection is within the editor
                if (editor && editor.contains(range.commonAncestorContainer)) {
                    savedEditorRange = range.cloneRange();
                }
            }
        }

        // Initialize editor selection tracking
        function initEditorSelectionTracking() {
            const editor = document.getElementById('emailBody');
            if (editor) {
                editor.addEventListener('mouseup', saveEditorSelection);
                editor.addEventListener('keyup', saveEditorSelection);
                editor.addEventListener('focus', saveEditorSelection);
                // Also track selection changes
                document.addEventListener('selectionchange', function() {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        if (editor.contains(range.commonAncestorContainer)) {
                            savedEditorRange = range.cloneRange();
                        }
                    }
                });
            }
        }

        function openEmailPanel() {
            if(selectedDevs.size === 0) { showToast("Select candidates first", "warning"); return; }
            document.getElementById('emailRecipientCount').textContent = selectedDevs.size;

            // Preview logic
            const recipients = tableData.filter(d => selectedDevs.has(d.developer_id));
            const preview = recipients.slice(0, 5).map(r => r.email).join(', ');
            document.getElementById('emailRecipientPreview').textContent = recipients.length > 5 ? preview + ` +${recipients.length - 5} more` : preview;

            // Refresh templates logic
            refreshTemplates();

            // Reset job settings to defaults
            jobSettings = { negotiation: true, followUp: true, dataGathering: true };
            updateJobTogglesUI();
            updateJobTypeHint();

            // Clear format painter state
            formatPainterActive = false;
            capturedFormat = null;
            const fpBtn = document.getElementById('formatPainterBtn');
            if(fpBtn) fpBtn.classList.remove('active');

            // Reset saved editor range and initialize tracking
            savedEditorRange = null;
            initEditorSelectionTracking();

            document.getElementById('emailModalOverlay').classList.add('open');
        }

        function closeEmailPanel() {
            document.getElementById('emailModalOverlay').classList.remove('open');
        }

        function handleModalOverlayClick(event) {
            if(event.target.id === 'emailModalOverlay') {
                closeEmailPanel();
            }
        }

        // Toggle job settings
        function toggleJobSetting(setting) {
            jobSettings[setting] = !jobSettings[setting];
            updateJobTogglesUI();
            updateJobTypeHint();
        }

        function updateJobTogglesUI() {
            const toggleNeg = document.getElementById('toggleNegotiation');
            const toggleFollow = document.getElementById('toggleFollowUp');
            const toggleData = document.getElementById('toggleDataGathering');

            if(toggleNeg) toggleNeg.classList.toggle('active', jobSettings.negotiation);
            if(toggleFollow) toggleFollow.classList.toggle('active', jobSettings.followUp);
            if(toggleData) toggleData.classList.toggle('active', jobSettings.dataGathering);
        }

        function updateJobTypeHint() {
            const hintText = document.getElementById('jobTypeHintText');
            if(!hintText) return;

            const parts = [];
            if(jobSettings.negotiation) parts.push('Negotiation');
            if(jobSettings.followUp) parts.push('Follow-up');
            if(jobSettings.dataGathering) parts.push('Data Gathering');

            if(parts.length === 0) {
                hintText.textContent = 'No features enabled. This will be a simple announcement email.';
            } else {
                const features = parts.join(' + ');
                let description = '';
                if(jobSettings.negotiation && jobSettings.followUp) {
                    description = 'AI will negotiate and send automated reminders.';
                } else if(jobSettings.negotiation) {
                    description = 'AI will negotiate rates, no automatic follow-ups.';
                } else if(jobSettings.followUp && jobSettings.dataGathering) {
                    description = 'Responses will be collected with follow-up reminders.';
                } else if(jobSettings.dataGathering) {
                    description = 'Responses will be collected and tracked.';
                } else if(jobSettings.followUp) {
                    description = 'Automated follow-ups will be sent if no response.';
                } else {
                    description = 'Selected features are enabled.';
                }
                hintText.textContent = `${features} enabled. ${description}`;
            }
        }

        // ============================================================
        // TASKS TAB - JOB AI SETTINGS PANEL
        // ============================================================
        let taskJobSettings = { negotiation: false, followUp: false, dataGathering: false };
        let currentTaskJobId = null;

        function toggleJobSettingsPanel() {
            const content = document.getElementById('jobSettingsPanelContent');
            const icon = document.getElementById('jobSettingsPanelIcon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';

            // Populate job dropdown when opening
            if (!content.classList.contains('hidden')) {
                populateTaskJobDropdown();
            }
        }

        function populateTaskJobDropdown() {
            google.script.run
                .withSuccessHandler(jobs => {
                    const dropdown = document.getElementById('taskJobSettingsDropdown');
                    const currentVal = dropdown.value;
                    dropdown.innerHTML = '<option value="">-- Select a Job --</option>';
                    jobs.forEach(j => {
                        dropdown.innerHTML += `<option value="${j}">Job ${j}</option>`;
                    });
                    // Restore selection if it still exists
                    if (currentVal && jobs.includes(currentVal)) {
                        dropdown.value = currentVal;
                    }
                })
                .getJobConfigList();
        }

        function loadTaskJobSettings(jobId) {
            currentTaskJobId = jobId;
            if (!jobId) {
                taskJobSettings = { negotiation: false, followUp: false, dataGathering: false };
                updateTaskJobTogglesUI();
                updateTaskJobSettingsHint();
                return;
            }

            google.script.run
                .withSuccessHandler(settings => {
                    if (settings) {
                        taskJobSettings = {
                            negotiation: settings.negotiation === true,
                            followUp: settings.followUp === true,
                            dataGathering: settings.dataGathering === true
                        };
                    } else {
                        taskJobSettings = { negotiation: false, followUp: false, dataGathering: false };
                    }
                    updateTaskJobTogglesUI();
                    updateTaskJobSettingsHint();
                })
                .withFailureHandler(err => {
                    console.error('Failed to load job settings:', err);
                    taskJobSettings = { negotiation: false, followUp: false, dataGathering: false };
                    updateTaskJobTogglesUI();
                    updateTaskJobSettingsHint();
                })
                .getJobSettings(jobId);
        }

        function toggleTaskJobSetting(setting) {
            if (!currentTaskJobId) {
                showToast('Select a job first', 'warning');
                return;
            }

            taskJobSettings[setting] = !taskJobSettings[setting];
            updateTaskJobTogglesUI();
            updateTaskJobSettingsHint();

            // Save immediately
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showToast(result.message, 'success');
                    } else {
                        showToast('Failed to save: ' + result.error, 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('Error saving settings: ' + err.message, 'error');
                })
                .updateJobSettings(currentTaskJobId, taskJobSettings);
        }

        function updateTaskJobTogglesUI() {
            const toggleNeg = document.getElementById('taskToggleNegotiation');
            const toggleFollow = document.getElementById('taskToggleFollowUp');
            const toggleData = document.getElementById('taskToggleDataGathering');

            if (toggleNeg) toggleNeg.classList.toggle('active', taskJobSettings.negotiation);
            if (toggleFollow) toggleFollow.classList.toggle('active', taskJobSettings.followUp);
            if (toggleData) toggleData.classList.toggle('active', taskJobSettings.dataGathering);
        }

        function updateTaskJobSettingsHint() {
            const hintText = document.getElementById('taskJobSettingsHintText');
            if (!hintText) return;

            if (!currentTaskJobId) {
                hintText.textContent = 'Select a job to view/modify its AI settings';
                return;
            }

            const parts = [];
            if (taskJobSettings.negotiation) parts.push('Negotiation');
            if (taskJobSettings.followUp) parts.push('Follow-up');
            if (taskJobSettings.dataGathering) parts.push('Data Gathering');

            if (parts.length === 0) {
                hintText.textContent = `Job ${currentTaskJobId}: All AI features are OFF. AI will not process this job.`;
            } else {
                hintText.textContent = `Job ${currentTaskJobId}: ${parts.join(' + ')} enabled.`;
            }
        }

        // Rich text editor formatting functions
        function formatText(cmd, value = null) {
            document.getElementById('emailBody').focus();
            if(cmd === 'formatBlock') {
                document.execCommand(cmd, false, value);
            } else {
                document.execCommand(cmd, false, value);
            }
            handleEditorInput();
        }

        // Format Painter
        function handleFormatPainter() {
            const btn = document.getElementById('formatPainterBtn');

            if(!formatPainterActive) {
                // Copy mode - capture current formatting
                const selection = window.getSelection();
                if(selection.rangeCount > 0) {
                    capturedFormat = {
                        bold: document.queryCommandState('bold'),
                        italic: document.queryCommandState('italic'),
                        underline: document.queryCommandState('underline')
                    };
                    formatPainterActive = true;
                    btn.classList.add('active');
                    showToast('Format copied! Select text to apply.', 'info');
                } else {
                    showToast('Select text first to copy its format.', 'warning');
                }
            } else {
                // Apply mode
                if(capturedFormat) {
                    // First remove all formatting
                    document.execCommand('removeFormat', false, null);

                    // Then apply captured formatting
                    if(capturedFormat.bold) document.execCommand('bold', false, null);
                    if(capturedFormat.italic) document.execCommand('italic', false, null);
                    if(capturedFormat.underline) document.execCommand('underline', false, null);

                    showToast('Format applied!', 'success');
                }

                // Reset format painter
                formatPainterActive = false;
                capturedFormat = null;
                btn.classList.remove('active');
            }
        }

        function handleEditorInput() {
            const editor = document.getElementById('emailBody');
            const hiddenField = document.getElementById('htmlBody');
            if(editor && hiddenField) {
                hiddenField.value = editor.innerHTML;
            }
        }

        // Paste as Plain Text - reads clipboard and inserts as plain text
        async function pasteAsPlainText() {
            const editor = document.getElementById('emailBody');

            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    editor.focus();
                    const selection = window.getSelection();

                    // Use saved range if available
                    if (savedEditorRange) {
                        selection.removeAllRanges();
                        selection.addRange(savedEditorRange);
                    }

                    // Insert the plain text
                    document.execCommand('insertText', false, text);
                    handleEditorInput();
                    saveEditorSelection();
                    showToast('Pasted as plain text', 'success');
                }
            } catch (err) {
                // Fallback: prompt user to paste manually
                showToast('Please use Ctrl+Shift+V to paste as plain text', 'info');
            }
        }

        // Get job type string for backend compatibility
        function getJobTypeFromSettings() {
            // Map toggle settings to job type for backend
            if(jobSettings.negotiation && jobSettings.followUp) {
                return 'negotiation';
            } else if(jobSettings.dataGathering && jobSettings.followUp) {
                return 'data_gathering';
            } else if(!jobSettings.followUp) {
                return 'informing';
            } else {
                return 'negotiation'; // default
            }
        }

        // --- Negotiation Config ---
        function loadNegotiationConfig() {
            const jId = document.getElementById('negJobId').value;
            if(!jId) {
                return;
            }
            google.script.run.withSuccessHandler(cfg => {
                if(cfg) {
                    document.getElementById('targetRate').value = cfg.targetRate || '';
                    document.getElementById('maxRate').value = cfg.maxRate || '';
                    document.getElementById('negStyle').value = cfg.style || 'Friendly but firm';
                    document.getElementById('specialRules').value = cfg.specialRules || '';
                    document.getElementById('jobDescription').innerHTML = cfg.jobDescription || '';
                    document.getElementById('jdLink').value = cfg.jdLink || '';

                    // Load start dates
                    renderStartDates(cfg.startDates || []);
                } else {
                    // Clear fields for new job
                    document.getElementById('jdLink').value = '';
                    renderStartDates([]);
                }
            }).getNegotiationConfig(jId);
            refreshRateTiers();
        }

        // --- Start Dates Management ---
        let currentStartDates = [];

        function renderStartDates(dates) {
            currentStartDates = dates || [];
            const container = document.getElementById('startDatesContainer');
            container.innerHTML = '';

            if (currentStartDates.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-400 italic">No start dates added yet</p>';
                return;
            }

            currentStartDates.forEach((date, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                row.innerHTML = `
                    <input type="date" value="${date}" onchange="updateStartDate(${index}, this.value)" class="input-field flex-1 text-sm">
                    <button type="button" onclick="removeStartDate(${index})" class="text-red-500 hover:text-red-700 p-1" title="Remove">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                container.appendChild(row);
            });
        }

        function addStartDate() {
            currentStartDates.push('');
            renderStartDates(currentStartDates);
            // Focus on the new date input
            const inputs = document.querySelectorAll('#startDatesContainer input[type="date"]');
            if (inputs.length > 0) {
                inputs[inputs.length - 1].focus();
            }
        }

        function updateStartDate(index, value) {
            currentStartDates[index] = value;
        }

        function removeStartDate(index) {
            currentStartDates.splice(index, 1);
            renderStartDates(currentStartDates);
        }

        function getStartDates() {
            // Filter out empty dates
            return currentStartDates.filter(d => d && d.trim() !== '');
        }

        // --- Insert Placeholder into Email Editor ---
        function insertPlaceholder(placeholder) {
            const editor = document.getElementById('emailBody');
            const selection = window.getSelection();

            // Use saved range if available (cursor position before clicking placeholder button)
            if (savedEditorRange) {
                // Save the range before focus, as focus event can overwrite savedEditorRange
                const rangeToUse = savedEditorRange.cloneRange();
                editor.focus();
                selection.removeAllRanges();
                selection.addRange(rangeToUse);

                const range = selection.getRangeAt(0);
                range.deleteContents();
                const textNode = document.createTextNode(placeholder);
                range.insertNode(textNode);

                // Move cursor after inserted text
                range.setStartAfter(textNode);
                range.setEndAfter(textNode);
                selection.removeAllRanges();
                selection.addRange(range);

                // Update saved range to new cursor position
                savedEditorRange = range.cloneRange();
            } else {
                // No saved range - append at end
                editor.focus();
                const textNode = document.createTextNode(placeholder);
                editor.appendChild(textNode);

                // Place cursor after inserted text
                const range = document.createRange();
                range.setStartAfter(textNode);
                range.setEndAfter(textNode);
                selection.removeAllRanges();
                selection.addRange(range);
                savedEditorRange = range.cloneRange();
            }

            handleEditorInput();
        }

        // --- Initial Load ---
        $(document).ready(() => {
            // Load DB URL
            google.script.run.withSuccessHandler(url => document.getElementById('sheetUrl').value = url).getStoredSheetUrl();
            google.script.run.withSuccessHandler(url => document.getElementById('jobsSheetUrl').value = url).getStoredJobsSheetUrl();
        });

        // --- RESTORED COMPLEX LOGIC ---
        
        function manualTriggerAI() {
            if(!confirm("Start AI negotiation sweep? This will process all configured jobs.")) return;
            
            const btn = document.getElementById('runAiBtn');
            const progressPanel = document.getElementById('aiProgressPanel');
            const logContainer = document.getElementById('aiLogContainer');
            const statusEl = document.getElementById('aiProgressStatus');
            
            progressPanel.classList.remove('hidden');
            logContainer.innerHTML = '';
            addLog('info', 'Starting AI Negotiator...');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Running...';
            btn.disabled = true;
            
            google.script.run
                .withSuccessHandler(res => {
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <span>Run AI Now</span>';
                    btn.disabled = false;
                    
                    if(res.status === 'Success') {
                        statusEl.textContent = 'Completed!';

                        if(res.log && res.log.length > 0) {
                            res.log.forEach(l => addLog(l.type, l.message));
                        }

                        let summary = ` Complete! Replied: ${res.stats.replied}, Escalated: ${res.stats.escalated}, Accepted: ${res.stats.accepted}`;
                        if(res.stats.summariesGenerated > 0) {
                            summary += `, Summaries: ${res.stats.summariesGenerated}`;
                        }
                        addLog('success', summary);
                        showToast(summary, "success");
                        loadTasks();
                    } else {
                        statusEl.textContent = 'Error';
                        addLog('error', 'Error: ' + res.message);
                        showToast("AI Error: " + res.message, "error");
                    }
                })
                .withFailureHandler(err => {
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <span>Run AI Now</span>';
                    btn.disabled = false;
                    statusEl.textContent = 'Failed';
                    addLog('error', 'Failed: ' + err.message);
                    showToast("Failed: " + err.message, "error");
                })
                .runAutoNegotiator();
        }

        function processCompletedHumanEscalations() {
            const btn = document.getElementById('processHumanBtn');
            const originalContent = btn.innerHTML;

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            google.script.run
                .withSuccessHandler(res => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;

                    if (res.processed > 0) {
                        showToast(`Processed ${res.processed} human escalations`, "success");
                        // Show details in log if AI progress panel is visible
                        const logContainer = document.getElementById('aiLogContainer');
                        if (logContainer && res.log) {
                            res.log.forEach(l => addLog(l.type, l.message));
                        }
                    } else {
                        showToast("No completed human escalations to process", "info");
                    }

                    // Refresh task list
                    loadTasks();
                })
                .withFailureHandler(err => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    showToast("Error: " + err.message, "error");
                })
                .processCompletedHumanEscalations();
        }

        // ==========================================
        // AI LEARNING CENTER FUNCTIONS
        // ==========================================

        function loadLearningCases(onComplete = null) {
            // Load basic stats
            google.script.run
                .withSuccessHandler(stats => {
                    document.getElementById('learningPendingCount').textContent = stats.pending || 0;
                    document.getElementById('learningApprovedCount').textContent = stats.approved || 0;
                    document.getElementById('learningConsolidatedCount').textContent = stats.consolidated || 0;
                    document.getElementById('learningTotalCount').textContent = stats.total || 0;
                })
                .withFailureHandler(err => console.error('Failed to load learning stats:', err))
                .getLearningStats();

            // Load validation stats (new feature)
            google.script.run
                .withSuccessHandler(validationStats => {
                    if (validationStats && !validationStats.error) {
                        // Update effectiveness rate
                        document.getElementById('learningEffectivenessRate').textContent = (validationStats.avgEffectiveness || 0) + '%';

                        // Update learning type counts
                        document.getElementById('learningPositiveCount').textContent = validationStats.positiveLearnings || 0;
                        document.getElementById('learningNegativeCount').textContent = validationStats.negativeLearnings || 0;
                        document.getElementById('learningStyleCount').textContent = validationStats.styleAdaptations || 0;

                        // Render top performers
                        renderTopPerformers(validationStats.topPerformers || []);

                        // Render low performers
                        renderLowPerformers(validationStats.lowPerformers || []);
                    }
                })
                .withFailureHandler(err => console.error('Failed to load validation stats:', err))
                .getLearningValidationStats();

            // Load pending cases
            google.script.run
                .withSuccessHandler(cases => {
                    renderLearningCases(cases);
                    // Call completion callback if provided
                    if (onComplete) onComplete(cases);
                })
                .withFailureHandler(err => {
                    console.error('Failed to load learning cases:', err);
                    showToast('Failed to load learning cases', 'error');
                    // Still call callback on failure
                    if (onComplete) onComplete([]);
                })
                .getPendingLearningCases();
        }

        function renderTopPerformers(performers) {
            const container = document.getElementById('topPerformersList');
            if (!performers || performers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-slate-400 text-sm">
                        <i class="fa-solid fa-chart-simple text-2xl mb-2 block"></i>
                        No data yet - learnings need 3+ uses to appear here
                    </div>
                `;
                return;
            }

            container.innerHTML = performers.map(p => `
                <div class="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-700 dark:text-slate-200 truncate">${escapeHtml(p.lesson || p.category)}</p>
                        <p class="text-xs text-slate-500">${p.category} | Used ${p.timesUsed}x</p>
                    </div>
                    <span class="ml-2 px-2 py-1 text-xs font-bold rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                        ${Math.round(p.effectiveness)}%
                    </span>
                </div>
            `).join('');
        }

        function renderLowPerformers(performers) {
            const container = document.getElementById('lowPerformersList');
            if (!performers || performers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-slate-400 text-sm">
                        <i class="fa-solid fa-check-circle text-2xl mb-2 block text-green-400"></i>
                        No underperforming learnings detected
                    </div>
                `;
                return;
            }

            container.innerHTML = performers.map(p => `
                <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-700 dark:text-slate-200 truncate">${escapeHtml(p.lesson || p.category)}</p>
                        <p class="text-xs text-slate-500">${p.category} | Used ${p.timesUsed}x | ${p.successCount} successes</p>
                    </div>
                    <span class="ml-2 px-2 py-1 text-xs font-bold rounded-full bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
                        ${Math.round(p.effectiveness)}%
                    </span>
                </div>
            `).join('');
        }

        // Refresh Learning Cases with animation and success message
        function refreshLearningCasesWithAnimation() {
            const btn = document.getElementById('learningRefreshBtn');
            if (!btn || btn.classList.contains('loading')) return;

            btn.classList.add('loading');

            loadLearningCases((cases) => {
                btn.classList.remove('loading');
                btn.classList.add('success');
                const caseCount = cases ? cases.length : 0;
                showToast(`Learning cases refreshed (${caseCount} pending)`, 'success');

                // Reset button state after animation
                setTimeout(() => {
                    btn.classList.remove('success');
                }, 1500);
            });
        }

        function renderLearningCases(cases) {
            const container = document.getElementById('learningCasesList');

            if (!cases || cases.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-slate-500">
                        <i class="fa-solid fa-inbox text-4xl mb-3 text-slate-300"></i>
                        <p>No pending learning cases</p>
                        <p class="text-sm">Learning cases will appear here when human escalations are completed</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = cases.map(c => `
                <div class="p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition" data-row="${c.rowIndex}">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                ${getLearningTypeBadge(c.learningType)}
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${getCategoryColor(c.category)}">${formatCategory(c.category)}</span>
                                ${c.candidateTone ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300"><i class="fa-solid fa-comment mr-1"></i>${c.candidateTone}</span>` : ''}
                                <span class="text-xs text-slate-400">Job ${c.jobId}</span>
                                <span class="text-xs text-slate-400">${formatDate(c.timestamp)}</span>
                            </div>
                            <p class="font-medium text-slate-800 dark:text-white mb-1">${escapeHtml(c.candidateConcern)}</p>
                            <div class="text-sm text-slate-600 dark:text-slate-300 mb-2">
                                <strong>${c.learningType === 'negative' ? 'What to Avoid:' : 'Human Approach:'}</strong> ${escapeHtml(c.humanApproach)}
                            </div>
                            <div class="text-sm text-slate-600 dark:text-slate-300 mb-2">
                                <strong>${c.learningType === 'negative' ? 'Warning Signs:' : 'Key Phrases:'}</strong> <span class="italic">${escapeHtml(c.keyPhrases)}</span>
                            </div>
                            <div class="text-sm ${c.learningType === 'negative' ? 'text-red-700 dark:text-red-400 bg-red-50 dark:bg-red-900/20' : 'text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/20'} px-3 py-2 rounded-lg">
                                <i class="fa-solid fa-lightbulb mr-1"></i> <strong>Lesson:</strong> ${escapeHtml(c.lessonLearned)}
                            </div>
                            <div class="text-xs text-slate-400 mt-2">
                                Outcome: ${c.resolutionOutcome} | Candidate: ${c.candidateEmail}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="approveLearning(${c.rowIndex})" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 flex items-center gap-1">
                                <i class="fa-solid fa-check"></i> Approve
                            </button>
                            <button onclick="rejectLearning(${c.rowIndex})" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-200 flex items-center gap-1">
                                <i class="fa-solid fa-trash"></i> Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getLearningTypeBadge(learningType) {
            const badges = {
                'positive': '<span class="px-2 py-1 text-xs font-bold rounded-full bg-green-600 text-white"><i class="fa-solid fa-thumbs-up mr-1"></i>Positive</span>',
                'negative': '<span class="px-2 py-1 text-xs font-bold rounded-full bg-red-600 text-white"><i class="fa-solid fa-thumbs-down mr-1"></i>Negative</span>',
                'style_adaptation': '<span class="px-2 py-1 text-xs font-bold rounded-full bg-purple-600 text-white"><i class="fa-solid fa-masks-theater mr-1"></i>Style</span>'
            };
            return badges[learningType] || badges['positive'];
        }

        function getCategoryColor(category) {
            const colors = {
                'rate_objection': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
                'availability': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
                'competitor': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
                'requirements': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300',
                'trust': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
                'timing': 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300',
                'communication': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300',
                'other': 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300'
            };
            return colors[category] || colors['other'];
        }

        function formatCategory(category) {
            const labels = {
                'rate_objection': 'Rate Objection',
                'availability': 'Availability',
                'competitor': 'Competitor Offer',
                'requirements': 'Requirements',
                'trust': 'Trust Concerns',
                'timing': 'Timing Issue',
                'communication': 'Communication',
                'other': 'Other'
            };
            return labels[category] || category;
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch {
                return dateStr;
            }
        }

        function approveLearning(rowIndex) {
            const userEmail = document.getElementById('userEmailText')?.textContent || 'Unknown';

            google.script.run
                .withSuccessHandler(success => {
                    if (success) {
                        showToast('Learning case approved!', 'success');
                        loadLearningCases();
                    } else {
                        showToast('Failed to approve learning case', 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('Error: ' + err.message, 'error');
                })
                .approveLearningCase(rowIndex, userEmail);
        }

        function rejectLearning(rowIndex) {
            if (!confirm('Are you sure you want to reject this learning case? This cannot be undone.')) {
                return;
            }

            google.script.run
                .withSuccessHandler(success => {
                    if (success) {
                        showToast('Learning case rejected', 'info');
                        loadLearningCases();
                    } else {
                        showToast('Failed to reject learning case', 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('Error: ' + err.message, 'error');
                })
                .rejectLearningCase(rowIndex);
        }

        function consolidateLearnings() {
            if (!confirm('This will consolidate all approved learnings into Negotiation FAQs. Continue?')) {
                return;
            }

            showToast('Consolidating approved learnings...', 'info');

            google.script.run
                .withSuccessHandler(result => {
                    if (result.consolidated > 0) {
                        showToast(`Successfully consolidated ${result.consolidated} learnings into FAQs!`, 'success');
                    } else {
                        showToast('No approved learnings to consolidate', 'info');
                    }
                    // Show detailed log
                    result.log.forEach(l => console.log(`[${l.type}] ${l.message}`));
                    loadLearningCases();
                })
                .withFailureHandler(err => {
                    showToast('Consolidation failed: ' + err.message, 'error');
                })
                .consolidateApprovedLearnings();
        }

        function setupWeeklyConsolidation() {
            google.script.run
                .withSuccessHandler(result => {
                    showToast(result.message, 'success');
                })
                .withFailureHandler(err => {
                    showToast('Error: ' + err.message, 'error');
                })
                .setupWeeklyLearningConsolidation();
        }

        function removeWeeklyConsolidation() {
            google.script.run
                .withSuccessHandler(result => {
                    showToast(result.message, 'info');
                })
                .withFailureHandler(err => {
                    showToast('Error: ' + err.message, 'error');
                })
                .removeWeeklyLearningConsolidation();
        }

        function addLog(type, message) {
            const container = document.getElementById('aiLogContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'triangle-exclamation' : type === 'error' ? 'circle-xmark' : 'circle-info';
            entry.innerHTML = `<i class="fa-solid fa-${icon} mr-1"></i> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function saveConfig() {
            const databaseUrl = document.getElementById('sheetUrl').value;
            const jobsUrl = document.getElementById('jobsSheetUrl').value;

            if(!databaseUrl || !jobsUrl) {
                showToast("Please enter both URLs", "warning");
                return;
            }

            // Get follow-up timing values
            const followUp1 = parseInt(document.getElementById('followUp1Hours').value) || 12;
            const followUp2 = parseInt(document.getElementById('followUp2Hours').value) || 28;
            const unresponsive = parseInt(document.getElementById('unresponsiveHours').value) || 76;

            // Validate timing sequence
            if (followUp1 < 1) {
                showToast("1st follow-up must be at least 1 hour", "warning");
                return;
            }
            if (followUp2 <= followUp1) {
                showToast("2nd follow-up must be after 1st follow-up", "warning");
                return;
            }
            if (unresponsive <= followUp2) {
                showToast("Mark unresponsive time must be after 2nd follow-up", "warning");
                return;
            }

            const btn = document.getElementById('saveConfigBtn');
            const btnText = document.getElementById('saveConfigText');
            const spinner = document.getElementById('saveConfigSpinner');

            btn.disabled = true;
            btnText.textContent = 'Saving...';
            spinner.classList.remove('hidden');

            // Save URLs, timing config, and email sender config
            let urlsSaved = false;
            let timingSaved = false;
            let emailSenderSaved = false;

            const checkComplete = () => {
                if (urlsSaved && timingSaved && emailSenderSaved) {
                    btn.disabled = false;
                    btnText.textContent = 'Save';
                    spinner.classList.add('hidden');
                    showToast("Settings saved!", "success");
                    document.getElementById('configModal').classList.add('hidden');
                }
            };

            google.script.run
                .withSuccessHandler(() => {
                    urlsSaved = true;
                    checkComplete();
                })
                .withFailureHandler(err => {
                    btn.disabled = false;
                    btnText.textContent = 'Save';
                    spinner.classList.add('hidden');
                    showToast("Error saving URLs: " + err.message, "error");
                })
                .saveSheetUrls(databaseUrl, jobsUrl);

            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        timingSaved = true;
                        checkComplete();
                    } else {
                        btn.disabled = false;
                        btnText.textContent = 'Save';
                        spinner.classList.add('hidden');
                        showToast("Error saving timing: " + result.error, "error");
                    }
                })
                .withFailureHandler(err => {
                    btn.disabled = false;
                    btnText.textContent = 'Save';
                    spinner.classList.add('hidden');
                    showToast("Error saving timing: " + err.message, "error");
                })
                .saveFollowUpTimingConfig({
                    FOLLOW_UP_1_HOURS: followUp1,
                    FOLLOW_UP_2_HOURS: followUp2,
                    UNRESPONSIVE_HOURS: unresponsive
                });

            // Save email sender config
            const emailSenderEnabled = document.getElementById('toggleEmailSender').classList.contains('active');
            google.script.run
                .withSuccessHandler(() => {
                    emailSenderSaved = true;
                    checkComplete();
                })
                .withFailureHandler(err => {
                    console.error('Error saving email sender config:', err);
                    emailSenderSaved = true; // Don't block other saves
                    checkComplete();
                })
                .saveEmailSenderConfig({
                    enabled: emailSenderEnabled,
                    senderName: document.getElementById('customSenderName').value.trim(),
                    signature: document.getElementById('customSignature').value.trim()
                });
        }

        function createAllTriggers() {
            const btn = document.getElementById('createAllTriggersBtn');
            const btnText = document.getElementById('createTriggersText');
            const spinner = document.getElementById('createTriggersSpinner');

            btn.disabled = true;
            btnText.textContent = 'Creating...';
            spinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(result => {
                    btn.disabled = false;
                    btnText.textContent = 'Create Missing Triggers';
                    spinner.classList.add('hidden');
                    if (result.success) {
                        showToast(`Created ${result.results.created.length} trigger(s)!`, 'success');
                        refreshTriggerStatus();
                    } else {
                        showToast(result.error, 'error');
                    }
                })
                .createAllMissingTriggers();
        }

        // Legacy function kept for compatibility - now uses toggle system
        function handleJobTypeChange() {
            // This function is deprecated - use toggle system instead
            updateJobTypeHint();
        }

        // Helper function to send a batch of emails
        function sendEmailBatch(recipientsBatch, senderName, subject, body, jobId, opts) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .sendBulkEmails(recipientsBatch, senderName, subject, body, jobId, opts);
            });
        }

        // Emergency stop function for email sending
        function stopEmailSending() {
            emailSendingAborted = true;
            document.getElementById('sendProgressText').textContent = 'Stopping...';
            document.getElementById('stopSendingBtn').disabled = true;
            document.getElementById('stopSendingBtn').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Stopping';
        }

        async function sendEmails() {
            const subject = document.getElementById('emailSubject').value;
            const senderName = document.getElementById('senderName')?.value || '';

            // Get body from rich text editor (HTML content)
            const emailBodyEl = document.getElementById('emailBody');
            const body = emailBodyEl.innerHTML || emailBodyEl.innerText || '';
            const plainTextBody = emailBodyEl.innerText || '';

            const recipients = tableData.filter(d => selectedDevs.has(d.developer_id)).map(d => ({
                name: d.full_name,
                email: d.email,
                devId: d.developer_id,
                // FIX: Check both developer_country (from pipeline data) and region (from manual entry)
                region: d.developer_country || d.region || ''
            }));
            const jobId = document.getElementById('jobId').value;

            // Get job type from toggle settings
            const jobType = getJobTypeFromSettings();

            if(!recipients.length) { showToast("No recipients", "warning"); return; }
            if(!jobId) { showToast("Missing Job ID", "warning"); return; }
            if(!subject || !plainTextBody.trim()) { showToast("Missing subject or content", "warning"); return; }

            // Check if user wants to save as template
            const saveAsTemplate = document.getElementById('saveAsTemplateCheck')?.checked;
            if(saveAsTemplate) {
                const templateName = document.getElementById('newTemplateName')?.value?.trim();
                if(!templateName) {
                    showToast("Please enter a name for your template", "warning");
                    document.getElementById('newTemplateName')?.focus();
                    return;
                }
                google.script.run.withSuccessHandler(() => {
                    showToast("Template saved!", "success");
                    refreshTemplates();
                }).saveEmailTemplate(templateName, subject, body, jobId);
            }

            const btn = document.getElementById('sendEmailBtn');
            const progressContainer = document.getElementById('sendProgressContainer');

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;
            progressContainer.classList.remove('hidden');

            // Build options with all job settings
            const opts = {
                jobType: jobType,
                jobSettings: jobSettings,
                senderName: senderName
            };

            // Batch sending logic - optimized for speed
            const BATCH_SIZE = 25; // Increased from 15 for faster sending
            const total = recipients.length;
            let totalSent = 0;
            let errors = [];

            // Reset abort flag at start
            emailSendingAborted = false;
            document.getElementById('sendProgressCount').textContent = `0/${total}`;

            try {
                for (let i = 0; i < total; i += BATCH_SIZE) {
                    // Check if user requested stop
                    if (emailSendingAborted) {
                        showToast(`Sending stopped! Sent ${totalSent} of ${total} emails.`, "warning");
                        break;
                    }

                    const batch = recipients.slice(i, i + BATCH_SIZE);
                    const progress = Math.floor((i / total) * 100);
                    document.getElementById('sendProgressBar').style.width = progress + '%';
                    document.getElementById('sendProgressCount').textContent = `${totalSent}/${total}`;
                    document.getElementById('sendProgressText').textContent = `Sending batch ${Math.floor(i/BATCH_SIZE) + 1}...`;

                    try {
                        const result = await sendEmailBatch(batch, senderName, subject, body, jobId, opts);
                        if (result.sent) {
                            totalSent += result.sent;
                            document.getElementById('sendProgressCount').textContent = `${totalSent}/${total}`;
                        }
                        if (result.errors) {
                            errors.push(...result.errors);
                        }
                    } catch (err) {
                        errors.push(err.message || "Batch failure");
                    }

                    // Only add small delay between batches if sending many emails (>50)
                    if (total > 50) {
                        await new Promise(r => setTimeout(r, 50));
                    }
                }

                // Complete
                document.getElementById('sendProgressBar').style.width = '100%';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Campaign';
                    btn.disabled = false;
                    progressContainer.classList.add('hidden');
                    document.getElementById('sendProgressBar').style.width = '0%';
                    // Reset stop button state
                    document.getElementById('stopSendingBtn').disabled = false;
                    document.getElementById('stopSendingBtn').innerHTML = '<i class="fa-solid fa-stop"></i> STOP';
                    document.getElementById('sendProgressText').textContent = 'Sending...';

                    if(totalSent > 0 && !emailSendingAborted) {
                        showToast(`Sent ${totalSent} emails!`, "success");
                        closeEmailPanel();
                        deselectAll(); // Clear selection after successful email send
                        fetchData();
                        // Clear form
                        document.getElementById('emailSubject').value = '';
                        document.getElementById('emailBody').innerHTML = '';
                        if(document.getElementById('senderName')) document.getElementById('senderName').value = '';
                        if(document.getElementById('saveAsTemplateCheck')) document.getElementById('saveAsTemplateCheck').checked = false;
                        if(document.getElementById('newTemplateName')) {
                            document.getElementById('newTemplateName').value = '';
                            document.getElementById('newTemplateName').classList.add('hidden');
                        }
                    } else if (totalSent > 0 && emailSendingAborted) {
                        // Partial send - don't close panel, let user see what was sent
                        fetchData();
                    } else {
                        showToast("No emails sent (duplicates?)", "warning");
                    }

                    if (errors.length > 0) {
                        console.error("Email sending errors:", errors);
                    }
                    emailSendingAborted = false; // Reset flag for next send
                }, 500);
            } catch (err) {
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Campaign';
                btn.disabled = false;
                progressContainer.classList.add('hidden');
                document.getElementById('sendProgressBar').style.width = '0%';
                // Reset stop button state on error
                document.getElementById('stopSendingBtn').disabled = false;
                document.getElementById('stopSendingBtn').innerHTML = '<i class="fa-solid fa-stop"></i> STOP';
                document.getElementById('sendProgressText').textContent = 'Sending...';
                emailSendingAborted = false;
                showToast("Error: " + err.message, "error");
            }
        }

        function saveNegotiationSettings() {
            const jobId = document.getElementById('negJobId').value;
            if(!jobId) { showToast("Enter Job ID", "warning"); return; }

            const config = {
                targetRate: document.getElementById('targetRate').value,
                maxRate: document.getElementById('maxRate').value,
                style: document.getElementById('negStyle').value,
                specialRules: document.getElementById('specialRules').value,
                jobDescription: document.getElementById('jobDescription').innerHTML,
                jdLink: document.getElementById('jdLink').value.trim(),
                startDates: getStartDates()
            };

            // Show loading state on button
            const btn = document.getElementById('saveConfigBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>Saving...</span>';

            google.script.run
                .withSuccessHandler(() => {
                    showToast("Configuration saved!", "success");
                    refreshJobDropdown();
                    // Restore button state
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                })
                .withFailureHandler((err) => {
                    showToast("Error saving configuration: " + (err.message || err), "error");
                    // Restore button state
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                })
                .saveNegotiationConfig(jobId, config);
        }

        // Country-to-Region mapping for manual entry validation
        const COUNTRY_TO_REGION_MAP = {
            // India
            'india': 'India', 'in': 'India', 'ind': 'India',
            // US/Canada
            'us': 'US/Canada', 'usa': 'US/Canada', 'united states': 'US/Canada', 'america': 'US/Canada',
            'canada': 'US/Canada', 'ca': 'US/Canada',
            // Europe
            'uk': 'Europe', 'united kingdom': 'Europe', 'england': 'Europe', 'germany': 'Europe',
            'de': 'Europe', 'france': 'Europe', 'fr': 'Europe', 'spain': 'Europe', 'es': 'Europe',
            'italy': 'Europe', 'it': 'Europe', 'netherlands': 'Europe', 'nl': 'Europe',
            'poland': 'Europe', 'pl': 'Europe', 'portugal': 'Europe', 'sweden': 'Europe',
            'norway': 'Europe', 'denmark': 'Europe', 'finland': 'Europe', 'ireland': 'Europe',
            'austria': 'Europe', 'switzerland': 'Europe', 'belgium': 'Europe', 'europe': 'Europe', 'eu': 'Europe',
            // LATAM
            'mexico': 'LATAM', 'mx': 'LATAM', 'brazil': 'LATAM', 'br': 'LATAM',
            'argentina': 'LATAM', 'ar': 'LATAM', 'colombia': 'LATAM', 'co': 'LATAM',
            'chile': 'LATAM', 'cl': 'LATAM', 'peru': 'LATAM', 'pe': 'LATAM',
            'venezuela': 'LATAM', 'ecuador': 'LATAM', 'uruguay': 'LATAM', 'costa rica': 'LATAM',
            'panama': 'LATAM', 'latam': 'LATAM', 'latin america': 'LATAM', 'south america': 'LATAM',
            // APAC
            'china': 'APAC', 'cn': 'APAC', 'japan': 'APAC', 'jp': 'APAC',
            'korea': 'APAC', 'south korea': 'APAC', 'kr': 'APAC', 'australia': 'APAC',
            'au': 'APAC', 'new zealand': 'APAC', 'nz': 'APAC', 'singapore': 'APAC',
            'sg': 'APAC', 'malaysia': 'APAC', 'my': 'APAC', 'indonesia': 'APAC',
            'id': 'APAC', 'philippines': 'APAC', 'ph': 'APAC', 'vietnam': 'APAC',
            'vn': 'APAC', 'thailand': 'APAC', 'th': 'APAC', 'taiwan': 'APAC',
            'tw': 'APAC', 'hong kong': 'APAC', 'hk': 'APAC', 'apac': 'APAC', 'asia': 'APAC', 'asia pacific': 'APAC',
            // Pakistan and nearby
            'pakistan': 'APAC', 'pk': 'APAC', 'bangladesh': 'APAC', 'bd': 'APAC', 'sri lanka': 'APAC', 'lk': 'APAC',
            'nepal': 'APAC', 'np': 'APAC',
            // Middle East
            'uae': 'Middle East', 'dubai': 'Middle East', 'saudi arabia': 'Middle East', 'qatar': 'Middle East',
            'israel': 'Middle East', 'turkey': 'Middle East', 'egypt': 'Middle East', 'middle east': 'Middle East',
            // Africa
            'south africa': 'Africa', 'za': 'Africa', 'nigeria': 'Africa', 'kenya': 'Africa', 'africa': 'Africa'
        };

        const VALID_REGIONS = ['India', 'US/Canada', 'Europe', 'LATAM', 'APAC', 'Middle East', 'Africa', 'Default'];

        function normalizeRegion(input) {
            if (!input) return { region: '', warning: 'No region specified' };
            const normalized = input.toLowerCase().trim();
            // Check direct region match
            if (VALID_REGIONS.map(r => r.toLowerCase()).includes(normalized)) {
                return { region: VALID_REGIONS.find(r => r.toLowerCase() === normalized), warning: null };
            }
            // Check country mapping
            if (COUNTRY_TO_REGION_MAP[normalized]) {
                return { region: COUNTRY_TO_REGION_MAP[normalized], warning: null, mapped: input };
            }
            // Unknown region - keep original but warn
            return { region: input.trim(), warning: `Unknown region "${input}" - will use as-is` };
        }

        function validateEmail(email) {
            if (!email) return { valid: false, error: 'Email is required' };
            const trimmed = email.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(trimmed)) {
                return { valid: false, error: `Invalid email format: "${trimmed}"` };
            }
            return { valid: true, email: trimmed };
        }

        function validateName(name) {
            if (!name || !name.trim()) {
                return { valid: false, warning: 'Name is empty - will use "Unknown"', name: 'Unknown' };
            }
            const trimmed = name.trim();
            if (trimmed.length < 2) {
                return { valid: false, warning: `Name "${trimmed}" is too short`, name: trimmed };
            }
            // Check for obviously invalid names (just numbers, special chars only)
            if (/^[\d\s\W]+$/.test(trimmed)) {
                return { valid: false, warning: `Name "${trimmed}" appears invalid`, name: trimmed };
            }
            return { valid: true, name: trimmed };
        }

        function closeManualEntryModal() {
            document.getElementById('manualInputModal').classList.add('hidden');
            document.getElementById('manualEntryValidation').classList.add('hidden');
            document.getElementById('manualEntryValidation').innerHTML = '';
        }

        function validateManualData() {
            const raw = document.getElementById('manualDataInput').value;
            const validationDiv = document.getElementById('manualEntryValidation');

            if (!raw.trim()) {
                validationDiv.innerHTML = '<span class="text-amber-600"><i class="fa-solid fa-exclamation-triangle mr-1"></i>Please enter some data to validate</span>';
                validationDiv.className = 'mb-3 p-3 rounded-lg text-sm max-h-32 overflow-y-auto bg-amber-50 border border-amber-200';
                validationDiv.classList.remove('hidden');
                return { valid: false, data: [] };
            }

            const lines = raw.split('\n').filter(l => l.trim());
            const errors = [];
            const warnings = [];
            const validData = [];
            const seenEmails = new Set();

            lines.forEach((line, index) => {
                const lineNum = index + 1;
                const parts = line.split(',');
                const rawEmail = parts[0];
                const rawName = parts[1];
                const rawRegion = parts[2];

                // Validate email
                const emailResult = validateEmail(rawEmail);
                if (!emailResult.valid) {
                    errors.push(`Line ${lineNum}: ${emailResult.error}`);
                    return;
                }

                // Check for duplicate emails
                const emailLower = emailResult.email.toLowerCase();
                if (seenEmails.has(emailLower)) {
                    errors.push(`Line ${lineNum}: Duplicate email "${emailResult.email}"`);
                    return;
                }
                seenEmails.add(emailLower);

                // Validate name
                const nameResult = validateName(rawName);
                if (!nameResult.valid && nameResult.warning) {
                    warnings.push(`Line ${lineNum}: ${nameResult.warning}`);
                }

                // Validate region
                const regionResult = normalizeRegion(rawRegion);
                if (regionResult.warning) {
                    warnings.push(`Line ${lineNum}: ${regionResult.warning}`);
                }
                if (regionResult.mapped) {
                    warnings.push(`Line ${lineNum}: "${regionResult.mapped}"  "${regionResult.region}"`);
                }

                validData.push({
                    developer_id: `TEST-${Math.floor(Math.random() * 10000)}`,
                    full_name: nameResult.name,
                    email: emailResult.email,
                    region: regionResult.region,
                    status: 'Manual Test',
                    is_sent: false
                });
            });

            // Display validation results
            let html = '';
            if (errors.length > 0) {
                html += `<div class="text-red-600 mb-2"><i class="fa-solid fa-times-circle mr-1"></i><strong>Errors (${errors.length}):</strong><ul class="ml-4 list-disc">`;
                errors.forEach(e => html += `<li>${e}</li>`);
                html += '</ul></div>';
            }
            if (warnings.length > 0) {
                html += `<div class="text-amber-600 mb-2"><i class="fa-solid fa-exclamation-triangle mr-1"></i><strong>Warnings (${warnings.length}):</strong><ul class="ml-4 list-disc">`;
                warnings.forEach(w => html += `<li>${w}</li>`);
                html += '</ul></div>';
            }
            if (validData.length > 0 && errors.length === 0) {
                html += `<div class="text-green-600"><i class="fa-solid fa-check-circle mr-1"></i><strong>${validData.length} valid record(s) ready to load</strong></div>`;
            } else if (validData.length > 0) {
                html += `<div class="text-blue-600"><i class="fa-solid fa-info-circle mr-1"></i>${validData.length} valid record(s), ${errors.length} skipped due to errors</div>`;
            }

            validationDiv.innerHTML = html;
            validationDiv.className = errors.length > 0
                ? 'mb-3 p-3 rounded-lg text-sm max-h-32 overflow-y-auto bg-red-50 border border-red-200'
                : warnings.length > 0
                    ? 'mb-3 p-3 rounded-lg text-sm max-h-32 overflow-y-auto bg-amber-50 border border-amber-200'
                    : 'mb-3 p-3 rounded-lg text-sm max-h-32 overflow-y-auto bg-green-50 border border-green-200';
            validationDiv.classList.remove('hidden');

            return { valid: errors.length === 0, data: validData, errors, warnings };
        }

        function loadManualData() {
            const result = validateManualData();

            if (result.data.length === 0) {
                showToast("No valid data to load. Please check validation errors.", "error");
                return;
            }

            if (result.errors.length > 0) {
                // Show confirmation if there are errors but some valid data
                if (!confirm(`${result.errors.length} row(s) have errors and will be skipped.\n\nLoad ${result.data.length} valid record(s)?`)) {
                    return;
                }
            }

            tableData = result.data;
            fullTableData = result.data;
            document.getElementById('tableContainer').classList.remove('hidden');
            document.getElementById('statusFilterContainer').classList.remove('hidden');
            document.getElementById('tableControls').classList.remove('hidden');
            renderTable(tableData);
            closeManualEntryModal();

            let message = `Loaded ${result.data.length} test candidate(s)`;
            if (result.warnings.length > 0) {
                message += ` (${result.warnings.length} warning(s))`;
            }
            showToast(message, result.warnings.length > 0 ? "warning" : "success");
        }

        // Functions for button calls
        function selectJobFromDropdown(v) { 
            if(!v) return;
            document.getElementById('negJobId').value = v; 
            loadNegotiationConfig(); 
        }
        function refreshJobDropdown() { 
            google.script.run.withSuccessHandler(jobs => {
                const s = document.getElementById('activeJobsDropdown');
                s.innerHTML = '<option value="">-- Select --</option>';
                jobs.forEach(j => s.innerHTML += `<option value="${j}">Job ${j}</option>`);
            }).getJobConfigList();
        }

        // Rate Tier Functions

        // Auto-fill region dropdown when country is entered
        function autoFillRegionFromCountry() {
            const countryInput = document.getElementById('tierCountry');
            const regionSelect = document.getElementById('tierRegion');
            const country = countryInput.value.trim().toLowerCase();

            if (!country) {
                return; // Don't auto-fill if country is empty
            }

            // Use the same mapping as backend
            const region = COUNTRY_TO_REGION_MAP[country];
            if (region) {
                // Find and select the matching option
                for (let option of regionSelect.options) {
                    if (option.value === region) {
                        regionSelect.value = region;
                        break;
                    }
                }
            }
        }

        function refreshRateTiers(onComplete = null) {
            const jobId = document.getElementById('negJobId').value;
            const tbody = document.getElementById('rateTiersBody');
            if(!jobId) {
                if (onComplete) onComplete([]);
                return;
            }

            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Loading...</td></tr>';

            google.script.run.withSuccessHandler(tiers => {
                if(!tiers || tiers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">No tiers loaded.</td></tr>';
                    if (onComplete) onComplete([]);
                    return;
                }
                tbody.innerHTML = '';
                tiers.forEach(tier => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 border-b border-slate-50';
                    const countryDisplay = tier.country
                        ? `<span class="font-medium text-blue-600">${tier.country}</span>`
                        : '<span class="text-slate-300">-</span>';
                    const tierKey = `${tier.country || ''}::${tier.region}`;
                    row.innerHTML = `
                        <td class="px-4 py-2">${countryDisplay}</td>
                        <td class="px-4 py-2">${tier.region}</td>
                        <td class="px-4 py-2 text-green-600">$${tier.targetRate}</td>
                        <td class="px-4 py-2 text-amber-600">$${tier.maxRate}</td>
                        <td class="px-4 py-2 text-slate-500 text-xs">${tier.notes || '-'}</td>
                        <td class="px-4 py-2 text-right">
                            <button onclick="deleteRateTier('${tier.country || ''}', '${tier.region}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                if (onComplete) onComplete(tiers);
            }).getRateTiersForJob(jobId);
        }

        // Refresh Rate Tiers with animation and success message
        function refreshRateTiersWithAnimation() {
            const btn = document.getElementById('rateTiersRefreshBtn');
            const jobId = document.getElementById('negJobId').value;

            if (!btn || btn.classList.contains('loading')) return;
            if (!jobId) {
                showToast('Please select a job first', 'warning');
                return;
            }

            btn.classList.add('loading');

            refreshRateTiers((tiers) => {
                btn.classList.remove('loading');
                btn.classList.add('success');
                const tierCount = tiers ? tiers.length : 0;
                showToast(`Rate tiers refreshed (${tierCount} tiers)`, 'success');

                // Reset button state after animation
                setTimeout(() => {
                    btn.classList.remove('success');
                }, 1500);
            });
        }

        function addRateTier() {
            const jobId = document.getElementById('negJobId').value;
            const countryInput = document.getElementById('tierCountry');
            const regionInput = document.getElementById('tierRegion');
            const targetInput = document.getElementById('tierTargetRate');
            const maxInput = document.getElementById('tierMaxRate');
            const notesInput = document.getElementById('tierNotes');
            const btn = document.getElementById('addRateTierBtn');

            const country = countryInput.value.trim();
            const region = regionInput.value;
            const target = targetInput.value;
            const max = maxInput.value;
            const notes = notesInput.value;

            if(!jobId || !region || !target || !max) { showToast("Fill Job ID, Region, Target and Max fields", "warning"); return; }

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            google.script.run
                .withSuccessHandler(() => {
                    const msg = country ? `Rate tier added for ${country} (${region})` : `Rate tier added for ${region}`;
                    showToast(msg, "success");
                    // Clear the form
                    countryInput.value = '';
                    regionInput.value = '';
                    targetInput.value = '';
                    maxInput.value = '';
                    notesInput.value = '';
                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-plus"></i>';
                    refreshRateTiers();
                })
                .withFailureHandler((error) => {
                    showToast("Failed to add rate tier", "error");
                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-plus"></i>';
                })
                .saveRateTier(jobId, country, region, target, max, notes);
        }

        function deleteRateTier(country, region) {
            const jobId = document.getElementById('negJobId').value;
            const tierDesc = country ? `${country} (${region})` : region;
            if(!confirm(`Delete rate tier for ${tierDesc}?`)) return;
            google.script.run.withSuccessHandler(() => {
                showToast("Deleted", "success");
                refreshRateTiers();
            }).deleteRateTier(jobId, country, region);
        }

        function manualTriggerFollowUps() {
            const btn = document.getElementById('runFollowUpBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;
            
            const progressPanel = document.getElementById('followUpProgressPanel');
            const logContainer = document.getElementById('followUpLogContainer');
            progressPanel.classList.remove('hidden');
            logContainer.innerHTML = '';
            
            google.script.run.withSuccessHandler(res => {
                btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-1"></i> Process Queue';
                btn.disabled = false;
                
                let msg = `Done! 1st: ${res.followUp1Sent}, 2nd: ${res.followUp2Sent}`;
                document.getElementById('followUpProgressStatus').textContent = msg;
                showToast(msg, "success");
                
                if(res.log) res.log.forEach(l => {
                    const entry = document.createElement('div');
                    entry.className = "mb-1";
                    entry.textContent = l.message;
                    logContainer.appendChild(entry);
                });
                
                loadFollowUpStats();
            }).runFollowUpProcessor();
        }

        function resetFollowUpStatuses() {
            if(!confirm("Reset statuses? This is usually for debugging.")) return;
            const btn = document.getElementById('resetStatusBtn');
            btn.disabled = true;
            google.script.run.withSuccessHandler(res => {
                btn.disabled = false;
                showToast(`Reset ${res.reset} entries`, "success");
                loadFollowUpStats();
            }).resetFollowUpStatus();
        }

        function refreshTemplates() {
            const jobId = document.getElementById('jobId').value || '';
            const select = document.getElementById('templateSelect');
            // Show loading state
            select.innerHTML = '<option value="">Loading templates...</option>';
            google.script.run.withSuccessHandler(templates => {
                cachedTemplates = templates;
                select.innerHTML = '<option value="">-- Select a saved template --</option>';
                templates.forEach((t, i) => {
                    select.innerHTML += `<option value="${i}">${t.name}</option>`;
                });
                if(templates.length === 0) {
                    select.innerHTML = '<option value="">No templates saved yet</option>';
                }
            }).getJobTemplates(jobId);
        }

        function loadSelectedTemplate() {
            const idx = document.getElementById('templateSelect').value;
            if(idx === '') return;
            const t = cachedTemplates[idx];
            document.getElementById('emailSubject').value = t.subject;
            // Use innerHTML for rich text editor (contenteditable div)
            const emailBody = document.getElementById('emailBody');
            emailBody.innerHTML = t.body;
            handleEditorInput(); // Update hidden field
        }

        function toggleTemplateNameInput() {
            const isChecked = document.getElementById('saveAsTemplateCheck').checked;
            const input = document.getElementById('newTemplateName');
            if (isChecked) {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
                input.value = '';
            }
        }

        function saveCurrentAsTemplate() {
            const name = prompt("Template Name:");
            if(!name) return;
            const subject = document.getElementById('emailSubject').value;
            // Get HTML content from rich text editor
            const emailBody = document.getElementById('emailBody');
            const body = emailBody.innerHTML || emailBody.innerText || '';
            const jobId = document.getElementById('jobId').value || '';

            google.script.run.withSuccessHandler(() => {
                showToast("Template Saved", "success");
                refreshTemplates();
            }).saveEmailTemplate(name, subject, body, jobId);
        }

        function markSelectedAsManualSent() {
            if(selectedDevs.size === 0) return;
            const jobId = document.getElementById('jobId').value;
            if(!jobId) { showToast("Enter Job ID", "warning"); return; }
            
            const ids = Array.from(selectedDevs);
            google.script.run.withSuccessHandler(res => {
                showToast(`Marked ${res.marked} as sent`, "success");
                fetchData();
            }).markAsManualSent(ids, jobId, "Bulk Manual Mark");
        }

        // --- Negotiation Completion Logic ---
        let pendingCompletion = null;

        function markAsDone(email, jobId, status, btn) {
            // Check for human negotiation
            if(status && (status.includes('Human') || status.includes('Escalated'))) {
                pendingCompletion = { email, jobId, btn };
                document.getElementById('completeHumanEmail').textContent = email;
                document.getElementById('completeHumanModal').classList.remove('hidden');
            } else {
                // Direct completion
                if(!confirm("Mark this negotiation as completed?")) return;
                const row = btn.closest('tr');
                row.style.opacity = '0.5';
                google.script.run.withSuccessHandler(() => {
                    loadTasks();
                    showToast("Completed", "success");
                }).moveToCompleted(email, "Manually Completed");
            }
        }

        function closeCompleteHumanModal() {
            document.getElementById('completeHumanModal').classList.add('hidden');
            pendingCompletion = null;
        }

        function toggleRateInput() {
            const chk = document.getElementById('noRateAgreed');
            document.getElementById('agreedRateInput').disabled = chk.checked;
        }

        function submitCompleteHuman() {
            if(!pendingCompletion) return;
            const { email, jobId } = pendingCompletion;
            const noRate = document.getElementById('noRateAgreed').checked;
            const rate = document.getElementById('agreedRateInput').value;
            const status = document.getElementById('completionStatus').value;
            
            let finalStatus = status || (rate ? 'Offer Accepted (Human)' : 'Completed (Human)');
            let finalRate = noRate ? null : rate;

            google.script.run.withSuccessHandler(() => {
                closeCompleteHumanModal();
                loadTasks();
                showToast("Completed", "success");
            }).completeHumanNegotiation(email, jobId, finalRate, finalStatus);
        }

        function markAsUnresponsive(email, btn) {
            if(!confirm("Mark as unresponsive? Stops follow-ups.")) return;
            const row = btn.closest('tr');
            row.style.opacity = '0.5';
            google.script.run.withSuccessHandler(() => {
                loadFollowUpStats();
                showToast("Updated", "success");
            }).markFollowUpAsUnresponsive(email);
        }

        function bulkCompleteSelected() {
            if(selectedTasks.size === 0) return;
            if(!confirm(`Complete ${selectedTasks.size} tasks?`)) return;
            
            google.script.run.withSuccessHandler(res => {
                showToast(`Completed ${res.success} tasks`, "success");
                loadTasks();
            }).bulkComplete(Array.from(selectedTasks), "Bulk Complete");
        }

        // --- Analytics ---
        let currentAnalyticsFilter = ''; // Track current email filter
        let currentAnalyticsJobFilter = ''; // Track current job ID filter
        let currentAnalyticsStartDate = ''; // Track current start date filter
        let currentAnalyticsEndDate = ''; // Track current end date filter
        let currentAnalyticsDatePreset = 'all'; // Track which preset is active

        // Client-side cache for instant search (no backend round-trips)
        let analyticsSearchCache = {
            emails: [],
            jobIds: [],
            loaded: false,
            loading: false
        };

        // RBAC: Track user permissions
        let userPermissions = {
            isAdmin: false,              // Can manage users
            canViewAllAnalytics: false,  // Can see all analytics data
            hasOperationalAccess: true,  // Can use operational tabs
            accessLevel: 'other',        // Role: admin, tl, tm, ta, manager, other
            userEmail: '',
            pageAccess: {                // Dynamic page access per role
                outreach: true, negotiation: true, tasks: true, followups: true,
                analytics: true, learning: true, aitesting: false, processmap: false
            }
        };

        // For backward compatibility
        let isAnalyticsAdmin = false;

        // ===== FAST ACCESS LOADING =====
        // Cache key for localStorage
        const ACCESS_CACHE_KEY = 'hr_ops_access_cache';
        const ACCESS_CACHE_EXPIRY = 30 * 60 * 1000; // 30 minutes

        // Load cached access immediately on page init (before DOMContentLoaded)
        function loadCachedAccess() {
            try {
                const cached = localStorage.getItem(ACCESS_CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Check if cache is still valid (not expired)
                    if (data.timestamp && (Date.now() - data.timestamp) < ACCESS_CACHE_EXPIRY) {
                        // Apply cached permissions immediately
                        userPermissions.isAdmin = data.isAdmin || false;
                        userPermissions.canViewAllAnalytics = data.canViewAllAnalytics || false;
                        userPermissions.hasOperationalAccess = data.hasOperationalAccess !== false;
                        userPermissions.accessLevel = data.accessLevel || 'other';
                        userPermissions.userEmail = data.userEmail || '';
                        userPermissions.pageAccess = data.pageAccess || userPermissions.pageAccess;
                        isAnalyticsAdmin = userPermissions.isAdmin;
                        console.log('[Access] Loaded from cache in <1ms');
                        return true;
                    }
                }
            } catch (e) {
                console.log('[Access] Cache read failed:', e);
            }
            return false;
        }

        // Save access to localStorage
        function saveAccessToCache(data) {
            try {
                const cacheData = {
                    isAdmin: data.isAdmin || false,
                    canViewAllAnalytics: data.canViewAllAnalytics || false,
                    hasOperationalAccess: data.hasOperationalAccess !== false,
                    accessLevel: data.accessLevel || 'other',
                    userEmail: data.userEmail || '',
                    pageAccess: data.pageAccess || userPermissions.pageAccess,
                    timestamp: Date.now()
                };
                localStorage.setItem(ACCESS_CACHE_KEY, JSON.stringify(cacheData));
            } catch (e) {
                console.log('[Access] Cache write failed:', e);
            }
        }

        // Load access from server (runs in background)
        function loadAccessFromServer() {
            google.script.run
                .withSuccessHandler(cache => {
                    // Store RBAC permissions
                    userPermissions.isAdmin = cache.isAdmin || false;
                    userPermissions.canViewAllAnalytics = cache.canViewAllAnalytics || false;
                    userPermissions.hasOperationalAccess = cache.hasOperationalAccess !== false;
                    userPermissions.accessLevel = cache.accessLevel || 'other';
                    userPermissions.userEmail = cache.userEmail || '';
                    userPermissions.pageAccess = cache.pageAccess || userPermissions.pageAccess;
                    isAnalyticsAdmin = userPermissions.isAdmin;

                    // Save to localStorage for next load
                    saveAccessToCache(cache);

                    // Update UI with fresh data
                    updateAnalyticsAdminUI();
                    updateRoleBasedUI();

                    // Load new users for admin
                    if (userPermissions.isAdmin) {
                        loadNewUsers();
                    }
                    console.log('[Access] Refreshed from server');
                })
                .withFailureHandler(err => {
                    console.log('[Access] Server fetch failed:', err);
                })
                .getAnalyticsSearchCache();
        }

        // Initialize access on page load - FAST!
        (function initFastAccess() {
            const hasCached = loadCachedAccess();
            // Always fetch fresh data in background
            // Use setTimeout to not block initial render
            setTimeout(() => {
                loadAccessFromServer();
            }, hasCached ? 500 : 0); // If cached, delay server fetch; if not, fetch immediately
        })();

        // Load search cache for instant filtering
        function loadAnalyticsSearchCache() {
            if (analyticsSearchCache.loaded || analyticsSearchCache.loading) return;
            analyticsSearchCache.loading = true;

            google.script.run
                .withSuccessHandler(cache => {
                    analyticsSearchCache.emails = cache.emails || [];
                    analyticsSearchCache.jobIds = cache.jobIds || [];
                    analyticsSearchCache.loaded = true;
                    analyticsSearchCache.loading = false;

                    // Store RBAC permissions
                    userPermissions.isAdmin = cache.isAdmin || false;
                    userPermissions.canViewAllAnalytics = cache.canViewAllAnalytics || false;
                    userPermissions.hasOperationalAccess = cache.hasOperationalAccess !== false; // default true
                    userPermissions.accessLevel = cache.accessLevel || 'other';
                    userPermissions.userEmail = cache.userEmail || '';
                    userPermissions.pageAccess = cache.pageAccess || userPermissions.pageAccess;

                    // For backward compatibility
                    isAnalyticsAdmin = userPermissions.isAdmin;

                    // Save to localStorage for fast loading next time
                    saveAccessToCache(cache);

                    updateAnalyticsAdminUI();
                    updateRoleBasedUI();

                    // Load new users for admin
                    if (userPermissions.isAdmin) {
                        loadNewUsers();
                    }
                })
                .withFailureHandler(() => {
                    analyticsSearchCache.loading = false;
                })
                .getAnalyticsSearchCache();
        }

        // Update UI based on RBAC permissions
        function updateAnalyticsAdminUI() {
            const manageViewersBtn = document.getElementById('manageViewersBtn');
            const userFilterContainer = document.getElementById('analyticsUserFilterContainer');
            const viewOnlyBadge = document.getElementById('analyticsViewOnlyBadge');
            // AI TESTING FEATURE - DELETE FOR PRODUCTION (START)
            const aiTestingNavTab = document.getElementById('aiTestingNavTab');
            // AI TESTING FEATURE - DELETE FOR PRODUCTION (END)

            // Show Manage Viewers only for admins (canManageUsers)
            if (userPermissions.isAdmin) {
                if (manageViewersBtn) manageViewersBtn.classList.remove('hidden');
            } else {
                if (manageViewersBtn) manageViewersBtn.classList.add('hidden');
            }

            // Show user filter for users who can view all analytics (admin, tl, tm, ta, manager)
            if (userPermissions.canViewAllAnalytics) {
                if (userFilterContainer) userFilterContainer.classList.remove('hidden');
                if (viewOnlyBadge) viewOnlyBadge.classList.add('hidden');
            } else {
                // 'other' role: hide filter, show "viewing your data" badge
                if (userFilterContainer) userFilterContainer.classList.add('hidden');
                if (viewOnlyBadge) viewOnlyBadge.classList.remove('hidden');
            }

            // AI TESTING FEATURE - DELETE FOR PRODUCTION (START)
            // Only admins can access AI Testing
            if (userPermissions.isAdmin) {
                if (aiTestingNavTab) aiTestingNavTab.classList.remove('hidden');
            } else {
                if (aiTestingNavTab) aiTestingNavTab.classList.add('hidden');
            }
            // AI TESTING FEATURE - DELETE FOR PRODUCTION (END)

            // Process Map - Admin Only
            const processMapNavTab = document.getElementById('processMapNavTab');
            if (userPermissions.isAdmin) {
                if (processMapNavTab) processMapNavTab.classList.remove('hidden');
            } else {
                if (processMapNavTab) processMapNavTab.classList.add('hidden');
            }
        }

        // Update UI based on role (show/hide tabs using dynamic page access)
        function updateRoleBasedUI() {
            const newUsersBtn = document.getElementById('newUsersBtn');
            const userRoleBadge = document.getElementById('userRoleBadge');
            const pageAccess = userPermissions.pageAccess || {};

            // Map nav tab IDs to page access keys
            const tabPageMap = {
                'navTabOutreach': 'outreach',
                'navTabNegotiation': 'negotiation',
                'navTabTasks': 'tasks',
                'navTabFollowups': 'followups',
                'navTabAnalytics': 'analytics',
                'navTabLearning': 'learning',
                'aiTestingNavTab': 'aitesting',
                'processMapNavTab': 'processmap',
                'navTabConfig': 'outreach' // Config follows outreach access (operational)
            };

            // Show/hide each tab based on pageAccess
            Object.entries(tabPageMap).forEach(([tabId, pageKey]) => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    // Admin always has access to everything
                    if (userPermissions.isAdmin) {
                        tab.classList.remove('hidden');
                    } else if (pageAccess[pageKey] !== false) {
                        tab.classList.remove('hidden');
                    } else {
                        tab.classList.add('hidden');
                    }
                }
            });

            // Show new users button for admins
            if (newUsersBtn) {
                if (userPermissions.isAdmin) {
                    newUsersBtn.classList.remove('hidden');
                } else {
                    newUsersBtn.classList.add('hidden');
                }
            }

            // Update role badge in sidebar
            if (userRoleBadge) {
                const roleLabels = {
                    'admin': 'Admin',
                    'tl': 'Team Lead',
                    'tm': 'Tech Manager',
                    'ta': 'Tech Analyst',
                    'manager': 'Manager',
                    'other': 'User'
                };
                userRoleBadge.textContent = roleLabels[userPermissions.accessLevel] || 'User';
            }

            // If user has no access to the current visible tab, switch to first available
            const currentActiveTab = document.querySelector('.nav-tab.active');
            if (currentActiveTab && currentActiveTab.classList.contains('hidden')) {
                // Find first visible tab
                const firstVisibleTab = document.querySelector('.nav-tab:not(.hidden)');
                if (firstVisibleTab) {
                    const tabName = firstVisibleTab.getAttribute('onclick')?.match(/switchTab\('([^']+)'/)?.[1];
                    if (tabName) {
                        switchTab(tabName, firstVisibleTab);
                    }
                }
            }

            // Fallback: If no operational access at all, try analytics
            const hasAnyOperationalAccess = pageAccess.outreach || pageAccess.negotiation || pageAccess.tasks || pageAccess.followups;
            if (!hasAnyOperationalAccess && !userPermissions.isAdmin) {
                const analyticsTab = document.getElementById('navTabAnalytics');
                if (analyticsTab && pageAccess.analytics !== false) {
                    switchTab('analytics', analyticsTab);
                }
            }
        }

        // Force refresh the search cache
        function refreshAnalyticsSearchCache() {
            analyticsSearchCache.loaded = false;
            analyticsSearchCache.loading = false;
            loadAnalyticsSearchCache();
        }

        // Client-side email search (instant)
        function filterCachedEmails(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return analyticsSearchCache.emails
                .filter(email => email.includes(lowerQuery))
                .slice(0, 10);
        }

        // Client-side job ID search (instant)
        function filterCachedJobIds(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return analyticsSearchCache.jobIds
                .filter(jobId => jobId.toLowerCase().includes(lowerQuery))
                .slice(0, 10);
        }

        // --- Email Filter Functions ---
        function handleAnalyticsFilterKeyup(event) {
            const input = document.getElementById('analyticsUserFilter');
            const clearBtn = document.getElementById('clearAnalyticsFilter');
            clearBtn.classList.toggle('hidden', !input.value);
            if(event.key === 'Enter') {
                hideAnalyticsEmailDropdown();
                applyAnalyticsFilter();
            }
            if(event.key === 'Escape') {
                hideAnalyticsEmailDropdown();
            }
        }

        // Debounce timer for email search
        let analyticsEmailSearchTimer = null;

        function handleAnalyticsEmailInput(event) {
            const query = event.target.value.trim();

            // Clear previous timer
            if (analyticsEmailSearchTimer) {
                clearTimeout(analyticsEmailSearchTimer);
            }

            // Hide dropdown if query is empty
            if (!query) {
                hideAnalyticsEmailDropdown();
                return;
            }

            // Fast debounce (50ms) - just enough to batch rapid keystrokes
            analyticsEmailSearchTimer = setTimeout(() => {
                searchAnalyticsEmails(query);
            }, 50);
        }

        function handleAnalyticsEmailFocus() {
            // Ensure cache is loaded
            loadAnalyticsSearchCache();
            const query = document.getElementById('analyticsUserFilter').value.trim();
            if (query) {
                searchAnalyticsEmails(query);
            }
        }

        function searchAnalyticsEmails(query) {
            // Use client-side cache for instant results
            if (analyticsSearchCache.loaded) {
                const emails = filterCachedEmails(query);
                renderAnalyticsEmailDropdown(emails, query);
            } else {
                // Fallback to backend if cache not loaded yet
                google.script.run
                    .withSuccessHandler(emails => {
                        renderAnalyticsEmailDropdown(emails, query);
                    })
                    .withFailureHandler(() => {
                        hideAnalyticsEmailDropdown();
                    })
                    .searchAnalyticsUsers(query);
            }
        }

        function renderAnalyticsEmailDropdown(emails, query) {
            const dropdown = document.getElementById('analyticsEmailDropdown');

            if (!emails || emails.length === 0) {
                dropdown.innerHTML = `
                    <div class="px-4 py-3 text-sm text-slate-500 text-center">
                        <i class="fa-solid fa-search mr-2"></i>No users found matching "${query}"
                    </div>
                `;
                dropdown.classList.remove('hidden');
                return;
            }

            dropdown.innerHTML = emails.map(email => `
                <div class="px-4 py-2 hover:bg-indigo-50 cursor-pointer flex items-center gap-2 text-sm border-b border-slate-100 last:border-b-0"
                     onclick="selectAnalyticsEmail('${email}')">
                    <i class="fa-solid fa-user text-indigo-400"></i>
                    <span class="text-slate-700">${highlightMatch(email, query)}</span>
                </div>
            `).join('');

            dropdown.classList.remove('hidden');
        }

        function highlightMatch(text, query) {
            const lowerText = text.toLowerCase();
            const lowerQuery = query.toLowerCase();
            const index = lowerText.indexOf(lowerQuery);

            if (index === -1) return text;

            const before = text.substring(0, index);
            const match = text.substring(index, index + query.length);
            const after = text.substring(index + query.length);

            return `${before}<span class="bg-yellow-200 font-semibold">${match}</span>${after}`;
        }

        function selectAnalyticsEmail(email) {
            document.getElementById('analyticsUserFilter').value = email;
            document.getElementById('clearAnalyticsFilter').classList.remove('hidden');
            hideAnalyticsEmailDropdown();
            applyAnalyticsFilter();
        }

        function hideAnalyticsEmailDropdown() {
            document.getElementById('analyticsEmailDropdown').classList.add('hidden');
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const emailInput = document.getElementById('analyticsUserFilter');
            const emailDropdown = document.getElementById('analyticsEmailDropdown');
            const jobInput = document.getElementById('analyticsJobFilter');
            const jobDropdown = document.getElementById('analyticsJobDropdown');

            if (emailInput && emailDropdown && !emailInput.contains(event.target) && !emailDropdown.contains(event.target)) {
                hideAnalyticsEmailDropdown();
            }
            if (jobInput && jobDropdown && !jobInput.contains(event.target) && !jobDropdown.contains(event.target)) {
                hideAnalyticsJobDropdown();
            }
        });

        function clearAnalyticsEmailFilter() {
            document.getElementById('analyticsUserFilter').value = '';
            document.getElementById('clearAnalyticsFilter').classList.add('hidden');
            currentAnalyticsFilter = '';
            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        // --- Job ID Filter Functions ---
        let analyticsJobSearchTimer = null;

        function handleAnalyticsJobFilterKeyup(event) {
            const input = document.getElementById('analyticsJobFilter');
            const clearBtn = document.getElementById('clearAnalyticsJobFilter');
            clearBtn.classList.toggle('hidden', !input.value);
            if(event.key === 'Enter') {
                hideAnalyticsJobDropdown();
                applyAnalyticsFilter();
            }
            if(event.key === 'Escape') {
                hideAnalyticsJobDropdown();
            }
        }

        function handleAnalyticsJobInput(event) {
            const query = event.target.value.trim();

            // Clear previous timer
            if (analyticsJobSearchTimer) {
                clearTimeout(analyticsJobSearchTimer);
            }

            // Hide dropdown if query is empty
            if (!query) {
                hideAnalyticsJobDropdown();
                return;
            }

            // Fast debounce (50ms) - just enough to batch rapid keystrokes
            analyticsJobSearchTimer = setTimeout(() => {
                searchAnalyticsJobs(query);
            }, 50);
        }

        function handleAnalyticsJobFocus() {
            // Ensure cache is loaded
            loadAnalyticsSearchCache();
            const query = document.getElementById('analyticsJobFilter').value.trim();
            if (query) {
                searchAnalyticsJobs(query);
            }
        }

        function searchAnalyticsJobs(query) {
            // Use client-side cache for instant results
            if (analyticsSearchCache.loaded) {
                const jobs = filterCachedJobIds(query);
                renderAnalyticsJobDropdown(jobs, query);
            } else {
                // Fallback to backend if cache not loaded yet
                google.script.run
                    .withSuccessHandler(jobs => {
                        renderAnalyticsJobDropdown(jobs, query);
                    })
                    .withFailureHandler(() => {
                        hideAnalyticsJobDropdown();
                    })
                    .searchAnalyticsJobIds(query);
            }
        }

        function renderAnalyticsJobDropdown(jobs, query) {
            const dropdown = document.getElementById('analyticsJobDropdown');

            if (!jobs || jobs.length === 0) {
                dropdown.innerHTML = `
                    <div class="px-4 py-3 text-sm text-slate-500 text-center">
                        <i class="fa-solid fa-search mr-2"></i>No jobs found matching "${query}"
                    </div>
                `;
                dropdown.classList.remove('hidden');
                return;
            }

            dropdown.innerHTML = jobs.map(job => `
                <div class="px-4 py-2 hover:bg-amber-50 cursor-pointer flex items-center gap-2 text-sm border-b border-slate-100 last:border-b-0"
                     onclick="selectAnalyticsJob('${job}')">
                    <i class="fa-solid fa-briefcase text-amber-400"></i>
                    <span class="text-slate-700">Job ${highlightMatch(job, query)}</span>
                </div>
            `).join('');

            dropdown.classList.remove('hidden');
        }

        function selectAnalyticsJob(jobId) {
            document.getElementById('analyticsJobFilter').value = jobId;
            document.getElementById('clearAnalyticsJobFilter').classList.remove('hidden');
            hideAnalyticsJobDropdown();
            applyAnalyticsFilter();
        }

        function hideAnalyticsJobDropdown() {
            document.getElementById('analyticsJobDropdown').classList.add('hidden');
        }

        function clearAnalyticsJobFilter() {
            document.getElementById('analyticsJobFilter').value = '';
            document.getElementById('clearAnalyticsJobFilter').classList.add('hidden');
            currentAnalyticsJobFilter = '';
            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function clearAllAnalyticsFilters() {
            document.getElementById('analyticsUserFilter').value = '';
            document.getElementById('clearAnalyticsFilter').classList.add('hidden');
            document.getElementById('analyticsJobFilter').value = '';
            document.getElementById('clearAnalyticsJobFilter').classList.add('hidden');
            currentAnalyticsFilter = '';
            currentAnalyticsJobFilter = '';
            // Also clear date range
            clearAnalyticsDateRange();
        }

        // --- Date Range Functions ---
        function setAnalyticsDatePreset(preset) {
            const today = new Date();
            let startDate = '';
            let endDate = '';

            switch(preset) {
                case 'today':
                    startDate = formatDateForInput(today);
                    endDate = formatDateForInput(today);
                    break;
                case '7days':
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 6);
                    startDate = formatDateForInput(sevenDaysAgo);
                    endDate = formatDateForInput(today);
                    break;
                case '30days':
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 29);
                    startDate = formatDateForInput(thirtyDaysAgo);
                    endDate = formatDateForInput(today);
                    break;
                case 'all':
                default:
                    startDate = '';
                    endDate = '';
                    break;
            }

            // Update the date inputs
            document.getElementById('analyticsStartDate').value = startDate;
            document.getElementById('analyticsEndDate').value = endDate;

            // Update state
            currentAnalyticsStartDate = startDate;
            currentAnalyticsEndDate = endDate;
            currentAnalyticsDatePreset = preset;

            // Update preset button styles
            updateDatePresetStyles(preset);

            // Update filter status and reload
            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function updateDatePresetStyles(activePreset) {
            const presetButtons = document.querySelectorAll('.analytics-date-preset');
            presetButtons.forEach(btn => {
                const preset = btn.getAttribute('data-preset');
                if (preset === activePreset) {
                    btn.classList.add('bg-teal-50', 'border-teal-300', 'text-teal-700');
                    btn.classList.remove('border-slate-200');
                } else {
                    btn.classList.remove('bg-teal-50', 'border-teal-300', 'text-teal-700');
                    btn.classList.add('border-slate-200');
                }
            });
        }

        function handleAnalyticsDateChange() {
            // When user manually changes dates, clear the preset selection
            currentAnalyticsDatePreset = 'custom';
            updateDatePresetStyles('custom');
        }

        function applyAnalyticsDateRange() {
            const startDate = document.getElementById('analyticsStartDate').value;
            const endDate = document.getElementById('analyticsEndDate').value;

            currentAnalyticsStartDate = startDate;
            currentAnalyticsEndDate = endDate;

            if (startDate || endDate) {
                currentAnalyticsDatePreset = 'custom';
                updateDatePresetStyles('custom');
            }

            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function clearAnalyticsDateRange() {
            document.getElementById('analyticsStartDate').value = '';
            document.getElementById('analyticsEndDate').value = '';
            currentAnalyticsStartDate = '';
            currentAnalyticsEndDate = '';
            currentAnalyticsDatePreset = 'all';
            updateDatePresetStyles('all');
            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function updateAnalyticsFilterStatus() {
            const statusDiv = document.getElementById('analyticsFilterStatus');
            const emailBadge = document.getElementById('analyticsFilterEmailBadge');
            const jobBadge = document.getElementById('analyticsFilterJobBadge');
            const dateBadge = document.getElementById('analyticsFilterDateBadge');

            const hasEmailFilter = currentAnalyticsFilter !== '';
            const hasJobFilter = currentAnalyticsJobFilter !== '';
            const hasDateFilter = currentAnalyticsStartDate !== '' || currentAnalyticsEndDate !== '';

            if (hasEmailFilter || hasJobFilter || hasDateFilter) {
                statusDiv.classList.remove('hidden');

                if (hasEmailFilter) {
                    emailBadge.classList.remove('hidden');
                    document.getElementById('analyticsFilterEmailText').textContent = currentAnalyticsFilter;
                } else {
                    emailBadge.classList.add('hidden');
                }

                if (hasJobFilter) {
                    jobBadge.classList.remove('hidden');
                    document.getElementById('analyticsFilterJobText').textContent = currentAnalyticsJobFilter;
                } else {
                    jobBadge.classList.add('hidden');
                }

                if (hasDateFilter) {
                    dateBadge.classList.remove('hidden');
                    let dateText = '';
                    if (currentAnalyticsStartDate && currentAnalyticsEndDate) {
                        if (currentAnalyticsStartDate === currentAnalyticsEndDate) {
                            dateText = formatDateForDisplay(currentAnalyticsStartDate);
                        } else {
                            dateText = `${formatDateForDisplay(currentAnalyticsStartDate)} - ${formatDateForDisplay(currentAnalyticsEndDate)}`;
                        }
                    } else if (currentAnalyticsStartDate) {
                        dateText = `From ${formatDateForDisplay(currentAnalyticsStartDate)}`;
                    } else if (currentAnalyticsEndDate) {
                        dateText = `Until ${formatDateForDisplay(currentAnalyticsEndDate)}`;
                    }
                    document.getElementById('analyticsFilterDateText').textContent = dateText;
                } else {
                    dateBadge.classList.add('hidden');
                }
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        function applyAnalyticsFilter() {
            const email = document.getElementById('analyticsUserFilter').value.trim().toLowerCase();
            const jobId = document.getElementById('analyticsJobFilter').value.trim();
            currentAnalyticsFilter = email;
            currentAnalyticsJobFilter = jobId;

            updateAnalyticsFilterStatus();
            loadAnalytics();
        }

        function loadAnalytics(onComplete = null) {
            const filterEmail = currentAnalyticsFilter || '';
            const filterJobId = currentAnalyticsJobFilter || '';
            const startDate = currentAnalyticsStartDate || '';
            const endDate = currentAnalyticsEndDate || '';
            const hasFilters = filterEmail || filterJobId || startDate || endDate;

            // Refresh search cache when loading all data (no filters)
            if (!hasFilters) {
                refreshAnalyticsSearchCache();
            }

            // Add loading animation to refresh button
            const refreshBtn = document.querySelector('#analyticsTab .fa-rotate');
            if (refreshBtn) refreshBtn.classList.add('fa-spin');

            google.script.run.withSuccessHandler(data => {
                // Remove loading animation
                if (refreshBtn) refreshBtn.classList.remove('fa-spin');

                if(data.error) { console.error('Analytics error:', data.error); return; }

                // Update RBAC permissions from returned data
                if (data.isAdmin !== undefined) {
                    userPermissions.isAdmin = data.isAdmin;
                    isAnalyticsAdmin = data.isAdmin; // backward compat
                }
                if (data.canViewAllAnalytics !== undefined) {
                    userPermissions.canViewAllAnalytics = data.canViewAllAnalytics;
                }
                if (data.hasOperationalAccess !== undefined) {
                    userPermissions.hasOperationalAccess = data.hasOperationalAccess;
                }
                if (data.accessLevel !== undefined) {
                    userPermissions.accessLevel = data.accessLevel;
                }
                updateAnalyticsAdminUI();
                updateRoleBasedUI();

                document.getElementById('statTotalUsers').textContent = data.totalUsers || 0;
                document.getElementById('statTotalEmails').textContent = data.totalEmailsSent || 0;
                // Show active candidates currently in data gathering phase (not cumulative fetches)
                document.getElementById('statTotalDataFetches').textContent = data.pendingDataGathering || 0;
                document.getElementById('statTotalCompleted').textContent = data.totalCompleted || 0;
                // Show active candidates currently in negotiation (not cumulative actions)
                document.getElementById('statTotalNegotiations').textContent = data.activeNegotiations || 0;
                // Show candidates currently awaiting follow-up (not cumulative follow-ups sent)
                document.getElementById('statTotalFollowUps').textContent = data.pendingFollowUps || 0;

                const tbody = document.getElementById('userStatsTableBody');
                tbody.innerHTML = '';
                if(data.userStats && data.userStats.length > 0) {
                    data.userStats.forEach((u, userIndex) => {
                        const hasJobs = u.jobBreakdown && u.jobBreakdown.length > 0;
                        const userRowId = `user-row-${userIndex}`;

                        // Main user row (parent row)
                        const tr = document.createElement('tr');
                        tr.id = userRowId;
                        tr.className = "hover:bg-slate-50 border-b border-slate-50 cursor-pointer user-parent-row";
                        tr.setAttribute('data-expanded', 'false');
                        tr.onclick = function() { toggleUserJobRows(userIndex); };
                        tr.innerHTML = `
                            <td class="px-6 py-3 text-center">
                                ${hasJobs ? `<i class="fa-solid fa-chevron-right text-slate-400 transition-transform duration-200" id="chevron-${userIndex}"></i>` : ''}
                            </td>
                            <td class="px-6 py-3 font-medium">
                                <div class="flex items-center gap-2">
                                    <span>${u.email}</span>
                                    ${hasJobs ? `<span class="text-xs bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${u.jobBreakdown.length} jobs</span>` : ''}
                                </div>
                            </td>
                            <td class="px-6 py-3 text-center text-emerald-600 font-bold">${u.emailsSent || 0}</td>
                            <td class="px-6 py-3 text-center text-cyan-600">${u.dataFetches || 0}</td>
                            <td class="px-6 py-3 text-center text-purple-600">${u.negotiations || 0}</td>
                            <td class="px-6 py-3 text-center text-amber-600">${u.followUps || 0}</td>
                            <td class="px-6 py-3 text-slate-500 text-xs">${u.lastActive ? new Date(u.lastActive).toLocaleDateString() : '-'}</td>
                        `;
                        tbody.appendChild(tr);

                        // Job breakdown rows (child rows - initially hidden)
                        if (hasJobs) {
                            u.jobBreakdown.forEach((job, jobIndex) => {
                                const jobTr = document.createElement('tr');
                                jobTr.id = `job-row-${userIndex}-${jobIndex}`;
                                jobTr.className = "bg-slate-50/50 border-b border-slate-50 job-child-row hidden";
                                jobTr.setAttribute('data-parent', userRowId);
                                jobTr.innerHTML = `
                                    <td class="px-6 py-2"></td>
                                    <td class="px-6 py-2 pl-12">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-briefcase text-slate-400 text-xs"></i>
                                            <span class="text-slate-600 font-medium">${job.jobId === 'No Job ID' ? '<span class="text-slate-400 italic">No Job ID</span>' : 'Job ' + job.jobId}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-2 text-center text-emerald-500">${job.emailsSent || 0}</td>
                                    <td class="px-6 py-2 text-center text-cyan-500">${job.dataFetches || 0}</td>
                                    <td class="px-6 py-2 text-center text-purple-500">${job.negotiations || 0}</td>
                                    <td class="px-6 py-2 text-center text-amber-500">${job.followUps || 0}</td>
                                    <td class="px-6 py-2 text-slate-400 text-xs">${job.lastActive ? new Date(job.lastActive).toLocaleDateString() : '-'}</td>
                                `;
                                tbody.appendChild(jobTr);
                            });
                        }
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-slate-400">
                        <i class="fa-regular fa-folder-open text-2xl mb-2 block"></i>
                        ${hasFilters ? 'No activity found for the selected filters' : 'No user activity recorded yet'}
                    </td></tr>`;
                }
                // Update cache
                dataCache.analytics = { data: data, lastLoaded: Date.now() };
                // Call completion callback if provided
                if (onComplete) onComplete(data);
            }).getUserAnalytics(filterEmail, filterJobId, startDate, endDate);

            google.script.run.withSuccessHandler(stats => {
                if(stats.error) return;
                // Note: statTotalFollowUps and statTotalNegotiations are already set by getUserAnalytics
                // to show active/pending counts instead of cumulative action counts

                // Render charts (simplified lists)
                const uList = document.getElementById('emailUsersList');
                const userEntries = stats.emailsByUser ? Object.entries(stats.emailsByUser).sort((a,b)=>b[1]-a[1]) : [];
                if(userEntries.length > 0) {
                    uList.innerHTML = '';
                    userEntries.forEach(([k,v]) => {
                        uList.innerHTML += `<div class="flex justify-between text-sm mb-2 p-2 bg-slate-50 rounded"><span class="text-slate-700">${k}</span><span class="font-bold text-emerald-600">${v}</span></div>`;
                    });
                } else {
                    uList.innerHTML = `<div class="text-center py-6 text-slate-400">
                        <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                        <span class="text-sm">${hasFilters ? 'No emails found for the selected filters' : 'No emails sent yet'}</span>
                    </div>`;
                }

                const jList = document.getElementById('emailJobsList');
                const jobEntries = stats.emailsByJob ? Object.entries(stats.emailsByJob).sort((a,b)=>b[1]-a[1]) : [];
                if(jobEntries.length > 0) {
                    jList.innerHTML = '';
                    jobEntries.forEach(([k,v]) => {
                        jList.innerHTML += `<div class="flex justify-between text-sm mb-2 p-2 bg-slate-50 rounded"><span class="text-slate-700">Job ${k}</span><span class="font-bold text-amber-600">${v}</span></div>`;
                    });
                } else {
                    jList.innerHTML = `<div class="text-center py-6 text-slate-400">
                        <i class="fa-regular fa-envelope text-2xl mb-2 block"></i>
                        <span class="text-sm">${hasFilters ? 'No emails found for the selected filters' : 'No emails sent yet'}</span>
                    </div>`;
                }

                // Render completed by user breakdown
                const cuList = document.getElementById('completedUsersList');
                const completedUserEntries = stats.completedByUser ? Object.entries(stats.completedByUser).sort((a,b)=>b[1]-a[1]) : [];
                if(completedUserEntries.length > 0) {
                    cuList.innerHTML = '';
                    completedUserEntries.forEach(([k,v]) => {
                        cuList.innerHTML += `<div class="flex justify-between text-sm mb-2 p-2 bg-slate-50 rounded"><span class="text-slate-700">${k}</span><span class="font-bold text-blue-600">${v}</span></div>`;
                    });
                } else {
                    cuList.innerHTML = `<div class="text-center py-6 text-slate-400">
                        <i class="fa-regular fa-check-circle text-2xl mb-2 block"></i>
                        <span class="text-sm">${hasFilters ? 'No completions found for the selected filters' : 'No completions yet'}</span>
                    </div>`;
                }

                // Render completed by job breakdown
                const cjList = document.getElementById('completedJobsList');
                const completedJobEntries = stats.completedByJob ? Object.entries(stats.completedByJob).sort((a,b)=>b[1]-a[1]) : [];
                if(completedJobEntries.length > 0) {
                    cjList.innerHTML = '';
                    completedJobEntries.forEach(([k,v]) => {
                        cjList.innerHTML += `<div class="flex justify-between text-sm mb-2 p-2 bg-slate-50 rounded"><span class="text-slate-700">Job ${k}</span><span class="font-bold text-purple-600">${v}</span></div>`;
                    });
                } else {
                    cjList.innerHTML = `<div class="text-center py-6 text-slate-400">
                        <i class="fa-regular fa-check-circle text-2xl mb-2 block"></i>
                        <span class="text-sm">${hasFilters ? 'No completions found for the selected filters' : 'No completions yet'}</span>
                    </div>`;
                }
            }).getDetailedEmailStats(filterEmail, filterJobId, startDate, endDate);

            // Load chart data
            loadAnalyticsCharts(filterJobId, startDate, endDate);
        }

        // ============================================
        // USER ACTIVITY TABLE - Pivot Row Toggle Functions
        // ============================================

        /**
         * Toggle job breakdown rows for a specific user
         * @param {number} userIndex - Index of the user in the table
         */
        function toggleUserJobRows(userIndex) {
            const parentRow = document.getElementById(`user-row-${userIndex}`);
            const chevron = document.getElementById(`chevron-${userIndex}`);
            if (!parentRow) return;

            const isExpanded = parentRow.getAttribute('data-expanded') === 'true';

            // Find all child rows for this user
            const childRows = document.querySelectorAll(`[data-parent="user-row-${userIndex}"]`);

            if (isExpanded) {
                // Collapse: hide child rows
                childRows.forEach(row => {
                    row.classList.add('hidden');
                });
                parentRow.setAttribute('data-expanded', 'false');
                if (chevron) {
                    chevron.classList.remove('rotate-90');
                }
            } else {
                // Expand: show child rows
                childRows.forEach(row => {
                    row.classList.remove('hidden');
                });
                parentRow.setAttribute('data-expanded', 'true');
                if (chevron) {
                    chevron.classList.add('rotate-90');
                }
            }

            // Update "Expand All" button text
            updateToggleAllButtonText();
        }

        /**
         * Toggle all user rows (expand or collapse all)
         */
        function toggleAllUserRows() {
            const parentRows = document.querySelectorAll('.user-parent-row');
            const anyExpanded = Array.from(parentRows).some(row => row.getAttribute('data-expanded') === 'true');

            if (anyExpanded) {
                // Collapse all
                parentRows.forEach((row, index) => {
                    const childRows = document.querySelectorAll(`[data-parent="${row.id}"]`);
                    childRows.forEach(childRow => {
                        childRow.classList.add('hidden');
                    });
                    row.setAttribute('data-expanded', 'false');
                    const chevron = document.getElementById(`chevron-${index}`);
                    if (chevron) {
                        chevron.classList.remove('rotate-90');
                    }
                });
            } else {
                // Expand all
                parentRows.forEach((row, index) => {
                    const childRows = document.querySelectorAll(`[data-parent="${row.id}"]`);
                    childRows.forEach(childRow => {
                        childRow.classList.remove('hidden');
                    });
                    row.setAttribute('data-expanded', 'true');
                    const chevron = document.getElementById(`chevron-${index}`);
                    if (chevron) {
                        chevron.classList.add('rotate-90');
                    }
                });
            }

            updateToggleAllButtonText();
        }

        /**
         * Update the "Expand All" / "Collapse All" button text
         */
        function updateToggleAllButtonText() {
            const btn = document.getElementById('toggleAllRowsBtn');
            if (!btn) return;

            const parentRows = document.querySelectorAll('.user-parent-row');
            const anyExpanded = Array.from(parentRows).some(row => row.getAttribute('data-expanded') === 'true');

            if (anyExpanded) {
                btn.innerHTML = '<i class="fa-solid fa-compress-alt mr-1"></i> Collapse All';
            } else {
                btn.innerHTML = '<i class="fa-solid fa-expand-alt mr-1"></i> Expand All';
            }
        }

        // ============================================
        // ANALYTICS CHARTS - Chart.js Visualizations
        // ============================================
        let funnelChartInstance = null;
        let responseTimeChartInstance = null;
        let outcomeChartInstance = null;
        let dayOfWeekChartInstance = null;

        function loadAnalyticsCharts(filterJobId, startDate, endDate) {
            google.script.run.withSuccessHandler(chartData => {
                if (chartData.error) {
                    console.error('Chart data error:', chartData.error);
                    return;
                }

                // Render all charts with the data
                if (chartData.conversionFunnel) {
                    renderFunnelChart(chartData.conversionFunnel);
                    renderOutcomeChart(chartData.conversionFunnel);
                }
                if (chartData.timeToResponse) {
                    renderResponseTimeChart(chartData.timeToResponse);
                    renderDayOfWeekChart(chartData.timeToResponse);
                }
            }).getAnalyticsChartData(filterJobId || '', startDate || '', endDate || '');
        }

        function refreshChartData() {
            const filterJobId = currentAnalyticsJobFilter || '';
            const startDate = currentAnalyticsStartDate || '';
            const endDate = currentAnalyticsEndDate || '';
            loadAnalyticsCharts(filterJobId, startDate, endDate);
            showToast('Charts refreshed', 'success');
        }

        function renderFunnelChart(data) {
            const ctx = document.getElementById('funnelChart');
            if (!ctx) return;

            // Update stats
            document.getElementById('funnelOutreach').textContent = data.totalOutreach || 0;
            document.getElementById('funnelResponded').textContent = data.totalResponded || 0;
            document.getElementById('funnelNegotiating').textContent = data.totalNegotiating || 0;
            document.getElementById('funnelAccepted').textContent = data.totalAccepted || 0;

            // Destroy existing chart
            if (funnelChartInstance) {
                funnelChartInstance.destroy();
            }

            const funnelLabels = data.funnel ? data.funnel.map(f => f.stage) : ['Outreach', 'Responded', 'Negotiating', 'Accepted'];
            const funnelValues = data.funnel ? data.funnel.map(f => f.count) : [0, 0, 0, 0];

            funnelChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funnelLabels,
                    datasets: [{
                        data: funnelValues,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // blue
                            'rgba(6, 182, 212, 0.8)',   // cyan
                            'rgba(245, 158, 11, 0.8)',  // amber
                            'rgba(16, 185, 129, 0.8)'   // emerald
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(6, 182, 212)',
                            'rgb(245, 158, 11)',
                            'rgb(16, 185, 129)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = data.totalOutreach || 1;
                                    const percent = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.raw} candidates (${percent}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderResponseTimeChart(data) {
            const ctx = document.getElementById('responseTimeChart');
            if (!ctx) return;

            // Update stats
            document.getElementById('avgResponseTime').textContent = data.avgResponseHours ? data.avgResponseHours + 'h' : '-';
            document.getElementById('medianResponseTime').textContent = data.medianResponseHours ? data.medianResponseHours + 'h' : '-';
            document.getElementById('responseRatePercent').textContent = data.responseRate ? data.responseRate + '%' : '-';

            // Destroy existing chart
            if (responseTimeChartInstance) {
                responseTimeChartInstance.destroy();
            }

            const buckets = data.responseTimeBuckets || {};
            const labels = Object.keys(buckets);
            const values = Object.values(buckets);

            responseTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Candidates',
                        data: values,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = values.reduce((a, b) => a + b, 0) || 1;
                                    const percent = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.raw} responses (${percent}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            title: { display: true, text: 'Responses', font: { size: 11 } }
                        },
                        x: {
                            grid: { display: false },
                            title: { display: true, text: 'Response Time', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        function renderOutcomeChart(data) {
            const ctx = document.getElementById('outcomeChart');
            if (!ctx) return;

            const outcomes = data.outcomes || {};

            // Update stats
            document.getElementById('outcomeAccepted').textContent = outcomes.accepted || 0;
            document.getElementById('outcomeRejected').textContent = outcomes.rejected || 0;
            document.getElementById('outcomeEscalated').textContent = outcomes.escalated || 0;
            document.getElementById('outcomeUnresponsive').textContent = outcomes.unresponsive || 0;

            // Destroy existing chart
            if (outcomeChartInstance) {
                outcomeChartInstance.destroy();
            }

            const labels = ['Accepted', 'Rejected', 'Escalated', 'Unresponsive', 'Pending'];
            const values = [
                outcomes.accepted || 0,
                outcomes.rejected || 0,
                outcomes.escalated || 0,
                outcomes.unresponsive || 0,
                outcomes.pending || 0
            ];

            // Only show if there's data
            const total = values.reduce((a, b) => a + b, 0);
            if (total === 0) {
                ctx.parentElement.innerHTML = `<div class="flex items-center justify-center h-56 text-slate-400">
                    <div class="text-center">
                        <i class="fa-regular fa-chart-pie text-3xl mb-2"></i>
                        <p class="text-sm">No outcome data yet</p>
                    </div>
                </div>`;
                return;
            }

            outcomeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',   // emerald - accepted
                            'rgba(239, 68, 68, 0.8)',   // red - rejected
                            'rgba(245, 158, 11, 0.8)',  // amber - escalated
                            'rgba(148, 163, 184, 0.8)', // slate - unresponsive
                            'rgba(99, 102, 241, 0.8)'   // indigo - pending
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)',
                            'rgb(148, 163, 184)',
                            'rgb(99, 102, 241)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percent = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDayOfWeekChart(data) {
            const ctx = document.getElementById('dayOfWeekChart');
            if (!ctx) return;

            const responsesByDay = data.responsesByDay || {};

            // Destroy existing chart
            if (dayOfWeekChartInstance) {
                dayOfWeekChartInstance.destroy();
            }

            const dayOrder = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const values = dayOrder.map(day => responsesByDay[day] || 0);

            // Find best day
            const maxVal = Math.max(...values);
            const bestDayIndex = values.indexOf(maxVal);
            const bestDay = maxVal > 0 ? dayOrder[bestDayIndex] : '-';
            document.getElementById('bestResponseDay').textContent = bestDay;

            // Create gradient colors (darker for higher values)
            const maxValue = Math.max(...values, 1);
            const colors = values.map(v => {
                const intensity = 0.3 + (v / maxValue) * 0.5;
                return `rgba(245, 158, 11, ${intensity})`;
            });

            dayOfWeekChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayOrder,
                    datasets: [{
                        label: 'Responses',
                        data: values,
                        backgroundColor: colors,
                        borderColor: 'rgb(245, 158, 11)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} responses`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Refresh Analytics with animation and success message
        function refreshAnalyticsWithAnimation() {
            const btn = document.getElementById('analyticsRefreshBtn');
            if (!btn || btn.classList.contains('loading')) return;

            btn.classList.add('loading');

            loadAnalytics((data) => {
                btn.classList.remove('loading');
                btn.classList.add('success');
                const userCount = data.userStats ? data.userStats.length : 0;
                showToast(`Analytics refreshed (${userCount} users)`, 'success');

                // Reset button state after animation
                setTimeout(() => {
                    btn.classList.remove('success');
                }, 1500);
            });
        }

        function showAnalyticsAccessDenied() {
            // Access denied no longer needed - all authorized users see their data
            console.log('Analytics access check completed');
        }

        function toggleCollapse(contentId, header) {
            const content = document.getElementById(contentId);
            if(content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        }
        function closeProgressPanel(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Viewers Logic
        function loadViewers() {
            const list = document.getElementById('viewersList');
            list.innerHTML = 'Loading...';
            google.script.run.withSuccessHandler(viewers => {
                if(viewers.error) { list.innerHTML = viewers.error; return; }
                list.innerHTML = '';
                viewers.forEach(v => {
                    const roleColors = {
                        'admin': 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
                        'tl': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300',
                        'tm': 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300',
                        'ta': 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300',
                        'manager': 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300',
                        'other': 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300'
                    };
                    const roleLabels = {
                        'admin': 'Admin',
                        'tl': 'TL',
                        'tm': 'TM',
                        'ta': 'TA',
                        'manager': 'Manager',
                        'other': 'Other',
                        'viewer': 'Other' // backwards compat
                    };
                    const role = (v.accessLevel || 'other').toLowerCase();
                    const colorClass = roleColors[role] || roleColors['other'];
                    const roleLabel = roleLabels[role] || role.toUpperCase();

                    list.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-700 rounded mb-1">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-sm text-slate-800 dark:text-white">${v.email}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${colorClass}">${roleLabel}</span>
                            </div>
                            <button onclick="removeViewer('${v.email}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                });
            }).getAnalyticsViewers();
        }
        function addViewer() {
            const email = document.getElementById('newViewerEmail').value;
            const level = document.getElementById('newViewerLevel').value;
            if(!email) return;
            google.script.run.withSuccessHandler(res => {
                if(res.success) {
                    showToast("User Added", "success");
                    loadViewers();
                    document.getElementById('newViewerEmail').value='';
                    // Also mark as reviewed if they were a new user
                    google.script.run.markUserReviewed(email);
                }
                else showToast(res.error, "error");
            }).addAnalyticsViewer(email, level);
        }
        function removeViewer(email) {
            if(!confirm("Remove this user?")) return;
            google.script.run.withSuccessHandler(res => {
                if(res.success) { showToast("Removed", "success"); loadViewers(); }
                else showToast(res.error, "error");
            }).removeAnalyticsViewer(email);
        }
        function openViewersModal() {
            document.getElementById('viewersModal').classList.remove('hidden');
            loadViewers();
        }
        function closeViewersModal() {
            document.getElementById('viewersModal').classList.add('hidden');
        }

        // ============================================================
        // SUPPLEMENTARY DATA REQUEST FEATURE
        // Allows users to request additional information from candidates
        // ============================================================
        let supplementaryCandidates = [];
        let parsedSupplementaryQuestions = [];

        function openSupplementaryDataModal() {
            document.getElementById('supplementaryDataModal').classList.remove('hidden');
            // Populate job dropdown
            populateSuppDataJobDropdown();
            // Reset form
            resetSupplementaryDataForm();
        }

        function closeSupplementaryDataModal() {
            document.getElementById('supplementaryDataModal').classList.add('hidden');
            resetSupplementaryDataForm();
        }

        function resetSupplementaryDataForm() {
            document.getElementById('suppDataInput').value = '';
            document.getElementById('parsedQuestionsPreview').classList.add('hidden');
            document.getElementById('parsedQuestionsList').innerHTML = '';
            document.getElementById('currentQuestionsSection').classList.add('hidden');
            document.getElementById('candidateSelectionSection').classList.add('hidden');
            document.getElementById('suppDataSummary').classList.add('hidden');
            document.getElementById('candidateCheckboxList').innerHTML = '';
            document.getElementById('suppDataIncludeCompleted').checked = false;
            document.getElementById('suppDataApplyToFuture').checked = true;
            document.querySelector('input[name="suppDataTarget"][value="all"]').checked = true;
            document.getElementById('sendSuppDataBtn').disabled = true;
            supplementaryCandidates = [];
            parsedSupplementaryQuestions = [];
            updateSupplementarySummary();
        }

        function populateSuppDataJobDropdown() {
            google.script.run
                .withSuccessHandler(jobs => {
                    const dropdown = document.getElementById('suppDataJobDropdown');
                    dropdown.innerHTML = '<option value="">-- Select a Job --</option>';
                    jobs.forEach(j => {
                        dropdown.innerHTML += `<option value="${j}">Job ${j}</option>`;
                    });
                    // Pre-select if a job is already selected in the tasks tab
                    if (currentTaskJobId) {
                        dropdown.value = currentTaskJobId;
                        loadSupplementaryCandidates();
                    }
                })
                .getJobConfigList();
        }

        function loadSupplementaryCandidates() {
            const jobId = document.getElementById('suppDataJobDropdown').value;
            if (!jobId) {
                supplementaryCandidates = [];
                document.getElementById('candidateCheckboxList').innerHTML = '<div class="text-sm text-slate-400 p-2">Select a job first</div>';
                document.getElementById('currentQuestionsSection').classList.add('hidden');
                updateSupplementarySummary();
                return;
            }

            const includeCompleted = document.getElementById('suppDataIncludeCompleted').checked;

            // Load current questions for this job
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success && result.currentSheetHeaders && result.currentSheetHeaders.length > 0) {
                        const questionsDiv = document.getElementById('currentQuestionsList');
                        questionsDiv.innerHTML = result.currentSheetHeaders.map(h =>
                            `<span class="px-2 py-1 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 rounded">${h}</span>`
                        ).join('');
                        document.getElementById('currentQuestionsSection').classList.remove('hidden');
                    } else {
                        document.getElementById('currentQuestionsSection').classList.add('hidden');
                    }
                })
                .getJobQuestionsInfo(jobId);

            // Load candidates
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        supplementaryCandidates = result.candidates || [];
                        renderCandidateCheckboxes();
                        updateSupplementarySummary();
                    } else {
                        showToast('Failed to load candidates: ' + result.error, 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('Error loading candidates: ' + err.message, 'error');
                })
                .getJobCandidatesForSupplementaryRequest(jobId, includeCompleted);
        }

        function renderCandidateCheckboxes() {
            const container = document.getElementById('candidateCheckboxList');
            if (supplementaryCandidates.length === 0) {
                container.innerHTML = '<div class="text-sm text-slate-400 p-2">No candidates found for this job</div>';
                return;
            }

            container.innerHTML = supplementaryCandidates.map((c, idx) => `
                <label class="flex items-center gap-2 p-2 hover:bg-slate-50 dark:hover:bg-slate-600 rounded cursor-pointer">
                    <input type="checkbox" class="supp-candidate-check rounded border-slate-300 text-teal-600"
                           data-email="${c.email}" onchange="updateSelectedCandidateCount()">
                    <span class="text-sm text-slate-700 dark:text-slate-300">${c.name}</span>
                    <span class="text-xs text-slate-400">(${c.email})</span>
                    ${c.isCompleted ? '<span class="text-xs px-1 py-0.5 bg-green-100 text-green-700 rounded">Completed</span>' : ''}
                    <span class="text-xs px-1 py-0.5 bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-slate-400 rounded">${c.status}</span>
                </label>
            `).join('');
        }

        function selectAllSupplementaryCandidates(selectAll) {
            const checkboxes = document.querySelectorAll('.supp-candidate-check');
            checkboxes.forEach(cb => cb.checked = selectAll);
            updateSelectedCandidateCount();
        }

        function updateSelectedCandidateCount() {
            const selected = document.querySelectorAll('.supp-candidate-check:checked').length;
            document.getElementById('selectedCandidateCount').textContent = selected;
            updateSupplementarySummary();
        }

        function toggleCandidateSelection() {
            const targetMode = document.querySelector('input[name="suppDataTarget"]:checked').value;
            const selectionSection = document.getElementById('candidateSelectionSection');

            if (targetMode === 'selected') {
                selectionSection.classList.remove('hidden');
            } else {
                selectionSection.classList.add('hidden');
            }
            updateSupplementarySummary();
        }

        function parseSupplementaryInput() {
            const input = document.getElementById('suppDataInput').value.trim();
            if (!input) {
                showToast('Please enter what information you need', 'warning');
                return;
            }

            showToast('Analyzing your request...', 'info');

            google.script.run
                .withSuccessHandler(questions => {
                    parsedSupplementaryQuestions = questions || [];
                    if (parsedSupplementaryQuestions.length === 0) {
                        showToast('Could not parse any questions from your input', 'warning');
                        return;
                    }

                    // Display parsed questions
                    const previewDiv = document.getElementById('parsedQuestionsList');
                    previewDiv.innerHTML = parsedSupplementaryQuestions.map((q, idx) => `
                        <div class="flex items-start gap-2 p-2 bg-white dark:bg-slate-700 rounded">
                            <span class="font-bold text-teal-600 min-w-[24px]">${idx + 1}.</span>
                            <div class="flex-1">
                                <div class="font-medium text-slate-700 dark:text-slate-300">${q.header}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">${q.question}</div>
                            </div>
                            <button onclick="removeSupplementaryQuestion(${idx})" class="text-slate-400 hover:text-red-500">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    `).join('');

                    document.getElementById('parsedQuestionsPreview').classList.remove('hidden');
                    updateSupplementarySummary();
                    showToast(`Parsed ${parsedSupplementaryQuestions.length} questions`, 'success');
                })
                .withFailureHandler(err => {
                    showToast('Error parsing questions: ' + err.message, 'error');
                })
                .parseSupplementaryQuestions(input);
        }

        function removeSupplementaryQuestion(idx) {
            parsedSupplementaryQuestions.splice(idx, 1);
            if (parsedSupplementaryQuestions.length === 0) {
                clearParsedQuestions();
            } else {
                // Re-render
                const previewDiv = document.getElementById('parsedQuestionsList');
                previewDiv.innerHTML = parsedSupplementaryQuestions.map((q, i) => `
                    <div class="flex items-start gap-2 p-2 bg-white dark:bg-slate-700 rounded">
                        <span class="font-bold text-teal-600 min-w-[24px]">${i + 1}.</span>
                        <div class="flex-1">
                            <div class="font-medium text-slate-700 dark:text-slate-300">${q.header}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">${q.question}</div>
                        </div>
                        <button onclick="removeSupplementaryQuestion(${i})" class="text-slate-400 hover:text-red-500">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }
            updateSupplementarySummary();
        }

        function clearParsedQuestions() {
            parsedSupplementaryQuestions = [];
            document.getElementById('parsedQuestionsPreview').classList.add('hidden');
            document.getElementById('parsedQuestionsList').innerHTML = '';
            updateSupplementarySummary();
        }

        function updateSupplementarySummary() {
            const jobId = document.getElementById('suppDataJobDropdown').value;
            const targetMode = document.querySelector('input[name="suppDataTarget"]:checked').value;
            const includeCompleted = document.getElementById('suppDataIncludeCompleted').checked;
            const applyToFuture = document.getElementById('suppDataApplyToFuture').checked;

            let candidateCount = 0;
            if (targetMode === 'all') {
                candidateCount = supplementaryCandidates.length;
            } else {
                candidateCount = document.querySelectorAll('.supp-candidate-check:checked').length;
            }

            const questionCount = parsedSupplementaryQuestions.length;
            const summaryDiv = document.getElementById('suppDataSummary');
            const summaryText = document.getElementById('suppDataSummaryText');
            const sendBtn = document.getElementById('sendSuppDataBtn');

            // Validate and enable/disable send button
            const canSend = jobId && questionCount > 0 && candidateCount > 0;
            sendBtn.disabled = !canSend;

            if (!jobId) {
                summaryText.textContent = 'Select a job to continue';
                summaryDiv.classList.remove('hidden');
                return;
            }

            if (questionCount === 0) {
                summaryText.textContent = 'Click "Preview Questions" to parse your input';
                summaryDiv.classList.remove('hidden');
                return;
            }

            let summaryParts = [];
            summaryParts.push(`${questionCount} question${questionCount > 1 ? 's' : ''}`);
            summaryParts.push(`${candidateCount} candidate${candidateCount > 1 ? 's' : ''}`);
            if (includeCompleted) summaryParts.push('including completed');
            if (applyToFuture) summaryParts.push('+ future candidates');

            summaryText.textContent = `Will send ${summaryParts.join(', ')}`;
            summaryDiv.classList.remove('hidden');
        }

        function sendSupplementaryDataRequest() {
            const jobId = document.getElementById('suppDataJobDropdown').value;
            const targetMode = document.querySelector('input[name="suppDataTarget"]:checked').value;
            const includeCompleted = document.getElementById('suppDataIncludeCompleted').checked;
            const applyToFuture = document.getElementById('suppDataApplyToFuture').checked;

            if (!jobId || parsedSupplementaryQuestions.length === 0) {
                showToast('Please select a job and preview your questions first', 'warning');
                return;
            }

            // Get selected candidate emails
            let selectedEmails = [];
            if (targetMode === 'selected') {
                const checkboxes = document.querySelectorAll('.supp-candidate-check:checked');
                checkboxes.forEach(cb => selectedEmails.push(cb.dataset.email));
                if (selectedEmails.length === 0) {
                    showToast('Please select at least one candidate', 'warning');
                    return;
                }
            }

            const sendBtn = document.getElementById('sendSuppDataBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Sending...';

            google.script.run
                .withSuccessHandler(result => {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Request';

                    if (result.success) {
                        let message = `Sent ${result.sent} email${result.sent !== 1 ? 's' : ''}`;
                        if (result.columnsAdded && result.columnsAdded.length > 0) {
                            message += `. Added columns: ${result.columnsAdded.join(', ')}`;
                        }
                        if (result.failed > 0) {
                            message += `. ${result.failed} failed.`;
                        }
                        if (result.applyToFuture) {
                            message += ' Questions saved for future candidates.';
                        }
                        showToast(message, result.failed > 0 ? 'warning' : 'success');
                        closeSupplementaryDataModal();
                        // Refresh tasks to show updated data
                        loadTasks();
                    } else {
                        showToast('Error: ' + (result.error || 'Unknown error'), 'error');
                    }
                })
                .withFailureHandler(err => {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Request';
                    showToast('Error: ' + err.message, 'error');
                })
                .sendSupplementaryDataRequest(jobId, selectedEmails, parsedSupplementaryQuestions, includeCompleted, applyToFuture);
        }

        // ===== Page Access Control (Admin Only) =====
        let pageAccessSettings = {};
        const PAGE_NAMES = {
            outreach: 'Outreach',
            negotiation: 'Job Setup',
            tasks: 'Tasks',
            followups: 'Follow-Ups',
            analytics: 'Analytics',
            learning: 'AI Learning',
            aitesting: 'AI Testing',
            processmap: 'Process Map'
        };
        const ROLE_NAMES = {
            admin: 'Admin',
            tl: 'Team Lead',
            tm: 'Talent Manager',
            ta: 'Talent Acquisition',
            manager: 'Manager',
            other: 'Other'
        };
        const ROLE_COLORS = {
            admin: 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300',
            tl: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300',
            tm: 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300',
            ta: 'bg-violet-100 text-violet-700 dark:bg-violet-900/50 dark:text-violet-300',
            manager: 'bg-pink-100 text-pink-700 dark:bg-pink-900/50 dark:text-pink-300',
            other: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300'
        };

        function openPageAccessModal() {
            if (!userPermissions.isAdmin) {
                showToast('Only admins can manage page access', 'error');
                return;
            }
            document.getElementById('pageAccessModal').classList.remove('hidden');
            loadPageAccessSettings();
        }

        function closePageAccessModal() {
            document.getElementById('pageAccessModal').classList.add('hidden');
        }

        function loadPageAccessSettings() {
            const loading = document.getElementById('pageAccessLoading');
            const tableContainer = document.getElementById('pageAccessTableContainer');

            loading.classList.remove('hidden');
            tableContainer.classList.add('hidden');

            google.script.run
                .withSuccessHandler(result => {
                    loading.classList.add('hidden');

                    if (result.error) {
                        showToast(result.error, 'error');
                        return;
                    }

                    pageAccessSettings = result.settings;
                    renderPageAccessTable(result.settings, result.roles, result.pages);
                    tableContainer.classList.remove('hidden');
                })
                .withFailureHandler(err => {
                    loading.classList.add('hidden');
                    showToast('Failed to load page access settings', 'error');
                    console.error('Page access error:', err);
                })
                .getPageAccessSettings();
        }

        function renderPageAccessTable(settings, roles, pages) {
            const tbody = document.getElementById('pageAccessTableBody');

            tbody.innerHTML = roles.map(role => {
                const roleSettings = settings[role] || {};
                const isAdmin = role === 'admin';

                return `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 ${isAdmin ? 'bg-blue-50/50 dark:bg-blue-900/20' : ''}">
                        <td class="px-3 py-3">
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${ROLE_COLORS[role]}">
                                ${ROLE_NAMES[role] || role}
                            </span>
                        </td>
                        ${pages.map(page => {
                            const enabled = roleSettings[page] !== false;
                            const disabled = isAdmin; // Admin always has access
                            return `
                                <td class="px-2 py-3 text-center">
                                    <button
                                        onclick="togglePageAccess('${role}', '${page}', ${!enabled})"
                                        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${enabled ? 'bg-green-500' : 'bg-slate-300 dark:bg-slate-600'} ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}"
                                        ${disabled ? 'disabled title="Admin always has full access"' : ''}
                                        id="toggle-${role}-${page}"
                                    >
                                        <span class="inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform ${enabled ? 'translate-x-6' : 'translate-x-1'}"></span>
                                    </button>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }).join('');
        }

        function togglePageAccess(role, page, enabled) {
            if (role === 'admin') {
                showToast('Admin role always has full access', 'info');
                return;
            }

            const toggleBtn = document.getElementById(`toggle-${role}-${page}`);
            if (toggleBtn) {
                toggleBtn.disabled = true;
                toggleBtn.classList.add('opacity-50');
            }

            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        // Update local state
                        if (!pageAccessSettings[role]) pageAccessSettings[role] = {};
                        pageAccessSettings[role][page] = enabled;

                        // Update toggle button UI
                        if (toggleBtn) {
                            toggleBtn.disabled = false;
                            toggleBtn.classList.remove('opacity-50');
                            toggleBtn.className = `relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${enabled ? 'bg-green-500' : 'bg-slate-300 dark:bg-slate-600'} cursor-pointer`;
                            toggleBtn.onclick = () => togglePageAccess(role, page, !enabled);
                            const span = toggleBtn.querySelector('span');
                            if (span) {
                                span.className = `inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform ${enabled ? 'translate-x-6' : 'translate-x-1'}`;
                            }
                        }

                        showToast(`${PAGE_NAMES[page]} ${enabled ? 'enabled' : 'disabled'} for ${ROLE_NAMES[role]}`, 'success');
                    } else {
                        showToast(result.error || 'Failed to update', 'error');
                        if (toggleBtn) {
                            toggleBtn.disabled = false;
                            toggleBtn.classList.remove('opacity-50');
                        }
                    }
                })
                .withFailureHandler(err => {
                    showToast('Failed to update page access', 'error');
                    console.error('Toggle error:', err);
                    if (toggleBtn) {
                        toggleBtn.disabled = false;
                        toggleBtn.classList.remove('opacity-50');
                    }
                })
                .updatePageAccessSetting(role, page, enabled);
        }

        // ===== New Users Panel (Admin Only) =====
        let newUsersList = [];

        function loadNewUsers() {
            if (!userPermissions.isAdmin) return;

            google.script.run
                .withSuccessHandler(users => {
                    newUsersList = users || [];
                    updateNewUsersBadge();
                    renderNewUsersList();
                })
                .withFailureHandler(() => {
                    console.error('Failed to load new users');
                })
                .getNewUsers();
        }

        function updateNewUsersBadge() {
            const badge = document.getElementById('newUsersBadge');
            const count = newUsersList.length;
            if (badge) {
                badge.textContent = count > 9 ? '9+' : count;
                if (count > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function renderNewUsersList() {
            const listContainer = document.getElementById('newUsersList');
            if (!listContainer) return;

            if (newUsersList.length === 0) {
                listContainer.innerHTML = '<div class="p-4 text-center text-slate-500 text-sm">No new users</div>';
                return;
            }

            listContainer.innerHTML = newUsersList.map(user => {
                const firstSeen = user.firstSeen ? new Date(user.firstSeen).toLocaleDateString() : 'Unknown';
                return `
                    <div class="p-3 border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-sm text-slate-800 dark:text-white">${user.email}</div>
                                <div class="text-xs text-slate-500">First seen: ${firstSeen}</div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="assignRoleToNewUser('${user.email}')" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition" title="Assign Role">
                                    <i class="fa-solid fa-user-tag"></i>
                                </button>
                                <button onclick="dismissNewUser('${user.email}')" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-white rounded hover:bg-slate-300 dark:hover:bg-slate-500 transition" title="Dismiss">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleNewUsersPanel() {
            const panel = document.getElementById('newUsersPanel');
            const notifPanel = document.getElementById('notificationPanel');
            if (panel) {
                // Close other panels
                if (notifPanel) notifPanel.classList.add('hidden');
                panel.classList.toggle('hidden');
            }
        }

        function closeNewUsersPanel() {
            const panel = document.getElementById('newUsersPanel');
            if (panel) panel.classList.add('hidden');
        }

        function assignRoleToNewUser(email) {
            // Pre-fill the email in the viewers modal and open it
            closeNewUsersPanel();
            document.getElementById('newViewerEmail').value = email;
            openViewersModal();
        }

        function dismissNewUser(email) {
            google.script.run
                .withSuccessHandler(res => {
                    if (res.success) {
                        showToast('User dismissed', 'success');
                        loadNewUsers(); // Refresh the list
                    } else {
                        showToast(res.error || 'Failed to dismiss user', 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('Failed to dismiss user', 'error');
                })
                .markUserReviewed(email);
        }

        // ===== AI TESTING FEATURE - DELETE FOR PRODUCTION (START JAVASCRIPT) =====
        // AI Testing state - now supports multi-function selection
        let aiTestSelectedFunctions = {
            negotiation: true,
            followup: false,
            datagathering: false
        };
        let aiTestHistory = [];
        let aiTestLoadedRateTiers = []; // Cached rate tiers for current job
        let conversationThread = []; // Stores the conversation messages
        let conversationContext = {}; // Stores context like extracted data, negotiation state

        // Toggle test type (multi-select mode)
        function toggleAiTestType(type) {
            // Toggle the selected state
            aiTestSelectedFunctions[type] = !aiTestSelectedFunctions[type];

            // Ensure at least one function is selected
            const anySelected = Object.values(aiTestSelectedFunctions).some(v => v);
            if (!anySelected) {
                aiTestSelectedFunctions[type] = true; // Re-enable if all were off
                showToast('At least one function must be selected', 'warning');
            }

            // Update chip visual state
            const chip = document.getElementById('testType' + type.charAt(0).toUpperCase() + type.slice(1));
            chip.classList.toggle('active', aiTestSelectedFunctions[type]);

            // Show/hide relevant settings panels
            updateAiTestSettingsPanels();

            // Update function hint text
            updateAiTestFunctionsHint();

            // Update chat header badge
            updateChatActiveFunctions();
        }

        // Update which settings panels are visible
        function updateAiTestSettingsPanels() {
            document.getElementById('negotiationFields').classList.toggle('hidden', !aiTestSelectedFunctions.negotiation);
            document.getElementById('followupFields').classList.toggle('hidden', !aiTestSelectedFunctions.followup);
            document.getElementById('dataGatheringFields').classList.toggle('hidden', !aiTestSelectedFunctions.datagathering);
        }

        // Update the hint text based on selected functions
        function updateAiTestFunctionsHint() {
            const hints = [];
            if (aiTestSelectedFunctions.negotiation) hints.push('negotiate rates');
            if (aiTestSelectedFunctions.followup) hints.push('send follow-ups');
            if (aiTestSelectedFunctions.datagathering) hints.push('extract data');

            let hintText = '';
            if (hints.length === 1) {
                hintText = `AI will ${hints[0]} with candidates.`;
            } else if (hints.length === 2) {
                hintText = `AI will ${hints[0]} and ${hints[1]}.`;
            } else if (hints.length === 3) {
                hintText = `AI will ${hints[0]}, ${hints[1]}, and ${hints[2]}.`;
            }

            document.getElementById('aiTestFunctionsHint').textContent = hintText;
        }

        // Update the chat header badge
        function updateChatActiveFunctions() {
            const active = [];
            if (aiTestSelectedFunctions.negotiation) active.push('Neg');
            if (aiTestSelectedFunctions.followup) active.push('F/U');
            if (aiTestSelectedFunctions.datagathering) active.push('Data');

            document.getElementById('chatActiveFunctions').textContent = active.join(' + ') || 'None';
        }

        // Legacy function for backwards compatibility
        function selectAiTestType(type) {
            // Clear all and select only this one (single-select mode)
            aiTestSelectedFunctions = {
                negotiation: type === 'negotiation',
                followup: type === 'followup',
                datagathering: type === 'datagathering'
            };

            // Update all chips
            document.querySelectorAll('[data-test-type]').forEach(chip => {
                chip.classList.remove('active');
            });
            document.getElementById('testType' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');

            updateAiTestSettingsPanels();
            updateAiTestFunctionsHint();
            updateChatActiveFunctions();
        }

        // Load rate tiers for a job
        function loadAiTestRateTiers() {
            const jobId = document.getElementById('aiTestJobId').value.trim();
            if (!jobId) {
                showToast('Please enter a Job ID first', 'warning');
                return;
            }

            showToast('Loading rate tiers...', 'info');

            google.script.run
                .withSuccessHandler(tiers => {
                    aiTestLoadedRateTiers = tiers || [];
                    const select = document.getElementById('aiTestRateTier');

                    // Clear existing options except first
                    select.innerHTML = '<option value="">-- Manual Entry (no tier selected) --</option>';

                    if (tiers && tiers.length > 0) {
                        tiers.forEach((tier, idx) => {
                            const option = document.createElement('option');
                            option.value = idx;
                            // Show country if specified, otherwise just region
                            const tierLabel = tier.country
                                ? `${tier.country} (${tier.region})`
                                : tier.region;
                            option.textContent = `${tierLabel}: $${tier.targetRate}/hr (max: $${tier.maxRate}/hr)`;
                            select.appendChild(option);
                        });
                        showToast(`Loaded ${tiers.length} rate tier(s) for Job ${jobId}`, 'success');
                    } else {
                        showToast('No rate tiers found for this job', 'warning');
                    }
                })
                .withFailureHandler(err => {
                    const errorMsg = err && err.message ? err.message : 'Unknown error';
                    showToast('Failed to load rate tiers: ' + errorMsg, 'error');
                })
                .getRateTiersForJob(jobId);
        }

        // Apply selected rate tier to input fields
        function applySelectedRateTier() {
            const select = document.getElementById('aiTestRateTier');
            const infoDiv = document.getElementById('aiTestRateTierInfo');
            const infoText = document.getElementById('aiTestRateTierInfoText');

            if (select.value === '') {
                infoDiv.classList.add('hidden');
                return;
            }

            const idx = parseInt(select.value);
            const tier = aiTestLoadedRateTiers[idx];

            if (tier) {
                document.getElementById('aiTestTargetRate').value = tier.targetRate;
                document.getElementById('aiTestMaxRate').value = tier.maxRate;

                // Show tier info with country if available
                infoDiv.classList.remove('hidden');
                const tierLabel = tier.country ? `<strong>${tier.country}</strong> (${tier.region})` : `<strong>${tier.region}</strong>`;
                let infoHtml = `${tierLabel}: Target $${tier.targetRate}/hr, Max $${tier.maxRate}/hr`;
                if (tier.notes) {
                    infoHtml += `  ${tier.notes}`;
                }
                infoText.innerHTML = infoHtml;

                // Auto-fill country field - prefer tier's country, fallback to region
                const countryField = document.getElementById('aiTestDevCountry');
                if (!countryField.value) {
                    countryField.value = tier.country || tier.region;
                }

                const appliedLabel = tier.country ? `${tier.country} (${tier.region})` : tier.region;
                showToast(`Applied ${appliedLabel} rates`, 'success');
            }
        }

        // Start a new test session
        function startNewAiTestSession() {
            // Clear inputs
            document.getElementById('aiTestDevName').value = '';
            document.getElementById('aiTestDevEmail').value = '';
            document.getElementById('aiTestDevCountry').value = '';
            document.getElementById('aiTestJobId').value = '';
            document.getElementById('aiTestJobDesc').value = '';
            document.getElementById('aiTestTargetRate').value = '';
            document.getElementById('aiTestMaxRate').value = '';
            document.getElementById('aiTestAttempt').value = '1';
            document.getElementById('aiTestFollowUpNum').value = '1';
            document.getElementById('aiTestPendingQuestions').value = '';
            document.getElementById('aiTestCandidateReply').value = '';

            // Clear rate tier selection
            const rateTierSelect = document.getElementById('aiTestRateTier');
            rateTierSelect.innerHTML = '<option value="">-- Manual Entry (no tier selected) --</option>';
            document.getElementById('aiTestRateTierInfo').classList.add('hidden');
            aiTestLoadedRateTiers = [];

            // Reset to default function selection (negotiation only)
            aiTestSelectedFunctions = {
                negotiation: true,
                followup: false,
                datagathering: false
            };

            // Update UI for function selection
            document.querySelectorAll('[data-test-type]').forEach(chip => {
                const type = chip.dataset.testType;
                chip.classList.toggle('active', aiTestSelectedFunctions[type]);
            });
            updateAiTestSettingsPanels();
            updateAiTestFunctionsHint();
            updateChatActiveFunctions();

            // Clear legacy response panel
            document.getElementById('aiTestResponseEmpty').classList.remove('hidden');
            document.getElementById('aiTestResponseContent').classList.add('hidden');

            // Clear data extraction results
            document.getElementById('dataExtractionResults').classList.add('hidden');

            // Clear AI Summary panel
            document.getElementById('aiTestSummaryPanel').classList.add('hidden');

            // Clear conversation thread
            conversationThread = [];
            conversationContext = {};
            renderConversationThread();

            // Hide quick reply section
            document.getElementById('quickReplySection').classList.add('hidden');

            // Clear history
            aiTestHistory = [];
            renderAiTestHistory();

            showToast('New testing session started', 'info');
        }

        // Render the conversation thread (WhatsApp-style)
        function renderConversationThread() {
            const container = document.getElementById('conversationThread');
            const emptyState = document.getElementById('chatEmptyState');

            if (conversationThread.length === 0) {
                // Show empty state
                emptyState.classList.remove('hidden');
                container.querySelectorAll('.chat-message').forEach(el => el.remove());
                return;
            }

            // Hide empty state
            emptyState.classList.add('hidden');

            // Clear existing messages (except empty state)
            container.querySelectorAll('.chat-message').forEach(el => el.remove());

            // Render each message
            conversationThread.forEach((msg, idx) => {
                const messageEl = createChatMessageElement(msg, idx);
                container.appendChild(messageEl);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;

            // Show quick reply section after first exchange
            if (conversationThread.length > 0) {
                document.getElementById('quickReplySection').classList.remove('hidden');
            }
        }

        // Create a chat message element
        function createChatMessageElement(msg, idx) {
            const div = document.createElement('div');
            div.className = 'chat-message';

            const isCandidate = msg.sender === 'candidate';
            const bubbleClass = isCandidate
                ? 'bg-white dark:bg-slate-700 rounded-lg rounded-tl-none shadow-sm'
                : 'bg-green-500 text-white rounded-lg rounded-tr-none shadow-sm';
            const alignClass = isCandidate ? 'justify-start' : 'justify-end';

            // Build type badges for AI messages
            let typeBadges = '';
            if (!isCandidate && msg.types && msg.types.length > 0) {
                typeBadges = msg.types.map(t => {
                    const colors = {
                        negotiation: 'bg-blue-400/30 text-blue-100',
                        followup: 'bg-orange-400/30 text-orange-100',
                        datagathering: 'bg-purple-400/30 text-purple-100'
                    };
                    const icons = {
                        negotiation: 'fa-hand-holding-dollar',
                        followup: 'fa-clock-rotate-left',
                        datagathering: 'fa-clipboard-question'
                    };
                    return `<span class="text-xs px-2 py-0.5 rounded ${colors[t]}"><i class="fa-solid ${icons[t]} mr-1"></i>${t}</span>`;
                }).join(' ');
            }

            // Build data extraction summary if present
            let dataExtractHtml = '';
            if (msg.extractedData && Object.keys(msg.extractedData).length > 0) {
                const extractedEntries = Object.entries(msg.extractedData)
                    .filter(([k, v]) => k !== 'is_negotiating' && k !== 'negotiation_notes' && v && v !== 'NOT_PROVIDED');
                if (extractedEntries.length > 0) {
                    dataExtractHtml = `
                        <div class="mt-2 pt-2 border-t border-green-400/30">
                            <div class="text-xs font-semibold mb-1 opacity-80"><i class="fa-solid fa-table-cells mr-1"></i>Data Extracted:</div>
                            <div class="grid grid-cols-2 gap-1 text-xs">
                                ${extractedEntries.map(([k, v]) => `
                                    <div class="bg-green-400/20 rounded px-2 py-1">
                                        <span class="opacity-70">${escapeHtml(k)}:</span> <span class="font-medium">${escapeHtml(v)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }

            div.innerHTML = `
                <div class="flex ${alignClass} mb-1">
                    <div class="max-w-[85%]">
                        ${!isCandidate && typeBadges ? `<div class="flex gap-1 mb-1 justify-end">${typeBadges}</div>` : ''}
                        <div class="${bubbleClass} px-3 py-2">
                            <div class="text-sm whitespace-pre-wrap leading-relaxed ${isCandidate ? 'text-slate-700 dark:text-slate-200' : ''}">${escapeHtml(msg.text)}</div>
                            ${dataExtractHtml}
                            <div class="text-xs ${isCandidate ? 'text-slate-400' : 'text-green-100'} mt-1 text-right">${escapeHtml(msg.time)}</div>
                        </div>
                        <div class="text-xs ${isCandidate ? 'text-slate-500' : 'text-slate-500 text-right'} mt-0.5">
                            ${isCandidate ? '<i class="fa-solid fa-user mr-1"></i>' + escapeHtml(msg.senderName || 'Candidate') : '<i class="fa-solid fa-robot mr-1"></i>AI Response'}
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // Clear conversation thread
        function clearConversationThread() {
            conversationThread = [];
            conversationContext = {};
            renderConversationThread();
            document.getElementById('quickReplySection').classList.add('hidden');
            document.getElementById('dataExtractionResults').classList.add('hidden');
            document.getElementById('aiTestSummaryPanel').classList.add('hidden');
            showToast('Conversation cleared', 'info');
        }

        // Send quick reply (for continued conversation)
        function sendQuickReply() {
            const input = document.getElementById('quickReplyInput');
            const reply = input.value.trim();
            if (!reply) {
                showToast('Please enter a reply', 'warning');
                return;
            }

            // Update the main reply field and trigger test
            document.getElementById('aiTestCandidateReply').value = reply;
            input.value = '';

            runAiTest();
        }

        // Update data extraction results panel from AI test response
        function updateDataExtractionResults(response) {
            const resultsPanel = document.getElementById('dataExtractionResults');
            resultsPanel.classList.remove('hidden');

            const answeredCount = response.answeredCount || 0;
            const totalQuestions = response.totalQuestions || 0;
            const extractedData = response.extractedData || {};
            const pendingQuestions = response.pendingQuestions || [];

            // Calculate progress
            const progressPercent = totalQuestions > 0
                ? Math.round((answeredCount / totalQuestions) * 100)
                : 0;

            document.getElementById('extractionProgressBar').style.width = progressPercent + '%';
            document.getElementById('extractionProgressText').textContent =
                `${answeredCount} of ${totalQuestions} fields extracted`;

            // Update status badge
            const statusEl = document.getElementById('extractionStatus');
            const dataComplete = answeredCount === totalQuestions && totalQuestions > 0;
            if (dataComplete) {
                statusEl.textContent = 'COMPLETE';
                statusEl.className = 'text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
                document.getElementById('extractionProgressBar').className = 'bg-green-500 h-2 rounded-full transition-all';
            } else {
                statusEl.textContent = 'PENDING';
                statusEl.className = 'text-xs font-bold px-2 py-1 rounded bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300';
                document.getElementById('extractionProgressBar').className = 'bg-amber-500 h-2 rounded-full transition-all';
            }

            // Build results table from extracted data
            const tableBody = document.getElementById('extractedFieldsTable');
            const rows = [];
            for (const [field, value] of Object.entries(extractedData)) {
                // Skip internal fields
                if (field === 'is_negotiating' || field === 'negotiation_notes') continue;

                const isAnswered = value && value !== 'NOT_PROVIDED' && value !== 'PARSE_ERROR';
                rows.push(`
                    <tr class="border-b border-slate-100 dark:border-slate-800">
                        <td class="py-2 px-2 font-medium text-slate-700 dark:text-slate-300">${field}</td>
                        <td class="py-2 px-2 ${isAnswered ? 'text-slate-700 dark:text-slate-300' : 'text-slate-400 italic'}">${isAnswered ? value : '(not provided)'}</td>
                        <td class="py-2 px-2">
                            ${isAnswered
                                ? '<span class="inline-flex items-center text-xs text-green-600"><i class="fa-solid fa-check-circle mr-1"></i>Extracted</span>'
                                : '<span class="inline-flex items-center text-xs text-amber-600"><i class="fa-solid fa-clock mr-1"></i>Pending</span>'
                            }
                        </td>
                    </tr>
                `);
            }
            tableBody.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="3" class="py-4 text-center text-slate-400 text-sm">No extraction data available</td></tr>';

            // Update sheet preview headers/values
            const headers = Object.keys(extractedData).filter(k => k !== 'is_negotiating' && k !== 'negotiation_notes');
            const values = headers.map(h => extractedData[h] && extractedData[h] !== 'NOT_PROVIDED' ? extractedData[h] : '-');

            document.getElementById('sheetPreviewHeaders').innerHTML = `
                <tr>
                    ${headers.map(h => `<th class="py-2 px-2 text-left font-bold text-green-800 dark:text-green-300 border-b border-green-200 dark:border-green-800 whitespace-nowrap">${h}</th>`).join('')}
                </tr>
            `;
            document.getElementById('sheetPreviewValues').innerHTML = `
                <tr>
                    ${values.map(v => `<td class="py-2 px-2 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap">${v || '<span class="text-slate-300">-</span>'}</td>`).join('')}
                </tr>
            `;

            // Show negotiation notes if any
            const notesPanel = document.getElementById('extractionNegotiationNotes');
            if (extractedData.is_negotiating || extractedData.negotiation_notes) {
                notesPanel.classList.remove('hidden');
                document.getElementById('negotiationNotesText').textContent =
                    extractedData.negotiation_notes || 'Candidate appears to be negotiating';
            } else {
                notesPanel.classList.add('hidden');
            }
        }

        // Run the AI test (with multi-function support)
        function runAiTest() {
            const devName = document.getElementById('aiTestDevName').value.trim();
            const devEmail = document.getElementById('aiTestDevEmail').value.trim();
            const devCountry = document.getElementById('aiTestDevCountry').value.trim();
            const jobId = document.getElementById('aiTestJobId').value.trim();
            const jobDesc = document.getElementById('aiTestJobDesc').value.trim();
            const candidateReply = document.getElementById('aiTestCandidateReply').value.trim();

            // Validation
            if (!devName) {
                showToast('Please enter a developer name', 'warning');
                return;
            }
            if (!candidateReply) {
                showToast('Please enter a simulated candidate reply', 'warning');
                return;
            }

            // Determine which functions are active
            const activeFunctions = Object.entries(aiTestSelectedFunctions)
                .filter(([k, v]) => v)
                .map(([k, v]) => k);

            // Build test data with multi-function support
            let testData = {
                type: 'multifunction', // New type for multi-function testing
                functions: aiTestSelectedFunctions, // Pass the full selection object
                devName: devName,
                devEmail: devEmail || 'test@example.com',
                devCountry: devCountry || '',
                jobId: jobId || '',
                jobDesc: jobDesc || 'General software development position',
                candidateReply: candidateReply,
                conversationHistory: conversationThread, // Pass conversation context
                conversationContext: conversationContext // Pass accumulated context
            };

            // Add negotiation-specific data if negotiation is enabled
            if (aiTestSelectedFunctions.negotiation) {
                testData.targetRate = document.getElementById('aiTestTargetRate').value || '45';
                testData.maxRate = document.getElementById('aiTestMaxRate').value || '';
                testData.attempt = document.getElementById('aiTestAttempt').value || '1';

                const rateTierSelect = document.getElementById('aiTestRateTier');
                if (rateTierSelect.value !== '' && aiTestLoadedRateTiers[parseInt(rateTierSelect.value)]) {
                    testData.rateTier = aiTestLoadedRateTiers[parseInt(rateTierSelect.value)];
                }
            }

            // Add followup-specific data if followup is enabled
            if (aiTestSelectedFunctions.followup) {
                testData.followUpNumber = document.getElementById('aiTestFollowUpNum').value || '1';
            }

            // Add data gathering-specific data if data gathering is enabled
            if (aiTestSelectedFunctions.datagathering) {
                testData.pendingQuestions = document.getElementById('aiTestPendingQuestions').value || 'What is your expected rate?';
            }

            // Add candidate message to conversation thread immediately
            const candidateMsg = {
                sender: 'candidate',
                senderName: devName,
                text: candidateReply,
                time: new Date().toLocaleTimeString()
            };
            conversationThread.push(candidateMsg);
            renderConversationThread();

            // Show loading state
            document.getElementById('runAiTestBtn').disabled = true;
            document.getElementById('runAiTestBtnText').textContent = 'Generating...';

            // Add loading indicator to chat
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chatLoadingIndicator';
            loadingDiv.className = 'chat-message flex justify-end';
            loadingDiv.innerHTML = `
                <div class="bg-green-400/50 text-white rounded-lg px-4 py-2 animate-pulse">
                    <i class="fa-solid fa-spinner fa-spin mr-2"></i>AI is typing...
                </div>
            `;
            document.getElementById('conversationThread').appendChild(loadingDiv);
            document.getElementById('conversationThread').scrollTop = document.getElementById('conversationThread').scrollHeight;

            // Call backend
            google.script.run
                .withSuccessHandler(response => {
                    // Remove loading indicator
                    const loadingEl = document.getElementById('chatLoadingIndicator');
                    if (loadingEl) loadingEl.remove();

                    document.getElementById('runAiTestBtn').disabled = false;
                    document.getElementById('runAiTestBtnText').textContent = 'Send & Generate Response';

                    if (response.error) {
                        showToast(response.error, 'error');
                        // Remove the candidate message on error
                        conversationThread.pop();
                        renderConversationThread();
                        return;
                    }

                    // Add AI response to conversation thread
                    const aiMsg = {
                        sender: 'ai',
                        text: response.aiResponse,
                        time: new Date().toLocaleTimeString(),
                        types: response.activeTypes || activeFunctions,
                        extractedData: response.extractedData || null
                    };
                    conversationThread.push(aiMsg);
                    renderConversationThread();

                    // Update conversation context with any extracted data
                    if (response.extractedData) {
                        conversationContext.extractedData = {
                            ...(conversationContext.extractedData || {}),
                            ...response.extractedData
                        };
                        conversationContext.answeredCount = response.answeredCount;
                        conversationContext.totalQuestions = response.totalQuestions;
                        conversationContext.pendingQuestions = response.pendingQuestions;
                    }

                    // Update negotiation attempt context
                    if (response.negotiationState) {
                        conversationContext.negotiationState = response.negotiationState;
                    }

                    // Show data extraction panel if data gathering is active
                    if (aiTestSelectedFunctions.datagathering && response.extractedData) {
                        updateDataExtractionResults(response);
                    }

                    // Show AI Summary panel if summary was generated
                    if (response.aiSummary) {
                        const summaryPanel = document.getElementById('aiTestSummaryPanel');
                        const summaryContent = document.getElementById('aiTestSummaryContent');
                        summaryPanel.classList.remove('hidden');
                        summaryContent.textContent = response.aiSummary;
                    }

                    // Clear the reply input for next message
                    document.getElementById('aiTestCandidateReply').value = '';

                    // Add to history
                    aiTestHistory.unshift({
                        type: activeFunctions.join('+'),
                        devName: devName,
                        candidateReply: candidateReply.substring(0, 50) + (candidateReply.length > 50 ? '...' : ''),
                        aiResponse: response.aiResponse.substring(0, 100) + (response.aiResponse.length > 100 ? '...' : ''),
                        fullResponse: response.aiResponse,
                        time: new Date().toLocaleTimeString(),
                        extractedData: response.extractedData,
                        answeredCount: response.answeredCount,
                        totalQuestions: response.totalQuestions
                    });
                    renderAiTestHistory();

                    showToast('AI response generated successfully', 'success');
                })
                .withFailureHandler(err => {
                    // Remove loading indicator
                    const loadingEl = document.getElementById('chatLoadingIndicator');
                    if (loadingEl) loadingEl.remove();

                    document.getElementById('runAiTestBtn').disabled = false;
                    document.getElementById('runAiTestBtnText').textContent = 'Send & Generate Response';

                    // Remove the candidate message on error
                    conversationThread.pop();
                    renderConversationThread();

                    // Handle cases where err.message might be undefined
                    const errorMsg = err && err.message ? err.message : (typeof err === 'string' ? err : 'Unknown error - check console');
                    showToast('Failed to generate AI response: ' + errorMsg, 'error');
                    console.error('AI Test Error:', err);
                })
                .testAiEmailResponse(testData);
        }

        // Run data extraction test (for Data Gathering mode)
        function runDataExtraction() {
            const devName = document.getElementById('aiTestDevName').value.trim();
            const candidateReply = document.getElementById('aiTestCandidateReply').value.trim();
            const questions = document.getElementById('aiTestPendingQuestions').value.trim();
            const jobId = document.getElementById('aiTestJobId').value.trim();

            if (!candidateReply) {
                showToast('Please enter a simulated candidate reply to extract data from', 'warning');
                return;
            }

            // Show loading state
            const btn = document.getElementById('extractDataBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> Extracting...';
            btn.disabled = true;

            google.script.run
                .withSuccessHandler(response => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    if (response.error) {
                        showToast(response.error, 'error');
                        return;
                    }

                    // Show the results panel
                    const resultsPanel = document.getElementById('dataExtractionResults');
                    resultsPanel.classList.remove('hidden');

                    // Update summary
                    const summary = response.summary;
                    const progressPercent = summary.totalQuestions > 0
                        ? Math.round((summary.answeredCount / summary.totalQuestions) * 100)
                        : 0;

                    document.getElementById('extractionProgressBar').style.width = progressPercent + '%';
                    document.getElementById('extractionProgressText').textContent =
                        `${summary.answeredCount} of ${summary.totalQuestions} fields extracted`;

                    const statusEl = document.getElementById('extractionStatus');
                    if (summary.dataComplete) {
                        statusEl.textContent = 'COMPLETE';
                        statusEl.className = 'text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
                        document.getElementById('extractionProgressBar').className = 'bg-green-500 h-2 rounded-full transition-all';
                    } else {
                        statusEl.textContent = 'PENDING';
                        statusEl.className = 'text-xs font-bold px-2 py-1 rounded bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300';
                        document.getElementById('extractionProgressBar').className = 'bg-amber-500 h-2 rounded-full transition-all';
                    }

                    // Populate extracted fields table
                    const tableBody = document.getElementById('extractedFieldsTable');
                    tableBody.innerHTML = response.results.map(r => `
                        <tr class="border-b border-slate-100 dark:border-slate-800">
                            <td class="py-2 px-2 font-medium text-slate-700 dark:text-slate-300">${r.field}</td>
                            <td class="py-2 px-2 ${r.status === 'answered' ? 'text-slate-700 dark:text-slate-300' : 'text-slate-400 italic'}">${r.extractedValue}</td>
                            <td class="py-2 px-2">
                                ${r.status === 'answered'
                                    ? '<span class="inline-flex items-center text-xs text-green-600"><i class="fa-solid fa-check-circle mr-1"></i>Extracted</span>'
                                    : '<span class="inline-flex items-center text-xs text-amber-600"><i class="fa-solid fa-clock mr-1"></i>Pending</span>'
                                }
                            </td>
                        </tr>
                    `).join('');

                    // Populate sheet preview
                    const preview = response.sheetPreview;
                    document.getElementById('sheetPreviewHeaders').innerHTML = `
                        <tr>
                            ${preview.headers.map(h => `<th class="py-2 px-2 text-left font-bold text-green-800 dark:text-green-300 border-b border-green-200 dark:border-green-800 whitespace-nowrap">${h}</th>`).join('')}
                        </tr>
                    `;
                    document.getElementById('sheetPreviewValues').innerHTML = `
                        <tr>
                            ${preview.values.map((v, i) => `<td class="py-2 px-2 border-b border-slate-200 dark:border-slate-700 whitespace-nowrap ${i === preview.values.length - 2 ? (v === 'Data Complete' ? 'text-green-600 font-medium' : 'text-amber-600 font-medium') : ''}">${v || '<span class="text-slate-300">-</span>'}</td>`).join('')}
                        </tr>
                    `;

                    // Show negotiation notes if any
                    const notesPanel = document.getElementById('extractionNegotiationNotes');
                    if (summary.isNegotiating || summary.negotiationNotes) {
                        notesPanel.classList.remove('hidden');
                        document.getElementById('negotiationNotesText').textContent =
                            summary.negotiationNotes || 'Candidate appears to be negotiating';
                    } else {
                        notesPanel.classList.add('hidden');
                    }

                    showToast('Data extracted successfully', 'success');
                })
                .withFailureHandler(err => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    const errorMsg = err && err.message ? err.message : (typeof err === 'string' ? err : 'Unknown error');
                    showToast('Failed to extract data: ' + errorMsg, 'error');
                    console.error('Data extraction error:', err);
                })
                .testDataExtraction({
                    candidateReply: candidateReply,
                    questions: questions,
                    devName: devName || 'Test Candidate',
                    jobId: jobId
                });
        }

        // Render test history
        function renderAiTestHistory() {
            const emptyEl = document.getElementById('aiTestHistoryEmpty');
            const listEl = document.getElementById('aiTestHistoryList');

            if (aiTestHistory.length === 0) {
                emptyEl.classList.remove('hidden');
                listEl.classList.add('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            listEl.classList.remove('hidden');

            const typeColors = {
                'negotiation': 'blue',
                'followup': 'orange',
                'datagathering': 'purple'
            };

            listEl.innerHTML = aiTestHistory.map((item, idx) => `
                <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition" onclick="showHistoryItem(${idx})">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-bold uppercase px-2 py-0.5 rounded bg-${typeColors[item.type]}-100 text-${typeColors[item.type]}-700 dark:bg-${typeColors[item.type]}-900 dark:text-${typeColors[item.type]}-300">${item.type}</span>
                        <span class="text-xs text-slate-500">${item.time}</span>
                    </div>
                    <p class="text-xs text-slate-600 dark:text-slate-400 mb-1"><strong>${item.devName}:</strong> ${item.candidateReply}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-500 italic">${item.aiResponse}</p>
                </div>
            `).join('');
        }

        // Show a history item in the response panel
        function showHistoryItem(idx) {
            const item = aiTestHistory[idx];
            if (!item) return;

            document.getElementById('aiTestResponseEmpty').classList.add('hidden');
            document.getElementById('aiTestResponseLoading').classList.add('hidden');
            document.getElementById('aiTestResponseContent').classList.remove('hidden');
            document.getElementById('aiTestResponseType').textContent = item.type.toUpperCase();
            document.getElementById('aiTestResponseTime').textContent = item.time;
            document.getElementById('aiTestResponseText').textContent = item.fullResponse;
        }

        // Clear test history
        function clearAiTestHistory() {
            aiTestHistory = [];
            renderAiTestHistory();
            showToast('History cleared', 'info');
        }
        // ===== AI TESTING FEATURE - DELETE FOR PRODUCTION (END JAVASCRIPT) =====

        // ===== PROCESS MAP TOOLTIP POSITIONING =====

        // Position tooltips dynamically to avoid clipping
        (function initProcessMapTooltips() {
            document.addEventListener('mouseover', function(e) {
                // Handle both tooltip systems
                let wrapper = e.target.closest('.process-tooltip-wrapper');
                let tooltip = wrapper ? wrapper.querySelector('.process-tooltip') : null;

                // Also check for pm-tooltip system
                if (!wrapper) {
                    wrapper = e.target.closest('.pm-tooltip');
                    tooltip = wrapper ? wrapper.querySelector('.pm-tooltip-text') : null;
                }

                if (!wrapper || !tooltip) return;

                // Get wrapper position
                const rect = wrapper.getBoundingClientRect();

                // Force tooltip to be visible momentarily to get its size
                const originalVisibility = tooltip.style.visibility;
                const originalOpacity = tooltip.style.opacity;
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
                tooltip.style.display = 'block';

                const tooltipRect = tooltip.getBoundingClientRect();

                // Reset
                tooltip.style.display = '';
                tooltip.style.visibility = originalVisibility;
                tooltip.style.opacity = originalOpacity;

                // Calculate position - above the element, centered
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                let top = rect.top - tooltipRect.height - 10;

                // Keep tooltip within viewport
                const padding = 10;

                // Horizontal bounds
                if (left < padding) {
                    left = padding;
                } else if (left + tooltipRect.width > window.innerWidth - padding) {
                    left = window.innerWidth - tooltipRect.width - padding;
                }

                // If tooltip goes above viewport, show below instead
                if (top < padding) {
                    top = rect.bottom + 10;
                }

                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            });
        })();

        // ===== PROCESS MAP FUNCTIONS =====

        // Load all process map data
        function loadProcessMapData() {
            refreshProcessMap();
        }

        // Refresh all process map status indicators
        function refreshProcessMap() {
            const btn = document.getElementById('refreshProcessMapBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Refreshing...';
            }

            // Call server-side function to get process status
            google.script.run
                .withSuccessHandler(function(data) {
                    if (data && !data.error) {
                        updateProcessMapUI(data);
                    } else {
                        console.error('Failed to load process map data:', data?.error);
                        showToast('Failed to load process status', 'error');
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-sync"></i> Refresh Status';
                    }
                })
                .withFailureHandler(function(err) {
                    console.error('Error loading process map:', err);
                    showToast('Error loading process status', 'error');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-sync"></i> Refresh Status';
                    }
                })
                .getProcessMapStatus();
        }

        // Update the Process Map UI with data
        function updateProcessMapUI(data) {
            // Update System Status lights
            updateStatusLight('status-light-trigger-negotiator', 'status-text-trigger-negotiator', data.triggers?.negotiator);
            updateStatusLight('status-light-trigger-followup', 'status-text-trigger-followup', data.triggers?.followup);
            updateStatusLight('status-light-sheets', 'status-text-sheets', data.sheets);
            updateStatusLight('status-light-gmail', 'status-text-gmail', data.gmail);
            updateStatusLight('status-light-openai', 'status-text-openai', data.openai);

            // Update Today's Statistics
            if (data.todayStats) {
                document.getElementById('stat-emails-sent').textContent = data.todayStats.emailsSent || 0;
                document.getElementById('stat-ai-replies').textContent = data.todayStats.aiReplies || 0;
                document.getElementById('stat-escalated').textContent = data.todayStats.escalated || 0;
                document.getElementById('stat-followups-sent').textContent = data.todayStats.followupsSent || 0;
                document.getElementById('stat-completed').textContent = data.todayStats.completed || 0;
                document.getElementById('stat-unresponsive').textContent = data.todayStats.unresponsive || 0;
            }

            // Update Queue Status
            if (data.queueStatus) {
                document.getElementById('queue-negotiations').textContent = data.queueStatus.activeNegotiations || 0;
                document.getElementById('queue-followups').textContent = data.queueStatus.pendingFollowups || 0;
                document.getElementById('queue-human').textContent = data.queueStatus.humanReview || 0;
                document.getElementById('queue-jobs').textContent = data.queueStatus.configuredJobs || 0;
            }

            // Update Activity Log
            if (data.recentActivity) {
                renderActivityLog(data.recentActivity);
            }

            // Update flowchart node status lights
            updateFlowchartNodes(data);
        }

        // Update individual status light
        function updateStatusLight(lightId, textId, statusData) {
            const light = document.getElementById(lightId);
            const text = document.getElementById(textId);

            if (!light || !text) return;

            // Remove all status classes
            light.classList.remove('status-ok', 'status-idle', 'status-error', 'status-disabled', 'status-checking');

            if (!statusData) {
                light.classList.add('status-disabled');
                text.textContent = 'Unknown';
                return;
            }

            if (statusData.status === 'ok') {
                light.classList.add('status-ok');
                text.textContent = statusData.message || 'Active';
            } else if (statusData.status === 'idle') {
                light.classList.add('status-idle');
                text.textContent = statusData.message || 'Idle';
            } else if (statusData.status === 'error') {
                light.classList.add('status-error');
                text.textContent = statusData.message || 'Error';
            } else if (statusData.status === 'disabled') {
                light.classList.add('status-disabled');
                text.textContent = statusData.message || 'Disabled';
            } else {
                light.classList.add('status-idle');
                text.textContent = statusData.message || '-';
            }
        }

        // Update flowchart node status lights
        function updateFlowchartNodes(data) {
            // Auto Negotiator node
            const negotiatorLight = document.getElementById('status-auto-negotiator');
            if (negotiatorLight) {
                negotiatorLight.classList.remove('status-ok', 'status-idle', 'status-error', 'status-disabled');
                if (data.triggers?.negotiator?.status === 'ok') {
                    negotiatorLight.classList.add('status-ok');
                } else if (data.triggers?.negotiator?.status === 'error') {
                    negotiatorLight.classList.add('status-error');
                } else {
                    negotiatorLight.classList.add('status-idle');
                }
            }

            // Follow-up Processor node
            const followupLight = document.getElementById('status-followup-processor');
            if (followupLight) {
                followupLight.classList.remove('status-ok', 'status-idle', 'status-error', 'status-disabled');
                if (data.triggers?.followup?.status === 'ok') {
                    followupLight.classList.add('status-ok');
                } else if (data.triggers?.followup?.status === 'error') {
                    followupLight.classList.add('status-error');
                } else {
                    followupLight.classList.add('status-idle');
                }
            }

            // OpenAI node
            const openaiLight = document.getElementById('status-openai');
            if (openaiLight) {
                openaiLight.classList.remove('status-ok', 'status-idle', 'status-error', 'status-disabled');
                if (data.openai?.status === 'ok') {
                    openaiLight.classList.add('status-ok');
                } else if (data.openai?.status === 'error') {
                    openaiLight.classList.add('status-error');
                } else {
                    openaiLight.classList.add('status-idle');
                }
            }
        }

        // Render the activity log
        function renderActivityLog(activities) {
            const container = document.getElementById('activityLogContainer');
            if (!container) return;

            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-slate-400">
                        <i class="fa-regular fa-clock text-xl mb-2 block"></i>
                        <span class="text-sm">No recent activity</span>
                    </div>
                `;
                return;
            }

            const typeStyles = {
                'success': { bg: 'bg-green-100 dark:bg-green-900/30', icon: 'fa-check', color: 'text-green-600' },
                'error': { bg: 'bg-red-100 dark:bg-red-900/30', icon: 'fa-times', color: 'text-red-600' },
                'info': { bg: 'bg-blue-100 dark:bg-blue-900/30', icon: 'fa-info', color: 'text-blue-600' },
                'warning': { bg: 'bg-amber-100 dark:bg-amber-900/30', icon: 'fa-exclamation', color: 'text-amber-600' },
                'email': { bg: 'bg-green-100 dark:bg-green-900/30', icon: 'fa-envelope', color: 'text-green-600' },
                'negotiation': { bg: 'bg-purple-100 dark:bg-purple-900/30', icon: 'fa-robot', color: 'text-purple-600' },
                'followup': { bg: 'bg-amber-100 dark:bg-amber-900/30', icon: 'fa-clock', color: 'text-amber-600' },
                'escalation': { bg: 'bg-red-100 dark:bg-red-900/30', icon: 'fa-user-tie', color: 'text-red-600' },
                'completed': { bg: 'bg-green-100 dark:bg-green-900/30', icon: 'fa-flag-checkered', color: 'text-green-600' }
            };

            container.innerHTML = activities.map(item => {
                const style = typeStyles[item.type] || typeStyles['info'];
                const timeAgo = formatTimeAgo(item.timestamp);
                return `
                    <div class="activity-item activity-${item.type === 'error' ? 'error' : item.type === 'success' || item.type === 'email' || item.type === 'completed' ? 'success' : item.type === 'warning' || item.type === 'escalation' ? 'warning' : 'info'}">
                        <div class="activity-icon ${style.bg}">
                            <i class="fa-solid ${style.icon} ${style.color} text-xs"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${item.message}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format time ago
        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return '';
            }
        }

    </script>
</body>
</html>
